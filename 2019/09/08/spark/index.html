<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>spark | 个人博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="./favicon.ico">
    <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?55943ae09e5901d7a9f5705133737eec";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
           </script>
    <script src="https://hm.baidu.com/hm.js?xxxxxxxxxxx"></script>
    <meta name="description" content="会思考的芦苇。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="robots" content="all">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="./assets/css/0.styles.f4f644f3.css" as="style"><link rel="preload" href="./assets/js/app.764dede6.js" as="script"><link rel="preload" href="./assets/js/13.20e964b9.js" as="script"><link rel="preload" href="./assets/js/1.8757f81f.js" as="script"><link rel="preload" href="./assets/js/3.9efa3b27.js" as="script"><link rel="preload" href="./assets/js/34.ec572062.js" as="script"><link rel="prefetch" href="./assets/js/10.36ed4133.js"><link rel="prefetch" href="./assets/js/11.18e1c33d.js"><link rel="prefetch" href="./assets/js/12.b32071c5.js"><link rel="prefetch" href="./assets/js/14.d0932ff0.js"><link rel="prefetch" href="./assets/js/15.7747d51d.js"><link rel="prefetch" href="./assets/js/16.487f9c88.js"><link rel="prefetch" href="./assets/js/17.9ae2b89b.js"><link rel="prefetch" href="./assets/js/18.801c9b12.js"><link rel="prefetch" href="./assets/js/19.867ef46b.js"><link rel="prefetch" href="./assets/js/20.ec371d7f.js"><link rel="prefetch" href="./assets/js/21.73f810bc.js"><link rel="prefetch" href="./assets/js/22.8c016772.js"><link rel="prefetch" href="./assets/js/23.9aa3d5ef.js"><link rel="prefetch" href="./assets/js/24.a6dcda10.js"><link rel="prefetch" href="./assets/js/25.2fe13775.js"><link rel="prefetch" href="./assets/js/26.2296389e.js"><link rel="prefetch" href="./assets/js/27.21f2d66f.js"><link rel="prefetch" href="./assets/js/28.3209357f.js"><link rel="prefetch" href="./assets/js/29.c7065b7f.js"><link rel="prefetch" href="./assets/js/30.92914cc9.js"><link rel="prefetch" href="./assets/js/31.13c12633.js"><link rel="prefetch" href="./assets/js/32.b016f60e.js"><link rel="prefetch" href="./assets/js/33.ed48a654.js"><link rel="prefetch" href="./assets/js/35.5b55607b.js"><link rel="prefetch" href="./assets/js/36.f50b6e38.js"><link rel="prefetch" href="./assets/js/37.34409ac4.js"><link rel="prefetch" href="./assets/js/38.c7073f77.js"><link rel="prefetch" href="./assets/js/39.12f063e9.js"><link rel="prefetch" href="./assets/js/4.95c562bd.js"><link rel="prefetch" href="./assets/js/40.1bbd5377.js"><link rel="prefetch" href="./assets/js/41.6331a8cf.js"><link rel="prefetch" href="./assets/js/42.28acd6f5.js"><link rel="prefetch" href="./assets/js/43.905d2114.js"><link rel="prefetch" href="./assets/js/44.041132c5.js"><link rel="prefetch" href="./assets/js/45.d1a66b92.js"><link rel="prefetch" href="./assets/js/46.1c9100fe.js"><link rel="prefetch" href="./assets/js/47.3e75f768.js"><link rel="prefetch" href="./assets/js/48.7d7248fb.js"><link rel="prefetch" href="./assets/js/49.8d465809.js"><link rel="prefetch" href="./assets/js/5.a1a0df33.js"><link rel="prefetch" href="./assets/js/50.4aa56564.js"><link rel="prefetch" href="./assets/js/51.59674bf5.js"><link rel="prefetch" href="./assets/js/52.f3990683.js"><link rel="prefetch" href="./assets/js/53.092fe0ad.js"><link rel="prefetch" href="./assets/js/54.ac62e2a7.js"><link rel="prefetch" href="./assets/js/55.3530fa5a.js"><link rel="prefetch" href="./assets/js/56.6e9bc6f3.js"><link rel="prefetch" href="./assets/js/6.e534639a.js"><link rel="prefetch" href="./assets/js/7.bc868936.js"><link rel="prefetch" href="./assets/js/8.ce0f4f25.js"><link rel="prefetch" href="./assets/js/9.a57a9cf0.js">
    <link rel="stylesheet" href="./assets/css/0.styles.f4f644f3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Gordon</h3> <p class="description" data-v-59e6cb88>会思考的芦苇。</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Gordon</span>
          
        <span data-v-59e6cb88>2018 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><img src="./logo.png" alt="个人博客" class="logo"> <span class="site-name">个人博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      计算引擎
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./计算引擎/flink.html" class="nav-link"><i class="undefined"></i>
  flink
</a></li><li class="dropdown-item"><!----> <a href="/./计算引擎/spark.html" class="nav-link"><i class="undefined"></i>
  spark
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      存储引擎
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./存储引擎/ElasticSearch.html" class="nav-link"><i class="undefined"></i>
  ElasticSearch
</a></li><li class="dropdown-item"><!----> <a href="/./存储引擎/hbase.html" class="nav-link"><i class="undefined"></i>
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/./存储引擎/redis.html" class="nav-link"><i class="undefined"></i>
  redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      云原生
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./云原生/Docker.html" class="nav-link"><i class="undefined"></i>
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      中间件
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./中间件/kafka.html" class="nav-link"><i class="undefined"></i>
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./中间件/Sqoop基本使用.html" class="nav-link"><i class="undefined"></i>
  Sqoop基本使用
</a></li></ul></div></div><div class="nav-item"><a href="/./tool/emoji/我的常用emoji.html" class="nav-link"><i class="undefined"></i>
  工具
</a></div><div class="nav-item"><a href="/./aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></div> <a href="https://github.com/GordonChanFZ/gordonchanfz.github.io/" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="./avatar.jpeg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Gordon
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>30</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>47</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41><li class="social-item" data-v-1fad0c41><i class="iconfont reco-github" style="color:#e15b64;" data-v-1fad0c41></i></li></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/./" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      计算引擎
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./计算引擎/flink.html" class="nav-link"><i class="undefined"></i>
  flink
</a></li><li class="dropdown-item"><!----> <a href="/./计算引擎/spark.html" class="nav-link"><i class="undefined"></i>
  spark
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      存储引擎
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./存储引擎/ElasticSearch.html" class="nav-link"><i class="undefined"></i>
  ElasticSearch
</a></li><li class="dropdown-item"><!----> <a href="/./存储引擎/hbase.html" class="nav-link"><i class="undefined"></i>
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/./存储引擎/redis.html" class="nav-link"><i class="undefined"></i>
  redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      云原生
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./云原生/Docker.html" class="nav-link"><i class="undefined"></i>
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      中间件
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./中间件/kafka.html" class="nav-link"><i class="undefined"></i>
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./中间件/Sqoop基本使用.html" class="nav-link"><i class="undefined"></i>
  Sqoop基本使用
</a></li></ul></div></div><div class="nav-item"><a href="/./tool/emoji/我的常用emoji.html" class="nav-link"><i class="undefined"></i>
  工具
</a></div><div class="nav-item"><a href="/./aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></div> <a href="https://github.com/GordonChanFZ/gordonchanfz.github.io/" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>spark</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Gordon</span>
          
        <span data-v-59e6cb88>2018 - </span>
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">spark</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Gordon</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2019-9-8</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>离线计算</span><span class="tag-item" data-v-8a445198>sparksql</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="spark入门"><a href="#spark入门" class="header-anchor">#</a> Spark入门</h2> <ul><li><p>四代计算引擎</p> <ul><li>第一代引擎：MR</li> <li>第二代引擎：Hive（MR,Spark,Tez） 部分支持DAG(有向无环图)</li> <li>第三代引擎：Spark和Impala(完全支持DAG)</li> <li>第四代计算引擎：批流统一FLink(完全支持DAG)</li></ul></li> <li><p>技术发展：</p></li> <li></li> <li><p><img src="./assets/img/image-20210327102855537.3436ecca.png" alt="image-20210327102855537"></p></li> <li><p><img src="./assets/img/image-20210327103436785.26b82796.png" alt="image-20210327103436785"></p></li> <li><p><img src="./assets/img/image-20210327103519977.a980f7dd.png" alt="image-20210327103519977"></p></li> <li><p><img src="./assets/img/image-20210327103617027.ba807273.png" alt="image-20210327103617027"></p></li> <li><p><img src="./assets/img/image-20210327103902124.94a48285.png" alt="image-20210327103902124"></p></li> <li><p>面试题：Hadoop的基于进程的计算和Spark基于线程方式优缺点？</p> <ul><li><p>只需要回答进程和线程的区别</p></li> <li><p>线程基本概念</p> <p>l 线程是CPU的基本调度单位</p> <p>l 一个进程一般包含多个线程, 一个进程下的多个线程共享进程的资源</p> <p>l 不同进程之间的线程相互不可见</p> <p>l 线程不能独立执行</p> <p>l 一个线程可以创建和撤销另外一个线程</p></li></ul></li></ul> <h2 id="spark的部署回顾"><a href="#spark的部署回顾" class="header-anchor">#</a> Spark的部署回顾</h2> <ul><li><img src="./assets/img/image-20210327105704323.6c57d480.png" alt="image-20210327105704323"></li></ul> <h3 id="local模式"><a href="#local模式" class="header-anchor">#</a> local模式</h3> <ul><li><p><img src="./assets/img/image-20210327105933324.057c5df1.png" alt="image-20210327105933324"></p></li> <li><p>如何安装？</p> <ul><li>local模式，开箱即用模式，使用测试模式下</li> <li><img src="./assets/img/image-20210327110806723.5234283d.png" alt="image-20210327110806723"></li></ul></li> <li><p>如何spark-shell应用？</p> <ul><li>bin/spark-shell --master local[3]</li> <li><img src="./assets/img/image-20210327111138411.7ecddd09.png" alt="image-20210327111138411"></li> <li><img src="./assets/img/image-20210327111507583.9f0c0fff.png" alt="image-20210327111507583"></li> <li><img src="./assets/img/image-20210327111806641.e53d18ee.png" alt="image-20210327111806641"></li> <li>wordcount</li> <li><img src="./assets/img/image-20210327112250810.b0346831.png" alt="image-20210327112250810"></li> <li>本地文件执行wordcount</li> <li><img src="./assets/img/image-20210327113020760.b660bd76.png" alt="image-20210327113020760"></li> <li>hdfs文件执行wordcount</li> <li><img src="./assets/img/image-20210327113147099.60417c8b.png" alt="image-20210327113147099"></li> <li>了解Spark的任务流程</li> <li><img src="./assets/img/image-20210327113000682.cf7a7926.png" alt="image-20210327113000682"></li> <li>深入原理：了解Shuffle</li> <li><img src="./assets/img/image-20210327114319204.67299cec.png" alt="image-20210327114319204"></li> <li>理解：为什么会生成两个文件夹？</li> <li><img src="./assets/img/image-20210327114644040.9d4023bc.png" alt="image-20210327114644040"></li></ul></li> <li><p>如何提交任务？</p> <ul><li><img src="./assets/img/image-20210327120055333.de03f77e.png" alt="image-20210327120055333"></li></ul></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>    # Spark-local模式提交任务
    bin/spark-submit \
    --master local[3] \
    --class org.apache.spark.examples.SparkPi \
    /export/server/spark/examples/jars/spark-examples_2.11-2.4.5.jar \
    10
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="standalone"><a href="#standalone" class="header-anchor">#</a> Standalone</h3> <ul><li><p>2-Standalone模式学会查看</p> <ul><li><img src="./assets/img/image-20210327110202972.22deec4f.png" alt="image-20210327110202972"></li></ul></li> <li><p>如何安装？</p> <ul><li>根据架构安装</li> <li><img src="./assets/img/image-20210327120358367.02651043.png" alt="image-20210327120358367"></li> <li>配置文件中需要更改：
<ul><li>1-指定谁是Master，谁是Worker</li> <li>2-指定Master的通信地址，7077，指定Master的WebUi地址，8080</li> <li>3-可选项指定WOrker通信地址和Worker的WebUi地址</li> <li>4-配置Spark的历史日志服务器
<ul><li>为什么配置？因为如果执行Spark-Shell启动4040在关闭当前应用窗口之后无法查看UI</li> <li>如何配置？需要将Spark的历史日志服务器的日志写入到HDFS分布式文件系统</li></ul></li></ul></li> <li>配置：</li> <li><img src="spark.assets/image-20210327121309024.png" alt="image-20210327121309024" style="zoom:150%;"></li> <li><img src="./assets/img/image-20210327120815023.6314dc7e.png" alt="image-20210327120815023"></li> <li>查看WebUi</li> <li><img src="./assets/img/image-20210327121628357.f77f9ced.png" alt="image-20210327121628357"></li></ul></li> <li><p>如何spark-shell？</p> <ul><li>bin/spark-shell --master spark://node1:7077</li> <li><img src="./assets/img/image-20210327122102781.48981a41.png" alt="image-20210327122102781"></li></ul></li> <li><p>如何提交Spark任务？</p> <ul><li><img src="./assets/img/image-20210327121829846.1c84eccd.png" alt="image-20210327121829846"></li></ul></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>    bin/spark-submit <span class="token punctuation">\</span>
    <span class="token parameter variable">--master</span> spark://node1:7077 <span class="token punctuation">\</span>
    <span class="token parameter variable">--class</span> org.apache.spark.examples.SparkPi <span class="token punctuation">\</span>
    /export/server/spark/examples/jars/spark-examples_2.11-2.4.5.jar <span class="token punctuation">\</span>
    <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><img src="./assets/img/image-20210327121933226.14a6b19e.png" alt="image-20210327121933226"></li></ul> <h3 id="standaloneha"><a href="#standaloneha" class="header-anchor">#</a> StandaloneHA</h3> <ul><li><p>3-standaloneHA模式</p> <ul><li><p>1-架构</p></li> <li><img src="./assets/img/image-20210327143454035.2e60ed46.png" alt="image-20210327143454035" style="zoom:150%;"></li> <li><p>2-如何搭建</p> <ul><li>1-首先注释spark-env.sh的master节点的部分(因为zk选举)</li> <li>2-增加zk选举的配置项</li> <li>3-进一步分发即可</li></ul></li> <li><img src="./assets/img/image-20210327143733819.c64004db.png" alt="image-20210327143733819" style="zoom:150%;"></li> <li><p>3-如何执行spark-shell(测试)</p></li> <li><p>bin/spark-shell --master spark://node1:7077,node2:7077</p></li> <li><p>启动遇到的问题</p></li> <li><p><img src="./assets/img/image-20210327144140349.8ca925b9.png" alt="image-20210327144140349"></p></li> <li><p>解决：在node2上启动master</p></li> <li><p><img src="./assets/img/image-20210327144240038.445ae274.png" alt="image-20210327144240038"></p></li> <li><p>正常启动</p></li> <li><p><img src="./assets/img/image-20210327144340319.78aad4e7.png" alt="image-20210327144340319"></p></li> <li><p>可以执行简单的rdd创建</p></li> <li><p><img src="./assets/img/image-20210327144507857.b8081029.png" alt="image-20210327144507857"></p></li> <li><p>4-如何提交任务(实际生产环境)</p></li></ul></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>    bin/spark-submit \
    --master spark://node1:7077,node2:7077 \
    --class org.apache.spark.examples.SparkPi \
    /export/server/spark/examples/jars/spark-examples_2.11-2.4.5.jar \
    10
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p><img src="./assets/img/image-20210327144639336.26f002db.png" alt="image-20210327144639336"></p></li> <li><p>观察现象：</p></li> <li><p><img src="./assets/img/image-20210327144912641.31c6184a.png" alt="image-20210327144912641"></p></li> <li><p><img src="./assets/img/image-20210327145319768.40d19682.png" alt="image-20210327145319768"></p></li></ul> <h3 id="sparkonyarn"><a href="#sparkonyarn" class="header-anchor">#</a> SparkOnYarn</h3> <ul><li><p>使用的Yarn负责资源管理和调度</p></li> <li><p><strong>Driver申请资源-----AppMaster应用管理器----ResourceManager</strong>----<strong>-NodeManager----Container----Task任务</strong></p></li> <li><p>（1）搭建Yarn环境</p> <ul><li>1-首先需要在spark-env.sh中配置HADOOP_CONF和Yarn_CONF</li> <li><img src="./assets/img/image-20210327162321701.02000665.png" alt="image-20210327162321701">2-需要关闭内存检查</li> <li><img src="spark.assets/image-20210327162502738.png" alt="image-20210327162502738" style="zoom:150%;"></li> <li>3-需要整合Yarn的历史日志服务器和Spark的历史日志服务器
<ul><li>为什么整合？
<ul><li>答案：因为Yarn的历史日志服务器中的历史Job无法查看具体spark的任务使用了多少executor和内存</li></ul></li></ul></li> <li><img src="spark.assets/image-20210327162647036.png" alt="image-20210327162647036" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210327163011193.png" alt="image-20210327163011193" style="zoom:150%;"></li></ul></li> <li><p>（2）提交Yarn任务</p></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>  bin/spark-submit \
  --master yarn \
  --class org.apache.spark.examples.SparkPi \
  /export/server/spark/examples/jars/spark-examples_2.11-2.4.5.jar \
  10
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p><img src="./assets/img/image-20210327163343546.d6022f66.png" alt="image-20210327163343546"></p></li> <li><p>（3）查看监控---8088，历史日志服务器19888</p></li> <li><p><img src="./assets/img/image-20210327163515924.afcae04a.png" alt="image-20210327163515924"></p></li> <li><p><img src="./assets/img/image-20210327163617881.2f70ec19.png" alt="image-20210327163617881"></p></li></ul> <p>重难点知识</p> <ul><li>Spark部署模式</li> <li>SparkOnYarn的两种deploymode模式原理</li> <li>掌握基于Scala的WOrdcount的IDEA编码</li> <li>学会提交Jar包集群跑</li> <li>需要形成属于自己的脚本</li></ul> <h4 id="spark的两种mode模式-集群模式均可用"><a href="#spark的两种mode模式-集群模式均可用" class="header-anchor">#</a> Spark的两种Mode模式(集群模式均可用)</h4> <ul><li><p>集群模式：standalone和HA和Yarn</p></li> <li><p>本质区别：Cluster和Client模式最最本质的区别是：Driver程序运行在哪里。</p></li> <li><p><img src="./assets/img/image-20210327164001715.422ce141.png" alt="image-20210327164001715"></p></li> <li><p>第一种Client：driver启动在本地</p></li> <li><img src="spark.assets/image-20210327164611022.png" alt="image-20210327164611022" style="zoom:150%;"></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>  bin/spark-submit \
  --master spark://node1:7077 \
  --deploy-mode client \
  --class org.apache.spark.examples.SparkPi \
  /export/server/spark-2.4.5-bin-hadoop2.7/examples/jars/spark-examples_2.11-2.4.5.jar \
  10
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><p><img src="./assets/img/image-20210327165606268.6c8445db.png" alt="image-20210327165606268"></p></li> <li><p>第二种Cluster：driver启动在由Master指定的worker节点上</p></li> <li><img src="spark.assets/image-20210327164914937.png" alt="image-20210327164914937" style="zoom:150%;"></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>  <span class="token comment"># Spark-standalone模式提交任务-cluster</span>
  bin/spark-submit <span class="token punctuation">\</span>
  <span class="token parameter variable">--master</span> spark://node1:7077 <span class="token punctuation">\</span>
  --deploy-mode cluster <span class="token punctuation">\</span>
  <span class="token parameter variable">--class</span> org.apache.spark.examples.SparkPi <span class="token punctuation">\</span>
  /export/server/spark-2.4.5-bin-hadoop2.7/examples/jars/spark-examples_2.11-2.4.5.jar <span class="token punctuation">\</span>
  <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><p><img src="./assets/img/image-20210327165656647.15576278.png" alt="image-20210327165656647"></p></li> <li><p><img src="./assets/img/image-20210327165819301.59e495e8.png" alt="image-20210327165819301"></p></li> <li><p><img src="./assets/img/image-20210327165853693.46cde17a.png" alt="image-20210327165853693"></p></li> <li><p><img src="./assets/img/image-20210327165907321.f683f926.png" alt="image-20210327165907321"></p></li> <li><p>总结：</p> <ul><li>本质：driver启动在哪里，如果启动在client端客户端直接看到结果，否则需要worker节点日志查看</li></ul></li></ul> <h4 id="spark的onyarn原理详解"><a href="#spark的onyarn原理详解" class="header-anchor">#</a> Spark的OnYarn原理详解</h4> <ul><li><h5 id="client"><a href="#client" class="header-anchor">#</a> Client</h5></li></ul> <ul><li><p>1-首先Driver启动在Client端的</p></li> <li><p>2-向ResourceManager申请启动AppMaster</p></li> <li><p>3-由AppMaster向ResourceManager申请资源</p></li> <li><p>4-由ResourceManager(返回资源列表到AppMaster在)指定NodeManager启动Executor进程</p></li> <li><p>5-Executor就是资源反向注册到Driver端</p></li> <li><p>6-Driver端继续执行计算任务-----DAGScheduler和TaskScheduler</p></li> <li><p>注意：执行到****Action算子时，触发一个Job，并根据宽依赖开始划分Stage，每个Stage生成对应的TaskSet，之后将Task分发到各个Executor上执行****。</p></li> <li><p><img src="./assets/img/image-20210327173511877.1b622182.png" alt="image-20210327173511877"></p></li> <li><p>命令</p></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>  bin/spark-submit <span class="token punctuation">\</span>
  <span class="token parameter variable">--master</span> <span class="token function">yarn</span> <span class="token punctuation">\</span>
  --deploy-mode client <span class="token punctuation">\</span>
  <span class="token parameter variable">--class</span> org.apache.spark.examples.SparkPi <span class="token punctuation">\</span>
  /export/server/spark/examples/jars/spark-examples_2.11-2.4.5.jar <span class="token punctuation">\</span>
  <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><img src="./assets/img/image-20210327175342898.d3bc170a.png" alt="image-20210327175342898"></li></ul> <ul><li>Cluster原理</li></ul> <ul><li><p><img src="./assets/img/image-20210327173910704.2d14e2d1.png" alt="image-20210327173910704"></p></li> <li><p><img src="./assets/img/image-20210327174352261.668c26a1.png" alt="image-20210327174352261"></p></li> <li><p><img src="./assets/img/image-20210327175118488.c6ddf7db.png" alt="image-20210327175118488"></p></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>  bin/spark-submit <span class="token punctuation">\</span>
  <span class="token parameter variable">--master</span> <span class="token function">yarn</span> <span class="token punctuation">\</span>
  --deploy-mode cluster <span class="token punctuation">\</span>
  <span class="token parameter variable">--class</span> org.apache.spark.examples.SparkPi <span class="token punctuation">\</span>
  /export/server/spark/examples/jars/spark-examples_2.11-2.4.5.jar <span class="token punctuation">\</span>
  <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><p>如何查询结果（conf 底下的log4j.properties.tmplete需复制一份log4j.properties,否则看不到stdout的东西）：</p></li> <li><p><img src="./assets/img/image-20210327175614690.4e4ea4d4.png" alt="image-20210327175614690"></p></li> <li><p><img src="./assets/img/image-20210327175655139.85edd940.png" alt="image-20210327175655139"></p></li> <li><p><img src="./assets/img/image-20210327175714557.90c6e8bd.png" alt="image-20210327175714557"></p></li> <li><p>查看Container容器和Executor的关系</p></li> <li><p>答案：Executor是运行在Continer里面</p></li> <li><p>Executor是进程，Task是线程，最终执行计算的是一个线程执行一个分区的Task任务</p></li> <li><p><img src="./assets/img/image-20210327175929005.9aa44132.png" alt="image-20210327175929005"></p></li> <li><p><img src="./assets/img/image-20210327180106135.c42241aa.png" alt="image-20210327180106135"></p></li></ul> <h4 id="spark的idea编程指南"><a href="#spark的idea编程指南" class="header-anchor">#</a> Spark的IDEA编程指南</h4> <h5 id="创建项目"><a href="#创建项目" class="header-anchor">#</a> 创建项目</h5> <ul><li><p>步骤：</p></li> <li><p>1-首先明确项目名称和包名</p> <ul><li>bigdata-spark_2.11</li> <li>spark-chapter01_2.11</li> <li><img src="spark.assets/image-20210327150541284.png" alt="image-20210327150541284" style="zoom:150%;"></li></ul></li> <li><p>2-加载pom文件，记得修改本地maven库一直使用的库</p></li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoding</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scala.version</span><span class="token punctuation">&gt;</span></span>2.11.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scala.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scala.binary.version</span><span class="token punctuation">&gt;</span></span>2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scala.binary.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spark.version</span><span class="token punctuation">&gt;</span></span>2.4.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spark.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hadoop.version</span><span class="token punctuation">&gt;</span></span>2.7.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hadoop.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.scala-lang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>scala-library<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${scala.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-core_${scala.binary.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${hadoop.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.38<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.47<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 后续使用 --&gt;</span>
        <span class="token comment">&lt;!--SparkSQL+ Hive依赖--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-hive_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-hive-thriftserver_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- spark-streaming--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-streaming_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- SparkMlLib机器学习模块,里面有ALS推荐算法--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-mllib_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--spark-streaming+Kafka依赖--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-streaming-kafka-0-10_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--StructuredStreaming+Kafka依赖--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-sql-kafka-0-10_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.hankcs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hanlp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>portable-1.7.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Redis客户端工具--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>outputDirectory</span><span class="token punctuation">&gt;</span></span>target/classes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>outputDirectory</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>testOutputDirectory</span><span class="token punctuation">&gt;</span></span>target/test-classes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>testOutputDirectory</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resource</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">&gt;</span></span>${project.basedir}/src/main/resources<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resource</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Maven 编译的插件 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 指定编译java的插件 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoding</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- 指定编译scala的插件 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.alchim31.maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>scala-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>testCompile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br></div></div><h5 id="scala编程指南-掌握"><a href="#scala编程指南-掌握" class="header-anchor">#</a> Scala编程指南[掌握]</h5> <ul><li><p>3-构建基础Scala的WordCount版本</p></li> <li><p>需求：使用IDEA实现wordcount案例</p></li> <li><p>步骤：</p> <ul><li>1-首先创建SparkContent上下文环境</li> <li>2-从外部文件数据源读取数据</li> <li>3-执行flatmap执行扁平化操作</li> <li>4-执行map转化操作，(word,1)</li> <li>5-reduceByKey(预聚合)</li> <li>6-输出到文件系统或打印即可</li></ul></li> <li><p>结果：</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase</span>
  
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>
  
  <span class="token comment">/**
   * DESC:
   * 1-首先创建SparkContent上下文环境
   * 2-从外部文件数据源读取数据
   * 3-执行flatmap执行扁平化操作
   * 4-执行map转化操作，(word,1)
   * 5-reduceByKey(预聚合)
   * 6-输出到文件系统或打印即可
   */</span>
  <span class="token keyword">object</span> _01SparkWordCount <span class="token punctuation">{</span>
    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">//* 1-首先创建SparkContext上下文环境</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;_01SparkWordCount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      <span class="token comment">//sc.setLogLevel(&quot;WARN&quot;)</span>
      <span class="token comment">//* 2-从外部文件数据源读取数据</span>
      <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/words.txt&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//println(s&quot;count value is:${fileRDD.count()}&quot;)//count value is:2</span>
      <span class="token comment">//* 3-执行flatmap执行扁平化操作</span>
      <span class="token keyword">val</span> valueRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> fileRDD<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//* 4-执行map转化操作，(word,1)</span>
      <span class="token keyword">val</span> mapRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> valueRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//* 5-reduceByKey(预聚合)</span>
      <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapRDD<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">)</span>
      <span class="token comment">//* 6-输出到文件系统或打印即可</span>
      resultRDD<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>println<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//这里是直接使用foreach对RDD进行打印</span>
      println<span class="token punctuation">(</span><span class="token string">&quot;=============================&quot;</span><span class="token punctuation">)</span>
      resultRDD<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//能否转换为集合在打印</span>
      println<span class="token punctuation">(</span><span class="token string">&quot;=============================&quot;</span><span class="token punctuation">)</span>
      resultRDD<span class="token punctuation">.</span>saveAsTextFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseoutput/output-1&quot;</span><span class="token punctuation">)</span>
      sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>Java编程指南[了解]</p> <ul><li><p>4-构建基础Java的WordCount版本[了解]</p> <ul><li><p>1-需求：使用Java语言完成Wordcount代码</p></li> <li><p>2-步骤：</p> <ul><li>1-首先创建SparkContent上下文环境</li> <li>2-从外部文件数据源读取数据</li> <li>3-执行flatmap执行扁平化操作</li> <li>4-执行map转化操作，(word,1)</li> <li>5-reduceByKey(预聚合)</li> <li>6-输出到文件系统或打印即可</li></ul></li> <li><p>3-结果或代码</p></li></ul></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase</span><span class="token punctuation">;</span>
    
    <span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token class-name">SparkConf</span></span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">JavaPairRDD</span></span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">JavaRDD</span></span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">JavaSparkContext</span></span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> <span class="token import"><span class="token namespace">scala<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span></span><span class="token punctuation">;</span>
    
    <span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * DESCRIPTION:
     * 1-首先创建SparkContent上下文环境
     * 2-从外部文件数据源读取数据
     * 3-执行flatmap执行扁平化操作
     * 4-执行map转化操作，(word,1)
     * 5-reduceByKey(预聚合)
     * 6-输出到文件系统或打印即可
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> _01SparkFirst <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//1-首先创建SparkContent上下文环境</span>
            <span class="token class-name">SparkConf</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparkConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span><span class="token string">&quot;_01SparkFirst&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMaster</span><span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">JavaSparkContext</span> jsc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavaSparkContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2-从外部文件数据源读取数据</span>
            <span class="token class-name">JavaRDD</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fileRDD <span class="token operator">=</span> jsc<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3-执行flatmap执行扁平化操作(学习看源码)</span>
            <span class="token class-name">JavaRDD</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> flatMapRDD <span class="token operator">=</span> fileRDD<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>x <span class="token operator">-&gt;</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4-执行map转化操作，(word,1)(学习看源码)</span>
            <span class="token class-name">JavaPairRDD</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> mapRDD <span class="token operator">=</span> flatMapRDD<span class="token punctuation">.</span><span class="token function">mapToPair</span><span class="token punctuation">(</span>x <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//5-reduceByKey(预聚合)</span>
            <span class="token class-name">JavaPairRDD</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> resultRDD <span class="token operator">=</span> mapRDD<span class="token punctuation">.</span><span class="token function">reduceByKey</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//6-输出到文件系统或打印即可</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> collectResult <span class="token operator">=</span> resultRDD<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            collectResult<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//关闭连接</span>
            jsc<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><ul><li><p>总结1：</p> <ul><li>setAppName撰写this.getClass.getSimpleName.stripSuffix(&quot;$&quot;)方式</li></ul></li> <li><p>总结2：</p></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>    //这里设置线程休眠为了能够看到WebUI的展示的DAG等监控界面
    Thread.sleep(100*1000)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><p><img src="./assets/img/image-20210327155412197.6445428c.png" alt="image-20210327155412197"></p></li> <li><p>总结3：</p> <ul><li>Spark划分为两大角色：Driver和Executor</li> <li><img src="./assets/img/image-20210327160052790.4e10dbfd.png" alt="image-20210327160052790"></li> <li>Driver是负责应用管理者，申请资源和执行dag的计算</li> <li>Executor利用线程执行对应分区的计算，一个task需要一个线程执行</li> <li><img src="./assets/img/image-20210327160453052.2f0ff3c4.png" alt="image-20210327160453052"></li> <li>传统意义上的几核几线程，实质上指的是PC机器的线程数，比如我的机器6和12线程，线程个数最多可以使用12个</li> <li><img src="spark.assets/image-20210327160757406.png" alt="image-20210327160757406" style="zoom:150%;"></li> <li>Job和DAG的关系</li> <li><img src="./assets/img/image-20210327160950818.d59c314f.png" alt="image-20210327160950818"></li> <li>代码中那些事在Driver端进行的，那些事Executor端进行的</li> <li><img src="./assets/img/image-20210327161207745.27c80390.png" alt="image-20210327161207745"></li> <li><img src="./assets/img/image-20210327161215209.986e96d6.png" alt="image-20210327161215209"></li></ul></li></ul> <h5 id="打包上传后提交任务"><a href="#打包上传后提交任务" class="header-anchor">#</a> 打包上传后提交任务</h5> <ul><li><p>后续再讲解打包上传</p></li> <li><p>需求：需要实现代码并提交到集群上运行</p></li> <li><p>步骤；</p> <ul><li><p>1-首先pom实现package打包</p> <ul><li>直接package</li></ul></li> <li><p>2-上传虚拟机中</p> <ul><li>直接拖拽</li></ul></li> <li><p>3-执行任务</p></li></ul></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>    <span class="token comment"># 自己实现的代码放在集群上跑任务，尝试使用Spark Yarn-client模式</span>
    bin/spark-submit <span class="token punctuation">\</span>
    <span class="token parameter variable">--master</span> <span class="token function">yarn</span> <span class="token punctuation">\</span>
    --deploy-mode client <span class="token punctuation">\</span>
    <span class="token parameter variable">--class</span> cn.itcast.sparkbase._01SparkWordCountTar <span class="token punctuation">\</span>
    /export/data/spark-base_2.11-1.0.0.jar <span class="token punctuation">\</span>
    hdfs://node1.itcast.cn:8020/wordcount/input <span class="token punctuation">\</span>
    hdfs://node1.itcast.cn:8020/wordcount/output-8
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li><p>查看结果</p></li> <li><p><img src="./assets/img/image-20210327181358437.d49c1dc4.png" alt="image-20210327181358437"></p></li> <li><p>该任务需要掌握</p></li></ul> <h5 id="sparksubmit提交任务的参数"><a href="#sparksubmit提交任务的参数" class="header-anchor">#</a> SparkSubmit提交任务的参数</h5> <ul><li>下面的重点掌握</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>  YARN：
  <span class="token parameter variable">--master</span> MASTER_URL集群资源管理器   spark://host:port,host1:port, mesos://host:port, <span class="token function">yarn</span>
                              k8s://https://host:port, or <span class="token builtin class-name">local</span> <span class="token punctuation">(</span>Default: local<span class="token punctuation">[</span>*<span class="token punctuation">]</span><span class="token punctuation">)</span>.
  --deploy-mode DEPLOY_MODE   Whether to launch the driver program locally <span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span> or
                              on one of the worker machines inside the cluster <span class="token punctuation">(</span><span class="token string">&quot;cluster&quot;</span><span class="token punctuation">)</span>
                              <span class="token punctuation">(</span>Default: client<span class="token punctuation">)</span>.
  <span class="token parameter variable">--class</span> CLASS_NAME          Your application's main class <span class="token punctuation">(</span>for Java / Scala apps<span class="token punctuation">)</span>.
  <span class="token parameter variable">--jars</span> JARS                 Comma-separated list of jars to include on the driverand executor classpaths.
  <span class="token parameter variable">--conf</span> <span class="token assign-left variable">PROP</span><span class="token operator">=</span>VALUE           Arbitrary Spark configuration property.
  <span class="token comment"># 关键部分，Driver端和Executor端的配置</span>
  <span class="token comment"># Driver申请资源执行计算任务</span>
  --driver-memory MEM         Driver端的内存默认1G Memory <span class="token keyword">for</span> driver <span class="token punctuation">(</span>e.g. 1000M, 2G<span class="token punctuation">)</span> <span class="token punctuation">(</span>Default: 1024M<span class="token punctuation">)</span>.
  --driver-cores NUM          Number of cores used by the driver, only <span class="token keyword">in</span> cluster mode<span class="token punctuation">(</span>Default: <span class="token number">1</span><span class="token punctuation">)</span>.
                              这里注意，为什么local不需要使用driver-cores，因为使用local<span class="token punctuation">[</span>*<span class="token punctuation">]</span>模拟本机多线程
  <span class="token comment"># Executor是真正执行资源和计算任务的</span>
  --num-executors NUM         Number of executors to launch <span class="token punctuation">(</span>Default: <span class="token number">2</span><span class="token punctuation">)</span>.启动多少个executors，默认2个
                              If dynamic allocation is enabled, the initial number of
                              executors will be at least NUM.还可以动态开启
  --executor-memory MEM       每个Executor的内存，默认1G  Memory per executor <span class="token punctuation">(</span>e.g. 1000M, 2G<span class="token punctuation">)</span> <span class="token punctuation">(</span>Default: 1G<span class="token punctuation">)</span>.
  --executor-cores NUM        每个executor有多少cores，yarn默认为1 
                          Number of cores per executor. <span class="token punctuation">(</span>Default: <span class="token number">1</span> <span class="token keyword">in</span> YARN mode,
                          or all available cores on the worker <span class="token keyword">in</span> standalone mode<span class="token punctuation">)</span>
  <span class="token parameter variable">--queue</span> QUEUE_NAME          The YARN queue to submit to <span class="token punctuation">(</span>Default: <span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span>.
  
  如果有一个需求的数据量，需要满足Executor端的内存一定超越给定的数据量，
  cpu-cores越多越好<span class="token punctuation">(</span>cpu-cores模拟的线程，每个线程执行1个分区的数据，如果业务数据分区越多，开启cpucores越多<span class="token punctuation">)</span>
  bin/spark-submit <span class="token punctuation">\</span>
  <span class="token parameter variable">--master</span> <span class="token function">yarn</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--deploy_mode</span> cluster <span class="token punctuation">\</span>
  --driver-memory 2g <span class="token punctuation">\</span> 
  --driver-cores <span class="token number">2</span> <span class="token punctuation">\</span>
  --num-executors <span class="token number">10</span> <span class="token punctuation">\</span>
  --executor-memory 2g <span class="token punctuation">\</span>
  --executor-cores <span class="token number">3</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--class</span> cn.itcast.apple.mainclass <span class="token punctuation">\</span>
  jar包路径 <span class="token punctuation">\</span>
  程序需要参数
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><ul><li><img src="spark.assets/image-20210327183419885.png" alt="image-20210327183419885" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210327183443992.png" alt="image-20210327183443992" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210327183528338.png" style="zoom:150%;"></li></ul> <h5 id="idea直接读取hdfs文件"><a href="#idea直接读取hdfs文件" class="header-anchor">#</a> IDEA直接读取HDFS文件</h5> <ul><li><p>需求：在IDEA中直接读取HDFS文件，如何实现</p></li> <li><p>步骤：</p> <ul><li>1-远程连接Hadoop集群</li> <li>2-直接拷贝core-site.xml和hdfs-site.xml配置文件(为了使用相对路径)</li> <li>3-拷贝到对应module模块的resource目录下</li> <li>4-直接写相对路径即可读取</li></ul></li> <li><p>操作连接服务器的步骤</p></li> <li><p><img src="./assets/img/image-20210329100755508.8b37fc8b.png" alt="image-20210329100755508"></p></li> <li><p><img src="./assets/img/image-20210329100814540.210202d0.png" alt="image-20210329100814540"></p></li> <li><p><img src="./assets/img/image-20210329100956361.167b52c2.png" alt="image-20210329100956361"></p></li> <li><p><img src="./assets/img/image-20210329101111673.79734526.png" alt="image-20210329101111673"></p></li> <li><p>用groupbykey的方法实现wordcount案例</p></li> <li><p><img src="./assets/img/image-20210329102340493.5aa26e47.png" alt="image-20210329102340493"></p></li> <li><p>排序的操作，这里截图使用的是top方法</p></li> <li><p><img src="./assets/img/image-20210329103236824.a21d1928.png" alt="image-20210329103236824"></p></li> <li><p>所有代码</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase</span>
  
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>
  
  <span class="token comment">/**
   * DESC:
   * 1-首先需要创建SparkContext，引入SparkConf
   * 2-读取外部数据文件到RDD
   * 3-RDD的转换
   * 4-将结果数据保存在HDFS中
   */</span>
  <span class="token keyword">object</span> _01SparkWordCount <span class="token punctuation">{</span>
    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">//1-首先需要创建SparkContext，引入SparkConf</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      sc<span class="token punctuation">.</span>setLogLevel<span class="token punctuation">(</span><span class="token string">&quot;WARN&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//2-读取外部数据文件到RDD</span>
      <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;hdfs://node1:8020/wordcount/input/&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//fileRDD.foreach(println(_))</span>
      <span class="token comment">//3-RDD的转换</span>
      <span class="token keyword">val</span> flatMapRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> fileRDD
        <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>line <span class="token keyword">=&gt;</span> line <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">.</span>trim<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> flatMapRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>_1<span class="token punctuation">,</span>x<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>sum<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token comment">//将结果数据收集到Driver端-all the data is loaded into the driver's memory.</span>
      <span class="token keyword">val</span> resultArray<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> resultRDD<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>
      println<span class="token punctuation">(</span>resultArray<span class="token punctuation">.</span>toBuffer<span class="token punctuation">)</span> <span class="token comment">//打印方法</span>
      <span class="token comment">//Buffer((hello,4), (me,3), (you,2), (her,1))</span>
      <span class="token comment">//4-排序操作,因为take是action算子，如果返回值是rdd的化验证操作是Transformation操作</span>
      println<span class="token punctuation">(</span><span class="token string">&quot;sotyby oprations is:================&quot;</span><span class="token punctuation">)</span>
      resultRDD<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
      println<span class="token punctuation">(</span><span class="token string">&quot;sotybykey oprations is:================&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//Take the first num elements of the RDD.</span>
      resultRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>swap<span class="token punctuation">)</span><span class="token punctuation">.</span>sortByKey<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
      println<span class="token punctuation">(</span><span class="token string">&quot;top oprations is:================&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//Returns the top k (largest) elements from this RDD</span>
      resultRDD<span class="token punctuation">.</span>top<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span>Ordering<span class="token punctuation">.</span>by<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>x<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//4-将结果数据保存在HDFS中</span>
      <span class="token comment">//flatMapRDD.foreach(println(_))</span>
      sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h2 id="sparkcore-rdd"><a href="#sparkcore-rdd" class="header-anchor">#</a> SparkCore--RDD</h2> <p>重难点知识</p> <ul><li><p>使用IDEA完成HDFS文件读取</p></li> <li><p>RDD的引入</p></li> <li><p>RDD的特性--面试必问[重点]</p></li> <li><p>RDD的创建</p></li> <li><p>RDD的转换算子</p></li> <li><p>RDD的行动算子</p></li> <li><p>RDD的案例实战[重点]</p></li></ul> <h3 id="rdd是什么"><a href="#rdd是什么" class="header-anchor">#</a> RDD是什么</h3> <p>RDD*(Resilient Distributed Dataset)*是弹性分布式数据集，是<strong>不可变，可分区，可并行计算</strong>的集合。</p> <ul><li><p>什么是弹性：数据可以存储在磁盘也可以存储在内存中</p></li> <li><p>什么是分布式：分布式计算和分布式存储</p></li> <li><p>什么是数据集：数据构成的集合</p></li> <li><p>不可变：RDD一旦创建就不能改变，不能转换</p></li> <li><p>可分区：RDD是可以划分为不同分区partition</p></li> <li><p>可并行计算的集合：基于内存的可并行计算集合</p></li> <li><img src="spark.assets/image-20210329104805381.png" alt="image-20210329104805381" style="zoom:150%;"></li> <li><p>源码分析</p></li> <li><p><img src="./assets/img/image-20210329105132237.8e400960.png" alt="image-20210329105132237"></p></li> <li><p><img src="./assets/img/image-20210329105322406.a1cc8fb7.png" alt="image-20210329105322406"></p></li> <li><p><img src="./assets/img/image-20210329105804738.a1ea0334.png" alt="image-20210329105804738"></p></li></ul> <h3 id="rdd的五大属性"><a href="#rdd的五大属性" class="header-anchor">#</a> RDD的五大属性</h3> <ul><li>1-分区列表，每一个RDD都是不同分区构成的</li> <li>2-计算函数：每个RDD的分区都有计算函数作用</li> <li>3-依赖关系：每个RDD有一定依赖关系</li> <li>4-可选分区器：也就是RDD有分区器，默认是Hash-Partitioner</li> <li>5-可选位置优先性：移动计算不要移动存储</li> <li><img src="spark.assets/image-20210329114735118.png" alt="image-20210329114735118" style="zoom:150%;"></li> <li>稍后以WordCount案例梳理五大属性</li> <li>1-如何查看分区个数</li> <li><img src="./assets/img/image-20210329114358375.cd975dac.png" alt="image-20210329114358375"></li> <li>2-如何查看分区器</li> <li><img src="./assets/img/image-20210329114611523.6610b29f.png" alt="image-20210329114611523"></li> <li><img src="./assets/img/image-20210329114647245.b903c0a2.png" alt="image-20210329114647245"></li> <li>补充图示</li> <li><img src="./assets/img/image-20210329114846354.c774a94c.png" alt="image-20210329114846354"></li></ul> <p><strong>RDD创建的方法</strong></p> <ul><li><p>三种方法的创建</p></li> <li><p><img src="./assets/img/image-20210329115334221.23c112ad.png" alt="image-20210329115334221"></p></li> <li><p>增加分区的理解</p></li> <li><p><img src="./assets/img/image-20210329115712928.4a8b9be5.png" alt="image-20210329115712928"></p></li> <li><p><img src="./assets/img/image-20210329120459797.e1f2818b.png" alt="image-20210329120459797"></p></li> <li><p>IDEA中查看</p></li> <li><p><img src="./assets/img/image-20210329120813069.d89597c0.png" alt="image-20210329120813069"></p></li> <li><p><img src="./assets/img/image-20210329121120383.d02d7970.png" alt="image-20210329121120383"></p></li> <li><p>点击源码查看的过程，得到结论是makerdd或parallise都是根据totalcpucores和2比较最大值</p></li> <li><p>如果直接覆盖makerdd或parallise的第二个分区个数的参数，改变该取值</p></li> <li><p><img src="./assets/img/image-20210329121141838.bcc08cbb.png" alt="image-20210329121141838"></p></li> <li><p><img src="./assets/img/image-20210329121155114.48762324.png" alt="image-20210329121155114"></p></li> <li><p><img src="./assets/img/image-20210329121233674.757bd4b4.png" alt="image-20210329121233674"></p></li> <li><p><img src="./assets/img/image-20210329121305638.13231975.png" alt="image-20210329121305638"></p></li> <li><p><img src="./assets/img/image-20210329121325894.8a6e3acc.png" alt="image-20210329121325894"></p></li> <li><p>思考：spark.default.parallelism啥东西</p></li> <li><p><img src="./assets/img/image-20210329121553014.4245fc3b.png" alt="image-20210329121553014"></p></li> <li><p><img src="./assets/img/image-20210329121821898.416557d1.png" alt="image-20210329121821898"></p></li> <li><p>如何在代码中设置上述参数</p></li> <li><p><img src="./assets/img/image-20210329122144187.bd9d1f07.png" alt="image-20210329122144187"></p></li> <li><p>查看textFile如何控制并行度？</p></li> <li><p><img src="./assets/img/image-20210329144455731.1592e0b2.png" alt="image-20210329144455731"></p></li> <li><p><img src="./assets/img/image-20210329144553963.b0d47d62.png" alt="image-20210329144553963"></p></li> <li><p><img src="./assets/img/image-20210329144700382.8b88fec2.png" alt="image-20210329144700382"></p></li> <li><p>如何使用Spark的rdd读取很多小文件？</p></li> <li><p>1-数据集含义：userid-moviesid-rating-timestamp，一个用户在什么时间给什么电影评分</p></li> <li><p><img src="./assets/img/image-20210329145620263.7dbd59f5.png" alt="image-20210329145620263"></p></li> <li><p>2-sc.textFile遇到小文件没有办法很好合并小文件的，即便重写第二个参数也没有作用</p></li> <li><p>Spark中提供了小文件的处理方案sc.wholetextFile的方式，不会根据文件多少得到多少分区</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase<span class="token punctuation">.</span>rddopration</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">object</span> _02SparkRDDFirst <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-准备环境</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">&quot;spark.default.parallelism&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
    <span class="token comment">//2-准备读取外部文件系统</span>
    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/words.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//sc.parallelize(1 to 10)</span>
    <span class="token comment">//3-查看分区个数</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;partitons length:&quot;</span> <span class="token operator">+</span> fileRDD<span class="token punctuation">.</span>getNumPartitions<span class="token punctuation">)</span> <span class="token comment">//2</span>
    println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">&quot;partiiton length is:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">fileRDD<span class="token punctuation">.</span>partitions<span class="token punctuation">.</span>length</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span> <span class="token comment">//2</span>
    <span class="token comment">//读取一个文件夹下的多个文件</span>
    <span class="token comment">//textFile在读取小文件的时候，会参考小文件的个数，文件个数越多，分区个数越多</span>
    <span class="token keyword">val</span> filesRDD1<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/ratings100/&quot;</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;partitons length:&quot;</span> <span class="token operator">+</span> filesRDD1<span class="token punctuation">.</span>getNumPartitions<span class="token punctuation">)</span> <span class="token comment">//100</span>
    <span class="token comment">//Spark读取小文件的方法</span>
    <span class="token keyword">val</span> filesRDD2<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>wholeTextFiles<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/ratings100/&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//println(&quot;partitons length:&quot; + filesRDD2.getNumPartitions) //2</span>
    filesRDD2<span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//23106,5214,3.0,1043445719</span>

    sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><ul><li><p>补充案例</p></li> <li><p><img src="./assets/img/image-20210329150938698.72630ce5.png" alt="image-20210329150938698"></p></li> <li><p><img src="./assets/img/image-20210329151026005.70348a33.png" alt="image-20210329151026005"></p></li></ul> <ul><li><strong>用textFile时，它的partition的数量是与文件夹下的文件数量（实例中用3个xxx.log文件）相关，一个文件就是一个partition(既然3个文件就是：partition=3)，文件大小均匀的情况下，可以这么估算，具体按照hadoop的文件切片规则（goalsize-&gt;splitsize-&gt;1.1split每个大文件会进行切片）。</strong></li></ul> <ul><li>textFile分片源码</li></ul> <p><img src="./assets/img/image-20210401101124646.9808f84e.png" alt="image-20210401101124646"></p> <p><img src="./assets/img/image-20210401125812303.ad66b7c3.png" alt="image-20210401125812303"></p> <ul><li><p><strong>wholeTextFiles通常用于读取许多小文件的需求，切片时会进行小文件的合并（maxSplitSize-&gt;累计切片）。</strong></p></li> <li><p>wholeTextFile分片源码https://blog.csdn.net/m0_37817767/article/details/125779863</p> <p><img src="./assets/img/image-20230223212451175.7229ef1d.png" alt="image-20230223212451175"></p></li></ul> <p>spark wholeTextFile合并小文件的过程较为简单，mapreduce的CombineTextInputFormat合并过程较为复杂。</p> <p>https://blog.csdn.net/qq_35241080/article/details/106065442</p> <p><img src="./assets/img/image-20230223212739929.cdef2bc1.png" alt="image-20230223212739929"></p> <h3 id="rdd的算子分类"><a href="#rdd的算子分类" class="header-anchor">#</a> RDD的算子分类</h3> <ul><li>Transmormation转化算子</li> <li>Action行动算子，使用action算子不会返回rdd，且会将结果返回给driver端。</li></ul> <h5 id="rdd的transformation算子"><a href="#rdd的transformation算子" class="header-anchor">#</a> RDD的Transformation算子</h5> <ul><li><p>第一种：RDD的单Value类型RDD</p></li> <li><p>第二种：RDD的双Value的RDD</p></li> <li><p>第三种：RDD的Key和value类型的RDD</p></li></ul> <p><strong>RDD单Value类型算子</strong></p> <p>map算子</p> <ul><li>1-含义：经过fun的操作得到新的RDD</li> <li>2-操作</li> <li><img src="./assets/img/image-20210329153047465.3a1294ee.png" alt="image-20210329153047465"></li></ul> <p>filter算子</p> <ul><li>1-含义：经过fun的操作得到新的RDD，元素需要满足条件</li> <li>2-操作</li> <li><img src="./assets/img/image-20210329153254866.1a196bfb.png" alt="image-20210329153254866"></li></ul> <p>flatMap算子</p> <ul><li>1-含义：扁平化</li> <li>2-操作</li> <li><img src="./assets/img/image-20210329153446260.b30e0a0f.png" alt="image-20210329153446260"></li></ul> <p>mapPartitions算子</p> <ul><li>1-含义</li> <li><img src="./assets/img/image-20210329153707322.15fec39b.png" alt="image-20210329153707322"></li> <li>2-操作</li></ul> <p>mapParittionWithIndex算子</p> <ul><li>1-含义</li> <li><img src="./assets/img/image-20210329153736589.91818514.png" alt="image-20210329153736589"></li> <li>2-操作</li></ul> <p>sample算子</p> <ul><li>1-含义</li> <li><img src="./assets/img/image-20210329153839101.1bbeeaa5.png" alt="image-20210329153839101"></li> <li>seed：保证每次随机切分的数据的可重复性</li> <li>2-操作</li> <li><img src="./assets/img/image-20210329154153144.973c17d6.png" alt="image-20210329154153144"></li></ul> <p>glom算子</p> <ul><li>1-含义：查看每个分区的内容</li> <li>2-操作</li> <li><img src="./assets/img/image-20210329154322630.017d4213.png" alt="image-20210329154322630"></li></ul> <p>sortBy算子</p> <ul><li>1-含义：根据key或者value进行排序</li> <li>2-操作：</li> <li><img src="./assets/img/image-20210329154534322.f37c9a98.png" alt="image-20210329154534322"></li></ul> <p>coalese算子（合并）</p> <ul><li>如果缩减分区直接给定缩减到的数量，扩分区需要需要开启Shuffle为true</li> <li>1-含义</li> <li><img src="./assets/img/image-20210329160552847.8165843d.png" alt="image-20210329160552847"></li> <li>2-操作</li> <li><img src="./assets/img/image-20210329161053037.55abc59b.png" alt="image-20210329161053037"></li></ul> <p>repartition算子</p> <ul><li><p>1-含义：重分区，调用coalesce(numPartitions,shuffle=true),因此缩减分区尽量用coalesce。</p></li> <li><p>2-操作</p></li> <li><p><img src="./assets/img/image-20210329161337772.fb97469e.png" alt="image-20210329161337772"></p></li> <li><p>源码：</p></li> <li><p><img src="./assets/img/image-20210329161453997.6416c361.png" alt="image-20210329161453997"></p></li> <li><p><img src="./assets/img/image-20210329161611016.caf7d720.png" alt="image-20210329161611016"></p></li> <li><p><strong>repartitionAndSortWithinPartitions</strong>重分区的时候就排序,比分完区再排序高效</p></li></ul> <p><strong>RDD的双Value类型算子</strong></p> <p>集合的交集并集补集</p> <p>union并集</p> <p>intersection交集</p> <p>distinct去重</p> <p>subtract差集</p> <p><img src="./assets/img/image-20210329162256595.1b630925.png" alt="image-20210329162256595"></p> <p>zip拉链</p> <p>需要保持元素和分区个数一致</p> <p><img src="./assets/img/image-20210329162543660.92b5698f.png" alt="image-20210329162543660"></p> <p><img src="./assets/img/image-20210329162617585.de0e1ff0.png" alt="image-20210329162617585"></p> <p><strong>RDD的Key和Value的算子</strong></p> <p>partitionBy：</p> <ul><li>1-含义：</li> <li><img src="./assets/img/image-20210329163033895.956723e4.png" alt="image-20210329163033895"></li> <li>2-操作：</li> <li><img src="./assets/img/image-20210329163525679.6115e871.png" alt="image-20210329163525679"></li> <li><img src="./assets/img/image-20210329163812119.27da065c.png" alt="image-20210329163812119"></li> <li>****注意：Spark采用的分区有三种****：第一、水平分区，也就是sc.makerdd按照下标元素划分，第二、Hash划分根据数据确定性划分到某个分区，一般只给定分区数。第三、Range分区该方法一般按照元素大小进行划分不同区域，每个分区表示一个数据区域，如数组中每个数是[0,100]之间的随机数，Range划分首先将区域划分为10份，然后将数组中每个数字分发到不同的分区，比如将18分到(10,20]的分区，最后对每个分区进行排序。</li></ul> <p>reduceByKey</p> <ul><li>1-含义：在shuffle前进行预聚合，减少shuffle拉取的数据量</li> <li><img src="./assets/img/image-20210329164120195.3cf903a0.png" alt="image-20210329164120195"></li> <li>2-操作：</li> <li><img src="./assets/img/image-20210329164239002.b6d9c66c.png" alt="image-20210329164239002"></li></ul> <p>groupByKey</p> <ul><li><p>1-含义：</p></li> <li><p><img src="./assets/img/image-20210407204927753.6b9e7f17.png" alt="image-20210407204927753"></p></li> <li><p>2-操作：</p></li> <li><p><img src="./assets/img/image-20210329164600142.0b753d6e.png" alt="image-20210329164600142"></p></li> <li><p>了解区别</p></li> <li><ol><li>reduceByKey：按照key进行聚合，在shuffle之前有combine（预聚合）操作，返回结果是RDD[k,v].</li> <li>groupByKey：按照key进行分组，直接进行shuffle。</li> <li>开发指导：reduceByKey比groupByKey，建议使用。但是需要注意是否会影响业务逻辑。</li></ol></li> <li><p><strong>需求：使用GroupByKey的源码---使用底层源码实现GroupByKey</strong></p></li> <li><p><img src="./assets/img/image-20210329165407910.4d05b312.png" alt="image-20210329165407910"></p></li> <li><p><img src="./assets/img/image-20210329165624219.9eda71c0.png" alt="image-20210329165624219"></p></li> <li><p><img src="./assets/img/image-20210329170006705.db57525e.png" alt="image-20210329170006705"></p></li> <li><p><img src="./assets/img/image-20210329170137771.6bdc2f11.png" alt="image-20210329170137771"></p></li> <li><p><img src="./assets/img/image-20210329170509329.5c9676ff.png" alt="image-20210329170509329"></p></li> <li><p><img src="./assets/img/image-20210329171103876.13a022d4.png" alt="image-20210329171103876"></p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase<span class="token punctuation">.</span>base</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span><span class="token punctuation">{</span>RDD<span class="token punctuation">,</span> ShuffledRDD<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Aggregator<span class="token punctuation">,</span> SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable<span class="token punctuation">.</span></span>ArrayBuffer

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">object</span> _01groupByKeyOperation <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//* 1-首先创建SparkContext上下文环境</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
    <span class="token comment">//* 2创建数据，生成RDD</span>
    <span class="token keyword">val</span> filerdd<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">&quot;hello you&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello me hello she&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello spark&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> flatmapRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> filerdd<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> mapRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> flatmapRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//* 3使用groupBy完成分组</span>
    <span class="token keyword">val</span> groupRDD1<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapRDD<span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span>
    groupRDD1<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//(me,CompactBuffer(1))</span>
    <span class="token comment">//(spark,CompactBuffer(1))</span>
    <span class="token comment">//(you,CompactBuffer(1))</span>
    <span class="token comment">//(she,CompactBuffer(1))</span>
    <span class="token comment">//(hello,CompactBuffer(1, 1, 1, 1))</span>
    <span class="token comment">//CompactBuffer是spark模仿arraybuffer构建缓冲容器</span>
    <span class="token comment">//换一种方法模拟gropuByKey实现相同key的value的分组，使用源码的方法</span>
    <span class="token comment">//1-首先CompactBuffer存放分组的结果可以防止的ArrayBuffer</span>
    <span class="token comment">//val createCombiner = (v: V) =&gt; CompactBuffer(v)</span>
    <span class="token comment">//val mergeValue = (buf: CompactBuffer[V], v: V) =&gt; buf += v</span>
    <span class="token comment">//val mergeCombiners = (c1: CompactBuffer[V], c2: CompactBuffer[V]) =&gt; c1 ++= c2</span>
    <span class="token comment">/*
    key value 存放value的arraybuffer
     */</span>
    <span class="token keyword">val</span> createCombiner <span class="token operator">=</span> <span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> ArrayBuffer<span class="token punctuation">(</span>v<span class="token punctuation">)</span>
    <span class="token keyword">val</span> mergeValue <span class="token operator">=</span> <span class="token punctuation">(</span>buf<span class="token operator">:</span> ArrayBuffer<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> buf <span class="token operator">+=</span> v
    <span class="token keyword">val</span> mergeCombiners <span class="token operator">=</span> <span class="token punctuation">(</span>c1<span class="token operator">:</span> ArrayBuffer<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token operator">:</span> ArrayBuffer<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> c1 <span class="token operator">++</span><span class="token operator">=</span> c2
    <span class="token keyword">val</span> valueRDD<span class="token operator">:</span> ShuffledRDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> ArrayBuffer<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> ShuffledRDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> ArrayBuffer<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span>mapRDD<span class="token punctuation">,</span> <span class="token keyword">new</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>HashPartitioner<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setAggregator<span class="token punctuation">(</span><span class="token keyword">new</span> Aggregator<span class="token punctuation">(</span>
        createCombiner<span class="token punctuation">,</span>
        mergeValue<span class="token punctuation">,</span>
        mergeCombiners<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setMapSideCombine<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;source code create groupBykey&quot;</span><span class="token punctuation">)</span>
    valueRDD<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p><strong>reduceByKey、foldByKey、aggregateByKey、combineByKey 的区别？</strong></p> <p>这四个算子底层调用的都是同一个方法combineByKeyWithClassTag只不过他们的参数传值不同：</p> <p>reduceByKey: 相同 key 的第一个数据不进行任何计算，分区内和分区间计算规则相同<br>
FoldByKey: 相同 key 的第一个数据和初始值进行分区内计算，分区内和分区间计算规则相同<br>
AggregateByKey：相同 key 的第一个数据和初始值进行分区内计算，分区内和分区间计算规则可以不相同<br>
CombineByKey:当计算时，发现数据结构不满足要求时，可以让第一个数据转换结构。分区内和分区间计算规则可以不相同。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">CombineByKey</span>与combineByKeyWithClassTag是一样的，为了兼容所以保留着
<span class="token class-name">This</span> method is here <span class="token keyword">for</span> backward <span class="token class-name"><span class="token namespace">compatibility<span class="token punctuation">.</span></span> It</span> does not provide combiner classtag information <span class="token keyword">to</span> <span class="token namespace">the</span> shuffle<span class="token punctuation">.</span>
jvm的类型擦除问题，泛型<span class="token class-name">T</span>，<span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">U</span><span class="token punctuation">,</span><span class="token class-name">V</span>的类型信息<span class="token punctuation">,</span>类<span class="token class-name">Java</span>语言只能在编译的阶段获取到类型参数，一旦代码被送入<span class="token constant">JVM</span>运行，就会被擦除<span class="token punctuation">.</span>
 <span class="token number">1.</span>只要在定义泛型函数或泛型类的时候，在泛型标识后加上<span class="token operator">:</span><span class="token class-name">ClassTag</span>关键字，并且导入 <span class="token class-name"><span class="token namespace">scala<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>ClassTag</span> 包即可
<span class="token number">2.</span>或者使用<span class="token operator">:</span><span class="token class-name">Manifest</span>关键字，这个不需要导包
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>用法举例：<br>
FoldByKey（同一分区同一key与初始值计算一次，n个分区同一key与初始值计算n次）</p> <p><img src="./assets/img/image-20210329175439719.acc98a9b.png" alt="image-20210329175439719"></p> <p>aggreateByKey 不同分区的最大值相加</p> <p>为避免reduceByKey内存问题，可用aggregateByKey。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>To avoid memory allocation, both of these functions are allowed to modify and return their first argument instead of creating a new U.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20210329175221167.cfc706f9.png" alt="image-20210329175221167"></p> <p>combineByKey（可用来求平均值）</p> <ul><li><img src="./assets/img/image-20210329174316632.9f8bc7f7.png" alt="image-20210329174316632"></li></ul> <p>sortByKey</p> <p><strong>思考</strong>：sortBy是全局排序吗？是。<br>
rdd. sortBy(<code>_._2</code>,false). foreach(println) //虽然sortBy是全局排序，但由于不止一个分区，foreach输出的时候分区的先后顺序随机，又把全局排序后的数据打乱了。</p> <p>按照RangePartitioner shuffle会有倾斜的问题</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABR0AAABgCAYAAACQeNVSAAAXk0lEQVR4nO3dO27qWhvG8cefzhQQFDCCsEUKMwKQ0pARQEf6ELELMoJNEYTpk46MIDSRYARQJAoziAssBuGv4BIuxlxiiE3+v+ac7IXt9S7by/hl2cu4uLhwBQAAAAAAAAAB+d9PVwAAAAAAAADAeSHpCAAAAAAAACBQJB0BAAAAAAAABIqkIwAAAAAAAIBAkXQEAAAAAAAAECiSjgAAAAAAAAACRdIRAAAAAAAAQKBIOgIAAAAAAAAIFElHAAAAAAAAAIH6z+sfXbOsVunP/O9R90H1jk0ZZZRRFsoyAAAAAAAQLsbFxYX705UAAAAAAAAAcD54vBoAAAAAAABAoEg6AgAAAAAAAAgUSUcAAAAAAAAAgSLpCAAAAAAAACBQJB0BAAAAAAAABIqkIwAAAAAAAIBAkXQEAAAAAAAAECiSjgAAAAAAAAACRdIRAAAAAAAAQKBIOgIAAAAAAAAIFElHAAAAAAAAAIEi6QgAAAAAAAAgUCQdAQAAAAAAAATqoKSjmyyo1myqbLpB10dmefN6F8tc11S5WZbpbq7DMeu5DzdZUK1WUNKjrn5lAAAAAAAAQBR5Jh2ThZpqhWSgG3LdpAo1/wRgslBTUc96Ghh7lYWFa5ZlWZYsy1JzIZFo2B11xzlVb7Jry/iVAQAAAAAAAFH03yELGXZH9buOpOASgG6yoFJurOdKXzKMnctOXc9NkoWaqumhHm4fZc/quFDX/uOzMlZehWRfHXu5Pn5lAAAAAAAAQNTsnXQ0y02V/kwSYx/t26WRh26yoPtqTolpsm3UfVC9YytZqOlvPjH5UKklqyS57ki9xr95ki17lZN6DQ08kop+ZcreyCr9WdqeXz1nycHGv5d5ctAsN5V3Gqp37LUYVmP04rqmJlX8WucqwxjotZdX9SqrztNg5zIAAAAAAAAgavZOOg6e7tR3k7q+ryq+Upa9ymn8XFF9JUlnd+q6fZku060sJPEm/3VdU5m0o+Hrp1ZHJfqVSWkVM8+qVJ4mjzYXr2S+PGpgGBvr+fnS1TCX12XqRbY9W/9Q3cdPucrqphpXt1LRwDDkuqZurHsVRv/8RyCmEoo5Q71f3sv6O0muLiZA59t+G8qpZmS6/bUEql8ZAAAAAAAAECWBzl49chz9KbXULJsHLD3W6HPfsqGeH/uzjcvZYSuGMdD7MK70ZUqSlLrOKz18nyT6UgnFlFap1ZJlWWq1SkrvWv14Tnm1ValUdHvb1jhXUiG58v7Kz5HGiimR8ljerwwAAAAAAACIkIPe6biJ3amr0plMqNKySnI/2roL4ePC/dee8qVLJV+ky7TUa/clGVIirrjT08O/1cekdxh56PTUfvmUDGOa2Cwqk5Bkb10SAAAAAAAAOCuBjnScMQZPun3oyklnZM5mcDZsjcZSbONQPr9RfgGPAPx801BpXWYvldZQb7NRlP13DeM5XflMJD2boXppFu7PNw31tZybLCifduSMVhZOJRTbNGrTrwwAAAAAAACIkI0jHRP5v7LyX39/tG/12E/p+r6qfGI68m86KYxn2XSZxfcT9l97ylersvLG0kQys5GB+cuUOvby0EC/sk3c6bscver5NDBkGLZeumO1Snl9tG/noxoNY6DHRkL3VUtWafq+yVF3adIZjRyN3LTSmaw0GEyXs/XS7i0t99G+XXsPZOoyrfiw6/nORr8yAAAAAAAAIEqMi4sLd/vHjm8ya3Rc3crjWuLNr+zUJpPLFKXnytZZrdeXy8tprE9K41cGAAAAAAAARM1RHq8+hGF31O7FVLxZf7bZr+yUkoWaWq2SYr3GXglHScreFJUedj2Tin5lAAAAAAAAQNSEZqTjjFluKvPuPYrQryzMXLMsK/PuOamOXxkAAAAAAAAQRaFLOgIAAAAAAACIttA8Xg0AAAAAAADgPJB0BAAAAAAAABAoko4AAAAAAAAAAkXSEQAAAAAAAECgSDoCAAAAAAAACBRJRwAAAAAAAACBIukIAAAAAAAAIFAHJR3dZEG1ZlNl0w26PjLLm9frVRZ0XdxkQbVaQUk3+Ngk//iCcg4xHINfuxy7zQAAAAAAAH4Tz6RjslBTrZAMdEOum1Sh5p+sShZqKupZTwNjr7K96zJNVFqWpWazpkLyq06G3VF3nFP1Jvvt7awiht3tcrx4LndguxyzzQAAAAAAAH6bg0Y6GnZH9bu7QBNPbrKgUm6s58f+XmX71sV1k7ouxdWtVFSpVNToSbnS9dIIt/7js4bp/FLC6rv8Yth7XWcQwzF8t12O0WYAAAAAAAC/0X/7LmCWmyr9mST4Ptq3S8k+N1nQfTWnhDH5t1H3QfWOrWShpr/5xORDpZaskuS6I/Ua/9SxJ5/NXuWkXkMDYz15uKnMry6bGIatTv1Jmq7rczSWcnElJNnzzwz02surepVV52mwc9v42RTDapvtEkfYYpCW94Xrfui58qiBYWyMz3VN3VgZvS99Lq5u5VGj6/utx8sx2uUYbQYAAAAAAPAb7Z10HDzdqe8mdX1fVXylLHuV0/i5ovpK0szu1HX7Ml2mW1lIqs2SVKYyaUfD18/5v834lfnVZVepREwadtcSaZ9vQznVjEy375lk28emGFzX1E11MjJvYMwScfcqjPyTa2GKQZokHIt6VqWykKibJxLTGjYqqtuzvyfxvXxu3ta242VXh7RLkG0GAAAAAADwWwU6e/XIcfSn1FKzbB6w9FijjYkov7LDuWZZ1U2PC3+ONFZMiVRQW/OIIZVQTGmVWi1ZlqVWq6T0nmv96Rhmycje6/r2U5dpxYfdeQLVsDvqDuOKJ4Kqz2YHt0vgbQYAAAAAAPD77D3S0Y/dqavSmSR8WlZJ7kdbdyF9TDVZqE2SUtPHe39EIq6409PDvxfZS3XYrT6hiCGEaBcAAAAAAICfFehIxxlj8KTbh66cdEbmdBIPw7A1GkuxjUPI/EaXHTbyzDXLsixrbQbknZJSqYRiXiP7NqxzO48Y+u8axnO68pkwOfQxaCTHiSvnEcTn21DOwsQsbrKgfNqRM1pe32QCmNzSI/LbjpdjtMvWMgAAAAAAAOxk40jHRP6vrPzX3x/tWz32U7q+ryqfmCZzppN8eJZNl1lM/PRfe8pXq7LyxtLEIIYx0PuwqPxlSh3b1qJNZe70XY5edZm/A3DkaOSmlc5kpcFkxOVkBua4DCOhUqul0kJdFydwmT0avJa48ljnNptiMIyBHhsJ3VctWaXp+y1HXTUWRz6GPgZbL/8a0n1VljWpyXwiGbujf89xtf62lJfW9vlrL6+/07JRt6thfPnNnJuOl6O1y5YyAAAAAAAA7Ma4uLjYd7jbUSzOXuw9w7N3me86XVM3VlF6ruw0s/Xycnk5HrMlH7zOXxzDMRyvXbzLAAAAAAAAsLujPF59CMPuqN2LqXiz/piuX9kmyUJNrVZJsV5jr6SUJGVvikovTIASxDp/awzHcIx22VYGAAAAAACA3YVmpOOMWW4q8+49es2vLCiuWZaVeT/aBDjE8HP82uXYbQYAAAAAAPCbhC7pCAAAAAAAACDaQvN4NQAAAAAAAIDzQNIRAAAAAAAAQKBIOgIAAAAAAAAIFElHAAAAAAAAAIEi6QgAAAAAAAAgUCQdAQAAAAAAAASKpCMAAAAAAACAQB2UdHSTBdWaTZVNN+j6yCxvXq9fWZi5yYJqtYKS7nHqHtV28XMObUYM2xHD97iuqXKzLPNIsXlu8wfa03WTKtSasixLlmWpVkh+axvnEMOhzuF8IIbtiGE3xLDdPv2ZWf76N6+4971/mG0n6DY8ZZt95zrt157b2jponCvbEcNuiGE7YthNlK5/QfOL/djtcgjPpGOyUAv8hmiXLw7JQk1FPetpYOxVFqRDv+AsHoCryxp2R91xTtWbbJBVlbR/uxzjC9y5tJlrluedRXPHEzVsMRyCGA53qn7p1ELXntkr5dTTw+2tKpWK6h1767rOIYZDhS72AxDD4bZ9l9rnC3EYY9gXMRxu3/5s8HSn29sHdUc/f6MTujY7gF97HqOtw9RmfnXxE6YYDkUMh1uNYTVBZFmWmmUzUjEs1iXK99qzH50sy1KzWVMhGdHvISe8/h0a+zHb5VAHjXQ07I7qd3eB3mi7yYJKubGeH/t7lYWB65q6sUpSu7HxQOs/PmuYzu98gu203ZC3i5+wtVmyUJOVd+YdyF29I9vwP77DFsNB6yKGw7cb4fPPTxjbM5WISePR1nNyvq4ziOHgOoQw9r3XRQyHb9fvu5RZVjU91seOX4jDGMPe6yKGw7d7hP7sGPcPXsLYZmEXpjbbpS6e6wpRDAevixgO365PDB/tyf1dpVLR3dNg+7pCGMPe6wpRDK6b1HUpru50HzR6Uq50vXWAT5himInK9/ljtMt3/LfvAma5qdKfSSN/tG/XMtj31ZwS050w6j6o3rGVLNT0N5+YfKjUklWSXHekXuOfOvbks9mrnNRraOCxAzeVbdqeV9liXc1yUxmnp1huUu66H3quPGp0fb+1nl4MY6Cnu8HkhPL5zGsvr+pVVp0dOrtd7Nsu2/bD4r6Vfk+bua6pyT+/7NWBhC2GGyuj98qjBoYxPQbi6k7/jkIMkv95u0nYYth0Hs32kdOLKT89Zxb7LL/zb7V8dv7NL4XZG1mlP2vrjHp7LvVZKsmySvPYo3Jcb4vhkGtVVGI/lxhmcayef1GKwXVN3RRj6jXaUimt+A7rClMM2/rPKMSQLNRUTQ/V+Df5ruG6SV3fV5UeNnzjCFsMh/TJ0ub7h3327Wz7265lYWqzr8LgrtPbRP3av0tdNtUvLDFIkx96WtN9PrOt3wpLDLP+Kd6tLN/rm2VZeWfej4U5hu8IUwy75FHCHoNh2OrUn6Tpv32OxlIuroQkv6t4mGL4zvXvJ/rkY7TLd+yddBw83ak/64hWyrJXOY2fK6qvNKLdqev2xavz+vrCkUk7Gr5+zv9txq9s0/YmOzatYaOiuj27qbtXYfR1cqbTUqNSkW1Mkm2ZrDTYUs/v+nwbyqlmZLr9b3eIh7TLtv0weLrT7JCctNmNzP7XiXS2bZZKKOYM9X55L+vv7jczuzrVfj+mU8Swy3n7HafaD5vOo0mCMK1c/FmVymBaVlLhbRKf3/lnlpsqarLcnGFI7mSdxcyzKpWnyZfB4pXMl0f1ldVNdfKr4sCYJT2j1Z52p65KZ3qzHu9+/Tod0K+LPx3DwdeqAL47nLJfinoMG8+/AJzse8FNUbFeQ4+f2usmfhenO5Y295/fdYoYPl+6Gubyuky9yLYlpS6Vjg/V/fcZyPH00/3ZNn73D0v7duk69sUsN1WM9fRw+y+wESanPHZPdZ0+l+9Sx3SS77TTH3q6D7fq2MY8Wdd+icb5bhi2RmMpnUjJdRPzgQ2jREwavwdyDp7yWPqzR7JuH6fqdyN/r70ilYhJw24gCWIp3Nc/1zV/7H4syHb5rr2Tjn5GjqNSqaVmpr3T0OVlY402Hp/eZZu2l7pMKz7sqj7dkYbdUXeYU2YhnT7sfv1CM7nZP8GO+BxprLQSKfmn9Xe2X7tss/qLnOt+LJWfc5spnlN+2FClYs+HMwd1M3OyGI7pBDHsct5+y4n2g/95NJwM1TcM6fNNQyen+DS+TcvNLn69Rn99Y6vrHDlyZrdzqYRiSqvUaqk0X+dIzjejnuO49rBfDD96rTph7FGOYfv5902niMEsq6hn3XVsSUeYwOhkx9Lm/vPbThCDYQz0Piwqf5lSx7aVukxLvXZwNwKR7pM3XMem/pRaSn+0dVcfBJbwl/Qzx+6Rr9Pn8l3qqIjBw3oMI2d6JGYzijkxZbLSSJLjjILY4In6XVud+p0607+ThZqq1RuNdhidthOOJQ/+MbhmWdXcWM+VfnD9eZj3w0/ejwXeLocLNOk4ywC7ZlktqyT345DkY3i3FxWHtMvaL3LTx3N/Dac3//VxdmMQ2Bc0/BqHnkdHOf8SccWdnh7WHoH52V+6AJyO6yZ1nU/LSPyRZZW+CkotNfNd30fkELz+a0/50qWSLwld5cbqVoIZ9XTuPtptqVhU2eyf18RtXKfP1uxeovS3pbxmI+weI9Xffo7GimcSSkkadodKZ7JKKK7x+6mzYsH5fBvKyYUjCfMbJQu1acIxoKRvFNDPSzpwIpltjMGTbh+6ctIZmdMXhM6GaccSqQ1LxbSxyLdsfXufb0M5Cy/OdJMF5dOOdvlhZls9ZzMcHzT7cyqh2CxzHsg692sXySe+VEKxhT+zV7md3vnku86p0LfZ55uGyulqOsGT1/ES+hgW/n3yst71/Rf2GHY5b8Mew17nUfZKufhQ7/1ty43kOHHlrvacgaz/rmH867j2Evr23EGUY/jOtep79dSPx/797elEMWw//8Icw2yUx+wF+rOZFT/at0sTpoU5Bk+L/ee3t6eTxTCZUTKty+uM0sN3z3fAhT2Gn9HXY6OnWHE9jki32Q7X6X2dxXepHYQ9BjdZUD72NcPt3V197empsMegkSMnltFV3NFb/01DZZSJRftYyl7lFHeGelvYZhRiiPy9trYnHKMQw0F+6H5sa9mJbRzpmMj/lZX/+vujfavHfkrX91XlE9MDZfp+BM+y6TKLB1X/tad8tSorbyy9U2H1kZNFm8pmL7j12p5hd/TvOa7W0q9Luz8qu6mekqSRo5GbVnrhpVSTx3GL+mOst8viL7KzRx7WTjSPdW5zSLv4xzd5/GL2i9yo29UwvftIqyi3mWHYemn3dF+1ZJWMeZstHS+hj2Hysti/i/svvrL/wh7DLudtBGLwP4++htfP4pv1WZuWMwxbL/8a0n11PlJpbSKZDXV8bCSWjmt3tDKyKeTtuZMIx/Dda1WUY49KDH7n34Dz6MQxePef0YpB6r+P1Sr90Uf7UR7vx4lEDF7Wvn/63SMsle20+q/+stRSLbHw3u0It5nfdfpTe9xzLcUX/e9SO9Ul5DFMfmBo6m/r62Y6cteOz5HG8Zxiw1fZhi05MVXTYy0NdAx5DKv90tr34AjEMBPle+3JbNBxGUZi6THjKJ3Tfvyuf0+DH7of21J2ap5Jx9njucuMtfcibC9bDtCwO6rfdTzLJyfS5MXKqw3jVbZte8bgSZWBd9m2d0r51XPybLw0fv96v9NsdiGPNc3/72uGZI/3QnmscxeHtItffIsTWUiSOpo/9nPObba1/hGJYe28Xdh/UYnB77yNSgwbzyNXkoZq3y5+fofltOG8NgwZmsY++5zdUf1OK3+v9NgROyakybF9t2nBiMfwnWtVFGI/hxg2nX9RimE1lij2rX79Z3RimG5z1NWr1yojEoNXf7b/PcKsbPN1zNDy8breX3rHF6Y284vv6+/16/Qs9n3bU4r+d6ld6hL2GFyzrGJ6uc8yy03lr1MazBLmIY9htS52p667iN1bbL1+RyCG+ZYjfK/t2c9FLIaZfa9/0s/cj/m2yw84yuPVhzDsjtq9mIo362NP/cpOKVmoqdUqKdZr7P1OmexNUelhd20Ey3fWGZZ28XMObUYMxOAlCuefn3Noz3OI4VDnEDsxEIOXc45h8v7e9NLkSlGLIUxos/2dQ5tFMYbJpGTSePqcYxRjWEUMxODlt8ZwqGPEvq3sJxgXFxcHPDx+PGa5qcx7xbPR/crCzDXLsjLvR5vkJqrt4ucc2owYtvtNMUyGyWf0HvGXJ4elPb/jHGI41DnETgzbnVsMx+o/TxmDWW6q9MfQqLvwaHAAzuFYOjXabH/n0Gan7bPWX3cVxLnPftiOGHZDDNuFuS/3i/3Y7XKI0CUdAQAAAAAAAERbaB6vBgAAAAAAAHAeSDoCAAAAAAAACBRJRwAAAAAAAACBIukIAAAAAAAAIFAkHQEAAAAAAAAEiqQjAAAAAAAAgECRdAQAAAAAAAAQKJKOAAAAAAAAAAJF0hEAAAAAAABAoEg6AgAAAAAAAAgUSUcAAAAAAAAAgSLpCAAAAAAAACBQJB0BAAAAAAAABIqkIwAAAAAAAIBAkXQEAAAAAAAAECiSjgAAAAAAAAACRdIRAAAAAAAAQKBIOgIAAAAAAAAI1P8BN/8cUMJqW3UAAAAASUVORK5CYII=" alt="image-20230228183833184"></p> <ul><li>1-含义：</li> <li><img src="./assets/img/image-20210329175618915.154cdef1.png" alt="image-20210329175618915"></li> <li>2-操作：</li> <li><img src="./assets/img/image-20210329175728523.ba58c814.png" alt="image-20210329175728523"></li></ul> <p>join</p> <ul><li>1-含义：</li> <li><img src="./assets/img/image-20210329175822048.1b071a56.png" alt="image-20210329175822048"></li> <li>2-操作：</li> <li><img src="./assets/img/image-20210329175908622.252d90e3.png" alt="image-20210329175908622"></li></ul> <p>cogroup</p> <ul><li>1-含义：</li> <li><img src="./assets/img/image-20210329175934847.975c247a.png" alt="image-20210329175934847"></li> <li>2-操作：</li> <li><img src="./assets/img/image-20210329180035130.af66dcba.png" alt=""></li></ul> <p>cartisian</p> <ul><li>1-含义：</li> <li><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA9gAAAArCAYAAACDxCBbAAASCklEQVR4nO3dP4zbWH4H8O/6BmEWzhJDA7yDo1eEo+LOA2wQsBCL645OFeCAkcpzOnexUg9wTZoc1Mu4Zt0sMO1oqnQrlwdQBa8Izq60RICn7O6x4ICLGOYChlM8kqI0HInUUKOR5/sBDJuWhnp81PD9/73PPn78+BFEREREREREdCMHz1692XUaiIiIiIiIiPbS2fPj/N8HAND/8sf8P75683f411/+H/72Zx95zGMe85jHPOYxj3nMYx7zmMc85vGK46LPfvfVXz72v/wRw//+AkRERLeNZRARERHtq/6XP8JxnPz4AQB4P2g7SxAREd1vLIOIiIhoXy3XYx6ovz7uIClEREQAyyAiIiLaX4v1mAcA4Pzip50khYiIaL/LIB39XhuDnoBjNH92Ybdx9ryNgatDNH96IiIiuqHlesyDHaVjf1kCg+fHGLj6rlOS0uDYAn17m1MsNQjLRL/XxtlzAWf9D9AdI2yBvs0KOn3CDBODXhsD11zxPdfQdQX6rtlgYzjBDBqEoaP/m1WfvQkNHUtD9gzubKEBnzN0dN02Br02+tYWP4eIiOgTdwBw/dv+0tHvCbQuJV6Ok619iuO2cWIhrThu73NW09DttdFdV8GMEkgkmAQxJn4MeStpu/ukH2LiCgx6Gk7PQ+YL3SlNlEHC0iEMDTBMvHATvByX/P4bOjqW6mhyDoFZw78LMmj4mWPoeaNa+hKjqMmTK8IycWLrcIz0HkQJcGRCXIYANMjo+me+SH9m1XuIiIg+dd4P2sIA5IH6a3/XvzmuAMYS3m19YCBx+uq2PmyVtHEdTHHqN1e5KctPb/wGnmFi0Gt6dKaOBKPzNxgVG9qBxKkfQ+aVTg3C0nFim+jaOrp2As+XGG45f+6a8jQm8MZTzOw2Bj0Nw/O7fQ1039y0DNJxks3iCSROx3H+irB0tADMghgtO3uGxRguNK41OJYGIIEXNN9YdGyBjpFgMg5r/d6JtDMAUYiXlZ9jOhxbA6IQXlD2ugbHNtGxNLSQYHappY3rGMNXheeCJXDm6kCUwLss++wszwDpN1sOERER7ZfFeswBoOaNT/66h6PYhokTC7jYdTp2wHEFnEuJZ01WavYiPxNMggTdfORk8TUZhBgGIS7sNga2Bsduo4WGKn/7kD9r0ij9KYbGMfquDq/QCCHapZuWQcI2855jCR39fAnPvBGIIIbMpj5HQMcV6GQnONTzKeMnN2gsCstEf3mWzaGWjw47PQ2o3LlV6DSAhhO3Yvdmfi0mOuM3GF5pZKuOR89PDw0TLauk8/QygQQgjASTsjTnPxdjsoVOCSIion2xvAb7YEfpaIRjq8L93rEE+laC0Xmz1/4p5af0pziFamQLu41+VFbRrGcf8qdKGj0/xElPoG/dPE+Ids4w8SJtiHpjiZltooMEF68lvAgYpm9z3GP0gXTmi4YXPRMIQrwcq5Hs4TWnr0MGYemMmU3OnXcaRGH1ZR2GiUFvnpbJ5QYfvIHZFqauExER7au93Qdb2Pc1EIuGrq0DQdjoerxPMT+lP5+O6dg3m96+D/lTOY1RjEl08zwhasrmZZCGbhpYzBtPMQxijPxEBRwrxmxIZ3YgCnE6jiHTKdfCMjG4k4Ebs9HrBKPX1deJZ7/T0p/idBzC26CMcCwdjqVDHNb/WSIiovtouR5z4zXYKkBKISJrFGOYjhwsSCOs5oFUoHrYL/zlSkC2jlaHYyQYvgoBV6BvaWlPfoxOT+RThAEd/edqZKJsHZiwBF7YOoSx6jNVlOUXaZRlGUi8HAMnLjAsTqM1NDiWiRNLB65b+7zxdUrMimmNYoxelwS1sUx0DUBWmZJ3JS0JPD/ExULwLw3dGvmZ51eVtJa9t3J+LN/3TYIRxbjwE7Ue0dDRMcLFKeWV7lWN/Kl87yt+37L3rs2/uvcwnWZvmzixQo5i0x2wWRkkbKGeh/4Uw+yZGMTwoMNJOyMn3+p44eoQS88RGcSQtgmRNma9O7SG2HHV6LU3nl59rqbxMLD8HEg7Edathxa2wMnCNHYt7WjTcNJr54HLiIiIqKoG12ALu42BDYzGUzwLkrzg7/faaJ0XKgZZgKwoxOkrVcFRP2uivxTJdTlidcfWcTGWGPXa6AJoIcHofIpRHnRrKTBLgeO20T9MMHz9Bl6kGioD11SNtsLPqLQkGJ6r98HQ0X8u4ASyMLVPR79nwkG69resUXKj6xSYRSFOz2V+nm5PYLZ0bc6RWls4Wxe11RI4czWMxlLdm3w7LwHHKlY0q+dnpmMLzAKJ0/O08efqpWmtcw/W33dsFJ1XRbdV29y0DgHU/k5WzJ8a977a961O/tW/h1m+OEc6hsHdnvZOn76NyiBL4IUNeP50aVq2WhPcOkzUTgKHaaAwQ1/sUIpiTCL1PL2tNcSO28bJITDzp9d3bFmqY1Gueg9U53bn2xheXhbEeHker43oLX2JC0ONjstIPY8cCwASXBTXWu88sCUREdF+aG4NtiUwsDV44zcY5RWWEBeBqvx3bR2jdDQui4Ra3MJE+iE8W8AxtIXG02LEag2zQEICkOdvMKqZvr4FjM7no+kykBgGx+hbeiHIk9pnVPqFUfcoxnAcwzkqnjDG8FWcB88qs/l1AhO/ULGJYkwiE8LQ0DIwbxRmjUQkmK1aW2eYGLg6pD/FKK84JvD8KWZQjb6Bm+DZhkGuimmVQYhJpJekFTXuQYP3fYWWoQFpftS5V1VUP1/V7xtq5V9tWQCjQzV6xW27aO+s2NHBG0/nz9NsqnMU42Khwao6piaG6oC7bgtCYZk4OVrd+G8Z8/deCXKWp2MeSE24bWBc1oDW0T0CRv4Uo7Uj6glmxejeUVL593jeCM/22SYiIqKmbLwPthpJjTFZqiB4fogTy1R7aaay0bLyUdeShlku2Th4inOkA1GIydLPe9/G6Fs6YOlwEBdGsQW6kZw3SIMY3nKDZ43Nr/M6S6Ou2TnW5Itah5cUGteFNGaNPstE14gbXMe9nNb692Bu8/teVdP3qu75qnzfNs+/CqIEM6h9bDedHUDUlJvGARFpx6eM4qudj4fpuQ0dJ+7y56zfakoGIS4u5yO+V2no9tQ5Zn44n6peYn2wszjvmM6oLb6A2TX7YN9oL+p0yZGSbv3oh6VlBxEREZVraB9sHZ3rgimlU2QXBBLP8pEGDcIy8/Wn25Glz8TgubnmvfNtn7puG90oxsgPMQpiDMc1P/bWr7NMYZR7VaeFcbVB3Kw69+B2LDR+m75Xlc9X9ft29/KPaHtuug+2IpDkUcFzloDjamoEu+w1S+0BfbGiUbm+8aqpGAlHGkRQfSR5PR0dW1eFttVGazzFcKkDQR6aOEtnLNXdXixbcpQzdHRdHZ1A4jTbxivdIqyz/MP52m0iIqL7bmf7YGtw0qBVMghx8Vqi09ty9NaKwbGkP8VplAWSUhWM7prAXdfbwXUufX7ruimKAPLp5Svf06CNA5Q1Y16BLJtW3/S9qna+Wt+3Hecf0W24nTJohajBWTO1ZyqtYOn588PLppQvP7sDiVO/jYHdxpkhVZT0SulMI6vnVCdf39UhLIGz/LUEF+NV+2ATERHdbw3vg61G2bx1UYjzAFAxhufTdD2pXtIj3rAV01+FbaJV2MZJBhKnQTEquo5urw2cl0RxvfbzdnSdpdZNc16zjrspNe5B8wozLZa3NWv6XtU8X+Xv207zj2g/zIMZ7pY4NPGiJ1RcgyjGxI8xCSo2eK9It2QEgECuDHgm/SmGxjH6lsCgV61TrnSbviCGF2lopTNtAGAWXLMMJQorBVUjIiK6bzbcB3u+9vrKFLOU42Yjd9k+pQlGZdt3bUU2GpHtJbpMU2vasvS584qGDEIMz7PgM3UCwNzGdWbXtWqUOrs369K+7XXOde7BdgjbTL+DCUZ+cV1j0/eqzvmqft+2nH9pwz1bi020Szddg31XyEDi9NUbnI5jADq6rsDg+THOegLdmsHEsi3I1Mjy+mCGXjbKXCX6dxpA8eoMGdVBeHou1dIVP4QXaej32hj02uhbavlL11Vbc7JxTUREdLUe80D9VX/9m/dtWuBbAgN3aa2pYeIkD760bsryNswbVMJuL6VPTePtRIVRhcPlqXLJ/Poqu43rzEads3XW5Tw/2ybKLJnurEZ15dZHPmveg4aJQrT3q3vJNn2vap6v0vdty/mXRg/PookT7VYza7BVIDOBfvGPra1/rWEykDg9n86naxs6uu71O1BcvQ4TL2wVWG10vnrLvblCQzzdSaKchm4aEG5YYaRb2CYcI11jDtUpOIOOfq9dCJBGRER0ny3WYx4AV+eNV1KYsiastJc++9PTMclHDOejrl17vh9p1zXVCFqq2BjMtg5a2XDJR97S9xjmYmXp2vS10T+M8XIpGIzjqt55pOfMoqRfLLxPU1s9Yb4t01yD12nMj7PPy2QNseX/X8ybML0+FRU22xoGhtqv2gnk1WA4a/JTWPXTWvceVLrvC6O880pffmyZ6PeO04psglHpVjj179Xq/Kl/vkrft5r5t/Z3opiW9F7V70giat5GZVCZKMbFWGJY/JP9nqx6bSuStKE9n9Vytdwok82IKescXKO4FGYhQvicsE10AExeV2i45w19tX92FiHdG4fwoKHLRjYREdGVeszP/vG3//YfmwaYmQUhJpGGXx1pyPrKZRDi69cS3+SVgg94+32C1mMd4rGOp7aO1vt3GP/pe8wMHY6h4cljDW///D289xq6vV+if5yl5QBPjk10LWDy9h0WmwIJ/jfS8Kujh3COdbTeh1cqS+Xpk/jDf0WFXvsDPPn7D/j6dQz9+DF+7z5G136E1mWIr19/D+99+jbDxOCZwD9nlYnPH+KprQNBhLfvG7pOI8HEEPij+yivhOmPH6Fra5j5sWo8XSaA9QiO8aEkT+bi7yJMIuCLx4/QtU3157GG2P8fnPrvSn7iuvxM03q0QVor34Mq91295/e/foQnn2f35CGeHpvz67Mf4alxAFy+wze+xH++DvH28kPJtda5V+vyp+75Kn7fauVflTQuenL8GA5CvPzT9d8hotty0yBn4sjE08cHwPt3+Gb5uWjo6B5p9V+r7ABPjtVzKf4uwjffLT1z3ieYvI0xCSJ8E8SQ78vPkl+L/Q/oHx1A+lP84W3J8+vzh3h6/BA6PuDt26z8yXzA2/eauiYc4Iv38VJ6NOjv32EShPOlLPn5EkwKz25AQ/dfBJzPy7YwSzCJNHSPHuLJcbEcJCIiun+cX/wEIeZd6J/97qu/fOz8/CdM/vo3O0wW1WIJnLkaRnUCsBFl0jWas/GblYGTiG7LTcugfElIWdR9S+DM1eu/Vtl8JHeTrbIWr0Pgha1h5q8YXc/XWCfXlAEauj2RjlJXKCPy88UYvpqPajvuMfpWOt29dA14cQR78WeJiIjuk87Pf8K///af8uMN98GmnQokhsEx+raOUYXgN0RFjm1CpFHMie6GJtdgL42EH2rrX7sLLBMnlobZeD4VW9Hmy02iBBNj3TTztOF9g6SoJSzrOgxUnIiuq6PyjiJERESfpJ3tg01N8sZTtHptDOybjZjQ/SJstX57eM6OGbo7GiuDohgX46sj0cPr3m8JOK62cju89RoKmhiEGAZhyQsJRmMJYQm8cE30s/+OYkwancGkoWVp6NptdI0k3Xd7TdkShBhFOtdhExHRvdbwPti0O2qUAr02BobEy/H2InLTp0BFHu8fJhhWjkpMtC8SyAiY+TWfg5cxRn6CWXDDXRWiBLKwd/Q2qIBpJga/UQERX248pX3JoQZECbwgBAwdCCROz6vmY4LR6ykmACSXKxEREQHgGuxPgrAFTnB9QCsi9R2JcVG3AUJ0C1gGERER0b7iGuxPkPTl9VMgicDvCN11LIOIiIhoXzW1DzYREVEDWAYRERHRvlquxzzYUTqIiIiIiIiIPikPAMD7gRHEiYhoN1gGERER0b5arsekI9hc/0ZERLvCMoiIiIj2FddgExHRHcIyiIiIiPYV12ATERERERERbQHXYBMR0U6xDCIiIqJ9xTXYRER0x7AMIiIion3FNdhERHSHsAwiIiKifcU12ERERERERERbwDXYRES0UyyDiIiIaF9xDTYREd0xLIOIiIhoX3ENNhER3SEsg4iIiGhfLddj/h8ULve6+5UpxQAAAABJRU5ErkJggg==" alt="image-20210329180049060"></li> <li>2-操作：</li> <li><img src="./assets/img/image-20210329180141685.2c4d06fa.png" alt="image-20210329180141685"></li></ul> <p>mapvalue</p> <ul><li>1-含义：</li> <li>对Value进行操作</li> <li>2-操作：</li> <li><img src="./assets/img/image-20210329180245294.3711df27.png" alt="image-20210329180245294"></li></ul> <h4 id="rdd的action算子"><a href="#rdd的action算子" class="header-anchor">#</a> RDD的Action算子</h4> <ul><li><p>reduce</p></li> <li><p>collect（拉取的分区结果数据很大的情况下，会造成driver端的内存溢出，可以foreach打印出来，或者saveasTextFile保存到硬盘查看）</p></li> <li><p>count</p></li> <li><p>first</p></li> <li><p>take（从第一个分区开始，满足要求就不再遍历获取，collect）</p></li> <li><p><img src="./assets/img/image-20210329180609115.f2cc8026.png" alt="image-20210329180609115"></p></li> <li><p>takeSample</p></li> <li><p><img src="./assets/img/image-20210329180739703.ceaf5e85.png" alt="image-20210329180739703"></p></li> <li><p><strong>takeorder</strong></p></li> <li><p>aggreate</p></li> <li><p>fold</p></li> <li><p><img src="./assets/img/image-20210329180904341.4f362a1e.png" alt="image-20210329180904341"></p></li> <li><p>countByKey</p></li> <li><p><img src="./assets/img/image-20210329181008334.328881c9.png" alt="image-20210329181008334"></p></li> <li><p><strong>foreach</strong></p></li> <li><p>rdd.foreach方法在执行的过程中的打印方法是在Executor中执行的，每个Executor在执行完自己的逻辑之后就执行foreach进行打印，因此在本地多线程执行的时候，可能List(3,4)是有可能先执行完成，所以会存在顺序错乱的情况。多线程，多分区才会有这种情况。而value.collect().foreach(println)这种写法的print是在数据采集到Driver之后，在Driver端打印的。所以顺序不会乱</p></li> <li></li> <li><p>常见的RDD统计操作</p></li> <li><p><img src="./assets/img/image-20210329181148676.27342d75.png" alt="image-20210329181148676"></p></li></ul> <p><strong>RDD的关键算子练习</strong></p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase<span class="token punctuation">.</span>base</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">,</span> TaskContext<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span>Test

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">class</span> _02RDDTest <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span><span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">&quot;_02RDDTest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">def</span> test01<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>

    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">def</span> test02<span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//如果直接使用foreach是无法作为iteratale返回</span>
    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token comment">//f: Iterator[T] =&gt; Iterator[U],</span>
      <span class="token punctuation">.</span>mapPartitions<span class="token punctuation">(</span>iter <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        iter<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
        iter
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//执行每个分区的元素乘以2</span>
    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token comment">//f: Iterator[T] =&gt; Iterator[U],</span>
      <span class="token punctuation">.</span>mapPartitions<span class="token punctuation">(</span>iter <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> iterator<span class="token operator">:</span> Iterator<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> iter<span class="token punctuation">.</span>map<span class="token punctuation">(</span>item <span class="token keyword">=&gt;</span> item <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
        iterator
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>

    println<span class="token punctuation">(</span><span class="token string">&quot;上面的等价写法&quot;</span><span class="token punctuation">)</span>
    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token comment">//f: Iterator[T] =&gt; Iterator[U],</span>
      <span class="token punctuation">.</span>mapPartitions<span class="token punctuation">(</span>iter <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        iter<span class="token punctuation">.</span>map<span class="token punctuation">(</span>item <span class="token keyword">=&gt;</span> item <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">def</span> test03<span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token comment">// f: (Int几号分区, Iterator[T]) =&gt; Iterator[U]</span>
      <span class="token punctuation">.</span>mapPartitionsWithIndex<span class="token punctuation">(</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> iter<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        println<span class="token punctuation">(</span><span class="token string">&quot;index:&quot;</span> <span class="token operator">+</span> index<span class="token punctuation">)</span>
        iter<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_ <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;改进的方法&quot;</span><span class="token punctuation">)</span>
    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token comment">// f: (Int几号分区, Iterator[T]) =&gt; Iterator[U]</span>
      <span class="token punctuation">.</span>mapPartitionsWithIndex<span class="token punctuation">(</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> iter<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        iter<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token string">&quot;index is:&quot;</span> <span class="token operator">+</span> index <span class="token operator">+</span> <span class="token string">&quot;\tvalue is:&quot;</span> <span class="token operator">+</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;想用mapPartition的方法实现分区有哪些元素&quot;</span><span class="token punctuation">)</span>
    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>mapPartitions<span class="token punctuation">(</span>iter <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        println<span class="token punctuation">(</span><span class="token string">&quot;partitionID:&quot;</span><span class="token punctuation">,</span> TaskContext<span class="token punctuation">.</span>getPartitionId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        iter<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>

    println<span class="token punctuation">(</span><span class="token string">&quot;想用mapPartition的方法实现分区有哪些元素,改进方法&quot;</span><span class="token punctuation">)</span>
    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>mapPartitions<span class="token punctuation">(</span>iter <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        iter<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token string">&quot;partitionID:&quot;</span> <span class="token operator">+</span> TaskContext<span class="token punctuation">.</span>getPartitionId<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\tvalue is:&quot;</span> <span class="token operator">+</span> x <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//想用mapPartition的方法实现分区有哪些元素,改进方法</span>
    <span class="token comment">//partitionID:0  value is:2</span>
    <span class="token comment">//partitionID:0  value is:4</span>
    <span class="token comment">//partitionID:0  value is:6</span>
    <span class="token comment">//partitionID:1  value is:8</span>
    <span class="token comment">//partitionID:1  value is:10</span>
    <span class="token comment">//partitionID:1  value is:12</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br></div></div><p>总结</p> <ul><li>使用IDEA完成HDFS文件读取
<ul><li>将core-site.xml和hdfs-site.xml加入配置</li></ul></li> <li>RDD的引入
<ul><li>RDD是弹性分布式数据集</li> <li>RDD特点：不可变可分区可并行计算的集合</li> <li>RDD五种属性</li></ul></li> <li>RDD的特性--面试必问[重点]
<ul><li>1-分区列表</li> <li>2-作用函数</li> <li>3-依赖关系</li> <li>4-key-value类型分区器</li> <li>5-位置优先性</li></ul></li> <li>RDD的创建
<ul><li>三种</li> <li>小文件读取</li></ul></li> <li>RDD的转换算子
<ul><li>单value类型
<ul><li>map</li> <li>filter</li> <li>repartiton</li> <li>colasese</li> <li>glom</li></ul></li> <li>双value类型
<ul><li>集合交并补</li> <li>distinct</li> <li>zip</li></ul></li> <li>key-value类型
<ul><li>大家晚上巩固groupByKey，combineBykey</li></ul></li></ul></li> <li>RDD的行动算子
<ul><li>collect</li> <li>take</li></ul></li> <li>RDD的案例实战[重点]</li></ul> <p><strong>案例1:groupByKey(要求和需要再sum)</strong></p> <ul><li><img src="spark.assets/image-20210330091415920.png" alt="image-20210330091415920" style="zoom:150%;"></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">def</span> test01<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> value<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    value
      <span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//(a,CompactBuffer(1, 1))</span>
    <span class="token comment">//(b,CompactBuffer(1))</span>
    value
      <span class="token punctuation">.</span>groupByKey<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> x<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>案例2:combineBykey(平均值)</strong></p> <ul><li><img src="./assets/img/image-20210330092050781.ca10565b.png" alt="image-20210330092050781"></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">def</span> test02<span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> rdd<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">,</span> <span class="token number">99.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">,</span> <span class="token number">96.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token string">&quot;lisi&quot;</span><span class="token punctuation">,</span> <span class="token number">97.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token string">&quot;lisi&quot;</span><span class="token punctuation">,</span> <span class="token number">98.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">,</span> <span class="token number">97.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// createCombiner: Value 元素=&gt; C 对元素的操作,</span>
    <span class="token comment">// mergeValue: (C, Value) =&gt; C,需要将上一个初始值和新的value进行合并</span>
    <span class="token comment">// mergeCombiners: (C, C) =&gt; C,</span>
    <span class="token keyword">val</span> createCombiner <span class="token operator">=</span> <span class="token punctuation">(</span>curr<span class="token operator">:</span> <span class="token builtin">Double</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>curr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> mergeValue <span class="token operator">=</span> <span class="token punctuation">(</span>curr<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Double</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nextValue<span class="token operator">:</span> <span class="token builtin">Double</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>curr<span class="token punctuation">.</span>_1 <span class="token operator">+</span> nextValue<span class="token punctuation">,</span> curr<span class="token punctuation">.</span>_2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> mergeCombiners <span class="token operator">=</span> <span class="token punctuation">(</span>curr1<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Double</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> agg1<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">Double</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>curr1<span class="token punctuation">.</span>_1 <span class="token operator">+</span> agg1<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> curr1<span class="token punctuation">.</span>_2 <span class="token operator">+</span> agg1<span class="token punctuation">.</span>_2<span class="token punctuation">)</span>
    <span class="token keyword">val</span> valueRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Double</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdd<span class="token punctuation">.</span>combineByKey<span class="token punctuation">(</span>createCombiner<span class="token punctuation">,</span> mergeValue<span class="token punctuation">,</span> mergeCombiners<span class="token punctuation">)</span>
  
    valueRDD<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// x._1      x._2._1</span>
    <span class="token comment">//(zhangsan,(292.0,3))</span>
    <span class="token comment">//(lisi,(195.0,2))</span>
    valueRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> x<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>_1 <span class="token operator">/</span> x<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//平均值</span>
    <span class="token comment">//(zhangsan,(292.0,3))</span>
    <span class="token comment">//(zhangsan,97.33333333333333)</span>
    <span class="token comment">//(lisi,97.5)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><strong>案例3:foldByKey</strong></p> <ul><li><img src="spark.assets/image-20210330093143876.png" alt="image-20210330093143876" style="zoom:150%;"></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">def</span> test03<span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//</span>
    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>aggregateByKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">,</span> _ <span class="token operator">+</span> _<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
  
    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>foldByKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
  
    sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>foldByKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li>collectAsMap</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">def</span> test04<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token keyword">val</span> rdd <span class="token operator">=</span> sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>List<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    rdd<span class="token punctuation">.</span>collectAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>randomSplit</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">def</span> test04<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token keyword">val</span> rdd <span class="token operator">=</span> sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>List<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    rdd<span class="token punctuation">.</span>collectAsMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//Randomly splits this RDD with the provided weights.</span>
    <span class="token comment">//weights: Array[Double],</span>
    <span class="token comment">//seed: Long = Utils.random.nextLong</span>
    <span class="token keyword">val</span> array<span class="token operator">:</span> Array<span class="token punctuation">[</span>RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdd<span class="token punctuation">.</span>randomSplit<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">123L</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> traingSet<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> array<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> testSet<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> array<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;=======================&quot;</span><span class="token punctuation">)</span>
    traingSet<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>join</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token annotation punctuation">@Test</span>
  <span class="token keyword">def</span> testJoin<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token comment">// 模拟数据集</span>
    <span class="token keyword">val</span> empRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>
      Seq<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token string">&quot;lisi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1003</span><span class="token punctuation">,</span> <span class="token string">&quot;wangwu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1004</span><span class="token punctuation">,</span> <span class="token string">&quot;zhangliu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">val</span> deptRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>
      Seq<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">,</span> <span class="token string">&quot;sales&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">,</span> <span class="token string">&quot;tech&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    empRDD<span class="token punctuation">.</span>join<span class="token punctuation">(</span>deptRDD<span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;============&quot;</span><span class="token punctuation">)</span>
    empRDD<span class="token punctuation">.</span>leftOuterJoin<span class="token punctuation">(</span>deptRDD<span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>重难点知识</p> <ul><li>案例代码实战1：Spark实战PV-UV-TOPK</li> <li>案例代码实战2：Spark实战区域热点查询</li> <li>案例代码实战3：Spark实战搜狗分词统计查询</li> <li>RDD依赖关系</li> <li>RDD缓存</li> <li>RDD的DAG</li> <li>Spark的Shuffle</li> <li>Spark的执行流程分析</li> <li>回顾总结spark调度</li></ul> <h3 id="实战案例"><a href="#实战案例" class="header-anchor">#</a> 实战案例</h3> <h4 id="实战1-spark实战pv、uv、访问来源topn"><a href="#实战1-spark实战pv、uv、访问来源topn" class="header-anchor">#</a> 实战1：Spark实战PV、UV、访问来源TOPN</h4> <ul><li>需求：读取日志文件，实现PV，UV，TOPN</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>  日志格式：
  127.0.0.1 - - [28/Nov/2019:08:37:25 +0800] &quot;GET / HTTP/1.1&quot; 200 57621 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36&quot;
  1、pv的全称是page view，译为页面浏览量或点击量，通常是衡量一个网站甚至一条网络新闻的指标。PV反映的是浏览某网站的页面数，所以每刷新一次也算一次。就是说PV与来访者的数量成正比，但PV并不是页面的来访者数量，而是网站被访问的页面数量。
  
  2、uv的全称是unique view，译为通过互联网访问、浏览这个网页的自然人，访问网站的一台电脑客户端被视为一个访客，在同一天内相同的客户端只被计算一次。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li></li> <li><p>步骤：</p> <ul><li>实现PV-PageView：</li> <li>1-首先读取数据</li> <li>2-通过map转换函数对于每一行数据都统计为一个PV</li> <li>3-需要通过reduceByKey累加计算(AggerateByKey，FoldByKey)</li> <li>4-实现PV排序操作</li> <li>5-打印输出或保存起来</li> <li>实现UV-UserView</li> <li>1-读取数据</li> <li>2-通过map转换函数将IP地址选择出来</li> <li>3-使用distinct去重，并实现统计</li> <li>4-使用reduceByKey实现相同key的value的统计</li> <li>5-实现UV的排序输出</li> <li>6-saveAsTextFile</li> <li>实现TopK-排名前几位</li> <li>1-读取数据</li> <li>2-通过map选择出用户点击的URL或APP等，X(10)</li> <li>3-进一步实现过滤统计</li> <li>4-实现TopK输出</li> <li>5-saveAsTextFile</li></ul></li> <li><p>代码</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase<span class="token punctuation">.</span>pro</span>
  
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>
  
  <span class="token comment">/**
   * DESC:
   * 实现PV-PageView：
   * 1-首先读取数据
   * 2-通过map转换函数对于每一行数据都统计为一个PV
   * 3-需要通过reduceByKey累加计算(AggerateByKey，FoldByKey)
   * 4-实现PV排序操作
   * 5-打印输出或保存起来
   * 实现UV-UserView
   */</span>
  <span class="token keyword">object</span> _01SparkPvUvTopK <span class="token punctuation">{</span>
    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">// 实现PV-PageView：</span>
      <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
        sc
      <span class="token punctuation">}</span>
      <span class="token comment">// 1-首先读取数据</span>
      <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/access.log&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//fileRDD.take(5).foreach(println(_))</span>
      <span class="token comment">//194.237.142.21 - - [18/Sep/2013:06:49:18 +0000] &quot;GET /wp-content/uploads/2013/07/rstudio-git3.png HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/4.0 (compatible;)&quot;</span>
      <span class="token comment">// 2-通过map转换函数对于每一行数据都统计为一个PV</span>
      <span class="token keyword">val</span> mapRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span><span class="token string">&quot;PV&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//mapRDD.take(3).foreach(println(_))</span>
      <span class="token comment">// 3-需要通过reduceByKey累加计算(AggerateByKey，FoldByKey)</span>
      <span class="token keyword">val</span> resuleRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapRDD<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span>
      <span class="token comment">// 5-打印输出或保存起来</span>
      resuleRDD<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//(PV,14619)</span>
      <span class="token comment">// 实现UV-UserView</span>
      <span class="token comment">// 1-读取数据 -已经读取</span>
      <span class="token comment">// 2-通过map转换函数将IP地址选择出来</span>
      <span class="token keyword">val</span> ipValue<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 3-使用distinct去重，并实现统计</span>
      <span class="token keyword">val</span> uvValue<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> ipValue<span class="token punctuation">.</span>distinct<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span><span class="token string">&quot;UV&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 4-使用reduceByKey实现相同key的value的统计</span>
      <span class="token keyword">val</span> uvResult<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> uvValue<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span>
      uvResult<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//(UV,1050)</span>
      <span class="token comment">// 5-实现UV的排序输出</span>
      <span class="token comment">//实现TopK-排名前几位</span>
      <span class="token comment">//1-读取数据--已经读取</span>
      <span class="token comment">//2-通过map选择出用户点击的URL或APP等，X(10)</span>
      <span class="token keyword">val</span> value1RDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//value1RDD.take(20).foreach(println(_))</span>
      <span class="token comment">//3-进一步实现过滤统计</span>
      <span class="token keyword">val</span> result1RDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> value1RDD<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span><span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>_1 <span class="token operator">!=</span> <span class="token string">&quot;\&quot;-\&quot;&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//如果直接执行sortBy或sortBykey可能得到结果没有办法全局排序的，这时候可以增加collect收集到driver端</span>
      result1RDD<span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//(&quot;http://blog.fens.me/category/hadoop-action/&quot;,547)</span>
      <span class="token comment">//(&quot;http://blog.fens.me/&quot;,377)</span>
      <span class="token comment">//(&quot;http://blog.fens.me/wp-admin/post.php?post=2445&amp;action=edit&amp;message=10&quot;,360)</span>
      <span class="token comment">//(&quot;http://blog.fens.me/r-json-rjson/&quot;,274)</span>
      <span class="token comment">//(&quot;http://blog.fens.me/angularjs-webstorm-ide/&quot;,271)</span>
      <span class="token comment">//4-实现TopK输出</span>
      sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><ul><li><p>总结</p> <ul><li>学会使用对应RDD实战</li></ul></li></ul> <h4 id="实战2-spark实战区域热点查询"><a href="#实战2-spark实战区域热点查询" class="header-anchor">#</a> 实战2：Spark实战区域热点查询</h4> <ul><li><p>需求：</p> <ul><li>需要通过日志信息（运行商或者网站自己生成）和城市ip段信息来判断用户的ip段，统计热点经纬</li></ul></li> <li><p>数据集：</p> <ul><li><img src="spark.assets/image-20210330120312064.png" alt="image-20210330120312064" style="zoom:150%;"></li> <li><p>用户IP日志信息：记录的是用户IP</p></li></ul></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>    20090121000132095572000|125.213.100.12|show.51.com|/
    关注的就是第二个字段
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>城市IP端信息：需要对某一个区域根据IP划分</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>    1.0.1.0|1.0.3.255|16777472|16778239|亚洲|中国|福建|福州||电信|350100|China|CN|119.306239|26.075302
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><p>125.213.100.12 对比 1.0.1.0|1.0.3.255  无法比较大小</p></li> <li><p>方法：1.0.1.0|1.0.3.255部分已经转化为Long类型数据16777472|16778239</p> <ul><li>如果125.213.100.12 转化为Long类型数据，可以拿到该数据和IP.txt数据进行对比</li> <li>如何对比？一个数字在一个连续数字区域中？这里选择的是<strong>二分查找法</strong></li> <li><img src="./assets/img/image-20210330121337381.ec061289.png" alt="image-20210330121337381"></li></ul></li> <li><p>统计：如果一个用户IP位于城市IP端之内，可以实现统计分析</p></li> <li><p><img src="./assets/img/image-20210330122430639.1f58ede6.png" alt="image-20210330122430639"></p></li> <li><p><img src="./assets/img/image-20210330122438073.684d4062.png" alt="image-20210330122438073"></p></li> <li><p>步骤分析：</p> <ul><li>1-创建SparkContext环境</li> <li>2-读取两个文件，ip和用户地址</li> <li>3-将用户IP对比IP信息段
<ul><li>3-1首先将用户ip转化为long类型</li> <li>3-2将long类型ip放在ip地址信息段中进行查询（二分查找法）</li> <li>3-3根据查找的索引下标，得到经度和维度</li></ul></li> <li>4-根据经度和维度统计区域热度</li></ul></li> <li><p>代码：</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase<span class="token punctuation">.</span>pro</span>
  
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span></span>Broadcast
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>
  
  <span class="token comment">/**
   * DESC:
   * 1-创建SparkContext环境
   * 2-读取两个文件，ip和用户地址
   * 3-将用户IP对比IP信息段
   * 3-1首先将用户ip转化为long类型
   * 3-2将long类型ip放在ip地址信息段中进行查询（二分查找法）
   * 3-3根据查找的索引下标，得到经度和维度
   * 4-根据经度和维度统计区域热度
   */</span>
  <span class="token keyword">object</span> _05IPCheck <span class="token punctuation">{</span>
  <span class="token operator">/</span>
    <span class="token keyword">def</span> binarySearch<span class="token punctuation">(</span>ipLong<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> boradcastValue<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> start <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">var</span> end <span class="token operator">=</span> boradcastValue<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  
      <span class="token keyword">while</span> <span class="token punctuation">(</span>start <span class="token operator">&lt;=</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> middle <span class="token operator">=</span> <span class="token punctuation">(</span>start <span class="token operator">+</span> end<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        <span class="token comment">//查找出结果--中间位置的startip</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ipLong <span class="token operator">&gt;=</span> boradcastValue<span class="token punctuation">(</span>middle<span class="token punctuation">)</span><span class="token punctuation">.</span>_1<span class="token punctuation">.</span>toLong <span class="token operator">&amp;&amp;</span> ipLong <span class="token operator">&lt;=</span> boradcastValue<span class="token punctuation">(</span>middle<span class="token punctuation">)</span><span class="token punctuation">.</span>_2<span class="token punctuation">.</span>toLong<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> middle
        <span class="token punctuation">}</span>
        <span class="token comment">//在右边查找</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ipLong <span class="token operator">&gt;</span> boradcastValue<span class="token punctuation">(</span>middle<span class="token punctuation">)</span><span class="token punctuation">.</span>_2<span class="token punctuation">.</span>toLong<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          start <span class="token operator">=</span> middle <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//在左边查找</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ipLong <span class="token operator">&lt;</span> boradcastValue<span class="token punctuation">(</span>middle<span class="token punctuation">)</span><span class="token punctuation">.</span>_1<span class="token punctuation">.</span>toLong<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          end <span class="token operator">=</span> middle <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">def</span> ipToLong<span class="token punctuation">(</span>ip<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">//注意:IP个原始面貌:</span>
      <span class="token comment">//10111111.10111010.11110000.11110000</span>
      <span class="token keyword">val</span> ipArr<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> ip<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;[.]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>s <span class="token keyword">=&gt;</span> Integer<span class="token punctuation">.</span>parseInt<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">var</span> ipnum <span class="token operator">=</span> <span class="token number">0L</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">&lt;-</span> ipArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//&lt;&lt;表示位运算左移 ,0L左移之后还是0L,二进制形式:00000000.00000000.00000000.00000000</span>
        <span class="token comment">//其他数,左移之后,后面补0</span>
        <span class="token comment">//|表示位运算或,或的特点是,与0进行或,返回本身</span>
        <span class="token comment">//第一次:</span>
        <span class="token comment">//00000000.00000000.00000000.10111111</span>
        <span class="token comment">//00000000.00000000.00000000.00000000</span>
        <span class="token comment">//00000000.00000000.00000000.10111111</span>
        <span class="token comment">//第二次:</span>
        <span class="token comment">//00000000.00000000.00000000.10111010</span>
        <span class="token comment">//00000000.00000000.10111111.00000000</span>
        <span class="token comment">//00000000.00000000.10111111.10111010</span>
        <span class="token comment">//第三次:</span>
        <span class="token comment">//00000000.00000000.00000000.11110000</span>
        <span class="token comment">//00000000.10111111.10111010.00000000</span>
        <span class="token comment">//00000000.10111111.10111010.11110000</span>
        <span class="token comment">//第四次:</span>
        <span class="token comment">//0000</span>
          <span class="token number">0.00000000</span><span class="token number">.00000000</span><span class="token number">.11110000</span>
        <span class="token comment">//10111111.10111010.11110000.00000000</span>
        <span class="token comment">//10111111.10111010.11110000.11110000</span>
        ipnum <span class="token operator">=</span> i <span class="token operator">|</span> <span class="token punctuation">(</span>ipnum <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      ipnum
    <span class="token punctuation">}</span>
  
    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">//1-创建SparkContext环境</span>
      <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
        sc
      <span class="token punctuation">}</span>
      <span class="token comment">//2-读取两个文件，ip和用户地址</span>
      <span class="token keyword">val</span> userIPRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/ip/20190121000132.394251.http.format&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> userSplitRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> userIPRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\|&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//userSplitRDD.take(5).foreach(println(_))//125.213.100.123</span>
  
      <span class="token keyword">val</span> ipRangeRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/ip/ip.txt&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//223.247.0.0|223.247.7.255|3757506560|3757508607|亚洲|中国|安徽|池州||电信|341700|China|CN|117.489157|30.656037</span>
      <span class="token comment">//开始ip的起始long类型地址，结束ip的long类型地址，经度，维度</span>
      <span class="token keyword">val</span> ipRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> ipRangeRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\|&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">(</span>x<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">(</span>x<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//ipRDD.take(5).foreach(println(_))//(16777472,16778239,119.306239,26.075302)</span>
      <span class="token keyword">val</span> broadcastIpValue<span class="token operator">:</span> Broadcast<span class="token punctuation">[</span>Array<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>ipRDD<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//broadcastIpValue.value//直接引用他的值</span>
      <span class="token comment">//3-将用户IP对比IP信息段</span>
      <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> userSplitRDD<span class="token punctuation">.</span>mapPartitions<span class="token punctuation">(</span>iter <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> boradcastValue<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> broadcastIpValue<span class="token punctuation">.</span>value
        iter<span class="token punctuation">.</span>map<span class="token punctuation">(</span>ip <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">//* 3-1首先将用户ip转化为long类型</span>
          <span class="token keyword">val</span> ipLong<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> ipToLong<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
          <span class="token comment">//* 3-2将long类型ip放在ip地址信息段中进行查询（二分查找法）</span>
          <span class="token keyword">val</span> index<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> binarySearch<span class="token punctuation">(</span>ipLong<span class="token punctuation">,</span> boradcastValue<span class="token punctuation">)</span>
          <span class="token comment">//* 3-3根据查找的索引下标，得到经度和维度</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>boradcastValue<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span>_3<span class="token punctuation">,</span> boradcastValue<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span>_4<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//end mapParttion</span>
      <span class="token comment">//4-根据经度和维度统计区域热度</span>
      resultRDD<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span><span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//((108.948024,34.263161),1824)</span>
      <span class="token comment">//((116.405285,39.904989),1535)</span>
      <span class="token comment">//((106.504962,29.533155),400)</span>
      <span class="token comment">//((114.502461,38.045474),383)</span>
      <span class="token comment">//((106.57434,29.60658),177)</span>
      sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br></div></div><ul><li><p>总结：</p> <ul><li>直接利用ip转化为long类型的额工具类</li> <li>注意使用二分查找方法</li> <li>需要使用广播变量</li></ul></li></ul> <h4 id="实战3-spark实战搜狗分词统计查询"><a href="#实战3-spark实战搜狗分词统计查询" class="header-anchor">#</a> 实战3：Spark实战搜狗分词统计查询</h4> <ul><li><p>需求：搜狗词库数据集，首先对搜狗的收集的词条需要分词操作，进行对应的统计</p> <ul><li><p>http://download.labs.sogou.com/dl/sogoulabdown/SogouQ/SogouQ.reduced.zip</p></li> <li><img src="spark.assets/image-20210330105228787.png" alt="image-20210330105228787" style="zoom:150%;"></li> <li><p>分词： 我是黑马程序员的一匹黑马  我/是/黑马/程序员/一匹/黑马  TFIDF Word2Vec</p></li> <li><p>引入HanLP的依赖</p></li></ul></li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.hankcs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hanlp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>portable-1.7.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p>读取数据</p></li> <li><p>搜索关键词统计</p></li> <li><p>用户搜索点击统计</p></li> <li><p>搜索时间段统计</p></li> <li><img src="spark.assets/image-20210330105419488.png" alt="image-20210330105419488" style="zoom:150%;"></li> <li><p>步骤</p> <ul><li>读取数据：sc.textFile,数据处理，这里可以使用map或mappartition，map(x=&gt;x.split(&quot;\\s+&quot;)</li> <li>搜索关键词统计:首先拿到查询词，对查询词进行分词，根据分词进行统计</li> <li>用户搜索点击统计：需要拿到用户ID和用户查询词，然后根据(用户ID，用户查询词)进行统计</li> <li>搜索时间段统计：获取用户的搜索的时间段，根据时间段统计排序</li></ul></li> <li><p>代码</p></li> <li><p>1-分词代码</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase<span class="token punctuation">.</span>pro</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hankcs<span class="token punctuation">.</span>hanlp<span class="token punctuation">.</span></span>HanLP
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hankcs<span class="token punctuation">.</span>hanlp<span class="token punctuation">.</span>seg<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span>Term
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hankcs<span class="token punctuation">.</span>hanlp<span class="token punctuation">.</span>tokenizer<span class="token punctuation">.</span></span>StandardTokenizer

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span>JavaConverters<span class="token punctuation">.</span>_

<span class="token keyword">object</span> _02HanLp <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token keyword">val</span> terms<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>Term<span class="token punctuation">]</span> <span class="token operator">=</span> HanLP<span class="token punctuation">.</span>segment<span class="token punctuation">(</span><span class="token string">&quot;我是黑马程序员的一匹黑马&quot;</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span>terms<span class="token punctuation">)</span> <span class="token comment">//[我/r, 是/v, 黑马/n, 程序员/n, 的/uj, 一/m, 匹/q, 黑马/n]</span>
    println<span class="token punctuation">(</span>terms<span class="token punctuation">.</span>asScala<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>word<span class="token punctuation">.</span>trim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//ArrayBuffer(我, 是, 黑马, 程序员, 的, 一, 匹, 黑马)</span>

    <span class="token keyword">val</span> terms1<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>Term<span class="token punctuation">]</span> <span class="token operator">=</span> StandardTokenizer<span class="token punctuation">.</span>segment<span class="token punctuation">(</span><span class="token string">&quot;我是黑马程序员的一匹黑马&quot;</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span>terms1<span class="token punctuation">.</span>asScala<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>word<span class="token punctuation">.</span>trim<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">//00:00:00 2982199073774412 [360安全卫士]  8 3  download.it.com.cn/softweb/software/firewall/antivirus/20067/17938.html</span>
    <span class="token keyword">val</span> arr<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token triple-quoted-string string">&quot;&quot;&quot;00:00:00 2982199073774412 [360安全卫士]  8 3  download.it.com.cn/softweb/software/firewall/antivirus/20067/17938.html&quot;&quot;&quot;</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span>arr<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replaceAll<span class="token punctuation">(</span><span class="token string">&quot;\\[|\\]&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//360安全卫士</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><ul><li>搜索关键词统计</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase<span class="token punctuation">.</span>pro</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hankcs<span class="token punctuation">.</span>hanlp<span class="token punctuation">.</span></span>HanLP
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>hankcs<span class="token punctuation">.</span>hanlp<span class="token punctuation">.</span>seg<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span>Term
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span></span>JavaConverters<span class="token punctuation">.</span>_
<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable</span>

<span class="token comment">/**
 * DESC:
 * 首先完成搜狗词库的数据读取
 * 1-创建SparkContext
 * 2-读取数据
 */</span>
<span class="token keyword">object</span> _04SougouCount <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-创建SparkContext</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      sc
    <span class="token punctuation">}</span>
    <span class="token comment">//2-读取数据</span>
    <span class="token keyword">val</span> sougouRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/sougu/SogouQ.reduced&quot;</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">&quot;sougouRDD count value is:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">sougouRDD<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span> <span class="token comment">//1724264</span>
    <span class="token comment">//3-引入样例类，可以基于样例类更好解析各个搜狗的字段</span>
    <span class="token keyword">val</span> recordRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span>SogouRecord<span class="token punctuation">]</span> <span class="token operator">=</span> sougouRDD
      <span class="token comment">//这里的过滤需要处理，需要对有缺失字段的需要使用length判断长度</span>
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>line <span class="token keyword">=&gt;</span> line <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">.</span>trim<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>mapPartitions<span class="token punctuation">(</span>iter <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        iter<span class="token punctuation">.</span>map<span class="token punctuation">(</span>record <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">val</span> arr<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> record<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span>
          SogouRecord<span class="token punctuation">(</span>arr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replaceAll<span class="token punctuation">(</span><span class="token string">&quot;\\[|\\]&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">//打印信息</span>
    recordRDD<span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//SogouRecord(00:00:00,2982199073774412,360安全卫士,8,3,download.it.com.cn/softweb/software/firewall/antivirus/20067/17938.html)</span>
    <span class="token comment">//SogouRecord(00:00:00,07594220010824798,哄抢救灾物资,1,1,news.21cn.com/social/daqian/2008/05/29/4777194_1.shtml)</span>
    <span class="token comment">//3-搜索关键词统计</span>
    <span class="token keyword">val</span> valueRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> recordRDD<span class="token punctuation">.</span>mapPartitions<span class="token punctuation">(</span>iter <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      iter<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>record <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> terms<span class="token operator">:</span> util<span class="token punctuation">.</span>List<span class="token punctuation">[</span>Term<span class="token punctuation">]</span> <span class="token operator">=</span> HanLP<span class="token punctuation">.</span>segment<span class="token punctuation">(</span>record<span class="token punctuation">.</span>queryWords<span class="token punctuation">)</span>
        terms<span class="token punctuation">.</span>asScala<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>word<span class="token punctuation">.</span>trim<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//end  mappartition</span>
    <span class="token comment">//valueRDD.take(5).foreach(println(_))</span>
    <span class="token keyword">val</span> keyWordCount<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> valueRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span><span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;========搜索关键词统计============&quot;</span><span class="token punctuation">)</span>
    keyWordCount<span class="token punctuation">.</span>take<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//(+,193939)</span>
    <span class="token comment">//(的,93246)</span>
    <span class="token comment">//(.,90985)</span>
    <span class="token comment">//(地震,88451)</span>
    <span class="token comment">//(救灾,69662)</span>
    

  sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><h3 id="rdd依赖关系"><a href="#rdd依赖关系" class="header-anchor">#</a> RDD依赖关系</h3> <p>案例</p> <ul><li><img src="./assets/img/image-20210330152344108.583b71b8.png" alt="image-20210330152344108"></li> <li><img src="./assets/img/image-20210330152626009.ae1cde96.png" alt="image-20210330152626009"></li> <li><img src="./assets/img/image-20210330152727589.18cd9c55.png" alt="image-20210330152727589"></li> <li><img src="./assets/img/image-20210330152828890.c1b2b66d.png" alt="image-20210330152828890"></li></ul> <h4 id="为什么有依赖"><a href="#为什么有依赖" class="header-anchor">#</a> 为什么有依赖</h4> <ul><li><p>原因有哪些？</p> <ul><li>1-依赖关系可以进行RDD的<strong>容错</strong>，某一个RDD出错，可以顺着依赖链重建RDD</li> <li>2-RDD的依赖可以构建RDD的血缘关系，也是方便容错</li> <li>3-依赖关系是为了RDD实现并行计算的,只有shuffle依赖无法实现并行计算</li></ul> <p><strong>相邻两个RDD的关系称之为依赖关系，多个连续的RDD的依赖关系，称之为血缘</strong></p></li> <li><p>依赖关系是Spark借助于DAG有向无环图实现的RDD的容错方法，基于依赖关系构建RDD或Spark的血缘关系</p></li></ul> <h4 id="依赖关系分为几类"><a href="#依赖关系分为几类" class="header-anchor">#</a> 依赖关系分为几类？</h4> <ul><li><p><img src="./assets/img/image-20210330153013442.f3d831a3.png" alt="image-20210330153013442"></p></li> <li></li> <li><img src="./assets/img/image-20210330153819152.2284cb1d.png" alt="image-20210330153819152" style="zoom:150%;"></li> <li><p>窄依赖：</p> <ul><li>一个子RDD依赖于一个父RDD，就是窄依赖(错误)</li> <li>一个父RDD对应一个子RDD，就是窄依赖</li></ul></li> <li><p>宽依赖：</p> <ul><li><strong>一个子RDD依赖于多个父RDD，就是宽依赖</strong>(错误)</li> <li>一个父RDD对应多个子RDD，就是宽依赖</li></ul></li> <li><p>shuffle</p> <ul><li>发生宽依赖，重新分桶，一定会伴随shuffle，但是发生shuffle不一定是宽依赖，比如缩减到一个分区。所有父RDD都只有这个子RDD，窄依赖的父RDD是干爹之一就会shuffle，否则不会。</li></ul></li> <li><p>总结：</p> <ul><li><strong>区分宽依赖还是窄依赖，看父RDD会不会被子RDD分享，被分享就是宽依赖，否则就是窄依赖。</strong></li> <li><strong>区分是否发生shuffle,父RDD的数据会不会被重新分桶</strong>(分到一个或多个桶,可能shuffle前后分区数一样.)</li></ul></li></ul> <h3 id="rdd缓存"><a href="#rdd缓存" class="header-anchor">#</a> RDD缓存</h3> <ul><li>什么是缓存
<ul><li>Spark速度非常快的原因之一，就是在不同操作中可以在内存中持久化或者缓存数据集。</li></ul></li> <li><strong>为什么需要缓存？</strong> <ul><li>对于某些比较<strong>昂贵的算子</strong>可以将计算结果缓存起来，重复利用<strong>加快计算速度</strong></li> <li>如果将数据缓存起来可以进行<strong>容错</strong>，因为缓存可以将数据保存在内存或磁盘中</li></ul></li> <li><strong>缓存有几种分类？</strong> <ul><li>两种：Cache和Persist</li> <li>缓存的级别有哪些？
<ul><li><img src="./assets/img/image-20210330160907938.095e1c2b.png" alt="image-20210330160907938"></li> <li><img src="./assets/img/image-20210330161116768.08243639.png" alt="image-20210330161116768"></li> <li>1-内存</li> <li>2-磁盘</li> <li>3-堆外内存(off_heap，不受限于jvm管理)</li> <li>4-序列化---网络传输</li> <li>5-副本---容错</li></ul></li></ul></li> <li>缓存如何选择？
<ul><li><strong>尽量选择内存，如果内存放不下可以尝试序列化，除非算子昂贵可以放在磁盘，如果容错恢复增加副本机制</strong></li> <li><img src="./assets/img/image-20210330163924968.97b6a3bd.png" alt="image-20210330163924968"></li></ul></li> <li>缓存怎么使用？
<ul><li>cache</li> <li>persist</li> <li>unpersist</li> <li>经过缓存的数据明显加快计算速度，一般用于昂贵算子，如shuffle算子的缓存</li> <li><img src="./assets/img/image-20210330164755248.b5ddd854.png" alt="image-20210330164755248"></li></ul></li> <li>缓存有什么问题？
<ul><li>缓存的数据可能存在丢失的情况，考虑使用非易失介质如HDFS分布式文件系统</li> <li>引出checkpoint检查点机制</li></ul></li></ul> <h3 id="rdd的checkpoint"><a href="#rdd的checkpoint" class="header-anchor">#</a> RDD的CheckPoint</h3> <ul><li>什么是checkpoint机制？
<ul><li>checkpoint是Spark的重要<strong>容错</strong>机制</li> <li>因为cache或persist会存在丢失缓存数据的情况，所以提出检查点机制，将数据放在HDFS中，之后就可以从checkpoint所保存的HDFS路径中读取</li></ul></li> <li>检查点机制的基本原理？
<ul><li>Checkpoint会<strong>斩断依赖链</strong>,因为Checkpoint会把结果保存在HDFS这类存储中,更加的<strong>安全可靠,一般不需要回溯依赖链</strong>,而cache和persist不会斩断依赖链.</li></ul></li> <li>怎么使用checkpoint检查点机制？
<ul><li>sc.setCheckpontDir(“hdfs:///”)设置将RDD的依赖关系保存在HDFS的那个路径中</li> <li>rdd1.checkpoint() 将rdd保存在上述设置的HDFS中</li></ul></li> <li><strong>checkpoint和缓存的区别和联系？</strong></li> <li><img src="spark.assets/image-20210330165819518.png" alt="image-20210330165819518" style="zoom:150%;"></li> <li>实验：</li> <li><img src="./assets/img/image-20210330170522925.e1cf860d.png" alt="image-20210330170522925"></li> <li><img src="./assets/img/image-20210330170710829.1f840101.png" alt="image-20210330170710829"></li> <li><img src="./assets/img/image-20210330171115309.a0b463a0.png" alt="image-20210330171115309"></li> <li><img src="./assets/img/image-20210330170926310.7b67cfd5.png" alt="image-20210330170926310"></li> <li>如果删除checkpoint的一个hdfs文件，会报错，文件不存在</li> <li><img src="./assets/img/image-20210330171438109.f54f427b.png" alt="image-20210330171438109"></li> <li>Spark如何实现容错机制的？思考
<ul><li>结果：</li> <li>1-如果Spark中将数据缓存在内存中，也就是cache和persist，首先从内存中寻找这部分数据</li> <li>2-如果内存没有数据的话，再从checkpoint所保存的HDFS中寻找</li> <li>3-如果上述都没有做，直接利用RDD的血缘关系实现容错，也就是重复从rdd1计算得到rdd2在得到rdd3</li> <li>分析：</li> <li><img src="./assets/img/image-20210330172853037.fbec4de5.png" alt="image-20210330172853037"></li> <li>源码</li> <li><img src="./assets/img/image-20210330173603330.c13a9103.png" alt="image-20210330173603330"></li> <li><img src="./assets/img/image-20210330173716229.af54061d.png" alt="image-20210330173716229"></li> <li><img src="./assets/img/image-20210330173653892.c36fc45c.png" alt="image-20210330173653892"></li> <li><img src="./assets/img/image-20210330173333510.f4528c3c.png" alt="image-20210330173333510"></li> <li><img src="./assets/img/image-20210330173515971.d511f683.png" alt="image-20210330173515971"></li> <li>完成</li></ul></li></ul> <h3 id="rdd的dag"><a href="#rdd的dag" class="header-anchor">#</a> RDD的DAG</h3> <ul><li><p><img src="./assets/img/image-20230226004638330.22a906d9.png" alt="image-20230226004638330"></p></li> <li><img src="./assets/img/image-20210330155143975.e8ccc450.png" alt="image-20210330155143975" style="zoom:150%;"></li> <li><p>为什么需要有DAG？</p> <ul><li>Spark作为第三代计算引擎，通过有向无环图构建Spark的任务。</li></ul></li> <li><p>什么是DAG？</p> <ul><li>有向无环图，Spark或Impala或Flink都是基于DAG构建任务</li> <li>通过4040端口查看DAG有向无环图</li></ul></li> <li><p>DAG<strong>如何划分Stage</strong>？</p> <ul><li><strong>划分Stages的依据是发生宽依赖</strong>，从当前job的最后一个算子往前推，遇到宽依赖，那么当前在这个批次中的所有算子操作都划分成一个stage</li></ul></li> <li><p>DAG划分Stage优势是什么？</p> <ul><li><strong>同一个Stage内可以并行计算，这样能够加快计算速度</strong></li></ul></li></ul> <p><strong>Spark调度流程分析</strong></p> <p><strong>spark的调度分为资源申请和任务调度。</strong></p> <p>如下图 1~10为资源申请，12~19为任务调度。</p> <p>12其实在driver启动后初始化就创建了DAGSchedluer和TaskScheduler，TaskScheduler通过后台进程去向ResourceManager申请资源。</p> <ul><li><img src="./assets/img/b6812fd9592e46c483f8f64fc50e6ad2.4728a096.jpg" alt="img"></li></ul> <p><strong>粗粒度资源申请(Spark）</strong></p> <p>在<strong>Application执行之前，将所有的资源申请完毕，当资源申请成功后，才会进行任务的调度，当所有的task执行完成后，才会释放这部分资源。</strong></p> <p>优点：在Application执行之前，所有的资源都申请完毕，每一个task运行时直接使用资源就可以了，不需要task运行时在执行前自己去申请资源，task启动就快了，task执行快了，stage执行就快了，job就快了，application执行就快了。</p> <p>缺点：直到最后一个task执行完成才会释放资源，集群的资源无法充分利用。当数据倾斜时更严重。</p> <p>细粒度资源申请（MapReduce）</p> <p>Application执行之前不需要先去申请资源，而是直接执行，让job中的每一个task在执行前自己去申请资源，task执行完成就释放资源。</p> <p>优点：集群的资源可以充分利用。</p> <p>缺点：task自己去申请资源，task启动变慢，Application的运行就相应的变慢了。</p> <h3 id="共享变量"><a href="#共享变量" class="header-anchor">#</a> 共享变量</h3> <h4 id="广播变量"><a href="#广播变量" class="header-anchor">#</a> 广播变量</h4> <ul><li><img src="./assets/img/image-20210331095314132.cf3f53b7.png" alt="image-20210331095314132" style="zoom:150%;"></li> <li><img src="./assets/img/image-20210331095257535.9f9eb4a5.png" alt="image-20210331095257535" style="zoom:150%;"></li> <li><p>关键点：</p></li> <li><p>1-广播变量，是在driver端定义的，executor端拥有副本，在executor端是不能改变广播变量的值</p></li> <li><p>2-广播变量获取的时候是从BlockManager中获取数据，如果本地没有从Driver端获取变量副本</p></li> <li><p>3-如何使用：sc.broadcast(map.collect)</p></li> <li><p>案例：</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase<span class="token punctuation">.</span>base</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span></span>Broadcast
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">object</span> _04broadcast <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token comment">//申请资源</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span>SparkContext<span class="token operator">=</span><span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      sc
    <span class="token punctuation">}</span>
    <span class="token comment">//创建RDD</span>
    <span class="token keyword">val</span> kvFruit<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>List<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;apple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;orange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;banana&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">&quot;grape&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> fruitMap<span class="token operator">:</span> collection<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span>kvFruit<span class="token punctuation">.</span>collectAsMap
    <span class="token comment">//fruitMap.foreach(println(_))</span>
    <span class="token comment">//需求：根据水果的编号查找水果的名称</span>
    <span class="token keyword">val</span> fruitsIds<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fruitsIds<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>fruitMap<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//改进：如果水果很多，那么每个水果都需要拉取fruitMap变量进行对比得到水果名称</span>
    <span class="token keyword">val</span> broadMap<span class="token operator">:</span> Broadcast<span class="token punctuation">[</span>collection<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>fruitMap<span class="token punctuation">)</span>
    fruitsIds<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>broadMap<span class="token punctuation">.</span>value<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//orange</span>
    <span class="token comment">//grape</span>
    <span class="token comment">//apple</span>
    <span class="token comment">//banana</span>
    sc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h4 id="累加器"><a href="#累加器" class="header-anchor">#</a> 累加器</h4> <ul><li>共享变量-累加器：</li></ul> <blockquote><p>Accumulator只提供了累加的功能，只能累加，不能减少。</p></blockquote> <blockquote><p>累加器只能在Driver端构建，并只能从Driver端读取结果，在Task端只能进行累加。</p></blockquote> <ul><li>scala的累加</li> <li>rdd的累加问题</li> <li>累加器</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase<span class="token punctuation">.</span>base</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>LongAccumulator
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Accumulator<span class="token punctuation">,</span> SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">object</span> _05accumulate <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//申请资源</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      sc
    <span class="token punctuation">}</span>
    <span class="token comment">//scala的加法</span>
    <span class="token keyword">var</span> counter1 <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">val</span> seq <span class="token operator">=</span> Seq<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    seq<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> counter1 <span class="token operator">+=</span> x<span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;counter result is:&quot;</span> <span class="token operator">+</span> counter1<span class="token punctuation">)</span>
    <span class="token comment">//rdd的加法-0--为什么会出现现象？因为变量在driver端定义，将数据发送到executor执行累加，但是执行完累加后结果并没返回driver</span>
    <span class="token keyword">var</span> counter2 <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">val</span> rdd1<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span>seq<span class="token punctuation">)</span>
    rdd1<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> counter2 <span class="token operator">+=</span> x<span class="token punctuation">)</span>
    println<span class="token punctuation">(</span>counter2<span class="token punctuation">)</span>
    <span class="token comment">//提出了在driver端和executor端共享当前变量</span>
    <span class="token comment">//累加器也是在action操作的时候触发</span>
    <span class="token keyword">val</span> acc<span class="token operator">:</span> Accumulator<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>accumulator<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    rdd1<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>acc<span class="token operator">+=</span>x<span class="token punctuation">)</span>
    println<span class="token punctuation">(</span>acc<span class="token punctuation">)</span>
    <span class="token comment">//sc.accumulator该方法2.0已经弃用，可以直接使用sc.longAccumulator</span>
    <span class="token keyword">val</span> acc_count<span class="token operator">:</span> LongAccumulator <span class="token operator">=</span> sc<span class="token punctuation">.</span>longAccumulator<span class="token punctuation">(</span><span class="token string">&quot;acc_count&quot;</span><span class="token punctuation">)</span>
    rdd1<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>x<span class="token keyword">=&gt;</span>acc_count<span class="token punctuation">.</span>add<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span>acc_count<span class="token punctuation">)</span><span class="token comment">//LongAccumulator(id: 51, name: Some(acc_count), value: 6)</span>
    println<span class="token punctuation">(</span>acc_count<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p><strong>累加器重复累加问题</strong></p> <p>Spark中的一系列transform操作都会构造成一长串的任务链，此时就需要通过一个action操作来触发（lazy的特性），accumulator也是如此。</p> <p>因此在一个action操作之后，调用value方法查看，是没有任何变化</p> <p>第一次action操作之后，调用value方法查看，变成了5</p> <p>第二次action操作之后，调用value方法查看，变成了10</p> <p>原因就在于第二次action操作的时候，又执行了一次累加器的操作，同个累加器，在原有的基础上又加了5，从而变成了10</p> <p>解决方案<br>
通过上述的现象描述，我们可以很快知道解决的方法：只进行一次action操作。基于此，我们只要避免重复计算（网上很多说法是说斩断依赖链，cache不会斩断依赖链，容错或者重复调用会依次判断内存、checkpoint里面有没有，没有才会根据依赖链重复计算），即使用cache、persist。这样操作之后，那么后续的累加器操作就不会重复累加。</p> <p><strong>共享变量案例</strong></p> <ul><li><p>需求：包括非单词组合，统计数据词频时过滤非单词的符合并且统计总的格式。</p></li> <li><p>分析：首先过滤单词，词频统计、</p></li> <li><p>步骤：</p> <ul><li>1-读取数据</li> <li>2-使用广播变量，定义的一组非单词组合的list或map广播到executor执行</li> <li>2-过滤出来，使用累加器统计非单词的组合</li> <li>3-使用wordcout统计单词综合</li></ul></li> <li><p>代码</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase<span class="token punctuation">.</span>base</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>broadcast<span class="token punctuation">.</span></span>Broadcast
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>LongAccumulator
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{</span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * * 1-读取数据
 * * 2-使用广播变量，定义的一组非单词组合的list或map广播到executor执行
 * * 2-过滤出来，使用累加器统计非单词的组合
 * * 3-使用wordcout统计单词综合
 */</span>
<span class="token keyword">object</span> _06acc_broadcast <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//申请资源</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      sc
    <span class="token punctuation">}</span>
    <span class="token comment">// 1-读取数据</span>
    <span class="token comment">//定义广播变量，因为每个单词都需要查看是否是费单词序列</span>
    <span class="token keyword">val</span> list<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;#&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;%&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> broadcastList<span class="token operator">:</span> Broadcast<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>broadcast<span class="token punctuation">(</span>list<span class="token punctuation">)</span>
    <span class="token comment">//定义累加器</span>
    <span class="token keyword">val</span> acc_count<span class="token operator">:</span> LongAccumulator <span class="token operator">=</span> sc<span class="token punctuation">.</span>longAccumulator<span class="token punctuation">(</span><span class="token string">&quot;acc_count&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/words1.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> wordscount<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> fileRDD
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>line <span class="token keyword">=&gt;</span> line <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">.</span>trim<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>line <span class="token keyword">=&gt;</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>word <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> listValue<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> broadcastList<span class="token punctuation">.</span>value
        <span class="token keyword">val</span> isFlag<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> listValue<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>word<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          acc_count<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token operator">!</span>isFlag
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 2-使用广播变量，定义的一组非单词组合的list或map广播到executor执行</span>
    <span class="token comment">// 2-过滤出来，使用累加器统计非单词的组合</span>
    <span class="token comment">// 3-使用wordcout统计单词综合</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;wordcount的结果&quot;</span><span class="token punctuation">)</span>
    wordscount<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>println<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;非单词的组合：&quot;</span><span class="token punctuation">,</span> acc_count<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><ul><li><p><img src="./assets/img/image-20210331103425594.5bf0967b.png" alt="image-20210331103425594"></p></li> <li><p>通过睡眠Thread.sleep睡眠查看WebUi</p></li></ul> <h3 id="kyro序列化"><a href="#kyro序列化" class="header-anchor">#</a> Kyro序列化</h3> <ul><li><p><img src="./assets/img/image-20210331112703791.e26d8b98.png" alt="image-20210331112703791"></p></li> <li><p><img src="./assets/img/image-20210331112802475.3d0d6db9.png" alt="image-20210331112802475"></p></li> <li><p>什么kyro序列化？</p></li> <li><p><img src="./assets/img/image-20210331113025537.e0563492.png" alt="image-20210331113025537"></p></li> <li><p><img src="./assets/img/image-20210331113420186.eab20a3a.png" alt="image-20210331113420186"></p></li> <li><p>如何使用kryo序列化？</p></li> <li><p><img src="./assets/img/image-20210331113605232.3c97ca9e.png" alt="image-20210331113605232"></p></li> <li><p>kryo序列化是java序列化的10x，kryo序列化并不是支持所有的类型，对于一部分类型需要注册，其他基础类直接设置</p></li> <li><p><img src="./assets/img/20200430105422254.3fdbbcbe.png" alt="img"></p></li> <li><p>配置说明：</p></li></ul> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">  1.</span> <span class="token value attr-value">spark.serializer：序列化时用的类，需要申明为org.apache.spark.serializer.KryoSerializer。这个设置不仅控制各个worker节点之间的混洗数据序列化格式，同时还控制RDD存到磁盘上的序列化格式及广播变量的序列化格式。</span>
<span class="token key attr-name">  2.</span> <span class="token value attr-value">spark.kryoserializer.buffer：每个Executor中的每个core对应着一个序列化buffer。如果你的对象很大，可能需要增大该配置项。其值不能超过spark.kryoserializer.buffer.max</span>
<span class="token key attr-name">  3.</span> <span class="token value attr-value">spark.kryoserializer.buffer.max：允许使用序列化buffer的最大值</span>
<span class="token key attr-name">  4.</span> <span class="token value attr-value">spark.kryo.classesToRegister：向Kryo注册自定义的的类型，类名间用逗号分隔</span>
<span class="token key attr-name">  5.</span> <span class="token value attr-value">spark.kryo.referenceTracking：跟踪对同一个对象的引用情况，这对发现有循环引用或同一对象有多个副本的情况是很有用的。设置为false可以提高性能</span>
<span class="token key attr-name">  6.</span> <span class="token value attr-value">spark.kryo.registrationRequired：是否需要在Kryo登记注册？如果为true，则序列化一个未注册的类时会抛出异常</span>
<span class="token key attr-name">  7.</span> <span class="token value attr-value">spark.kryo.registrator：为Kryo设置这个类去注册你自定义的类。最后，如果你不注册需要序列化的自定义类型，Kryo也能工作，不过每一个对象实例的序列化结果都会包含一份完整的类名，这有点浪费空间</span>
<span class="token key attr-name">  8.</span> <span class="token value attr-value">spark.kryo.unsafe：如果想更加提升性能，可以使用Kryo unsafe方式</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>kryo的使用</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token comment">//刚开始的时候一直序列化不成功，应该是找不到类，java+scala混编，把scala设置成src了，去掉pom的这个配置就可以了。</span>
  <span class="token comment">//第一种方式</span>
  <span class="token comment">//实现一个KryoRegistrator注册类，在该类里面对自定义的序列化类进行注册，然后在conf里面配置该类</span>
  public <span class="token keyword">class</span> MyKryoRegistrator implements KryoRegistrator <span class="token punctuation">{</span>
      <span class="token annotation punctuation">@Override</span>
      public void registerClasses<span class="token punctuation">(</span> Kryo kryo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          kryo<span class="token punctuation">.</span>register<span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          kryo<span class="token punctuation">.</span>register<span class="token punctuation">(</span>User<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          kryo<span class="token punctuation">.</span>register<span class="token punctuation">(</span>scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>convert<span class="token punctuation">.</span>Wrappers$<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@Data</span>
  public <span class="token keyword">class</span> User implements Serializable <span class="token punctuation">{</span>
          int id<span class="token punctuation">;</span>
          <span class="token builtin">String</span> name<span class="token punctuation">;</span>
          <span class="token builtin">String</span> city<span class="token punctuation">;</span>
          List<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hobby<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">//  在conf配置如下</span>
  <span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">)</span>
        conf
        <span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">&quot;spark.serializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.spark.serializer.KryoSerializer&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">&quot;spark.kryo.registrationRequired&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">&quot;spark.kryo.registrator&quot;</span><span class="token punctuation">,</span>classOf<span class="token punctuation">[</span>MyKryoRegistrator<span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
      
  
      <span class="token keyword">val</span> sc <span class="token operator">=</span> <span class="token keyword">new</span> SparkContext<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
  
  <span class="token comment">//第二种方式</span>
   conf
        <span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">&quot;spark.serializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.spark.serializer.KryoSerializer&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>registerKryoClasses<span class="token punctuation">(</span>Array<span class="token punctuation">(</span>classOf<span class="token punctuation">[</span>User<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>声明序列化为kryo</p> <p><img src="./assets/img/image-20230227033247178.24b4e860.png" alt="image-20230227033247178"></p> <p><img src="./assets/img/image-20230227032331056.2476ee08.png" alt="image-20230227032331056"></p> <p><img src="./assets/img/image-20230226164309634.669da0b7.png" alt="image-20230226164309634"></p> <p><img src="./assets/img/image-20230227042540983.48d040ec.png" alt="image-20230227042540983"></p> <p><strong>扩展2：groupBy什么时候是窄依赖或宽依赖？</strong></p> <ul><li><p><img src="./assets/img/image-20210331114250206.99fe34e6.png" alt="image-20210331114250206"></p></li> <li><p><img src="./assets/img/image-20210331114434517.bf7d5ab8.png" alt="image-20210331114434517"></p></li></ul> <h3 id="内存模型"><a href="#内存模型" class="header-anchor">#</a> 内存模型</h3> <ul><li><img src="./assets/img/image-20210331114727741.b3e73255.png" alt="image-20210331114727741"></li> <li>问题1：</li> <li><img src="./assets/img/image-20210331114934684.01ce3f20.png" alt="image-20210331114934684"></li> <li>Spark和Flink不一样，Flink的内存对用户无法操作，Spark的内存用户可以配置</li> <li>SparkCore的内存模型</li> <li><img src="./assets/img/image-20210331115357701.28258def.png" alt="image-20210331115357701"></li> <li>问题2：</li> <li><img src="./assets/img/image-20210331115548422.0f2765e0.png" alt="image-20210331115548422"></li> <li><img src="./assets/img/image-20210331115616734.40655e12.png" alt="image-20210331115616734"></li> <li><img src="./assets/img/image-20210331115812793.0c8d9e52.png" alt="image-20210331115812793"></li> <li><img src="./assets/img/image-20210331120038457.af56ac49.png" alt="image-20210331120038457"></li> <li><img src="./assets/img/image-20210331120334511.ed15fe57.png" alt="image-20210331120334511"></li></ul> <h3 id="spark的shuffle"><a href="#spark的shuffle" class="header-anchor">#</a> Spark的shuffle</h3> <ul><li><p>Spark不同版本的shuffle</p> <ul><li>1.2之前HashShuffleManager</li> <li>1.2之后SortShuffleManager</li></ul></li> <li><p>Shuffle阶段</p> <ul><li>shuffle write：mapper阶段，上一个stage得到最后的结果写出<br>
shuffle read ：reduce阶段，下一个stage拉取上一个stage进行合并</li></ul></li> <li><p>HashShuffleManager</p> <ul><li>未经优化的hashShuffleManager</li> <li><img src="spark.assets/image-20210331121139637.png" alt="image-20210331121139637" style="zoom:150%;"></li> <li>优化的hashShuffleManager
<ul><li>shuffleFileGroup</li></ul></li> <li><img src="spark.assets/image-20210331121322477-1622994367239.png" alt="image-20210331121322477" style="zoom:150%;"></li></ul></li></ul> <p><img src="./assets/img/image-20210331121322477.45c95cdf.png" alt="image-20210331121322477"></p> <img src="spark.assets/image-20210331121405820.png" alt="image-20210331121405820" style="zoom:150%;"> <ul><li><p>SortShuffleManager</p> <ul><li><p><img src="./assets/img/image-20210331121523379.a1e93757.png" alt="image-20210331121523379"></p></li> <li><p>bypassMerge机制</p> <ul><li>shuffle write task的数量小于等于spark.shuffle.sort.bypassMergeThreshold参数的值时(****默认为200****)</li> <li>不能是聚合类的算子，比如reduceByKey，本质是map side combine是否为true</li> <li><img src="./assets/img/image-20230328233608398.506ac6f7.png" alt="image-20230328233608398"></li></ul></li> <li><p>普通机制</p> <ul><li><img src="spark.assets/image-20210331122648578.png" alt="image-20210331122648578" style="zoom:150%;"></li> <li><p>（1）该模式下，数据会先写入一个内存数据结构中(默认5M)，此时根据不同的shuffle算子，可能选用不同的数据结构。如果是reduceByKey这种聚合类的shuffle算子，那么会选用Map数据结构，一边通过Map进行聚合，一边写入内存;如果是join这种普通的shuffle算子，那么会选用Array数据结构，直接写入内存。</p> <p>（2）   接着，每写一条数据进入内存数据结构之后，就会判断一下，是否达到了某个临界阈值。如果达到临界阈值的话，那么就会尝试将内存数据结构中的数据溢写到磁盘，然后清空内存数据结构。</p> <p>注意：</p> <p>shuffle中的定时器：定时器会检查内存数据结构的大小，如果内存数据结构空间不够，那么会申请额外的内存，申请的大小满足如下公式：</p> <p>applyMemory=nowMenory*2-oldMemory</p> <p>申请的内存=当前的数据内存情况*2-上一次的内嵌情况</p> <p>意思就是说内存数据结构的大小的动态变化，如果存储的数据超出内存数据结构的大小，将申请内存数据结构存储的数据*2-内存数据结构的设定值的内存大小空间。申请到了，内存数据结构的大小变大，内存不够，申请不到，则发生溢写。</p> <p>由于Spark是一个内存计算框架，没有办法严格控制Executor内存，只能采用监控方式监控内存，内存初始值为5M，当超出的时候，如5.02M，监控内存数据的对象会去申请5.02*2-5=5.04M内存，如果申请到了就不需要溢写，否则会发生溢写。</p> <p>区别：</p> <p>（a）Spark内存数据初始值为5M，他可以申请扩大，而MR固定的Buffer为100M</p> <p>（b）溢写磁盘文件还带有索引文件，索引文件是对磁盘文件的描述，还记录每个分区的起始位置<strong>start offset</strong>和终止位置<strong>end offset</strong>。</p> <p>（3）排序</p> <p>在溢写到磁盘文件之前，会先根据key对内存数据结构中已有的数据进行排序。</p> <p>（4）溢写</p> <p>排序过后，会分批将数据写入磁盘文件。默认的batch数量是10000条，也就是说，排序好的数据，会以每批1万条数据的形式分批写入磁盘文件。写入磁盘文件是通过<a href="https://www.2cto.com/kf/ware/Java/" target="_blank" rel="noopener noreferrer">Java<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的BufferedOutputStream实现的。BufferedOutputStream是Java的缓冲输出流，首先会将数据缓冲在内存中，当内存缓冲满溢之后再一次写入磁盘文件中，这样可以减少磁盘IO次数，提升性能。</p> <p>（5）merge</p> <p><strong>一个task</strong>将所有数据写入内存数据结构的过程中，会发生多次磁盘溢写操作，也就会产生多个临时文件。最后会将之前所有的临时磁盘文件都进行合并成1个磁盘文件，这就是merge过程，此时会将之前所有临时磁盘文件中的数据读取出来，然后依次写入最终的磁盘文件之中。此外，由于一个task就只对应一个磁盘文件，也就意味着该task为Reduce端的stage的task准备的数据都在这一个文件中，因此还会单独写一份索引文件，其中标识了下游各个task的数据在文件中的start offset与end offset。</p> <p>SortShuffleManager由于有一个磁盘文件merge的过程，因此大大减少了文件数量。比如第一个stage有50个task，总共有10个Executor，每个Executor执行5个task，而第二个stage有100个task。由于每个task最终只有一个磁盘文件，因此此时每个Executor上只有5个磁盘文件，所有Executor只有50个磁盘文件。</p></li></ul></li></ul></li></ul> <p><strong>bypass和普通机制的区别</strong></p> <p><strong>第一，磁盘写机制不同;</strong></p> <p><strong>第二，不会进行排序。也就是说，启用该机制的最大好处在于，shuffle write过程中，不需要进行数据的排序操作，也就节省掉了这部分的性能开销。</strong></p> <p>两个最终都是会产生2M(map task number)个磁盘小文件。</p> <p>**总结：**SortShuffle也分为普通机制和bypass机制，普通机制在内存数据结构(默认为5M)完成排序，而当shuffle map task数量小于spark.shuffle.sort.bypassMergeThreshold参数的值。或者算子不是聚合类的shuffle算子(比如reduceByKey)的时候会触发SortShuffle的bypass机制，SortShuffle的bypass机制不会进行排序，极大的提高了其性能。</p> <ul><li><p>页面监控：</p> <ul><li><img src="./assets/img/image-20210331123737378.993c5cc4.png" alt="image-20210331123737378"></li></ul></li> <li><p>补充：Shuffle类算子</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>下面列出Shuffle类不同分类算子
去重
<span class="token keyword">def</span> distinct<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> distinct<span class="token punctuation">(</span>numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span>
聚合
<span class="token keyword">def</span> reduceByKey<span class="token punctuation">(</span>func<span class="token operator">:</span> <span class="token punctuation">(</span>V<span class="token punctuation">,</span> V<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> V<span class="token punctuation">,</span> numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> reduceByKey<span class="token punctuation">(</span>partitioner<span class="token operator">:</span> Partitioner<span class="token punctuation">,</span> func<span class="token operator">:</span> <span class="token punctuation">(</span>V<span class="token punctuation">,</span> V<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> V<span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> groupBy<span class="token punctuation">[</span>K<span class="token punctuation">]</span><span class="token punctuation">(</span>f<span class="token operator">:</span> T <span class="token keyword">=&gt;</span> K<span class="token punctuation">,</span> p<span class="token operator">:</span> Partitioner<span class="token punctuation">)</span><span class="token operator">:</span>RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span>V<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> groupByKey<span class="token punctuation">(</span>partitioner<span class="token operator">:</span> Partitioner<span class="token punctuation">)</span><span class="token operator">:</span>RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> Iterable<span class="token punctuation">[</span>V<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> aggregateByKey<span class="token punctuation">[</span>U<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>zeroValue<span class="token operator">:</span> U<span class="token punctuation">,</span> partitioner<span class="token operator">:</span> Partitioner<span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> U<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> aggregateByKey<span class="token punctuation">[</span>U<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>zeroValue<span class="token operator">:</span> U<span class="token punctuation">,</span> numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> U<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> combineByKey<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">(</span>createCombiner<span class="token operator">:</span> V <span class="token keyword">=&gt;</span> C<span class="token punctuation">,</span> mergeValue<span class="token operator">:</span> <span class="token punctuation">(</span>C<span class="token punctuation">,</span> V<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> C<span class="token punctuation">,</span> mergeCombiners<span class="token operator">:</span> <span class="token punctuation">(</span>C<span class="token punctuation">,</span> C<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> C<span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> combineByKey<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">(</span>createCombiner<span class="token operator">:</span> V <span class="token keyword">=&gt;</span> C<span class="token punctuation">,</span> mergeValue<span class="token operator">:</span> <span class="token punctuation">(</span>C<span class="token punctuation">,</span> V<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> C<span class="token punctuation">,</span> mergeCombiners<span class="token operator">:</span> <span class="token punctuation">(</span>C<span class="token punctuation">,</span> C<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> C<span class="token punctuation">,</span> numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> combineByKey<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">(</span>createCombiner<span class="token operator">:</span> V <span class="token keyword">=&gt;</span> C<span class="token punctuation">,</span> mergeValue<span class="token operator">:</span> <span class="token punctuation">(</span>C<span class="token punctuation">,</span> V<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> C<span class="token punctuation">,</span> mergeCombiners<span class="token operator">:</span> <span class="token punctuation">(</span>C<span class="token punctuation">,</span> C<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> C<span class="token punctuation">,</span> partitioner<span class="token operator">:</span> Partitioner<span class="token punctuation">,</span> mapSideCombine<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> serializer<span class="token operator">:</span> Serializer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">]</span>
排序
<span class="token keyword">def</span> sortByKey<span class="token punctuation">(</span>ascending<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>partitions<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> sortBy<span class="token punctuation">[</span>K<span class="token punctuation">]</span><span class="token punctuation">(</span>f<span class="token operator">:</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> K<span class="token punctuation">,</span> ascending<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>partitions<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">implicit</span> ord<span class="token operator">:</span> Ordering<span class="token punctuation">[</span>K<span class="token punctuation">]</span><span class="token punctuation">,</span> ctag<span class="token operator">:</span> ClassTag<span class="token punctuation">[</span>K<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span>
重分区
<span class="token keyword">def</span> coalesce<span class="token punctuation">(</span>numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> shuffle<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> partitionCoalescer<span class="token operator">:</span> Option<span class="token punctuation">[</span>PartitionCoalescer<span class="token punctuation">]</span> <span class="token operator">=</span> Option<span class="token punctuation">.</span>empty<span class="token punctuation">)</span>
<span class="token keyword">def</span> repartition<span class="token punctuation">(</span>numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">implicit</span> ord<span class="token operator">:</span> Ordering<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
集合或者表操作
<span class="token keyword">def</span> intersection<span class="token punctuation">(</span>other<span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span>
<span class="token keyword">def</span> intersection<span class="token punctuation">(</span>other<span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span> partitioner<span class="token operator">:</span> Partitioner<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">implicit</span> ord<span class="token operator">:</span> Ordering<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span>
<span class="token keyword">def</span> intersection<span class="token punctuation">(</span>other<span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span> numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span>
<span class="token keyword">def</span> subtract<span class="token punctuation">(</span>other<span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span> numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span>
<span class="token keyword">def</span> subtract<span class="token punctuation">(</span>other<span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token operator">:</span> Partitioner<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">implicit</span> ord<span class="token operator">:</span> Ordering<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span>T<span class="token punctuation">]</span>
<span class="token keyword">def</span> subtractByKey<span class="token punctuation">[</span>W<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>other<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> subtractByKey<span class="token punctuation">[</span>W<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>other<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> subtractByKey<span class="token punctuation">[</span>W<span class="token operator">:</span> ClassTag<span class="token punctuation">]</span><span class="token punctuation">(</span>other<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token operator">:</span> Partitioner<span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> join<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">(</span>other<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> partitioner<span class="token operator">:</span> Partitioner<span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> <span class="token punctuation">(</span>V<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> join<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">(</span>other<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> <span class="token punctuation">(</span>V<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> join<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">(</span>other<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> numPartitions<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> <span class="token punctuation">(</span>V<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> leftOuterJoin<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">(</span>other<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> <span class="token punctuation">(</span>V<span class="token punctuation">,</span> Option<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><ul><li><p><em><strong>*spark.shuffle.file.buffer*</strong></em>  默认32K，调整64K</p></li> <li><p><em><strong>*spark.reducer.maxSizeInFlight：*</strong></em>  默认48M</p></li> <li><p><em><strong>*spark.shuffle.io.maxRetries*</strong></em> ：重试次数</p></li> <li><p>****spark.shuffle.io.retryWait：****：重试时间</p></li> <li><p>内存结构：Array和Map，5M</p></li> <li><p><img src="./assets/img/image-20210331145131584.d9904d70.png" alt="image-20210331145131584"></p></li> <li><img src="spark.assets/image-20210331145515423.png" alt="image-20210331145515423" style="zoom:150%;"></li> <li><p><img src="./assets/img/image-20210331145701303.cfdc175a.png" alt="image-20210331145701303"></p></li> <li><p><img src="./assets/img/image-20210331145919396.20726257.png" alt="image-20210331145919396"></p></li> <li><p><img src="./assets/img/image-20210331150250050.f2d9c6d7.png" alt="image-20210331150250050"></p></li> <li><img src="spark.assets/image-20210331150509308.png" alt="image-20210331150509308" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210331151039694.png" alt="image-20210331151039694" style="zoom:150%;"></li> <li><p><img src="./assets/img/image-20210331151711346.2d6ce79f.png" alt="image-20210331151711346"></p></li> <li><p>补充源码</p></li> <li><p><img src="./assets/img/image-20210331152346503.b950c113.png" alt="image-20210331152346503"></p></li> <li><p><img src="./assets/img/image-20210331152525171.755c85a2.png" alt="image-20210331152525171"></p></li> <li><p><img src="./assets/img/image-20210331152809557.c757a544.png" alt="image-20210331152809557"></p></li> <li><p><img src="./assets/img/image-20210331153110113.d87482c4.png" alt="image-20210331153110113"></p></li> <li><p><img src="./assets/img/image-20210331153933489.7f9988c5.png" alt="image-20210331153933489"></p></li></ul> <h2 id="sparksql引入"><a href="#sparksql引入" class="header-anchor">#</a> SparkSQL引入</h2> <ul><li>SparkCore撰写代码非常复杂，引入SparkSQL处理结构化数据</li> <li>SparkSQL基于Hive之上做了改进</li></ul> <h3 id="什么是sparksql"><a href="#什么是sparksql" class="header-anchor">#</a> 什么是sparksql</h3> <ul><li><img src="./assets/img/image-20210331160531652.2c311f73.png" alt="image-20210331160531652"></li> <li><img src="./assets/img/image-20210331160809716.cc2976ec.png" alt="image-20210331160809716"></li></ul> <h3 id="sparksql和hive的关系-发展历程"><a href="#sparksql和hive的关系-发展历程" class="header-anchor">#</a> SparkSQL和Hive的关系(发展历程)</h3> <ul><li><p>SparkSQL引入Hive的发展历程:</p> <ul><li><p>Hive</p></li> <li><img src="spark.assets/image-20210331161008605.png" alt="image-20210331161008605" style="zoom:150%;"></li> <li><p>Shark</p></li> <li><p><img src="spark.assets/image-20210331161309661.png" alt="image-20210331161309661" style="zoom:150%;">HQL on MapRedduce -&gt;</p> <p>HQL on MapReduce -&gt; HQL on Spark</p></li> <li><p>SparkSQL</p></li> <li><img src="./assets/img/image-20210331161546924.b4521814.png" alt="image-20210331161546924" style="zoom:150%;"></li> <li><p>历史发展</p></li></ul></li></ul> <h3 id="sparksql的数据结构"><a href="#sparksql的数据结构" class="header-anchor">#</a> SparkSQL的数据结构</h3> <ul><li><p>SparkCore数据结构：RDD</p></li> <li><p>SparkSQL数据结构：DataFrame和DataSet</p></li> <li><p>思考：三种数据结构关系</p></li> <li><img src="spark.assets/image-20210331162730736.png" alt="image-20210331162730736" style="zoom:150%;"> <p><strong>在2.0中DataFrame = DataSet[Row]</strong></p> <p><strong>DataFrame是在运行时候进行类型的检查，而Dataset是在编译的时候进行类型检查，DataSet安全性更好</strong></p></li></ul> <p><strong>SparkSQL的DataFrame创建的四种方法</strong></p> <ul><li>SparkSession=sqlcontext+hivecontext+sparkcontext</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkContext
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Dataset<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 使用SparkSession应用程序入口
 */</span>
<span class="token keyword">object</span> _01SparkSession <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//现在我们使用SparkSession</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//读取文件</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext
    sc<span class="token punctuation">.</span>setLogLevel<span class="token punctuation">(</span><span class="token string">&quot;WARN&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//</span>
    <span class="token keyword">val</span> valueDS<span class="token operator">:</span> Dataset<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/words.txt&quot;</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;counts:&quot;</span> <span class="token operator">+</span> valueDS<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ul><li><p>RDD转DF的方式</p></li> <li><p>1-RDD配合样例类实现转化为DF</p> <ul><li><img src="./assets/img/image-20210331165229535.7d197163.png" alt="image-20210331165229535"></li></ul></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkContext
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> People<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span>

<span class="token keyword">object</span> _02toDFWay1 <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//申请资源</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//For implicit conversions from RDDs to DataFrames</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//读取数据</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext
    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/sql/people1.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//切分后套入person类</span>
    <span class="token keyword">val</span> peopleRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span>People<span class="token punctuation">]</span> <span class="token operator">=</span> fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> People<span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//引入隐式反馈转化为df</span>
    <span class="token keyword">val</span> peopleDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> peopleRDD<span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//打印输出</span>
    peopleDF<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//+---+--------+---+</span>
    <span class="token comment">//| id|    name|age|</span>
    <span class="token comment">//+---+--------+---+</span>
    <span class="token comment">//|  1|zhangsan| 20|</span>
    <span class="token comment">//|  2|    lisi| 29|</span>
    <span class="token comment">//|  3|  wangwu| 25|</span>
    <span class="token comment">//如何打印scheme</span>
    peopleDF<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//root</span>
    <span class="token comment">// |-- id: integer (nullable = false)</span>
    <span class="token comment">// |-- name: string (nullable = true)</span>
    <span class="token comment">// |-- age: integer (nullable = false)</span>
    <span class="token comment">//关闭资源</span>
    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><ul><li><p>2-spark直接读取数据文件转化为DF(了解)</p> <ul><li><img src="./assets/img/image-20210331173050877.90169f33.png" alt="image-20210331173050877"></li> <li><img src="./assets/img/image-20210331173500656.9df427f6.png" alt="image-20210331173500656"></li> <li><img src="./assets/img/image-20210331173714098.9cb55419.png" alt="image-20210331173714098"></li></ul></li> <li><p>4-RDD配合Row+StructType转化为DF</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkContext
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataTypes<span class="token punctuation">,</span> StructType<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> Row<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 */</span>

<span class="token keyword">object</span> _04toDFWay3 <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//申请资源</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//For implicit conversions from RDDs to DataFrames</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//读取数据</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext
    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/sql/people1.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//一个row对象就是一行数据</span>
    <span class="token keyword">val</span> peopleRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span>Row<span class="token punctuation">]</span> <span class="token operator">=</span> fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> Row<span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//需要引入structedFiled</span>
    <span class="token keyword">val</span> schema<span class="token operator">:</span> StructType <span class="token operator">=</span> <span class="token keyword">new</span> StructType<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>IntegerType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;int&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">//打印输出</span>
    <span class="token keyword">val</span> peopleDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>peopleRDD<span class="token punctuation">,</span> schema<span class="token punctuation">)</span>
    peopleDF<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token comment">//+---+--------+---+</span>
    <span class="token comment">//| id|    name|age|</span>
    <span class="token comment">//+---+--------+---+</span>
    <span class="token comment">//|  1|zhangsan| 20|</span>
    <span class="token comment">//|  2|    lisi| 29|</span>
    <span class="token comment">//|  3|  wangwu| 25|</span>
    <span class="token comment">//如何打印scheme</span>
    peopleDF<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//root</span>
    <span class="token comment">// |-- id: integer (nullable = false)</span>
    <span class="token comment">// |-- name: string (nullable = true)</span>
    <span class="token comment">// |-- age: integer (nullable = false)</span>
    <span class="token comment">//关闭资源</span>
    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><ul><li>方式2</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkContext
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataTypes<span class="token punctuation">,</span> IntegerType<span class="token punctuation">,</span> LongType<span class="token punctuation">,</span> StringType<span class="token punctuation">,</span> StructField<span class="token punctuation">,</span> StructType<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> Row<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 */</span>

<span class="token keyword">object</span> _04toDFWay4 <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//申请资源</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//For implicit conversions from RDDs to DataFrames</span>
    <span class="token comment">//读取数据</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext
    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/sql/people1.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//一个row对象就是一行数据</span>
    <span class="token keyword">val</span> peopleRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span>Row<span class="token punctuation">]</span> <span class="token operator">=</span> fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> Row<span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//需要引入structedFiled</span>

    <span class="token comment">/* val schema: StructType = StructType(Array(
       StructField(&quot;id&quot;, DataTypes.IntegerType, true),
       StructField(&quot;name&quot;, DataTypes.StringType, true),
       StructField(&quot;age&quot;, DataTypes.IntegerType, true)
     ))*/</span>

    <span class="token keyword">val</span> schema<span class="token operator">:</span> StructType <span class="token operator">=</span> StructType<span class="token punctuation">(</span>
      StructField<span class="token punctuation">(</span><span class="token string">&quot;f1&quot;</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">::</span>
        StructField<span class="token punctuation">(</span><span class="token string">&quot;f2&quot;</span><span class="token punctuation">,</span> StringType<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">::</span>
        StructField<span class="token punctuation">(</span><span class="token string">&quot;f3&quot;</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">::</span>
        Nil<span class="token punctuation">)</span>
    <span class="token comment">//打印输出</span>
    <span class="token keyword">val</span> peopleDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>peopleRDD<span class="token punctuation">,</span> schema<span class="token punctuation">)</span>
    peopleDF<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token comment">//+---+--------+---+</span>
    <span class="token comment">//| id|    name|age|</span>
    <span class="token comment">//+---+--------+---+</span>
    <span class="token comment">//|  1|zhangsan| 20|</span>
    <span class="token comment">//|  2|    lisi| 29|</span>
    <span class="token comment">//|  3|  wangwu| 25|</span>
    <span class="token comment">//如何打印scheme</span>
    peopleDF<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//root</span>
    <span class="token comment">// |-- id: integer (nullable = false)</span>
    <span class="token comment">// |-- name: string (nullable = true)</span>
    <span class="token comment">// |-- age: integer (nullable = false)</span>
    <span class="token comment">//关闭资源</span>
    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><ul><li>5-直接toDF</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkContext
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 */</span>

<span class="token keyword">object</span> _03toDFWay2 <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//申请资源</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//For implicit conversions from RDDs to DataFrames</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//读取数据</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext
    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/sql/people1.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//切分后套入person类</span>
    <span class="token keyword">val</span> peopleRDD <span class="token operator">=</span> fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//引入隐式反馈转化为df</span>
    <span class="token keyword">val</span> peopleDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> peopleRDD<span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//打印输出</span>
    peopleDF<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//+---+--------+---+</span>
    <span class="token comment">//| id|    name|age|</span>
    <span class="token comment">//+---+--------+---+</span>
    <span class="token comment">//|  1|zhangsan| 20|</span>
    <span class="token comment">//|  2|    lisi| 29|</span>
    <span class="token comment">//|  3|  wangwu| 25|</span>
    <span class="token comment">//如何打印scheme</span>
    peopleDF<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//root</span>
    <span class="token comment">// |-- id: integer (nullable = false)</span>
    <span class="token comment">// |-- name: string (nullable = true)</span>
    <span class="token comment">// |-- age: integer (nullable = false)</span>
    <span class="token comment">//关闭资源</span>
    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><ul><li>补充：</li> <li><img src="spark.assets/image-20210331172635814.png" alt="image-20210331172635814" style="zoom:150%;"></li> <li>样例类的rdd到df使用比较多的，特别是字段多的时候</li> <li>如果需要动态增加字段，可以使用strucedType的方式</li></ul> <p><strong>SparkSQL的DataFrame的花式操作</strong></p> <p>DSL案例</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkContext
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> People1<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span>

<span class="token keyword">object</span> _06DataFrameOpration <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//申请资源</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//For implicit conversions from RDDs to DataFrames</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//读取数据</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext
    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/sql/people1.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//切分后套入person类</span>
    <span class="token keyword">val</span> peopleRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span>People1<span class="token punctuation">]</span> <span class="token operator">=</span> fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> People1<span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//引入隐式反馈转化为df</span>
    <span class="token keyword">val</span> peopleDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> peopleRDD<span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//打印输出</span>
    peopleDF<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//+---+--------+---+</span>
    <span class="token comment">//| id|    name|age|</span>
    <span class="token comment">//+---+--------+---+</span>
    <span class="token comment">//|  1|zhangsan| 20|</span>
    <span class="token comment">//|  2|    lisi| 29|</span>
    <span class="token comment">//|  3|  wangwu| 25|</span>
    <span class="token comment">//如何打印scheme</span>
    peopleDF<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//root</span>
    <span class="token comment">// |-- id: integer (nullable = false)</span>
    <span class="token comment">// |-- name: string (nullable = true)</span>
    <span class="token comment">// |-- age: integer (nullable = false)</span>
    <span class="token comment">//Spark中提供了查询的方式</span>
    <span class="token comment">//DSL基于领域查询语言</span>
    <span class="token comment">//需求1-能否将name字段筛选出来</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span>column<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token symbol">'name</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//需求2-能否将name，age字段筛选出来</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> col<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span>column<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> column<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token char">'name, '</span>age<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//组合写法</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> column<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token symbol">'age</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//peopleDF.select(&quot;name&quot;,'age).show()</span>
    <span class="token comment">//需求3-能否将age字段筛选出来+1</span>
    <span class="token comment">//peopleDF.select('name,'age+1).show()</span>
    <span class="token comment">//peopleDF.select(&quot;name&quot;,&quot;age&quot;+1).show()</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> col<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> column<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    peopleDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token char">'name, '</span>age <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//需求4：过滤age大于等于25的，使用filter方法过滤</span>
    peopleDF<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    peopleDF<span class="token punctuation">.</span>filter<span class="token punctuation">(</span><span class="token symbol">'age</span> <span class="token operator">&gt;</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span>peopleDF<span class="token punctuation">.</span>filter<span class="token punctuation">(</span><span class="token symbol">'age</span> <span class="token operator">&gt;</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//需求5：按年龄进行分组并统计相同年龄的人数</span>
    <span class="token keyword">val</span> re1<span class="token operator">:</span> DataFrame <span class="token operator">=</span> peopleDF<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//这里通过count操作之后，schem中会增加count的名称</span>
    re1<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    re1<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    re1<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    re1<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span><span class="token symbol">'count</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//完整的方案</span>
    peopleDF<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//SQL结构化查询语言</span>
    <span class="token comment">//关闭资源</span>
    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><p><strong>SQL案例</strong></p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkContext
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_

<span class="token comment">/**
 * DESC:
 */</span>

<span class="token keyword">object</span> _06_1DataFrameOpration <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//申请资源</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//For implicit conversions from RDDs to DataFrames</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//读取数据</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext
    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/sql/people1.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//切分后套入person类</span>
    <span class="token keyword">val</span> peopleRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span>People1<span class="token punctuation">]</span> <span class="token operator">=</span> fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> People1<span class="token punctuation">(</span>x<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toInt<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//引入隐式反馈转化为df</span>
    <span class="token keyword">val</span> peopleDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> peopleRDD<span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//打印输出</span>
    <span class="token comment">//SQL</span>
    peopleDF<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">&quot;peopleTable&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//需求1-能否将name字段筛选出来</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name from peopleTable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//需求2-能否将name，age字段筛选出来</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,age from peopleTable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//需求3-查询年龄最大的前两名</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select * from peopleTable order by age desc limit 2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>
      <span class="token triple-quoted-string string">&quot;&quot;&quot;
        |select *
        |from peopleTable
        |order by age desc
        |limit 2
        |&quot;&quot;&quot;</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//SQL结构化查询语言</span>
    <span class="token comment">//关闭资源</span>
    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p><strong>SparkSQL的DataSet</strong></p> <ul><li><p>wordcount</p></li> <li><p>DSL:</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql<span class="token punctuation">.</span>wordcount</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> Dataset<span class="token punctuation">,</span> Row<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">object</span> _01DSL <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//现在我们使用SparkSession</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//读取数据</span>
    <span class="token keyword">val</span> df1<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/words.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> ds1<span class="token operator">:</span> Dataset<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/words.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//这里只能使用ds</span>
    <span class="token comment">//df1.as[String].flatMap(_.split(&quot;\\s+&quot;))</span>
    <span class="token keyword">val</span> value<span class="token operator">:</span> Dataset<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ds1<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    value<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//+----------+</span>
    <span class="token comment">//|     value|</span>
    <span class="token comment">//+----------+</span>
    <span class="token comment">//|     hello|</span>
    <span class="token comment">//|     spark|</span>
    <span class="token comment">//|     hello|</span>
    <span class="token comment">//|     flink|</span>
    <span class="token comment">//|     hello|</span>
    <span class="token comment">//dsl</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> Dataset<span class="token punctuation">[</span>Row<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span><span class="token symbol">'count</span><span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
    result<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><ul><li>SQL:</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql<span class="token punctuation">.</span>wordcount</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> Dataset<span class="token punctuation">,</span> Row<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">object</span> _02SQL <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//现在我们使用SparkSession</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//读取数据</span>
    <span class="token keyword">val</span> df1<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/words.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> ds1<span class="token operator">:</span> Dataset<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/words.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//这里只能使用ds</span>
    <span class="token comment">//df1.as[String].flatMap(_.split(&quot;\\s+&quot;))</span>
    <span class="token keyword">val</span> value<span class="token operator">:</span> Dataset<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ds1<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    value<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//+----------+</span>
    <span class="token comment">//|     value|</span>
    <span class="token comment">//+----------+</span>
    <span class="token comment">//|     hello|</span>
    <span class="token comment">//|     spark|</span>
    <span class="token comment">//|     hello|</span>
    <span class="token comment">//|     flink|</span>
    <span class="token comment">//|     hello|</span>
    <span class="token comment">//sql</span>
    value<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">&quot;table&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>
      <span class="token triple-quoted-string string">&quot;&quot;&quot;
        |select  value,count(value) as counts
        |from table
        |group by value
        |order by counts desc
        |&quot;&quot;&quot;</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span>
    <span class="token comment">//+----------+-----+</span>
    <span class="token comment">//|     value|count|</span>
    <span class="token comment">//+----------+-----+</span>
    <span class="token comment">//|     hello|    6|</span>
    <span class="token comment">//|     sqoop|    1|</span>
    <span class="token comment">//|     flink|    1|</span>
    <span class="token comment">//|    pulsar|    1|</span>
    <span class="token comment">//|     doris|    1|</span>
    <span class="token comment">//|clickhouse|    1|</span>
    <span class="token comment">//|     spark|    1|</span>
    <span class="token comment">//+----------+-----+</span>
    result<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><h4 id="sparksql的数据结构之间转换-掌握"><a href="#sparksql的数据结构之间转换-掌握" class="header-anchor">#</a> <strong>SparkSQL的数据结构之间转换(掌握)</strong></h4> <ul><li><img src="./assets/img/image-20210331182824551.59f1f63c.png" alt="image-20210331182824551"></li> <li>RDD和DF和DS区别和练习</li> <li>RDD通过scheme转化为df，df增加泛型转化ds</li> <li>df是在运行的时候检查类型的，rdd和dataset是在编译时候进行类型检查</li> <li>dataset在spark2.0之后基本dataframe统一，dataSet[ROW]=dataframe</li></ul> <h3 id="电影评分案例-掌握"><a href="#电影评分案例-掌握" class="header-anchor">#</a> 电影评分案例(掌握)</h3> <ul><li><p>电影数据集统计需求分析</p></li> <li><p>需求：对电影评分数据进行统计分析</p> <ul><li>获取Top10电影（电影评分平均值最高，并且每个电影被评分的次数大于2000)</li></ul></li> <li><p>数据集的认知：</p> <ul><li><img src="./assets/img/image-20210402102333287.4b340736.png" alt="image-20210402102333287"></li></ul></li> <li><p>步骤</p> <ul><li>1-首先读取数据集</li> <li>2-数据集的解析，使用RDD转DF(case class)</li> <li>3-SQL操作的实现</li> <li>4-使用DSL实现</li> <li>5-将结果存入到csv结果文件中</li> <li>6-将结果数据存入到MySQL</li></ul></li> <li><p>代码</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql<span class="token punctuation">.</span>moviesPro</span>


<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> Dataset<span class="token punctuation">,</span> Row<span class="token punctuation">,</span> SaveMode<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_

<span class="token comment">/**
 * DESC:
 * 1-首先读取数据集
 * 2-数据集的解析，使用RDD转DF(case class)
 * 3-SQL操作的实现
 * 4-使用DSL实现
 * 5-将结果存入到csv结果文件中
 * 6-将结果数据存入到MySQL中
 */</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> MoviesRatings<span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> moviesId<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> ratings<span class="token operator">:</span> <span class="token builtin">Double</span><span class="token punctuation">,</span> timestamp<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>

<span class="token keyword">object</span> _01MoviesRatingLoader <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.shuffle.partitions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token comment">//默认200</span>
      <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
      spark
    <span class="token punctuation">}</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//1-首先读取数据集</span>
    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/ml-1m/ratings.dat&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//2-数据集的解析，使用RDD转DF(case class)</span>
    <span class="token keyword">val</span> moviesDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> fileRDD
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>line <span class="token keyword">=&gt;</span> line <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">.</span>trim<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;::&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>mapPartitions<span class="token punctuation">(</span>iter <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        iter<span class="token punctuation">.</span>map<span class="token punctuation">(</span>line <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">val</span> arr<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;::&quot;</span><span class="token punctuation">)</span>
          MoviesRatings<span class="token punctuation">(</span>arr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDouble<span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDF
    moviesDF<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token comment">//+------+--------+-------+---------+</span>
    <span class="token comment">//|userId|moviesId|ratings|timestamp|</span>
    <span class="token comment">//+------+--------+-------+---------+</span>
    <span class="token comment">//|1     |1193    |5.0    |978300760|</span>
    <span class="token comment">//|1     |661     |3.0    |978302109|</span>
    <span class="token comment">//|1     |914     |3.0    |978301968|</span>
    <span class="token comment">//+------+--------+-------+---------+</span>
    moviesDF<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//root</span>
    <span class="token comment">// |-- userId: string (nullable = true)</span>
    <span class="token comment">// |-- moviesId: string (nullable = true)</span>
    <span class="token comment">// |-- ratings: double (nullable = false)</span>
    <span class="token comment">// |-- timestamp: string (nullable = true)</span>
    <span class="token comment">//3-SQL操作的实现</span>
    moviesDF<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">&quot;movies_table&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//需求：获取Top10电影（电影评分平均值最高，并且每个电影被评分的次数大于2000)</span>
    <span class="token keyword">val</span> sql <span class="token operator">=</span>
      <span class="token triple-quoted-string string">&quot;&quot;&quot;
        |select moviesId,round(avg(ratings),2) as avg_rating,count(moviesId) as rnt_rating
        |from movies_table
        |group by moviesId
        |having rnt_rating&gt;2000
        |order by avg_rating desc,rnt_rating desc
        |limit 10
        |&quot;&quot;&quot;</span><span class="token punctuation">.</span>stripMargin
    println<span class="token punctuation">(</span><span class="token string">&quot;sql funtions way is:...........&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//spark.sql(sql).show()</span>
    <span class="token comment">//4-使用DSL实现</span>
    <span class="token keyword">val</span> resultDF<span class="token operator">:</span> Dataset<span class="token punctuation">[</span>Row<span class="token punctuation">]</span> <span class="token operator">=</span> moviesDF
      <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">&quot;moviesId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ratings&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">&quot;moviesId&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>agg<span class="token punctuation">(</span>
        round<span class="token punctuation">(</span>avg<span class="token punctuation">(</span><span class="token string">&quot;ratings&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;avg_rating&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        count<span class="token punctuation">(</span><span class="token string">&quot;moviesId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;rnt_rating&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span><span class="token symbol">'rnt_rating</span> <span class="token operator">&gt;</span> <span class="token number">2000</span><span class="token punctuation">)</span>
      <span class="token comment">//.filter($&quot;rnt_rating&quot; &gt;2000)</span>
      <span class="token comment">//.filter(col(&quot;rnt_rating&quot;) &gt;2000)</span>
      <span class="token comment">//.filter(column(&quot;rnt_rating&quot;) &gt;2000)</span>
      <span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>$<span class="token string">&quot;avg_rating&quot;</span><span class="token punctuation">.</span>desc<span class="token punctuation">,</span> <span class="token symbol">'rnt_rating</span><span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;dsl funtions way is:...........&quot;</span><span class="token punctuation">)</span>
    resultDF<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//5-将结果存入到csv结果文件中</span>
    <span class="token comment">//+--------+----------+----------+</span>
    <span class="token comment">//|moviesId|avg_rating|rnt_rating|</span>
    <span class="token comment">//+--------+----------+----------+</span>
    <span class="token comment">//|     318|      4.55|      2227|</span>
    <span class="token comment">//resultDF</span>
    <span class="token comment">//  .coalesce(1)</span>
    <span class="token comment">//  .write</span>
    <span class="token comment">//  .mode(SaveMode.Overwrite)</span>
    <span class="token comment">//  .csv(&quot;data/baseoutput/output-2/&quot;)</span>
    <span class="token comment">// Thread.sleep(100 * 1000)</span>
    <span class="token comment">//6-将结果数据存入到MySQL中</span>
    <span class="token comment">//创建数据库和表</span>
    <span class="token comment">/*    CREATE DATABASE bigdata CHARACTER SET utf8;
        CREATE TABLE `tb_top10_movies` (
          `movieId` INT(11) NOT NULL,
          `avg_rating` FLOAT(10) DEFAULT NULL,
          `cnt_rating` INT(11) DEFAULT NULL,
          PRIMARY KEY (`movieId`)
        ) ENGINE=INNODB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;
        SELECT * FROM tb_top10_movies*/</span>
    <span class="token comment">//写入url，方法1</span>
    <span class="token comment">//val prop = new Properties()</span>
    <span class="token comment">//prop.setProperty(&quot;driver&quot;, &quot;com.mysql.jdbc.Driver&quot;)</span>
    <span class="token comment">//prop.setProperty(&quot;user&quot;, &quot;root&quot;)</span>
    <span class="token comment">//prop.setProperty(&quot;password&quot;, &quot;root&quot;)</span>
    <span class="token comment">//resultDF</span>
    <span class="token comment">//  .coalesce(1)</span>
    <span class="token comment">//  .write</span>
    <span class="token comment">//  .mode(SaveMode.Overwrite)</span>
    <span class="token comment">//  .jdbc(&quot;jdbc:mysql://localhost:3306/bigdata&quot;, &quot;tb_top10_movie&quot;, prop)</span>
    <span class="token comment">//写法2,https://spark.apache.org/docs/3.1.1/sql-data-sources-jdbc.html</span>
    <span class="token comment">// Saving data to a JDBC source</span>
    resultDF<span class="token punctuation">.</span>write
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;jdbc&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>mode<span class="token punctuation">(</span>SaveMode<span class="token punctuation">.</span>Overwrite<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jdbc:mysql://localhost:3306/bigdata&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;dbtable&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tb_top10_movie&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;data write finished!&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//读取数据方法1</span>
    <span class="token comment">//val jdbcDF = spark.read</span>
    <span class="token comment">//  .format(&quot;jdbc&quot;)</span>
    <span class="token comment">//  .option(&quot;url&quot;, &quot;jdbc:mysql://localhost:3306/bigdata&quot;)</span>
    <span class="token comment">//  .option(&quot;dbtable&quot;, &quot;tb_top10_movie&quot;)</span>
    <span class="token comment">//  .option(&quot;user&quot;, &quot;root&quot;)</span>
    <span class="token comment">//  .option(&quot;password&quot;, &quot;root&quot;)</span>
    <span class="token comment">//  .load()</span>
    println<span class="token punctuation">(</span><span class="token string">&quot;data reader finished!&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//读取方法2</span>
    <span class="token keyword">val</span> connectionProperties <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span>
    connectionProperties<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
    connectionProperties<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> jdbcDF2 <span class="token operator">=</span> spark<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span>jdbc<span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://localhost:3306/bigdata&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tb_top10_movie&quot;</span><span class="token punctuation">,</span> connectionProperties<span class="token punctuation">)</span>
    jdbcDF2<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br></div></div><ul><li>总结：</li> <li><img src="./assets/img/image-20210402104901864.e55a483b.png" alt="image-20210402104901864"></li> <li><img src="./assets/img/image-20210402105217031.19e5bba3.png" alt="image-20210402105217031"></li> <li>寻找多种数据源官网</li> <li><img src="./assets/img/image-20210402105609245.ac3bdc5d.png" alt="image-20210402105609245"></li> <li><img src="./assets/img/image-20210402105837056.06956205.png" alt="image-20210402105837056"></li></ul> <h3 id="spark-sql整合hive"><a href="#spark-sql整合hive" class="header-anchor">#</a> Spark SQL整合Hive</h3> <p>SparkSQL的和Hive本地集成(为了测试)</p> <ul><li><p>SparkSQL和Hive本地测试步骤</p> <ul><li><p>0-数据</p></li> <li><p>1,zhangsan,30</p> <p>2,lisi,40</p> <p>3,wangwu,50</p></li> <li><p>1-引入maven的依赖，spark_hive</p></li></ul></li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-hive_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.4.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p>2-在sparkconf下面引用ennableHiveSupprt支持Hive</p></li> <li><p>3-直接写hive的语句，使用spark.sql(hivesql)</p></li> <li><p>4-打印结果</p></li> <li><p>代码</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql<span class="token punctuation">.</span>toHive</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SparkSession

<span class="token comment">/**
 * DESC:
 *
 */</span>
<span class="token keyword">object</span> _01SparkToHive <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//现在我们使用SparkSession</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>enableHiveSupport<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//to a persistent Hive metastore</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//hive默认的元数据信息在derby中存储，后面配置了mysql</span>

    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;show databases&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;create table if not exists student2(id int,name String,age int) row format delimited fields terminated by ','&quot;</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;load data local inpath 'data/baseinput/sql/hive/students.csv' overwrite into table student2&quot;</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select * from student2 where age &gt;30&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>


  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h5 id="spark整合集群环境的hive"><a href="#spark整合集群环境的hive" class="header-anchor">#</a> Spark整合集群环境的Hive</h5> <ul><li><p>SParkOnHive</p> <ul><li>Hive---HiveOnMR</li> <li>Shark----HiveOnSpark---大部分用的都是Hive</li> <li>SparkSQL----独立实现的一套引擎</li> <li>SparkSQL+HIve整合----<strong>SparkOnHive</strong>--除了使用Hive元数据其他均使用SparkSQL的东西</li></ul></li> <li><p>如何搭建SparkOnHive环境？</p> <ul><li><p>1-首先让Spark知道Hive元数据的信息在哪里，需要将hive-site.xml放入saprk的conf目录下</p></li> <li><p><img src="./assets/img/image-20210402114644744.90e8ebf8.png" alt="image-20210402114644744"></p></li> <li><img src="./assets/img/image-20210402115311922.502a8148.png" alt="image-20210402115311922" style="zoom:150%;"></li> <li><p>2-需要将hive-site.xml分发到其他两台上</p></li> <li><p>3-需要将mysql的jar包放在spark的jars目录下</p></li> <li><p>启动metastore</p></li></ul></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">nohup</span> /export/server/hive/bin/hive <span class="token parameter variable">--service</span> metastore <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&gt;&gt;</span> /var/log.log <span class="token operator">&amp;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><p>4-通过spark-sql或spark-shell测试是否整合成功</p></li> <li><p><img src="./assets/img/image-20210402115843898.38267b3f.png" alt="image-20210402115843898"></p></li> <li><p><img src="./assets/img/image-20210402115928368.e362825a.png" alt="image-20210402115928368"></p></li> <li><p>4-通过IDEA远程连接集群环境的Hive进行相关操作</p></li> <li><p><img src="./assets/img/image-20210402121329177.3893ddc5.png" alt="image-20210402121329177"></p></li> <li><p><img src="./assets/img/image-20210402121252479.fba268e3.png" alt="image-20210402121252479"></p></li> <li><p>代码</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkbase</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SparkSession

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">object</span> _02SparkToHive <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.shuffle.partitions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//在2.0.0之前hive.sql.warehouse.dir，2.0之后spark.sql.warehouse.dir</span>
      <span class="token comment">//warehouse的hive数据存放地址</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.warehouse.dir&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hdfs://node1:8020/user/hive/warehouse&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//metastore服务地址，thrift</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;hive.metastore.uris&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;thrift://node3:9083&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>enableHiveSupport<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//to a persistent Hive metastore</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>

    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;show databases&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;use sparkhive3&quot;</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;create table if not exists student2(id int,name String,age int) row format delimited fields terminated by ','&quot;</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;show tables&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;load data local inpath 'data/baseinput/sql/hive/students.csv' overwrite into table student2&quot;</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
      |select *
      |from student2
      |where age &gt;30
      |&quot;&quot;&quot;</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//+---+------+---+</span>
    <span class="token comment">//| id|  name|age|</span>
    <span class="token comment">//+---+------+---+</span>
    <span class="token comment">//|  2|  lisi| 40|</span>
    <span class="token comment">//|  3|wangwu| 50|</span>
    <span class="token comment">//+---+------+---+</span>
    spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><ul><li><img src="./assets/img/image-20210402121855213.c1f11435.png" alt="image-20210402121855213"></li></ul> <h5 id="两种启动方式"><a href="#两种启动方式" class="header-anchor">#</a> 两种启动方式</h5> <ul><li><p><img src="./assets/img/image-20210402122223537.912bfc53.png" alt="image-20210402122223537"></p></li> <li><p>Spark的CLI方式</p></li> <li><img src="spark.assets/image-20210402122319835.png" alt="image-20210402122319835" style="zoom:150%;"></li> <li><p>Spark的Beeline方式，thrift</p></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>Spark的ThriftServer服务(类似于Hive的HiveServer2)，在通过Beeline连接执行SQL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><img src="./assets/img/image-20210402122421815.a528737e.png" alt="image-20210402122421815"></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">SPARK_HOME</span><span class="token operator">=</span>/export/server/spark
<span class="token variable">$SPARK_HOME</span>/sbin/start-thriftserver.sh <span class="token punctuation">\</span>
<span class="token parameter variable">--hiveconf</span> <span class="token assign-left variable">hive.server2.thrift.port</span><span class="token operator">=</span><span class="token number">10001</span> <span class="token punctuation">\</span><span class="token punctuation">\</span>同时连hive可换一个port
<span class="token parameter variable">--hiveconf</span> <span class="token assign-left variable">hive.server2.thrift.bind.host</span><span class="token operator">=</span>node3 <span class="token punctuation">\</span>
<span class="token parameter variable">--master</span> local<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p><img src="./assets/img/image-20210402122542530.502a16ad.png" alt="image-20210402122542530"></p></li> <li><p>可以在其他机器上访问sparkonhive</p></li> <li><p><img src="./assets/img/image-20210402122821677.88187351.png" alt="image-20210402122821677"></p></li> <li><p>可以通过thrift访问sparkonhive的数据</p></li></ul> <h3 id="sparksql的udf函数-必须掌握"><a href="#sparksql的udf函数-必须掌握" class="header-anchor">#</a> SparkSQL的UDF函数(必须掌握)</h3> <ul><li><p>UDF：一对一，Spark使用最多</p></li> <li><p>UDAF：多对一，Spark基本实现</p></li> <li><p>UDTF：一对多，Hive实现了UDTF，Spark没有实现</p></li> <li><p><img src="./assets/img/image-20210402144310799.242966c4.png" alt="image-20210402144310799"></p></li> <li><img src="./assets/img/image-20210402144358985.3fd377e5.png" alt="image-20210402144358985" style="zoom:150%;"></li></ul> <p><strong>编程模式sparksession使用UDF 需要先注册</strong></p> <p><strong>spark.udf.register() 方式</strong></p> <ul><li>1.通过匿名函数注册udf</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//注册udf, 返回字符串长度</span>
spark<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">&quot;strLen&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>str<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> str<span class="token punctuation">.</span>length<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//spark sql中使用udf</span>
spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,strLen(name) as name_len from user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>2.通过实名函数注册udf</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//定义实名函数</span>
<span class="token keyword">def</span> getStrLen<span class="token punctuation">(</span>str<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  str<span class="token punctuation">.</span>length
<span class="token punctuation">}</span>

<span class="token comment">//注册udf,要在实名函数后面加 _(注意前面有个空格)</span>
spark<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">&quot;strLen&quot;</span><span class="token punctuation">,</span> getStrLen _<span class="token punctuation">)</span>
<span class="token comment">//spark sql中使用udf</span>
spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,strLen(name) as name_len from user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li><strong>SparkSQL中使用UDF</strong>（如果是打包单个类注意指定META-INF/MANIFEST.MF在src下，不要放在resouces,不然会找不到主类，可带一个空main函数类，注册时就会报类路径错误）</li> <li>方式一：在启动spark-sql时通过--jars指定</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> <span class="token variable">$SPARK_HOME</span>/bin
spark-sql <span class="token parameter variable">--jars</span> /home/hadoop/lib/udf.jar
CREATE TEMPORARY FUNCTION hello AS <span class="token string">'com.luogankun.udf.HelloUDF'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> hello<span class="token punctuation">(</span>url<span class="token punctuation">)</span> from page_views limit <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>方式二：</li></ul> <p>1）需要先将udf.jar的路径配置到spark-env.sh的SPARK_CLASSPATH中，形如：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">SPARK_CLASSPATH</span><span class="token operator">=</span><span class="token variable">$SPARK_CLASSPATH</span>:/home/hadoop/software/mysql-connector-java-5.1.27-bin.jar:/home/hadoop/lib/udf.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2）再启动spark-sql，直接CREATE TEMPORARY FUNCTION即可；</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> <span class="token variable">$SPARK_HOME</span>/bin
spark-sql
CREATE TEMPORARY FUNCTION hello AS <span class="token string">'com.luogankun.udf.HelloUDF'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> hello<span class="token punctuation">(</span>url<span class="token punctuation">)</span> from page_views limit <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>方式三：Thrift JDBC Server中使用UDF</li></ul> <p>在beeline命令行中执行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>create <span class="token keyword">function</span> base_analizer as <span class="token string">'com.zhengkw.udf.BaseFieldUDF'</span> using jar <span class="token string">'hdfs://hadoop102:9000/user/hive/jars/hivefunction-1.0-SNAPSHOT.jar'</span><span class="token punctuation">;</span>//hdfs路径

<span class="token function">add</span> jar /home/hadoop/lib/udf.jar<span class="token punctuation">;</span>//本地机器路径
CREATE TEMPORARY FUNCTION hello AS <span class="token string">'com.luogankun.udf.HelloUDF'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> hello<span class="token punctuation">(</span>url<span class="token punctuation">)</span> from page_views limit <span class="token number">1</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>spark/hive共用自定义函数(见hive udf)</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
基于DataFrame(或者DataSet) 的Java(或Python、Scale) 可以轻松的定义注册UDF，但是想在SQL(SparkSQL、Hive) 中自定义或者想共用就遇到困难。这时，可以先按照一定规约自定义函数，再向Spark(或Hive)注册为永久函数，实现在Spark和Hive共享UDF的目的。
**/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>UDF函数案例1</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql<span class="token punctuation">.</span>udf</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span>UDF1
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>StringType
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_

<span class="token comment">/**
 * DESC:
 * 1-申请资源
 * 2-读取数据
 * 3-执行转化为大写，适合于UDF函数
 */</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> Smaller<span class="token punctuation">(</span>line<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>

<span class="token keyword">object</span> _01wordsToBigger <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-申请资源</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//2-读取数据</span>
    <span class="token keyword">val</span> fileRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>textFile<span class="token punctuation">(</span><span class="token string">&quot;data\\baseinput\\sql\\udf\\udf.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//3-执行转化为大写，适合于UDF函数</span>
    <span class="token keyword">val</span> wordsDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> fileRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> Smaller<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDF
    wordsDF<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    wordsDF<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// |-- line: string (nullable = true)</span>
    <span class="token comment">//user-defined function</span>
    <span class="token comment">//spark.udf.register(&quot;wordToBigger&quot;, new UDF1[String, String] {</span>
    <span class="token comment">//  override def call(t1: String): String = {</span>
    <span class="token comment">//    t1.toUpperCase()</span>
    <span class="token comment">//  }</span>
    <span class="token comment">//}, StringType)</span>
    spark<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">&quot;wordToBigger&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span>line<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token keyword">=&gt;</span><span class="token punctuation">{</span>
      line<span class="token punctuation">.</span>toUpperCase<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//SQL</span>
    wordsDF<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">&quot;word_view&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> result1<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select line,wordToBigger(line) as bigger from word_view&quot;</span><span class="token punctuation">)</span>
    result1<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//DSL</span>
    <span class="token keyword">val</span> result2<span class="token operator">:</span> DataFrame <span class="token operator">=</span> wordsDF<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token symbol">'line</span><span class="token punctuation">,</span>
      callUDF<span class="token punctuation">(</span><span class="token string">&quot;wordToBigger&quot;</span><span class="token punctuation">,</span> <span class="token symbol">'line</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;bigger&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    result2<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><ul><li>更多参数</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql<span class="token punctuation">.</span>udf</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span>UDF1
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>StringType
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_

<span class="token comment">/**
 * DESC:
 * 1-申请资源
 * 2-读取数据
 * 3-执行转化为大写，适合于UDF函数
 */</span>

<span class="token keyword">object</span> _02udfDemo <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-申请资源</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_

    <span class="token keyword">val</span> df <span class="token operator">=</span> Seq<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;id1&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;id2&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;id3&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">&quot;simpleUDF&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> n <span class="token operator">*</span> n<span class="token punctuation">)</span>
    df<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> callUDF<span class="token punctuation">(</span><span class="token string">&quot;simpleUDF&quot;</span><span class="token punctuation">,</span> $<span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;pow(x,2)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> df1 <span class="token operator">=</span> Seq<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;id1&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;id2&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;id3&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;value2&quot;</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">&quot;simpleUDF2&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span>v1<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">,</span>v2<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token keyword">=&gt;</span><span class="token punctuation">{</span>
      v1<span class="token operator">*</span>v2
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    df1<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">&quot;table_df&quot;</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>
      <span class="token triple-quoted-string string">&quot;&quot;&quot;
        |select id,simpleUDF2(value1,value2) as simple
        |from table_df
        |&quot;&quot;&quot;</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

    df1<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>
      callUDF<span class="token punctuation">(</span><span class="token string">&quot;simpleUDF2&quot;</span><span class="token punctuation">,</span><span class="token string">'value1,'</span>value2<span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;bigger&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><ul><li>UDAF了解</li> <li><img src="./assets/img/image-20210402151001095.32b74415.png" alt="image-20210402151001095"></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql<span class="token punctuation">.</span>udf</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> Row<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span></span><span class="token punctuation">{</span>MutableAggregationBuffer<span class="token punctuation">,</span> UserDefinedAggregateFunction<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>_

<span class="token keyword">class</span> SparkFunctionUDAF <span class="token keyword">extends</span> UserDefinedAggregateFunction<span class="token punctuation">{</span>
  <span class="token comment">//输入的数据类型的schema</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> inputSchema<span class="token operator">:</span> StructType <span class="token operator">=</span> <span class="token punctuation">{</span>
    StructType<span class="token punctuation">(</span>StructField<span class="token punctuation">(</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">,</span>LongType<span class="token punctuation">)</span><span class="token operator">::</span>Nil<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//缓冲区数据类型schema，说白了就是转换之后的数据的schema</span>
  <span class="token comment">//求解平均值“总金额，总人数”</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> bufferSchema<span class="token operator">:</span> StructType <span class="token operator">=</span> <span class="token punctuation">{</span>
    StructType<span class="token punctuation">(</span>StructField<span class="token punctuation">(</span><span class="token string">&quot;sum&quot;</span><span class="token punctuation">,</span>LongType<span class="token punctuation">)</span><span class="token operator">::</span>StructField<span class="token punctuation">(</span><span class="token string">&quot;total&quot;</span><span class="token punctuation">,</span>LongType<span class="token punctuation">)</span><span class="token operator">::</span>Nil<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//返回值的数据类型---总金额/总人数 可能会有小数，返回doubleType</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> dataType<span class="token operator">:</span> DataType <span class="token operator">=</span> <span class="token punctuation">{</span>
    DoubleType
  <span class="token punctuation">}</span>
  <span class="token comment">//确定是否相同的输入会有相同的输出</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> deterministic<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//初始化内部数据结构</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> initialize<span class="token punctuation">(</span>buffer<span class="token operator">:</span> MutableAggregationBuffer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0L</span>  <span class="token comment">//总金额都累加到Buffer0中，初始值为0</span>
    buffer<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0L</span>  <span class="token comment">//总人数都累加到buffer1参数中</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//更新数据内部结构</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> update<span class="token punctuation">(</span>buffer<span class="token operator">:</span> MutableAggregationBuffer<span class="token punctuation">,</span> input<span class="token operator">:</span> Row<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//所有的金额相加</span>
    buffer<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> buffer<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> input<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">//一共有多少条数据</span>
    buffer<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> buffer<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment">//能否累加10？--不能，+！为了求解人数</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//来自不同分区的数据进行合并</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> merge<span class="token punctuation">(</span>buffer1<span class="token operator">:</span> MutableAggregationBuffer<span class="token punctuation">,</span> buffer2<span class="token operator">:</span> Row<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    buffer1<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span>buffer1<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> buffer2<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    buffer1<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> buffer1<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> buffer2<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//计算输出数据值</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> evaluate<span class="token punctuation">(</span>buffer<span class="token operator">:</span> Row<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Any</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDouble <span class="token operator">/</span> buffer<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">object</span> SparkFunctionUDAF <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取sparkSession</span>
    <span class="token keyword">val</span> sparkSession<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token string">&quot;sparkUDAF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[2]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//通过sparkSession读取json文件得到DataFrame</span>
    <span class="token keyword">val</span> employeeDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token string">&quot;data\\baseinput\\sql\\udf\\udaf.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//通过DataFrame创建临时表</span>
    employeeDF<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">&quot;employee_table&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//注册我们的自定义UDAF函数</span>
    sparkSession<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">&quot;avgSal&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> SparkFunctionUDAF<span class="token punctuation">)</span>
    <span class="token comment">//调用我们的自定义UDAF函数</span>
    sparkSession<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select avgSal(salary) from employee_table&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sparkSession<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h3 id="sparksql函数"><a href="#sparksql函数" class="header-anchor">#</a> SparkSQL函数</h3> <ul><li><p>Hive中的开窗函数</p></li> <li><p>聚合类开窗函数</p> <ul><li>count() over(order by partition by)</li></ul></li> <li><p>排序类开窗函数</p> <ul><li>row_number() over(partition by order by)   12345</li> <li>rank() over(partition by order by)     446</li> <li>dense_rank() over(partition by order by)   445</li></ul></li> <li><p>代码</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparksql<span class="token punctuation">.</span>func</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SparkSession

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> Score<span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> clazz<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> score<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span>

<span class="token keyword">object</span> _01class <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-申请资源</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> scoreDF <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>makeRDD<span class="token punctuation">(</span>Array<span class="token punctuation">(</span>
      Score<span class="token punctuation">(</span><span class="token string">&quot;a1&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Score<span class="token punctuation">(</span><span class="token string">&quot;a2&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Score<span class="token punctuation">(</span><span class="token string">&quot;a3&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Score<span class="token punctuation">(</span><span class="token string">&quot;a4&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Score<span class="token punctuation">(</span><span class="token string">&quot;a5&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Score<span class="token punctuation">(</span><span class="token string">&quot;a6&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Score<span class="token punctuation">(</span><span class="token string">&quot;a7&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Score<span class="token punctuation">(</span><span class="token string">&quot;a8&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Score<span class="token punctuation">(</span><span class="token string">&quot;a9&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Score<span class="token punctuation">(</span><span class="token string">&quot;a10&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Score<span class="token punctuation">(</span><span class="token string">&quot;a11&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;score&quot;</span><span class="token punctuation">)</span>
    scoreDF<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">&quot;scores&quot;</span><span class="token punctuation">)</span>
    scoreDF<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//聚合开窗函数</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select count(name) from scores&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,class,score,count(name) over() ccc from scores&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,class,score,count(name) over(partition by class) ccc from scores&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//排序开窗函数 123</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,class,score,row_number() over(order by class) sss from scores&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,class,score,row_number() over(partition by class order by score) sss from scores&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//446</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,class,score,rank() over(order by class) sss from scores&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,class,score,rank() over(partition by class order by score) sss from scores&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//445</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,class,score,dense_rank() over(order by class) sss from scores&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,class,score,dense_rank() over(partition by class order by score) sss from scores&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//ntile</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,class,score,ntile(6) over(order by class) sss from scores&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span><span class="token string">&quot;select name,class,score,ntile(6) over(partition by class order by score) sss from scores&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h3 id="sparksql底层如何执行解析成rdd"><a href="#sparksql底层如何执行解析成rdd" class="header-anchor">#</a> SparkSQL底层如何执行解析成RDD</h3> <ul><li><img src="spark.assets/image-20210402155225251.png" alt="image-20210402155225251" style="zoom:150%;"></li> <li><p>步骤</p></li> <li><img src="spark.assets/image-20210402155752267.png" alt="image-20210402155752267" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210402155849640.png" alt="image-20210402155849640" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210402160151359.png" alt="image-20210402160151359" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210402160250191.png" alt="image-20210402160250191" style="zoom:150%;"></li> <li><p>如何查看逻辑计划和物理计划</p></li> <li><p>（1）通过WebUI查看</p></li> <li><p><img src="./assets/img/image-20210402160629237.29d7d8a0.png" alt="image-20210402160629237"></p></li> <li><p>（2）通过spark-shell交互式命令行，启动4040端口</p></li> <li><p><img src="./assets/img/image-20210402161146763.1f27bbd2.png" alt="image-20210402161146763"></p></li> <li><p><img src="./assets/img/image-20210402161214076.e4bbc1e1.png" alt="image-20210402161214076"></p></li> <li><p>面试时候回答的SparkSQL底层解析原理？</p></li> <li><img src="spark.assets/image-20210402161545086.png" alt="image-20210402161545086" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210402161622186.png" alt="image-20210402161622186" style="zoom:150%;"></li></ul> <h2 id="sparkstreaming引入-rdd-dstream"><a href="#sparkstreaming引入-rdd-dstream" class="header-anchor">#</a> SparkStreaming引入--RDD--DStream</h2> <h3 id="流数据的处理模式"><a href="#流数据的处理模式" class="header-anchor">#</a> 流数据的处理模式</h3> <ul><li><img src="spark.assets/image-20210402162641358.png" alt="image-20210402162641358" style="zoom:150%;"></li> <li><p>两种处理方式</p></li> <li><img src="spark.assets/image-20210402162855266.png" alt="image-20210402162855266" style="zoom:150%;"></li> <li><p>SparkStreaming官网</p></li> <li><p><img src="./assets/img/image-20210402163103866.f5cd26d4.png" alt="image-20210402163103866"></p></li> <li><p><img src="./assets/img/image-20210402163419342.e733cfa6.png" alt="image-20210402163419342"></p></li></ul> <h3 id="sparkstreaming数据结构"><a href="#sparkstreaming数据结构" class="header-anchor">#</a> SparkStreaming数据结构</h3> <p>SparkStreaming原理架构</p> <ul><li><img src="spark.assets/image-20210402171712399.png" alt="image-20210402171712399" style="zoom:150%;"></li> <li><img src="./assets/img/image-20210402172037127.4a4983af.png" alt="image-20210402172037127"></li> <li><img src="spark.assets/image-20210402172258524.png" alt="image-20210402172258524" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210402172527740.png" alt="image-20210402172527740" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210402172713126.png" alt="image-20210402172713126" style="zoom:150%;"></li></ul> <h4 id="sparkstreaming原理"><a href="#sparkstreaming原理" class="header-anchor">#</a> SparkStreaming原理</h4> <p>基础原理</p> <ul><li><img src="./assets/img/image-20210403102341971.c1487714.png" alt="image-20210403102341971"></li> <li><img src="./assets/img/image-20210403102446613.e856d419.png" alt="image-20210403102446613"></li></ul> <h4 id="sparkstreaming原理深入"><a href="#sparkstreaming原理深入" class="header-anchor">#</a> SparkStreaming原理深入</h4> <ul><li>整个SparkStreaming涉及两个时间
<ul><li>Receiver接收器需要接受数据的时间，一般设置200ms左右，官网建议我们不能低于50ms</li> <li><img src="./assets/img/image-20210403103915083.dc14d122.png" alt="image-20210403103915083"></li> <li><img src="./assets/img/image-20210403104331191.5fdd1bd3.png" alt="image-20210403104331191"></li> <li><img src="./assets/img/image-20210403104416532.48934038.png" alt="image-20210403104416532"></li> <li>https://spark.apache.org/docs/3.1.1/configuration.html</li> <li>SparkStreaming处理还有时间，一般程序中设置5s</li></ul></li></ul> <h3 id="dstream两种算子"><a href="#dstream两种算子" class="header-anchor">#</a> DStream两种算子</h3> <ul><li>底层RDD@Time时间序列构成</li> <li>RDD分为Transormation算子和Action算子，那个DStream如何划分呢？</li> <li>答案：Transormation和OutPutOpration操作</li> <li><img src="spark.assets/image-20210402172907207.png" alt="image-20210402172907207" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210402172942855.png" alt="image-20210402172942855" style="zoom:150%;"></li> <li>问题：对于SparkSTreaming的DStream的操作支持的算子并没有那么多，比如排序算子</li> <li>SparkStreaming解决方案利用transform的方法将DStream转化为RDD，因为RDD的transform很多的</li> <li><img src="spark.assets/image-20210402173248662.png" alt="image-20210402173248662" style="zoom:150%;"></li></ul> <h3 id="sparkstreaming初体验-无状态"><a href="#sparkstreaming初体验-无状态" class="header-anchor">#</a> SparkStreaming初体验-无状态</h3> <ul><li><p>需求：数据按照每5s处理一次，输入数据wordcount</p></li> <li><p>数据源：nc -lk 9999/9998 模拟socket数据源</p></li> <li><p>步骤：</p> <ul><li>1-准备上下文环境</li> <li>2-读取数据</li> <li>3-flatMap</li> <li>4-map</li> <li>5-reduceBykey</li> <li>6-start</li> <li>7-awaitTermination</li></ul></li> <li><p>代码：</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> ReceiverInputDStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 *1-准备上下文环境
 *2-读取数据
 *3-flatMap
 *4-map
 *5-reduceBykey
 *6-start
 *7-awaitTermination
 */</span>
<span class="token keyword">object</span> _01baseStreaming <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1-准备上下文环境</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//batchDuration the time interval at which streaming data will be divided into batches</span>
    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 2-读取数据--从socket读数据，需要在linux或windows中安装nc，如何安装nc；yum install -y nc   执行nc -lk 9999</span>
    <span class="token keyword">val</span> receiveRDD<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node1.itcast.cn&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
    <span class="token comment">// 3-flatMap</span>
    <span class="token keyword">val</span> flatRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> receiveRDD<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 4-map</span>
    <span class="token keyword">val</span> mapRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> flatRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 5-reduceBykey</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapRDD<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">)</span>
    resultRDD<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 6-start</span>
    <span class="token comment">//Start the execution of the streams.</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 7-awaitTermination--Wait for the execution to stop</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><ul><li><p>截图</p> <ul><li><img src="./assets/img/image-20210402164943001.2ec3c8cd.png" alt="image-20210402164943001"></li></ul></li></ul> <h3 id="状态计算"><a href="#状态计算" class="header-anchor">#</a> 状态计算</h3> <h4 id="updatestatebykey"><a href="#updatestatebykey" class="header-anchor">#</a> updateStateByKey</h4> <ul><li><p>首先实现有状态的统计，然后我们进行transform排序</p></li> <li><p>代码：</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> ReceiverInputDStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-准备上下文环境
 * 2-读取数据
 * 3-flatMap
 * 4-map
 * 5-reduceBykey
 * 6-start
 * 7-awaitTermination
 */</span>
<span class="token keyword">object</span> _02baseStreaming <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @param currentValue 当前的值
   * @param historyValue 历史的值
   * @return Option-none some
   */</span>
  <span class="token keyword">def</span> updateFunc<span class="token punctuation">(</span>currentValue<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> historyValue<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> sumV<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> currentValue<span class="token punctuation">.</span>sum <span class="token operator">+</span> historyValue<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//如果有值就给值否则给0</span>
    <span class="token comment">//Some(sumV)</span>
    Option<span class="token punctuation">(</span>sumV<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1-准备上下文环境</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//batchDuration the time interval at which streaming data will be divided into batches</span>
    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;data/baseoutput/output-4&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 2-读取数据--从socket读数据，需要在linux或windows中安装nc，如何安装nc；yum install -y nc   执行nc -lk 9999</span>
    <span class="token keyword">val</span> receiveRDD<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node1.itcast.cn&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
    <span class="token comment">// 3-flatMap</span>
    <span class="token keyword">val</span> flatRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> receiveRDD<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 4-map</span>
    <span class="token keyword">val</span> mapRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> flatRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 5-reduceBykey</span>
      <span class="token comment">//在Scala中，它和Java一样也是拥有方法和函数。Scala的方法是类的一部分，而函数是一个对象可以赋值给一个变量。换句话来说，在类中定义的函数即是方法。</span>

<span class="token comment">//Scala 中可以使用 def语句和val 语句定义函数，而定义方法只能使用def 语句。</span>
      <span class="token comment">//需要函数自动转换，不会自动转换的可以通过方法名+空格+_转化成函数</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapRDD<span class="token punctuation">.</span>updateStateByKey<span class="token punctuation">(</span>updateFunc<span class="token punctuation">)</span>
    <span class="token comment">//增加排序的方法--tranform中使用rdd</span>
    <span class="token keyword">val</span> sortResultDS<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> resultRDD<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>rdd <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      rdd<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    sortResultDS<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
      
      <span class="token comment">// 启动新的线程，希望在特殊的场合关闭SparkStreaming</span>
    <span class="token keyword">new</span> Thread<span class="token punctuation">(</span><span class="token keyword">new</span> Runnable <span class="token punctuation">{</span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token boolean">true</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> ex <span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// 监控HDFS文件的变化</span>
          <span class="token keyword">val</span> fs<span class="token operator">:</span> FileSystem <span class="token operator">=</span> FileSystem<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token keyword">new</span> URI<span class="token punctuation">(</span><span class="token string">&quot;hdfs://node1:8020&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> Configuration<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>

          <span class="token keyword">val</span> state<span class="token operator">:</span> StreamingContextState <span class="token operator">=</span> ssc<span class="token punctuation">.</span>getState<span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token comment">// 如果环境对象处于活动状态，可以进行关闭操作</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> state <span class="token operator">==</span> StreamingContextState<span class="token punctuation">.</span>ACTIVE <span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// 判断路径是否存在</span>
            <span class="token keyword">val</span> flg<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> fs<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token keyword">new</span> Path<span class="token punctuation">(</span><span class="token string">&quot;hdfs://node1:8020/spark/stopSparkHistory/&quot;</span><span class="token operator">+</span>appName<span class="token operator">+</span><span class="token string">&quot;@&quot;</span><span class="token operator">+</span>ssc<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>getConf<span class="token punctuation">.</span>getAppId<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> flg <span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 关闭采集器和Driver:优雅的关闭</span>
              ssc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
              System<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 6-start</span>
    <span class="token comment">//Start the execution of the streams.</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
      
     
    <span class="token comment">// 7-awaitTermination--Wait for the execution to stop调用awaitTermination()，driver将阻塞在这里，直到流式应用意外退出。</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br></div></div><ul><li><img src="./assets/img/image-20210402174214391.9cd56953.png" alt="image-20210402174214391"></li></ul> <h4 id="双流合并"><a href="#双流合并" class="header-anchor">#</a> 双流合并</h4> <ul><li>有两个流的合并union</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> ReceiverInputDStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-准备上下文环境
 * 2-读取数据
 * 3-flatMap
 * 4-map
 * 5-reduceBykey
 * 6-start
 * 7-awaitTermination
 */</span>
<span class="token keyword">object</span> _06twoSourceStreaming <span class="token punctuation">{</span>

  <span class="token keyword">def</span> updateFunc<span class="token punctuation">(</span>curentValue<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histouryValue<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> curentValue<span class="token punctuation">.</span>sum <span class="token operator">+</span> histouryValue<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    Option<span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1-准备上下文环境</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[3]&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//batchDuration the time interval at which streaming data will be divided into batches</span>
    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;data/baseoutput/output-6&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 2-读取数据--从socket读数据，需要在linux或windows中安装nc，如何安装nc；yum install -y nc   执行nc -lk 9999</span>
    <span class="token keyword">val</span> receiveRDD1<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node1.itcast.cn&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> receiveRDD2<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node1.itcast.cn&quot;</span><span class="token punctuation">,</span> <span class="token number">9998</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> receiveRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> receiveRDD1<span class="token punctuation">.</span>union<span class="token punctuation">(</span>receiveRDD2<span class="token punctuation">)</span>
    <span class="token comment">// 3-flatMap</span>
    <span class="token keyword">val</span> flatRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> receiveRDD<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 4-map</span>
    <span class="token keyword">val</span> mapRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> flatRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 5-reduceBykey</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapRDD<span class="token punctuation">.</span>updateStateByKey<span class="token punctuation">(</span>updateFunc<span class="token punctuation">)</span>
    resultRDD<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 6-start</span>
    <span class="token comment">//Start the execution of the streams.</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 7-awaitTermination--Wait for the execution to stop</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h4 id="mapwithstate"><a href="#mapwithstate" class="header-anchor">#</a> mapWithState</h4> <ul><li><p>updateStateByKey的所有计算结果经过计算之后都会返回Driver端</p></li> <li><p>mapWithState只会返回driver端更新的数据，而不是全部数据</p></li> <li><img src="spark.assets/image-20210403093630206.png" alt="image-20210403093630206" style="zoom:150%;"></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span>StringUtils
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>MapWithStateDStream<span class="token punctuation">,</span> ReceiverInputDStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> State<span class="token punctuation">,</span> StateSpec<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-首先加载StreamingContext上下文对象，获取资源，内部调用sparkconf
 * 2-读取外部数据源，如socket数据源
 * 3-flatMap
 * 4-map
 * 5-mapwithstate
 * 6-print
 * 7-ssc.start
 * 8-ssc.awaitTermination等待程序异常退出
 */</span>
<span class="token keyword">object</span> _04mapWithState <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-首先加载StreamingContext上下文对象，获取资源，内部调用sparkconf</span>
    <span class="token keyword">val</span> ssc<span class="token operator">:</span> StreamingContext <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      ssc
    <span class="token punctuation">}</span>
    ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;data/baseoutput/output-5&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//2-读取外部数据源，如socket数据源</span>
    <span class="token keyword">val</span> receiveStream<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node1.itcast.cn&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
    <span class="token comment">//3-flatMap</span>
    <span class="token comment">//4-map</span>
    <span class="token comment">//5-mapwithstate</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> MapWithStateDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Any</span><span class="token punctuation">]</span> <span class="token operator">=</span> receiveStream
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>line <span class="token keyword">=&gt;</span> StringUtils<span class="token punctuation">.</span>isNotBlank<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>mapWithState<span class="token punctuation">(</span>StateSpec<span class="token punctuation">.</span>function<span class="token punctuation">(</span>mappingFunction<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//6-print</span>
    result<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//7-ssc.start</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//8-ssc.awaitTermination等待程序异常退出</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * word-统计单词
   * option-
   * state-
   */</span>
  <span class="token keyword">val</span> mappingFunction <span class="token operator">=</span> <span class="token punctuation">(</span>word<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> option<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> state<span class="token operator">:</span> State<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-首先查看状态的时间是否超时</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>isTimingOut<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      println<span class="token punctuation">(</span>word <span class="token operator">+</span> <span class="token string">&quot;is time out..&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//2-没有超时状态</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//3-option历史的值，结合当前的状态的值累加</span>
      <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> option<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> state<span class="token punctuation">.</span>getOption<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> keyFreq<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>word<span class="token punctuation">,</span> sum<span class="token punctuation">)</span>
      <span class="token comment">//4-state的update的方法执行</span>
      state<span class="token punctuation">.</span>update<span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
      keyFreq
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h4 id="窗口计算"><a href="#窗口计算" class="header-anchor">#</a> 窗口计算</h4> <ul><li><p><img src="./assets/img/image-20210403105136557.1a1cb564.png" alt="image-20210403105136557"></p></li> <li><p>窗口长度:被包含在窗口中的数据需要被处理</p></li> <li><p>窗口滑动时间间隔：窗口每过多久滑动一次</p></li> <li><p>数据处理时间5s处理一次，streamigcontect(second(5))</p></li> <li><img src="spark.assets/image-20210403105628523.png" alt="image-20210403105628523" style="zoom:150%;"></li> <li><p>切分批次：没隔多久处理一次，一般设置5s</p></li> <li><p>窗口长度：被包括在窗口中的数据需要被计算</p></li> <li><p>窗口滑动时间间隔；窗口每隔多久计算一次</p></li> <li><p>当窗口的长度=窗口的滑动时间间隔，不会造成数据丢失或重复</p></li> <li><p>当窗口的长度&lt;滑动的时间间隔，会造成数据丢失</p></li> <li><p>当窗口的长度&gt;滑动时间间隔，造成数据重复，</p> <p>（<strong>重复得看最后的数据怎么使用，如果说是每5min统计最近1小时的数据，只要这一小时的数据，没有重复可言，如果是要保留数据最后累计，就会有重复累计问题。</strong>）</p></li> <li><p>上述案例下，窗口的长度设置为17s，不能随便设置</p></li> <li><p><strong>一般设置，窗口的滑动时间间隔和窗口的长度必须是数据处理时间的整数倍，否则rdd需要被分为两部分，违反了rdd的不可变</strong></p></li> <li><p>案例：</p></li> <li><p>每隔10s统计一下10s的数据</p></li> <li><p><img src="./assets/img/image-20210403110227029.27519ba1.png" alt="image-20210403110227029"></p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> ReceiverInputDStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-准备上下文环境
 * 2-读取数据
 * 3-flatMap
 * 4-map
 * 5-reduceBykey
 * 6-start
 * 7-awaitTermination
 */</span>
<span class="token keyword">object</span> _07windowsOpration <span class="token punctuation">{</span>


  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1-准备上下文环境</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[3]&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//batchDuration the time interval at which streaming data will be divided into batches</span>
    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;data/baseoutput/output-6&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 2-读取数据--从socket读数据，需要在linux或windows中安装nc，如何安装nc；yum install -y nc   执行nc -lk 9999</span>
    <span class="token keyword">val</span> receiveRDD<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node1.itcast.cn&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">// 3-flatMap</span>
    <span class="token keyword">val</span> flatRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> receiveRDD<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 4-map</span>
    <span class="token keyword">val</span> mapRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> flatRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 5-reduceBykey</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapRDD<span class="token punctuation">.</span>reduceByKeyAndWindow<span class="token punctuation">(</span>
      <span class="token punctuation">(</span>a<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">,</span>
      Seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      Seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    resultRDD<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 6-start</span>
    <span class="token comment">//Start the execution of the streams.</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 7-awaitTermination--Wait for the execution to stop</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><ul><li><p>换种API实现</p></li> <li><p><img src="./assets/img/image-20210403110649150.84e0f0ed.png" alt="image-20210403110649150"></p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> ReceiverInputDStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-准备上下文环境
 * 2-读取数据
 * 3-flatMap
 * 4-map
 * 5-reduceBykey
 * 6-start
 * 7-awaitTermination
 */</span>
<span class="token keyword">object</span> _08windowsOpration <span class="token punctuation">{</span>


  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1-准备上下文环境</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[3]&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//batchDuration the time interval at which streaming data will be divided into batches</span>
    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;data/baseoutput/output-6&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 2-读取数据--从socket读数据，需要在linux或windows中安装nc，如何安装nc；yum install -y nc   执行nc -lk 9999</span>
    <span class="token keyword">val</span> receiveRDD<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node1.itcast.cn&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">// 3-flatMap</span>
    <span class="token keyword">val</span> flatRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> receiveRDD<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 4-map</span>
    <span class="token keyword">val</span> mapRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> flatRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 5-reduceBykey</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapRDD<span class="token punctuation">.</span>window<span class="token punctuation">(</span>Seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 6-tranform</span>
    <span class="token keyword">val</span> resultRDD1<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> resultRDD<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>rdd <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      rdd<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    resultRDD1<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 6-start</span>
    <span class="token comment">//Start the execution of the streams.</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 7-awaitTermination--Wait for the execution to stop</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><ul><li><img src="spark.assets/image-20210403110809607.png" alt="image-20210403110809607" style="zoom:150%;"></li> <li><p>增加排序的功能</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span>RDD
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> ReceiverInputDStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-准备上下文环境
 * 2-读取数据
 * 3-flatMap
 * 4-map
 * 5-reduceBykey
 * 6-start
 * 7-awaitTermination
 */</span>
<span class="token keyword">object</span> _08windowsOpration <span class="token punctuation">{</span>


  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1-准备上下文环境</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[3]&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//batchDuration the time interval at which streaming data will be divided into batches</span>
    <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;data/baseoutput/output-6&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 2-读取数据--从socket读数据，需要在linux或windows中安装nc，如何安装nc；yum install -y nc   执行nc -lk 9999</span>
    <span class="token keyword">val</span> receiveRDD<span class="token operator">:</span> ReceiverInputDStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;node1.itcast.cn&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>

    <span class="token comment">// 3-flatMap</span>
    <span class="token keyword">val</span> flatRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> receiveRDD<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 4-map</span>
    <span class="token keyword">val</span> mapRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> flatRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 5-reduceBykey</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapRDD<span class="token punctuation">.</span>window<span class="token punctuation">(</span>Seconds<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 6-tranform</span>
    <span class="token keyword">val</span> resultRDD1<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> resultRDD<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>rdd <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> reduceRDD<span class="token operator">:</span> RDD<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> rdd<span class="token punctuation">.</span>reduceByKey<span class="token punctuation">(</span>_ <span class="token operator">+</span> _<span class="token punctuation">)</span>
      reduceRDD<span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    resultRDD1<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 6-start</span>
    <span class="token comment">//Start the execution of the streams.</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 7-awaitTermination--Wait for the execution to stop</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h3 id="sparkstreaming和sparksql整合"><a href="#sparkstreaming和sparksql整合" class="header-anchor">#</a> SparkStreaming和SparkSQL整合</h3> <p>SparkStreaming和基本数据源(监控HDFS文件夹下内容同格式文件)</p> <ul><li>基础数据源</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming<span class="token punctuation">.</span>filesource</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>DStream
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-申请资源
 * 2-读取数据源，设置文件夹
 * 3-通过flatMap，map，updateStateByKey统计
 * 4-ssc.start
 * 5-ssc.awitTermination
 * 6-ssc.stop
 */</span>
<span class="token keyword">object</span> _01textFileSource <span class="token punctuation">{</span>

  <span class="token keyword">def</span> updateFunc<span class="token punctuation">(</span>currenValue<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> historyValue<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> currenValue<span class="token punctuation">.</span>sum <span class="token operator">+</span> historyValue<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    Some<span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1-申请资源</span>
    <span class="token keyword">val</span> ssc<span class="token operator">:</span> StreamingContext <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      ssc
    <span class="token punctuation">}</span>
    ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;data/baseoutput/output-7&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 2-读取数据源，设置文件夹</span>
    <span class="token keyword">val</span> rddDS<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>textFileStream<span class="token punctuation">(</span><span class="token string">&quot;hdfs://node1.itcast.cn:8020/wordcount/trans/&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 3-通过flatMap，map，updateStateByKey统计</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> rddDS
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>updateStateByKey<span class="token punctuation">(</span>updateFunc<span class="token punctuation">)</span>
    resultRDD<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 4-ssc.start</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 5-ssc.awitTermination</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 6-ssc.stop</span>
    ssc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><ul><li><p><img src="./assets/img/image-20210403114432612.bf5b0a13.png" alt="image-20210403114432612"></p></li> <li><p>通过SparkSQL整合SparkSTreaming</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming<span class="token punctuation">.</span>filesource</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span>DStream
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-申请资源
 * 2-读取数据源，设置文件夹
 * 3-通过flatMap，map，updateStateByKey统计
 * 4-ssc.start
 * 5-ssc.awitTermination
 * 6-ssc.stop
 */</span>
<span class="token keyword">object</span> _03textFileSourceSparkSQL <span class="token punctuation">{</span>

  <span class="token keyword">def</span> updateFunc<span class="token punctuation">(</span>currenValue<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> historyValue<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> currenValue<span class="token punctuation">.</span>sum <span class="token operator">+</span> historyValue<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    Some<span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1-申请资源</span>
    <span class="token keyword">val</span> ssc<span class="token operator">:</span> StreamingContext <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      ssc
    <span class="token punctuation">}</span>
    ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;data/baseoutput/output-7&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 2-读取数据源，设置文件夹</span>
    <span class="token keyword">val</span> rddDS<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> ssc<span class="token punctuation">.</span>textFileStream<span class="token punctuation">(</span><span class="token string">&quot;hdfs://node1.itcast.cn:8020/wordcount/trans/&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 3-通过flatMap，map，updateStateByKey统计</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> rddDS<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> resultValue<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> resultRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>updateStateByKey<span class="token punctuation">(</span>updateFunc<span class="token punctuation">)</span>

    resultValue<span class="token punctuation">.</span>foreachRDD<span class="token punctuation">(</span>rdd <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Get the singleton instance of SparkSession</span>
      <span class="token keyword">val</span> spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>config<span class="token punctuation">(</span>rdd<span class="token punctuation">.</span>sparkContext<span class="token punctuation">.</span>getConf<span class="token punctuation">)</span><span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
      <span class="token keyword">val</span> df<span class="token operator">:</span> DataFrame <span class="token operator">=</span> rdd<span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">&quot;word&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//dsl</span>
      <span class="token comment">//sql</span>
      df<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">&quot;table_view&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> result<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
          |select *
          |from table_view
          |&quot;&quot;&quot;</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span>
      result<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 4-ssc.start</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 5-ssc.awitTermination</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 6-ssc.stop</span>
    ssc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><h3 id="sparkstreaming和kafka整合"><a href="#sparkstreaming和kafka整合" class="header-anchor">#</a> SparkStreaming和Kafka整合</h3> <p>kafka原理</p> <ul><li>Kafka</li> <li>什么是消息：应用之间传输的数据</li> <li>什么是消息队列：应用之间保障消息传递的准确性</li> <li>消息队列分类：点对点，发布订阅者方式</li> <li>消息队列应用：限流消峰，应用解耦</li> <li>Kafka：Scala+Java混编，LinkedIn(ActiveMQ)</li> <li>Kafka：生产者，消费者，Broker</li> <li>当前的虚拟机的Kafka的版本是1,1.0大家之前学习的是2,4,1，高版本命令更多使用的是boostrap-server替代zk</li> <li><img src="./assets/img/image-20210403151702229.ca0f1414.png" alt="image-20210403151702229"></li></ul> <p>Kafka安装</p> <ul><li>脚本：</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 当前版本是1.1.0 大家使用的是2.4.1</span>
<span class="token comment"># 1-kafka启动 </span>
<span class="token function">nohup</span> bin/kafka-server-start.sh config/server.properties  <span class="token operator">&amp;</span>
<span class="token comment"># 2-查看kafka内部的topic的内容</span>
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--list</span> <span class="token parameter variable">--zookeeper</span> node1:2181
<span class="token comment">#3-描述topic</span>
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token parameter variable">--zookeeper</span> node1:2181 <span class="token parameter variable">--topic</span> spark_kafka
<span class="token comment"># 创建topic</span>
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token parameter variable">--zookeeper</span> node1:2181 --replication-factor <span class="token number">1</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> <span class="token parameter variable">--topic</span> spark_kafka
<span class="token comment">#描述topic</span>
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token parameter variable">--zookeeper</span> node1:2181 <span class="token parameter variable">--topic</span> spark_kafka
<span class="token comment"># 删除opic</span>
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--zookeeper</span> node1:2181 <span class="token parameter variable">--delete</span> <span class="token parameter variable">--topic</span> <span class="token builtin class-name">test</span>

<span class="token comment">#生产者和消费者</span>
/export/server/kafka/bin/kafka-console-producer.sh --broker-list node1:9092 <span class="token parameter variable">--topic</span> spark_kafka
/export/server/kafka/bin/kafka-console-consumer.sh --bootstrap-server node1:9092 <span class="token parameter variable">--topic</span> spark_kafka --from-beginning 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="整合两种方式区别"><a href="#整合两种方式区别" class="header-anchor">#</a> 整合两种方式区别</h4> <ul><li>实现SparkStreaming和kafka整合</li> <li>两个版本：0.8级0.10以上，目前企业中使用的是0.10版本以上</li> <li>两种消费方式：
<ul><li>Receiver：启动多个Receiver接收器线程拉取kafka数据过来合并，使用WAL和checkpount等
<ul><li>问题1：需要开启多个Receiver线程拉取数据，需要合并数据源</li> <li>问题2：使用的HighLevelAPI对接的是offset维护在ZK中</li> <li>问题3：需要大量的WAL或checkpoint影响效率</li></ul></li> <li><strong>Direct：直接采用直接连接kafka的topic的partition数据，获取区中offset</strong> <ul><li>解决1：直接使用spark的rdd的一个分区对接的是kafka的一个partition</li> <li>解决2：使用的是lowlevel api将offset在kafka的topic中存放的，还可以手动设置</li> <li>解决3：没有提供WAL的方式</li></ul></li></ul></li> <li><img src="./assets/img/image-20210403153026537.4df2d596.png" alt="image-20210403153026537"></li> <li><img src="spark.assets/image-20210403153254881.png" alt="image-20210403153254881" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210403153950592.png" alt="image-20210403153950592" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210403153957570.png" alt="image-20210403153957570" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210403153421089.png" alt="image-20210403153421089" style="zoom:150%;"></li> <li><img src="./assets/img/image-20210403153551432.57a63331.png" alt="image-20210403153551432"></li> <li><img src="./assets/img/image-20210403153758585.3edbac09.png" alt="image-20210403153758585" style="zoom:150%;"></li> <li>几个特点：</li> <li><img src="spark.assets/image-20210403154242521.png" alt="image-20210403154242521" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210403154320025.png" alt="image-20210403154320025" style="zoom:150%;"></li> <li><img src="spark.assets/image-20210403154606414.png" alt="image-20210403154606414" style="zoom:150%;"></li> <li>kafka+sparkstreaming消费者消费数据</li> <li><img src="./assets/img/image-20210403155215474.1a420cec.png" alt="image-20210403155215474"></li></ul> <h4 id="sparkstreaming010整合kafka"><a href="#sparkstreaming010整合kafka" class="header-anchor">#</a> SparkStreaming010整合Kafka</h4> <ul><li><p>010以上kafka版本，使用Directly的方式</p></li> <li><p>需求：【自动提交偏移量】使用sparkstreaming提供的API读取kafka中的数据，使用该数据完成wordcount</p></li> <li><p>步骤：</p> <ul><li>1-导入有kafka和spark整合的Jar包</li></ul></li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-streaming-kafka-0-10_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.4.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p>2-调用streamingCOntext</p></li> <li><p>3-KafkaUtils.creatDriectlyStream的方法直接连接Kafka集群的分区</p></li> <li><p><img src="./assets/img/image-20210403161707554.2ce5b817.png" alt="image-20210403161707554"></p></li> <li><p><img src="./assets/img/image-20210403162224275.47a0835f.png" alt="image-20210403162224275"></p></li> <li><p>在大多数情况下使用此功能，它将在所有执行程序之间一致地分配分区。</p></li> <li><p>LocationStrategies 的几种方式。</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token number">1.</span> LocationStrategies<span class="token punctuation">.</span>PreferBrokers<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>仅仅在你 spark 的 executor 在相同的节点上，优先分配到存在 <a href="https://so.csdn.net/so/search?q=kafka&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">kafka<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> broker 的机器上；</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token number">2.</span> LocationStrategies<span class="token punctuation">.</span>PreferConsistent<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>大多数情况下使用，一致性的方式分配分区所有 executor 上。（主要是为了分布均匀）</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token number">3.</span> LocationStrategies<span class="token punctuation">.</span>PreferFixed<span class="token punctuation">(</span>hostMap<span class="token operator">:</span> collection<span class="token punctuation">.</span>Map<span class="token punctuation">[</span>TopicPartition<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token number">4.</span> LocationStrategies<span class="token punctuation">.</span>PreferFixed<span class="token punctuation">(</span>hostMap<span class="token operator">:</span> ju<span class="token punctuation">.</span>Map<span class="token punctuation">[</span>TopicPartition<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果你的负载不均衡，可以通过这两种方式来手动指定分配方式，其他没有在 map 中指定的，均采用 preferConsistent() 的方式分配；</p> <ul><li><p><img src="./assets/img/image-20210403162530139.c4bb03a4.png" alt="image-20210403162530139"></p></li> <li><p><img src="./assets/img/image-20210403162734342.c54fa28a.png" alt="image-20210403162734342"></p></li> <li><p><img src="./assets/img/image-20210403163144926.3d69eeca.png" alt="image-20210403163144926"></p></li> <li><p>4-获取record记录中的value的值</p></li> <li><p>5-根据value进行累加求和wordcount</p></li> <li><p>6-ssc.statrt</p></li> <li><p>7-ssc.awaitTermination</p></li> <li><p>8-ssc.stop(true,true)</p></li> <li><p>代码</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming<span class="token punctuation">.</span>kafka</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span>ConsumerRecord
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringDeserializer
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> InputDStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span><span class="token punctuation">{</span>ConsumerStrategies<span class="token punctuation">,</span> KafkaUtils<span class="token punctuation">,</span> LocationStrategies<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-导入有kafka和spark整合的Jar包
 * 2-调用streamingCOntext
 * 3-KafkaUtils.creatDriectlyStream的方法直接连接Kafka集群的分区
 * 4-获取record记录中的value的值
 * 5-根据value进行累加求和wordcount
 * 6-ssc.statrt
 * 7-ssc.awaitTermination
 * 8-ssc.stop(true,true)
 */</span>
<span class="token keyword">object</span> _01SparkStreamingKafkaAuto <span class="token punctuation">{</span>
  <span class="token keyword">def</span> updateFunc<span class="token punctuation">(</span>curentValue<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histouryValue<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> curentValue<span class="token punctuation">.</span>sum <span class="token operator">+</span> histouryValue<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    Option<span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">val</span> kafkaParams <span class="token operator">=</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span><span class="token punctuation">(</span>
    <span class="token string">&quot;bootstrap.servers&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;key.deserializer&quot;</span> <span class="token operator">-&gt;</span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;value.deserializer&quot;</span> <span class="token operator">-&gt;</span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;group.id&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;spark_group&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//offset的偏移量自动设置为最新偏移量，有几种设置偏移量的方法</span>
    <span class="token comment">// //这里的auto.offset.reset代表的是自动重置offset为latest就表示的是最新的偏移量，如果没有偏移从最新的位置开始</span>
    <span class="token string">&quot;auto.offset.reset&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;latest&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//是否自动提交，这里设置为自动提交，提交到kafka指导的__consumeroffset中，由kafka自己维护，如果设置为false可以使用ckeckpoint或者是将offset存入mysql</span>
    <span class="token comment">// //这里如果是false手动提交，默认由SparkStreaming提交到checkpoint中，在这里也可以根据用户或程序员将offset偏移量提交到mysql或redis中</span>
    <span class="token string">&quot;enable.auto.commit&quot;</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token builtin">Boolean</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//自动设置提交的时间</span>
    <span class="token string">&quot;auto.commit.interval.ms&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;1000&quot;</span>
  <span class="token punctuation">)</span>



  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-导入有kafka和spark整合的Jar包</span>
    <span class="token comment">//2-调用streamingCOntext</span>
    <span class="token keyword">val</span> ssc<span class="token operator">:</span> StreamingContext <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      ssc
    <span class="token punctuation">}</span>
    ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;data/baseoutput/cck1&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//3-KafkaUtils.creatDriectlyStream的方法直接连接Kafka集群的分区</span>
    <span class="token comment">//ssc: StreamingContext,</span>
    <span class="token comment">//locationStrategy: LocationStrategy,</span>
    <span class="token comment">//consumerStrategy: ConsumerStrategy[K, V]</span>
    <span class="token keyword">val</span> streamRDD<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>
      LocationStrategies<span class="token punctuation">.</span>PreferConsistent<span class="token punctuation">,</span>
      ConsumerStrategies<span class="token punctuation">.</span>Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">&quot;spark_kafka&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kafkaParams<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//4-获取record记录中的value的值</span>
    <span class="token keyword">val</span> mapValue<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//5-根据value进行累加求和wordcount</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapValue
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>updateStateByKey<span class="token punctuation">(</span>updateFunc<span class="token punctuation">)</span>
    resultRDD<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//6-ssc.statrt</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//7-ssc.awaitTermination</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//8-ssc.stop(true,true)</span>
    ssc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><h4 id="手动提交偏移量"><a href="#手动提交偏移量" class="header-anchor">#</a> 手动提交偏移量</h4> <p>​	<strong>（实现恰好一次，但还是存在断网没有及时提交数据）</strong></p> <ul><li><p>https://spark.apache.org/docs/3.1.1/streaming-kafka-0-10-integration.html</p></li> <li><p><img src="./assets/img/image-20210403170438942.38c3491d.png" alt="image-20210403170438942"></p></li> <li><p>`代码（手动提交的偏移量保存在checkpoint中，checkpoint设置为hdfs，这种方式会导致hdfs小文件过多）</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming<span class="token punctuation">.</span>kafka</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span>ConsumerRecord
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringDeserializer
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> InputDStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span><span class="token punctuation">{</span>CanCommitOffsets<span class="token punctuation">,</span> ConsumerStrategies<span class="token punctuation">,</span> HasOffsetRanges<span class="token punctuation">,</span> KafkaUtils<span class="token punctuation">,</span> LocationStrategies<span class="token punctuation">,</span> OffsetRange<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-导入有kafka和spark整合的Jar包
 * 2-调用streamingCOntext
 * 3-KafkaUtils.creatDriectlyStream的方法直接连接Kafka集群的分区
 * 4-获取record记录中的value的值
 * 5-根据value进行累加求和wordcount
 * 6-ssc.statrt
 * 7-ssc.awaitTermination
 * 8-ssc.stop(true,true)
 */</span>
<span class="token keyword">object</span> _02SparkStreamingKafkaByPass <span class="token punctuation">{</span>
  <span class="token keyword">def</span> updateFunc<span class="token punctuation">(</span>curentValue<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histouryValue<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> curentValue<span class="token punctuation">.</span>sum <span class="token operator">+</span> histouryValue<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    Option<span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">val</span> kafkaParams <span class="token operator">=</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span><span class="token punctuation">(</span>
    <span class="token string">&quot;bootstrap.servers&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;key.deserializer&quot;</span> <span class="token operator">-&gt;</span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;value.deserializer&quot;</span> <span class="token operator">-&gt;</span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;group.id&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;spark_group&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//offset的偏移量自动设置为最新偏移量，有几种设置偏移量的方法</span>
    <span class="token comment">//这里的auto.offset.reset代表的是自动重置offset为latest就表示的是最新的偏移量，如果没有偏移从最新的位置开始</span>
    <span class="token string">&quot;auto.offset.reset&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;latest&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//这里如果是false手动提交，默认由SparkStreaming提交到checkpoint中，在这里也可以根据用户或程序员将offset偏移量提交到mysql或redis中</span>
    <span class="token string">&quot;enable.auto.commit&quot;</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token builtin">Boolean</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>


  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-导入有kafka和spark整合的Jar包</span>
    <span class="token comment">//2-调用streamingCOntext</span>
    <span class="token keyword">val</span> ssc<span class="token operator">:</span> StreamingContext <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      ssc
    <span class="token punctuation">}</span>
    ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;data/baseoutput/cck2&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//3-KafkaUtils.creatDriectlyStream的方法直接连接Kafka集群的分区</span>
    <span class="token comment">//ssc: StreamingContext,</span>
    <span class="token comment">//locationStrategy: LocationStrategy,</span>
    <span class="token comment">//consumerStrategy: ConsumerStrategy[K, V]</span>
    <span class="token keyword">val</span> streamRDD<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>
      LocationStrategies<span class="token punctuation">.</span>PreferConsistent<span class="token punctuation">,</span>
      ConsumerStrategies<span class="token punctuation">.</span>Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">&quot;spark_kafka&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kafkaParams<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//实现获取offset然后手动提交offset</span>
    streamRDD<span class="token punctuation">.</span>foreachRDD<span class="token punctuation">(</span>f <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//这里仅仅是为了打印</span>
        println<span class="token punctuation">(</span><span class="token string">&quot;rdd is:&quot;</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>record <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
          println<span class="token punctuation">(</span><span class="token string">&quot;record result is:&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">)</span>
          <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> record<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span>
          println<span class="token punctuation">(</span><span class="token string">&quot;value is:&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token comment">//end id</span>
      <span class="token comment">//获取offset</span>
      <span class="token keyword">val</span> offsetRanges<span class="token operator">:</span> Array<span class="token punctuation">[</span>OffsetRange<span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>HasOffsetRanges<span class="token punctuation">]</span><span class="token punctuation">.</span>offsetRanges
      <span class="token comment">//这里仅仅是为了打印</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span>offsetRange <span class="token keyword">&lt;-</span> offsetRanges<span class="token punctuation">)</span><span class="token punctuation">{</span>
        println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">&quot;topic:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>topic</span><span class="token punctuation">}</span></span><span class="token string"> partition:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>partition</span><span class="token punctuation">}</span></span><span class="token string"> fromoffset:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>fromOffset</span><span class="token punctuation">}</span></span><span class="token string"> endoffset:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>untilOffset</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token comment">//end for</span>
      <span class="token comment">//提交offset,手动的方式默认提交到checkpoint的目录中</span>
      streamRDD<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>CanCommitOffsets<span class="token punctuation">]</span><span class="token punctuation">.</span>commitAsync<span class="token punctuation">(</span>offsetRanges<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>


    <span class="token comment">//4-获取record记录中的value的值</span>
    <span class="token keyword">val</span> mapValue<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//5-根据value进行累加求和wordcount</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapValue
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>updateStateByKey<span class="token punctuation">(</span>updateFunc<span class="token punctuation">)</span>
    resultRDD<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//6-ssc.statrt</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//7-ssc.awaitTermination</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//8-ssc.stop(true,true)</span>
    ssc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><ul><li><p><img src="./assets/img/image-20210403170114199.efffee8d.png" alt="image-20210403170114199"></p></li> <li><p><img src="./assets/img/image-20210403170300844.8197c40e.png" alt="image-20210403170300844"></p></li></ul> <p>代码模板抽取</p> <p><img src="./assets/img/image-20210403170918166.59b3d757.png" alt="image-20210403170918166"></p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming<span class="token punctuation">.</span>kafka</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span>ConsumerRecord
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringDeserializer
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> InputDStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-导入有kafka和spark整合的Jar包
 * 2-调用streamingCOntext
 * 3-KafkaUtils.creatDriectlyStream的方法直接连接Kafka集群的分区
 * 4-获取record记录中的value的值
 * 5-根据value进行累加求和wordcount
 * 6-ssc.statrt
 * 7-ssc.awaitTermination
 * 8-ssc.stop(true,true)
 */</span>
<span class="token keyword">object</span> _03SparkStreamingKafkaModel <span class="token punctuation">{</span>
  <span class="token keyword">def</span> updateFunc<span class="token punctuation">(</span>curentValue<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histouryValue<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> curentValue<span class="token punctuation">.</span>sum <span class="token operator">+</span> histouryValue<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    Option<span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">val</span> kafkaParams <span class="token operator">=</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span><span class="token punctuation">(</span>
    <span class="token string">&quot;bootstrap.servers&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;key.deserializer&quot;</span> <span class="token operator">-&gt;</span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;value.deserializer&quot;</span> <span class="token operator">-&gt;</span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;group.id&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;spark_group&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//offset的偏移量自动设置为最新偏移量，有几种设置偏移量的方法</span>
    <span class="token comment">//这里的auto.offset.reset代表的是自动重置offset为latest就表示的是最新的偏移量，如果没有偏移从最新的位置开始</span>
    <span class="token string">&quot;auto.offset.reset&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;latest&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//这里如果是false手动提交，默认由SparkStreaming提交到checkpoint中，在这里也可以根据用户或程序员将offset偏移量提交到mysql或redis中</span>
    <span class="token string">&quot;enable.auto.commit&quot;</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token builtin">Boolean</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>


  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-导入有kafka和spark整合的Jar包</span>
    <span class="token comment">//2-调用streamingCOntext</span>
    <span class="token keyword">val</span> ssc<span class="token operator">:</span> StreamingContext <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      ssc
    <span class="token punctuation">}</span>
    ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span><span class="token string">&quot;data/baseoutput/cck3&quot;</span><span class="token punctuation">)</span>
    compute<span class="token punctuation">(</span>ssc<span class="token punctuation">)</span>
    <span class="token comment">//6-ssc.statrt</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//7-ssc.awaitTermination</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//8-ssc.stop(true,true)</span>
    ssc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">def</span> compute<span class="token punctuation">(</span>ssc<span class="token operator">:</span> StreamingContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//3-KafkaUtils.creatDriectlyStream的方法直接连接Kafka集群的分区</span>
    <span class="token comment">//ssc: StreamingContext,</span>
    <span class="token comment">//locationStrategy: LocationStrategy,</span>
    <span class="token comment">//consumerStrategy: ConsumerStrategy[K, V]</span>
    <span class="token keyword">val</span> streamRDD<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>
      LocationStrategies<span class="token punctuation">.</span>PreferConsistent<span class="token punctuation">,</span>
      ConsumerStrategies<span class="token punctuation">.</span>Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">&quot;spark_kafka&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kafkaParams<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//实现获取offset然后手动提交offset</span>
    streamRDD<span class="token punctuation">.</span>foreachRDD<span class="token punctuation">(</span>f <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//这里仅仅是为了打印</span>
        println<span class="token punctuation">(</span><span class="token string">&quot;rdd is:&quot;</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>record <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
          println<span class="token punctuation">(</span><span class="token string">&quot;record result is:&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">)</span>
          <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> record<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span>
          println<span class="token punctuation">(</span><span class="token string">&quot;value is:&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token comment">//end id</span>
      <span class="token comment">//获取offset</span>
      <span class="token keyword">val</span> offsetRanges<span class="token operator">:</span> Array<span class="token punctuation">[</span>OffsetRange<span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>HasOffsetRanges<span class="token punctuation">]</span><span class="token punctuation">.</span>offsetRanges
      <span class="token comment">//这里仅仅是为了打印</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>offsetRange <span class="token keyword">&lt;-</span> offsetRanges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">&quot;topic:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>topic</span><span class="token punctuation">}</span></span><span class="token string"> partition:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>partition</span><span class="token punctuation">}</span></span><span class="token string"> fromoffset:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>fromOffset</span><span class="token punctuation">}</span></span><span class="token string"> endoffset:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>untilOffset</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token comment">//end for</span>
      <span class="token comment">//提交offset,手动的方式默认提交到checkpoint的目录中</span>
      streamRDD<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>CanCommitOffsets<span class="token punctuation">]</span><span class="token punctuation">.</span>commitAsync<span class="token punctuation">(</span>offsetRanges<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//4-获取record记录中的value的值</span>
    <span class="token keyword">val</span> mapValue<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//5-根据value进行累加求和wordcount</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapValue
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>updateStateByKey<span class="token punctuation">(</span>updateFunc<span class="token punctuation">)</span>
    resultRDD<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br></div></div><h4 id="checkpoint-恢复"><a href="#checkpoint-恢复" class="header-anchor">#</a> Checkpoint 恢复</h4> <ul><li><img src="spark.assets/image-20210403171127519.png" alt="image-20210403171127519" style="zoom:150%;"></li> <li><img src="./assets/img/image-20210403171318133.7cf4c1a8.png" alt="image-20210403171318133" style="zoom:150%;"></li> <li><p><img src="./assets/img/image-20210403172152495.727c6dec.png" alt="image-20210403172152495"></p> <p>当Streaming Application再次运行时，从Checkpoint检查点目录恢复时，有时有问题，<strong>比如修改程序，再次从运行时</strong>，可能<strong>出现类型转换异常</strong>，如下所示：</p> <blockquote><p>ERROR Utils: Exception encountered  <strong>java.lang.ClassCastException: cannot assign instance of  cn.itcast.spark.ckpt.StreamingCkptState$$anonfun$streamingProcess$1 to field</strong> org.apache.spark.streaming.dstream.ForEachDStream.org$apache$spark$streaming$dstream$ForEachDStream$$foreachFunc  of type scala.Function2 in instance of  org.apache.spark.streaming.dstream.ForEachDStream     at  java.io.ObjectStreamClass$FieldReflector.setObjFieldValues(ObjectStreamClass.java:2133)     at  java.io.ObjectStreamClass.setObjFieldValues(ObjectStreamClass.java:1305)     at java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:2024)</p></blockquote> <p>原因在于修改DStream转换操作，在检查点目录中存储的数据没有此类的相关代码，所以保存ClassCastException异常。</p> <p>此时无法从检查点读取偏移量信息和转态信息，所以实际开发人员：SparkStreaming中Checkpoint功能，属于鸡肋，食之无味，弃之可惜。解决方案：</p> <p>l  1）、针对状态信息：当应用启动时，从外部存储系统读取最新状态，比如从MySQL表读取，或者从Redis读取；</p> <p>l  2）、针对偏移量数据：自己管理偏移量，将偏移量存储到MySQL表、Zookeeper、HBase或Redis；</p> <p><img src="./assets/img/的.91781605.png" alt="img"></p></li> <li><p>代码</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming<span class="token punctuation">.</span>kafka</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span>ConsumerRecord
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringDeserializer
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> InputDStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-导入有kafka和spark整合的Jar包
 * 2-调用streamingCOntext
 * 3-KafkaUtils.creatDriectlyStream的方法直接连接Kafka集群的分区
 * 4-获取record记录中的value的值
 * 5-根据value进行累加求和wordcount
 * 6-ssc.statrt
 * 7-ssc.awaitTermination
 * 8-ssc.stop(true,true)
 */</span>
<span class="token keyword">object</span> _04getActiveOrCreate <span class="token punctuation">{</span>
  <span class="token keyword">def</span> updateFunc<span class="token punctuation">(</span>curentValue<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histouryValue<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> curentValue<span class="token punctuation">.</span>sum <span class="token operator">+</span> histouryValue<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    Option<span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">val</span> kafkaParams <span class="token operator">=</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span><span class="token punctuation">(</span>
    <span class="token string">&quot;bootstrap.servers&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;key.deserializer&quot;</span> <span class="token operator">-&gt;</span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;value.deserializer&quot;</span> <span class="token operator">-&gt;</span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;group.id&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;spark_group&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//offset的偏移量自动设置为最新偏移量，有几种设置偏移量的方法</span>
    <span class="token comment">//这里的auto.offset.reset代表的是自动重置offset为latest就表示的是最新的偏移量，如果没有偏移从最新的位置开始</span>
    <span class="token string">&quot;auto.offset.reset&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;latest&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//这里如果是false手动提交，默认由SparkStreaming提交到checkpoint中，在这里也可以根据用户或程序员将offset偏移量提交到mysql或redis中</span>
    <span class="token string">&quot;enable.auto.commit&quot;</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token builtin">Boolean</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>


  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-导入有kafka和spark整合的Jar包</span>
    <span class="token keyword">val</span> CHECKPOINT <span class="token operator">=</span> <span class="token string">&quot;data/baseoutput/cck5&quot;</span>
    <span class="token comment">//2-调用streamingCOntext</span>
    <span class="token keyword">val</span> ssc<span class="token operator">:</span> StreamingContext <span class="token operator">=</span> StreamingContext<span class="token punctuation">.</span>getActiveOrCreate<span class="token punctuation">(</span>CHECKPOINT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span>CHECKPOINT<span class="token punctuation">)</span>
      compute<span class="token punctuation">(</span>ssc<span class="token punctuation">)</span>
      ssc
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//6-ssc.statrt</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//7-ssc.awaitTermination</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//8-ssc.stop(true,true)</span>
    ssc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">def</span> compute<span class="token punctuation">(</span>ssc<span class="token operator">:</span> StreamingContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//3-KafkaUtils.creatDriectlyStream的方法直接连接Kafka集群的分区</span>
    <span class="token comment">//ssc: StreamingContext,</span>
    <span class="token comment">//locationStrategy: LocationStrategy,</span>
    <span class="token comment">//consumerStrategy: ConsumerStrategy[K, V]</span>
    <span class="token keyword">val</span> streamRDD<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>
      LocationStrategies<span class="token punctuation">.</span>PreferConsistent<span class="token punctuation">,</span>
      ConsumerStrategies<span class="token punctuation">.</span>Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">&quot;spark_kafka&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kafkaParams<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//实现获取offset然后手动提交offset</span>
    streamRDD<span class="token punctuation">.</span>foreachRDD<span class="token punctuation">(</span>f <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//这里仅仅是为了打印</span>
        println<span class="token punctuation">(</span><span class="token string">&quot;rdd is:&quot;</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>record <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
          println<span class="token punctuation">(</span><span class="token string">&quot;record result is:&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">)</span>
          <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> record<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span>
          println<span class="token punctuation">(</span><span class="token string">&quot;value is:&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token comment">//end id</span>
      <span class="token comment">//获取offset</span>
      <span class="token keyword">val</span> offsetRanges<span class="token operator">:</span> Array<span class="token punctuation">[</span>OffsetRange<span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>HasOffsetRanges<span class="token punctuation">]</span><span class="token punctuation">.</span>offsetRanges
      <span class="token comment">//这里仅仅是为了打印</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>offsetRange <span class="token keyword">&lt;-</span> offsetRanges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">&quot;topic:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>topic</span><span class="token punctuation">}</span></span><span class="token string"> partition:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>partition</span><span class="token punctuation">}</span></span><span class="token string"> fromoffset:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>fromOffset</span><span class="token punctuation">}</span></span><span class="token string"> endoffset:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>untilOffset</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token comment">//end for</span>
      <span class="token comment">//提交offset,手动的方式默认提交到checkpoint的目录中</span>
      streamRDD<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>CanCommitOffsets<span class="token punctuation">]</span><span class="token punctuation">.</span>commitAsync<span class="token punctuation">(</span>offsetRanges<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//4-获取record记录中的value的值</span>
    <span class="token keyword">val</span> mapValue<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//5-根据value进行累加求和wordcount</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapValue
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>updateStateByKey<span class="token punctuation">(</span>updateFunc<span class="token punctuation">)</span>
    resultRDD<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><p>偏移量存储在MySQL中</p> <ul><li><p>实际工作中，将offset存储在mysql或redis中，可以监控redis或mysql中offset的变化，从而更好管理offset</p></li> <li><p><img src="./assets/img/image-20210403173545345.a2679cbe.png" alt="image-20210403173545345"></p></li> <li><p>需要使用MySQL的驱动包，DriverManager结合</p></li></ul> <div class="language-mysql line-numbers-mode"><pre class="language-text"><code>    CREATE TABLE `t_offset` (
      `topic` varchar(255) NOT NULL,
      `partition` int(11) NOT NULL,
      `groupid` varchar(255) NOT NULL,
      `offset` bigint(20) DEFAULT NULL,
      PRIMARY KEY (`topic`,`partition`,`groupid`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><p>查询topic的信息</p></li> <li><p><img src="./assets/img/image-20210403174537296.448b047f.png" alt="image-20210403174537296"></p></li> <li><p>查看官网对于TopicPerition的讲解</p></li> <li><p><img src="./assets/img/image-20210403174143467.5935144f.png" alt="image-20210403174143467"></p></li> <li><p><img src="./assets/img/image-20210403174318353.10734f2c.png" alt="image-20210403174318353"></p></li> <li><p>1-MySQL的偏移量查询或保存的工具类提供</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>toMySQL</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DriverManager<span class="token punctuation">,</span> ResultSet<span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span>TopicPartition
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span>OffsetRange

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable</span>

<span class="token keyword">object</span> OffsetUtil <span class="token punctuation">{</span>

    <span class="token comment">//从数据库读取偏移量</span>
    <span class="token keyword">def</span> getOffsetMap<span class="token punctuation">(</span>groupid<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> topic<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> connection <span class="token operator">=</span> DriverManager<span class="token punctuation">.</span>getConnection<span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://localhost:3306/bigdata?characterEncoding=UTF-8&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> pstmt <span class="token operator">=</span> connection<span class="token punctuation">.</span>prepareStatement<span class="token punctuation">(</span><span class="token string">&quot;select * from t_offset where groupid=? and topic=?&quot;</span><span class="token punctuation">)</span>
      pstmt<span class="token punctuation">.</span>setString<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> groupid<span class="token punctuation">)</span>
      pstmt<span class="token punctuation">.</span>setString<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> topic<span class="token punctuation">)</span>
      <span class="token keyword">val</span> rs<span class="token operator">:</span> ResultSet <span class="token operator">=</span> pstmt<span class="token punctuation">.</span>executeQuery<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> offsetMap <span class="token operator">=</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span>TopicPartition<span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>rs<span class="token punctuation">.</span>next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        offsetMap <span class="token operator">+=</span> <span class="token keyword">new</span> TopicPartition<span class="token punctuation">(</span>rs<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span>getInt<span class="token punctuation">(</span><span class="token string">&quot;partition&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> rs<span class="token punctuation">.</span>getLong<span class="token punctuation">(</span><span class="token string">&quot;offset&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      rs<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      pstmt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      offsetMap
    <span class="token punctuation">}</span>

    <span class="token comment">//将偏移量保存到数据库</span>
    <span class="token keyword">def</span> saveOffsetRanges<span class="token punctuation">(</span>groupid<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> offsetRange<span class="token operator">:</span> Array<span class="token punctuation">[</span>OffsetRange<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> connection <span class="token operator">=</span> DriverManager<span class="token punctuation">.</span>getConnection<span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://localhost:3306/bigdata?characterEncoding=UTF-8&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//replace into表示之前有就替换,没有就插入</span>
      <span class="token keyword">val</span> pstmt <span class="token operator">=</span> connection<span class="token punctuation">.</span>prepareStatement<span class="token punctuation">(</span><span class="token string">&quot;replace into t_offset (`topic`, `partition`, `groupid`, `offset`) values(?,?,?,?)&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>o <span class="token keyword">&lt;-</span> offsetRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pstmt<span class="token punctuation">.</span>setString<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>topic<span class="token punctuation">)</span>
        pstmt<span class="token punctuation">.</span>setInt<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>partition<span class="token punctuation">)</span>
        pstmt<span class="token punctuation">.</span>setString<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> groupid<span class="token punctuation">)</span>
        pstmt<span class="token punctuation">.</span>setLong<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> o<span class="token punctuation">.</span>untilOffset<span class="token punctuation">)</span>
        pstmt<span class="token punctuation">.</span>executeUpdate<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      pstmt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><ul><li><p>2-使用MySQL偏移量的工具类给出偏移量</p></li> <li><p>分析一下，什么时候需要从mysql中读取偏移量</p> <ul><li>首先，MysQL中是有offset的记录，才可以读取，判断Map的数是否有空</li> <li>接着，如果Mysql没有记录，拉取最新的偏移量直接消费即可</li> <li>接着，如果MySQL存放了记录，直接读取，直接在subscribe增加第三个参数</li> <li><img src="./assets/img/image-20210403175320379.6ada53e3.png" alt="image-20210403175320379"></li></ul></li> <li><p>分析一下，什么时候应该将偏移量写入Mysql</p> <ul><li>每次有新的数据消费需要更新MySQL的Offset(utilOffset)</li> <li><img src="./assets/img/image-20210403175612958.cd3fd699.png" alt="image-20210403175612958"></li></ul></li> <li><p>代码：</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>sparkstreaming<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>toMySQL</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span>ConsumerRecord
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span>TopicPartition
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringDeserializer
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>dstream<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DStream<span class="token punctuation">,</span> InputDStream<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>kafka010<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Seconds<span class="token punctuation">,</span> StreamingContext<span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable</span>

<span class="token comment">/**
 * DESC:
 * 1-导入有kafka和spark整合的Jar包
 * 2-调用streamingCOntext
 * 3-KafkaUtils.creatDriectlyStream的方法直接连接Kafka集群的分区
 * 4-获取record记录中的value的值
 * 5-根据value进行累加求和wordcount
 * 6-ssc.statrt
 * 7-ssc.awaitTermination
 * 8-ssc.stop(true,true)
 */</span>
<span class="token keyword">object</span> _01getActiveOrCreate <span class="token punctuation">{</span>
  <span class="token keyword">def</span> updateFunc<span class="token punctuation">(</span>curentValue<span class="token operator">:</span> Seq<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> histouryValue<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> sum<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> curentValue<span class="token punctuation">.</span>sum <span class="token operator">+</span> histouryValue<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    Option<span class="token punctuation">(</span>sum<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">val</span> kafkaParams <span class="token operator">=</span> Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> Object<span class="token punctuation">]</span><span class="token punctuation">(</span>
    <span class="token string">&quot;bootstrap.servers&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;key.deserializer&quot;</span> <span class="token operator">-&gt;</span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;value.deserializer&quot;</span> <span class="token operator">-&gt;</span> classOf<span class="token punctuation">[</span>StringDeserializer<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;group.id&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;spark_group&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//offset的偏移量自动设置为最新偏移量，有几种设置偏移量的方法</span>
    <span class="token comment">//这里的auto.offset.reset代表的是自动重置offset为latest就表示的是最新的偏移量，如果没有偏移从最新的位置开始</span>
    <span class="token string">&quot;auto.offset.reset&quot;</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;latest&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//这里如果是false手动提交，默认由SparkStreaming提交到checkpoint中，在这里也可以根据用户或程序员将offset偏移量提交到mysql或redis中</span>
    <span class="token string">&quot;enable.auto.commit&quot;</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token builtin">Boolean</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>


  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-导入有kafka和spark整合的Jar包</span>
    <span class="token keyword">val</span> CHECKPOINT <span class="token operator">=</span> <span class="token string">&quot;data/baseoutput/cck6&quot;</span>
    <span class="token comment">//2-调用streamingCOntext</span>
    <span class="token keyword">val</span> ssc<span class="token operator">:</span> StreamingContext <span class="token operator">=</span> StreamingContext<span class="token punctuation">.</span>getActiveOrCreate<span class="token punctuation">(</span>CHECKPOINT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> StreamingContext<span class="token punctuation">(</span>conf<span class="token punctuation">,</span> Seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      ssc<span class="token punctuation">.</span>checkpoint<span class="token punctuation">(</span>CHECKPOINT<span class="token punctuation">)</span>
      compute<span class="token punctuation">(</span>ssc<span class="token punctuation">)</span>
      ssc
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//6-ssc.statrt</span>
    ssc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//7-ssc.awaitTermination</span>
    ssc<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//8-ssc.stop(true,true)</span>
    ssc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">def</span> compute<span class="token punctuation">(</span>ssc<span class="token operator">:</span> StreamingContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-首先获取偏移量</span>
    <span class="token keyword">val</span> offsetMap<span class="token operator">:</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span>TopicPartition<span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">]</span> <span class="token operator">=</span> OffsetUtil<span class="token punctuation">.</span>getOffsetMap<span class="token punctuation">(</span><span class="token string">&quot;spark_group&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;spark_kafka&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> streamRDD<span class="token operator">:</span> InputDStream<span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offsetMap<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      println<span class="token punctuation">(</span><span class="token string">&quot;如果MySQL中有记录offset,则应该从该offset处开始消费&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//3-KafkaUtils.creatDriectlyStream的方法直接连接Kafka集群的分区</span>
      streamRDD <span class="token operator">=</span> KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>
        LocationStrategies<span class="token punctuation">.</span>PreferConsistent<span class="token punctuation">,</span>
        ConsumerStrategies<span class="token punctuation">.</span>Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">&quot;spark_kafka&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kafkaParams<span class="token punctuation">,</span> offsetMap<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      println<span class="token punctuation">(</span><span class="token string">&quot;如果MySQL中没有记录offset,则直接连接,从latest开始消费&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//3-KafkaUtils.creatDriectlyStream的方法直接连接Kafka集群的分区</span>
      streamRDD <span class="token operator">=</span> KafkaUtils<span class="token punctuation">.</span>createDirectStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>ssc<span class="token punctuation">,</span>
        LocationStrategies<span class="token punctuation">.</span>PreferConsistent<span class="token punctuation">,</span>
        ConsumerStrategies<span class="token punctuation">.</span>Subscribe<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Array<span class="token punctuation">(</span><span class="token string">&quot;spark_kafka&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kafkaParams<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//实现获取offset然后手动提交offset</span>
    streamRDD<span class="token punctuation">.</span>foreachRDD<span class="token punctuation">(</span>f <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//这里仅仅是为了打印</span>
        <span class="token comment">//println(&quot;rdd is:&quot;, f)</span>
        f<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>record <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
          println<span class="token punctuation">(</span><span class="token string">&quot;record result is:&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">)</span>
          <span class="token keyword">val</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> record<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token comment">//println(&quot;value is:&quot;, value)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token comment">//end id</span>
      <span class="token comment">//获取offset</span>
      <span class="token keyword">val</span> offsetRanges<span class="token operator">:</span> Array<span class="token punctuation">[</span>OffsetRange<span class="token punctuation">]</span> <span class="token operator">=</span> f<span class="token punctuation">.</span>asInstanceOf<span class="token punctuation">[</span>HasOffsetRanges<span class="token punctuation">]</span><span class="token punctuation">.</span>offsetRanges
      <span class="token comment">//这里仅仅是为了打印</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>offsetRange <span class="token keyword">&lt;-</span> offsetRanges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">&quot;topic:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>topic</span><span class="token punctuation">}</span></span><span class="token string"> partition:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>partition</span><span class="token punctuation">}</span></span><span class="token string"> fromoffset:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>fromOffset</span><span class="token punctuation">}</span></span><span class="token string"> endoffset:</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">offsetRange<span class="token punctuation">.</span>untilOffset</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token comment">//end for</span>
      <span class="token comment">//提交offset,手动的方式默认提交到checkpoint的目录中</span>
      <span class="token comment">//streamRDD.asInstanceOf[CanCommitOffsets].commitAsync(offsetRanges)</span>
      <span class="token comment">//手动保存在MySQL中</span>
      OffsetUtil<span class="token punctuation">.</span>saveOffsetRanges<span class="token punctuation">(</span><span class="token string">&quot;spark_group&quot;</span><span class="token punctuation">,</span>offsetRanges<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//4-获取record记录中的value的值</span>
    <span class="token keyword">val</span> mapValue<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamRDD<span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//5-根据value进行累加求和wordcount</span>
    <span class="token keyword">val</span> resultRDD<span class="token operator">:</span> DStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> mapValue
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>updateStateByKey<span class="token punctuation">(</span>updateFunc<span class="token punctuation">)</span>
    resultRDD<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div></div><ul><li><p><img src="./assets/img/image-20210403180041343.28b9ff45.png" alt="image-20210403180041343"></p></li> <li><p><img src="./assets/img/image-20210403180025016.f7195e13.png" alt="image-20210403180025016"></p></li></ul> <p>偏移量也可以保存至Zookeeper上或者Redis中，原因如下：</p> <p>l  1）、保存Zookeeper上：方便使用Kafka 监控工具管理Kafka 各个Topic被消费信息；</p> <p>l  2）、保存Redis上：从Redis读取数据和保存数据很快，基于内存数据库；</p> <p>代码可以进一步优化，提高性能：<strong>由于每批次数据结果RDD输出以后，都需要向MySQL数据库表更新偏移量数据，频繁连接数据库，建议构建数据库连接池，每次从池子中获取连接。</strong></p> <h2 id="structuredstreamig引入"><a href="#structuredstreamig引入" class="header-anchor">#</a> StructuredStreamig引入</h2> <h3 id="structuredstreamig定义"><a href="#structuredstreamig定义" class="header-anchor">#</a> StructuredStreamig定义</h3> <ul><li>StructuredStreaming<strong>结构化流</strong>--处理实时数据(流式数据)</li> <li><strong>流式处理的方式</strong>：（1）原生的处理方式：来一条数据处理一条 结构化流和Flink（2）<strong>微批次处理方式</strong>：SParkStreaming</li> <li><strong>底层数据结构</strong>：底层数据结构类似SparkSQL，使用DataFrame和DataSet</li> <li><img src="./assets/img/image-20210405103325480.e52bbab2.png" alt="image-20210405103325480"></li> <li><img src="./assets/img/image-20210405103642322.fa629a9e.png" alt="image-20210405103642322"></li></ul> <h3 id="structuredstreaming与sparkstreaming区别"><a href="#structuredstreaming与sparkstreaming区别" class="header-anchor">#</a> StructuredStreaming与sparkstreaming区别</h3> <p>SparkStreaming问题四点</p> <ul><li>1-SparkStreaing的时间是基于ProcessingTime处理时间，而不是EventTime事件时间</li> <li><s>2-SparkStreaming编程API偏底层，本质上就是要去构造RDD的DAG执行图</s></li> <li>3-SparkStreaming无法实现端到端的一致性,<strong>DStream 只能保证自己的一致性语义是 exactly-once 的</strong>，而 input 接入 Spark Streaming 和 Spark Straming 输出到外部存储的语义往往需要用户自己来保证；</li> <li>4-SparkStreaming无法实现流批统一,有时候确实需要将的流处理逻辑运行到批数据上面,转化成RDD需要一定的工作量</li></ul> <p>StructuredStreaming应用场景</p> <ul><li>结构化流解决SparkStreaing的问题</li> <li><strong>1-结构化流是基于EventTime事件时间处理</strong></li> <li>2-使用DataFrame和DataSet的API</li> <li><strong>3-结构化流实现从source到sink的端到端的一致性exactly-once</strong></li> <li><strong>4-结构化流实现批处理和流式处理的统一</strong></li> <li>结构化流使用两种API
<ul><li>ProcesstimgTime--微批次处理场景</li> <li>CotinuceTime-实时的场景</li></ul></li> <li><img src="./assets/img/image-20210405105542562.107123d8.png" alt="image-20210405105542562" style="zoom:150%;"></li></ul> <h3 id="结构化流编程模型"><a href="#结构化流编程模型" class="header-anchor">#</a> 结构化流编程模型</h3> <ul><li><p><img src="./assets/img/image-20210405105945362.b0039551.png" alt="image-20210405105945362"></p></li> <li><img src="./assets/img/image-20210405110054378.4a0dc54f.png" alt="image-20210405110054378" style="zoom:150%;"></li></ul> <h3 id="入门案例"><a href="#入门案例" class="header-anchor">#</a> 入门案例</h3> <h4 id="structuredstreaming第一个案例-socket"><a href="#structuredstreaming第一个案例-socket" class="header-anchor">#</a> StructuredStreaming第一个案例-Socket</h4> <ul><li><p>需求：实现wordcount案例</p></li> <li><p><img src="./assets/img/image-20210405110902911.94edf882.png" alt="image-20210405110902911"></p></li> <li><p>分析：</p></li> <li><p><img src="./assets/img/image-20210405110615601.92639034.png" alt="image-20210405110615601"></p></li> <li><p>l 第一行表示从socket不断接收数据，</p> <p>l 第二行是时间轴，表示每隔1秒进行一次数据处理，</p> <p>l 第三行可以看成是之前提到的“unbound table&quot;，</p> <p>l 第四行为最终的wordCounts是结果集。</p></li> <li><p>代码：</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>iitcast<span class="token punctuation">.</span>structedstreaming</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>TimeUnit

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span>StringUtils
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>OutputMode<span class="token punctuation">,</span> StreamingQuery<span class="token punctuation">,</span> Trigger<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> Dataset<span class="token punctuation">,</span> Row<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-首先准备sparksession，底层是sparksql的引擎
 * 2-读取socket的流式数据
 * 3-wordcount统计
 * 4-输出到控制台
 */</span>
<span class="token keyword">object</span> _01socketSource <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-首先准备sparksession，底层是sparksql的引擎</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">//.set(&quot;spark.sql.shuffle.partitions&quot;,&quot;4&quot;)</span>
      <span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.shuffle.partitions&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//spark.sparkContext.setLogLevel(&quot;WARN&quot;)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//2-读取socket的流式数据</span>
    <span class="token keyword">val</span> streamData<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>readStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;host&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node1&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
    streamData<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// |-- value: string (nullable = true)</span>
    <span class="token comment">//3-wordcount统计</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> Dataset<span class="token punctuation">[</span>Row<span class="token punctuation">]</span> <span class="token operator">=</span> streamData
      <span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span>isNoneBlank<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span><span class="token symbol">'count</span><span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
    <span class="token comment">//value.printSchema()</span>
    <span class="token comment">//4-输出到控制台</span>
    <span class="token keyword">val</span> query<span class="token operator">:</span> StreamingQuery <span class="token operator">=</span> result<span class="token punctuation">.</span>writeStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;console&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//.outputMode(&quot;complete&quot;)</span>
      <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span>OutputMode<span class="token punctuation">.</span>Complete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;numRows&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;truncate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//.trigger(Trigger.ProcessingTime(10))</span>
      <span class="token punctuation">.</span>trigger<span class="token punctuation">(</span>Trigger<span class="token punctuation">.</span>ProcessingTime<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//Starts the execution of the streaming query,</span>

    query<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    query<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><ul><li><p>总结：</p></li> <li><p>一定是spark.sql.shuffle.partition分区个数默认为200需要设置小一些</p></li></ul> <h4 id="structuredstreaming文本数据源"><a href="#structuredstreaming文本数据源" class="header-anchor">#</a> StructuredStreaming文本数据源</h4> <ul><li><p>需求：通过文件夹不断放入文件然后<strong>统计年龄小于25岁的人群的爱好排行榜。</strong></p></li> <li><p>分析：</p></li> <li><p>1-指定SparkSession</p></li> <li><p>2-读取文本数据源</p></li> <li><p>3-执行统计</p></li> <li><p>4-输出到控制台</p></li> <li><p>5-query.awaitTermination</p></li> <li><p>6-query.stop</p></li> <li><p>代码：</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>iitcast<span class="token punctuation">.</span>structedstreaming<span class="token punctuation">.</span>filesource</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataTypes<span class="token punctuation">,</span> StructField<span class="token punctuation">,</span> StructType<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>OutputMode<span class="token punctuation">,</span> StreamingQuery<span class="token punctuation">,</span> Trigger<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">object</span> _01FileSource <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-指定SparkSession</span>
    <span class="token comment">//1-首先准备sparksession，底层是sparksql的引擎</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.shuffle.partitions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//2-读取文本数据源---将不同名称的文件放入到文件夹中统计</span>
    <span class="token keyword">val</span> schema<span class="token operator">:</span> StructType <span class="token operator">=</span> StructType<span class="token punctuation">(</span>
      StructField<span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>StringType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">::</span>
        StructField<span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>IntegerType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">::</span>
        StructField<span class="token punctuation">(</span><span class="token string">&quot;hobby&quot;</span><span class="token punctuation">,</span> DataTypes<span class="token punctuation">.</span>StringType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">::</span> Nil
    <span class="token punctuation">)</span>
      <span class="token comment">//思考：批处理如何读取数据设定查询条件？</span>
    <span class="token keyword">val</span> streamDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>readStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;csv&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;sep&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;;&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;header&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>schema<span class="token punctuation">(</span>schema<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">&quot;data/baseinput/struct/&quot;</span><span class="token punctuation">)</span>
    streamDF<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//3-执行统计-统计年龄小于25岁的人群的爱好排行榜。</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> DataFrame <span class="token operator">=</span> streamDF
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span><span class="token symbol">'age</span> <span class="token operator">&lt;</span> <span class="token number">25</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token symbol">'hobby</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//4-输出到控制台</span>
    <span class="token keyword">val</span> query<span class="token operator">:</span> StreamingQuery <span class="token operator">=</span> result<span class="token punctuation">.</span>writeStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;console&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span>OutputMode<span class="token punctuation">.</span>Complete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;numRows&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;truncate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>trigger<span class="token punctuation">(</span>Trigger<span class="token punctuation">.</span>ProcessingTime<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//5-query.awaitTermination</span>
    query<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//6-query.stop</span>
    query<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><ul><li><p>总结：</p></li> <li><p>读取文本数据源的参考</p></li> <li></li></ul> <h3 id="structuredstreaming的kakfa整合"><a href="#structuredstreaming的kakfa整合" class="header-anchor">#</a> StructuredStreaming的Kakfa整合</h3> <ul><li><p>需求：通过StructuredStreaming结合Kakfa消费Kafka中的数据实现单词统计计数</p></li> <li><p>步骤：</p> <ul><li>1-准备上下文环境</li> <li>2-读取Kafka的数据</li> <li>3-将Kafka的数据转化，实现单词统计技术</li> <li>4-将得到结果写入控制台</li> <li>5.query.awaitTermination</li> <li>6-query.stop</li></ul></li> <li><p>代码：</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>iitcast<span class="token punctuation">.</span>structedstreaming<span class="token punctuation">.</span>kafka</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>OutputMode<span class="token punctuation">,</span> StreamingQuery<span class="token punctuation">,</span> Trigger<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> Dataset<span class="token punctuation">,</span> Row<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * * 1-准备上下文环境
 * * 2-读取Kafka的数据
 * * 3-将Kafka的数据转化，实现单词统计技术
 * * 4-将得到结果写入控制台
 * * 5.query.awaitTermination
 * * 6-query.stop
 */</span>
<span class="token keyword">object</span> _01KafkaSourceWordcount <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-准备上下文环境</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.shuffle.partitions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//spark.sparkContext.setLogLevel(&quot;WARN&quot;)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//2-读取Kafka的数据</span>
    <span class="token keyword">val</span> streamDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>readStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;kafka&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;kafka.bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;subscribe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wordstopic&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//streamDF.printSchema()</span>
    <span class="token comment">//root</span>
    <span class="token comment">// |-- key: binary (nullable = true)</span>
    <span class="token comment">// |-- value: binary (nullable = true)</span>
    <span class="token comment">// |-- topic: string (nullable = true)</span>
    <span class="token comment">// |-- partition: integer (nullable = true)</span>
    <span class="token comment">// |-- offset: long (nullable = true)</span>
    <span class="token comment">// |-- timestamp: timestamp (nullable = true)</span>
    <span class="token comment">// |-- timestampType: integer (nullable = true)</span>
    <span class="token comment">//3-将Kafka的数据转化，实现单词统计技术</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> Dataset<span class="token punctuation">[</span>Row<span class="token punctuation">]</span> <span class="token operator">=</span> streamDF
      <span class="token punctuation">.</span>selectExpr<span class="token punctuation">(</span><span class="token string">&quot;cast (value as string)&quot;</span><span class="token punctuation">)</span> <span class="token comment">//因为kafka得到的数据是binary类型的数据需要使用cast转换</span>
      <span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>x <span class="token keyword">=&gt;</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// |-- value: string (nullable = true)</span>
      <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>$<span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span><span class="token symbol">'count</span><span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
    <span class="token comment">//.groupBy(&quot;value&quot;)</span>
    <span class="token comment">//4-将得到结果写入控制台</span>
    <span class="token keyword">val</span> query<span class="token operator">:</span> StreamingQuery <span class="token operator">=</span> result
      <span class="token punctuation">.</span>writeStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;console&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span>OutputMode<span class="token punctuation">.</span>Complete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>trigger<span class="token punctuation">(</span>Trigger<span class="token punctuation">.</span>ProcessingTime<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;numRows&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;truncate&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//5.query.awaitTermination</span>
    query<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//6-query.stop</span>
    query<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><ul><li><p>总结：</p></li> <li><p>Kafka整合代码需要掌握</p></li> <li><p><img src="./assets/img/image-20210405155454255.1b4ba110.png" alt="image-20210405155454255"></p></li> <li><p><img src="./assets/img/image-20210405155649481.db9330e7.png" alt="image-20210405155649481"></p></li> <li><p><img src="./assets/img/image-20210405155750912.920e8895.png" alt="image-20210405155750912"></p></li> <li><p>数据结果写入kafka</p></li> <li><p><img src="./assets/img/image-20210405160238993.9082d7be.png" alt="image-20210405160238993"></p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">// Write key-value data from a DataFrame to a specific Kafka topic specified in an option</span>
<span class="token keyword">val</span> ds <span class="token operator">=</span> df
  <span class="token punctuation">.</span>selectExpr<span class="token punctuation">(</span><span class="token string">&quot;CAST(key AS STRING)&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CAST(value AS STRING)&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>writeStream
  <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;kafka&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;kafka.bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;host1:port1,host2:port2&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;topic1&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="运营商基站数据etl"><a href="#运营商基站数据etl" class="header-anchor">#</a> 运营商基站数据ETL</h4> <ul><li><p>案例</p></li> <li><img src="spark.assets/image-20210405160605762.png" alt="image-20210405160605762" style="zoom:150%;"></li> <li><p>准备Kafka的topic</p></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 实时ETL案例1</span>
<span class="token comment">#查看topic信息</span>
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--list</span> <span class="token parameter variable">--zookeeper</span> node1:2181
<span class="token comment">#删除topic</span>
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--delete</span> <span class="token parameter variable">--zookeeper</span> node1:2181 <span class="token parameter variable">--topic</span> stationTopic
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--delete</span> <span class="token parameter variable">--zookeeper</span> node1:2181 <span class="token parameter variable">--topic</span> etlTopic

<span class="token comment">#创建topic</span>
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token parameter variable">--zookeeper</span> node1:2181 --replication-factor <span class="token number">1</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> <span class="token parameter variable">--topic</span> stationTopic
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token parameter variable">--zookeeper</span> node1:2181 --replication-factor <span class="token number">1</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> <span class="token parameter variable">--topic</span> etlTopic

<span class="token comment">#模拟生产者</span>
/export/server/kafka/bin/kafka-console-producer.sh --broker-list node1:9092 <span class="token parameter variable">--topic</span> stationTopic
/export/server/kafka/bin/kafka-console-producer.sh --broker-list node1:9092 <span class="token parameter variable">--topic</span> etlTopic

<span class="token comment">#模拟消费者----------stationTopic</span>
/export/server/kafka/bin/kafka-console-consumer.sh --bootstrap-server node1:9092 <span class="token parameter variable">--topic</span> stationTopic --from-beginning
/export/server/kafka/bin/kafka-console-consumer.sh --bootstrap-server node1:9092 <span class="token parameter variable">--topic</span> etlTopic --from-beginning
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li><p>Mock模拟一个Kafka的Producer生产Station数据</p></li> <li><img src="spark.assets/image-20210405161003547.png" alt="image-20210405161003547" style="zoom:150%;"></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>iitcast<span class="token punctuation">.</span>structedstreaming<span class="token punctuation">.</span>kafka</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Properties

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token punctuation">{</span>KafkaProducer<span class="token punctuation">,</span> ProducerRecord<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span>StringSerializer

<span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Random

<span class="token comment">/**
 * 模拟产生基站日志数据，实时发送Kafka Topic中，数据字段信息：
 * 基站标识符ID, 主叫号码, 被叫号码, 通话状态, 通话时间，通话时长
 */</span>
<span class="token keyword">object</span> MockStationLog <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 发送Kafka Topic</span>
    <span class="token keyword">val</span> props <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;acks&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;retries&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>
    props<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;key.serializer&quot;</span><span class="token punctuation">,</span> classOf<span class="token punctuation">[</span>StringSerializer<span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    props<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;value.serializer&quot;</span><span class="token punctuation">,</span> classOf<span class="token punctuation">[</span>StringSerializer<span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">)</span>
    <span class="token keyword">val</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> KafkaProducer<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>

    <span class="token keyword">val</span> random <span class="token operator">=</span> <span class="token keyword">new</span> Random<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> allStatus <span class="token operator">=</span> Array<span class="token punctuation">(</span>
      <span class="token string">&quot;fail&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;busy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;barring&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;success&quot;</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> callOut<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">&quot;1860000%04d&quot;</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>random<span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> callIn<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token string">&quot;1890000%04d&quot;</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>random<span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> callStatus<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> allStatus<span class="token punctuation">(</span>random<span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span>allStatus<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> callDuration <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">.</span>equals<span class="token punctuation">(</span>callStatus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000L</span> <span class="token keyword">else</span> <span class="token number">0L</span>

      <span class="token comment">// 随机产生一条基站日志数据</span>
      <span class="token keyword">val</span> stationLog<span class="token operator">:</span> StationLog <span class="token operator">=</span> StationLog<span class="token punctuation">(</span>
        <span class="token string">&quot;station_&quot;</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        callOut<span class="token punctuation">,</span>
        callIn<span class="token punctuation">,</span>
        callStatus<span class="token punctuation">,</span>
        System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        callDuration
      <span class="token punctuation">)</span>
      println<span class="token punctuation">(</span>stationLog<span class="token punctuation">.</span>toString<span class="token punctuation">)</span>
      Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token keyword">val</span> record <span class="token operator">=</span> <span class="token keyword">new</span> ProducerRecord<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;stationTopic&quot;</span><span class="token punctuation">,</span> stationLog<span class="token punctuation">.</span>toString<span class="token punctuation">)</span>
      producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span>record<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    producer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 关闭连接</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 基站通话日志数据
   */</span>
  <span class="token keyword">case</span> <span class="token keyword">class</span> StationLog<span class="token punctuation">(</span>
                         stationId<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token comment">//基站标识符ID</span>
                         callOut<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token comment">//主叫号码</span>
                         callIn<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token comment">//被叫号码</span>
                         callStatus<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token comment">//通话状态</span>
                         callTime<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token comment">//通话时间</span>
                         duration<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token comment">//通话时长</span>
                       <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">def</span> toString<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token string-interpolation"><span class="token id function">s</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">stationId</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">callOut</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">callIn</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">callStatus</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">callTime</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">duration</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><ul><li><p>StationTopic开启消费者消费Producer产生的数据</p></li> <li><p>接着通过结构化流获取staiontopic的kafka数据，进行过滤</p></li></ul> <p>步骤</p> <ul><li>1-首先将Kafka两个Topic构建好</li> <li>2-启动模拟程序模拟生产者生产station数据到staiontopic中</li> <li>3-启动StructuredStreaming消费staiontopic的数据</li> <li>4-进行etl的操作---------过滤下标三个字段(callStatus=‘success’)</li> <li>5-将过滤出来的数据写入到etltopic中</li> <li>6-查看etltopic的消费者查看结果是否正确</li></ul> <p>代码</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>iitcast<span class="token punctuation">.</span>structedstreaming<span class="token punctuation">.</span>kafka</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span>StringUtils
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span>StreamingQuery
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> Dataset<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 */</span>
<span class="token keyword">object</span> _02StationDataProcess <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-首先将Kafka两个Topic构建好</span>
    <span class="token comment">//1-准备上下文环境</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.shuffle.partitions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">//2-启动模拟程序模拟生产者生产station数据到staiontopic中</span>
    <span class="token comment">//3-启动StructuredStreaming消费staiontopic的数据</span>
    <span class="token keyword">val</span> streamDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>readStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;kafka&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;kafka.bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;subscribe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;stationTopic&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//4-进行etl的操作---------过滤下标三个字段(callStatus=‘success’)</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> Dataset<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> streamDF
      <span class="token punctuation">.</span>selectExpr<span class="token punctuation">(</span><span class="token string">&quot;cast (value as string)&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>line <span class="token keyword">=&gt;</span> StringUtils<span class="token punctuation">.</span>isNotBlank<span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">.</span>equals<span class="token punctuation">(</span>line<span class="token punctuation">.</span>trim<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//5-将过滤出来的数据写入到etltopic中</span>
    <span class="token keyword">val</span> query<span class="token operator">:</span> StreamingQuery <span class="token operator">=</span> result<span class="token punctuation">.</span>writeStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;kafka&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;kafka.bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;etlTopic&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;checkpointLocation&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;data/baseoutput/checkpoint-2&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//6-查看etltopic的消费者查看结果是否正确</span>
    query<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    query<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>结果</p> <ul><li><img src="./assets/img/image-20210405162557574.0d46d563.png" alt="image-20210405162557574"></li></ul> <h4 id="物联网案例"><a href="#物联网案例" class="header-anchor">#</a> 物联网案例</h4> <ul><li><p>IOT</p></li> <li><p>基本配置</p></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 物联网设备案例</span>
<span class="token comment">#查看topic信息</span>
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--list</span> <span class="token parameter variable">--zookeeper</span> node1:2181
<span class="token comment">#删除topic</span>
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--delete</span> <span class="token parameter variable">--zookeeper</span> node1:2181 <span class="token parameter variable">--topic</span> iotTopic

<span class="token comment">#创建topic</span>
/export/server/kafka/bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token parameter variable">--zookeeper</span> node1:2181 --replication-factor <span class="token number">1</span> <span class="token parameter variable">--partitions</span> <span class="token number">3</span> <span class="token parameter variable">--topic</span> iotTopic

<span class="token comment">#模拟生产者</span>
/export/server/kafka/bin/kafka-console-producer.sh --broker-list node1:9092 <span class="token parameter variable">--topic</span> iotTopic
<span class="token comment">#模拟消费者</span>
/export/server/kafka/bin/kafka-console-consumer.sh --bootstrap-server node1:9092 <span class="token parameter variable">--topic</span> iotTopic --from-beginning
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li><p>对物联网设备状态信号数据，实时统计分析:</p> <p>1）、信号强度大于30的设备；</p> <p>2）、各种设备类型的数量；</p> <p>3）、各种设备类型的平均信号强度；</p></li> <li><p>梳理流程：</p></li> <li><p>1-首先准备生产者生产IOT的设备的数据，IOT可以开启topic的消费者查看是否成功消费</p></li> <li><p>2-使用StructuredStreaming读取Kafka的数据</p></li> <li><p>3-处理IOTTopic的数据--DSL&amp;SQL</p></li> <li><p>4-将数据结果写入控制台</p></li> <li><p>5-query.awaitTermination</p></li> <li><p>6-query.stop</p></li> <li><p>代码：</p></li> <li><p>SQL的实现</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>iitcast<span class="token punctuation">.</span>structedstreaming<span class="token punctuation">.</span>iot</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>OutputMode<span class="token punctuation">,</span> StreamingQuery<span class="token punctuation">,</span> Trigger<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>DoubleType

<span class="token comment">/**
 * DESC:
 * 1-首先准备生产者生产IOT的设备的数据，IOT可以开启topic的消费者查看是否成功消费
 * 2-使用StructuredStreaming读取Kafka的数据
 * 3-处理IOTTopic的数据--DSL&amp;SQL
 * 4-将数据结果写入控制台
 * 5-query.awaitTermination
 * 6-query.stop
 */</span>
<span class="token keyword">object</span> _01IOTStreamProcess <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-首先准备生产者生产IOT的设备的数据，IOT可以开启topic的消费者查看是否成功消费</span>
    <span class="token comment">//2-使用StructuredStreaming读取Kafka的数据</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.shuffle.partitions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> streamDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>readStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;kafka&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;kafka.bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;subscribe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;iotTopic&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//3-处理IOTTopic的数据--DSL&amp;SQL</span>
    <span class="token keyword">val</span> parseJsonData<span class="token operator">:</span> DataFrame <span class="token operator">=</span> streamDF
      <span class="token punctuation">.</span>selectExpr<span class="token punctuation">(</span><span class="token string">&quot;cast (value as string)&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>
      <span class="token comment">//{&quot;device&quot;:&quot;device_10&quot;,&quot;deviceType&quot;:&quot;db&quot;,&quot;signal&quot;:74.0,&quot;time&quot;:1617612014757}</span>
      <span class="token punctuation">.</span>select<span class="token punctuation">(</span>
        get_json_object<span class="token punctuation">(</span>$<span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$.device&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;device&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        get_json_object<span class="token punctuation">(</span>$<span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$.deviceType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;deviceType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        get_json_object<span class="token punctuation">(</span>$<span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$.signal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cast<span class="token punctuation">(</span>DoubleType<span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;signal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        get_json_object<span class="token punctuation">(</span>$<span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$.time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token comment">//SQL:signal &gt; 30 所有数据，按照设备类型 分组，统计数量、平均信号强度</span>
    parseJsonData<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">&quot;table_view&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> sql <span class="token operator">=</span>
      <span class="token triple-quoted-string string">&quot;&quot;&quot;
        |select round(avg(signal),2) as avg_signal,count(deviceType) as device_counts
        |from table_view
        |where signal &gt;30
        |group by deviceType
        |&quot;&quot;&quot;</span><span class="token punctuation">.</span>stripMargin
    <span class="token keyword">val</span> result<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token comment">//4-将数据结果写入控制台</span>
    <span class="token keyword">val</span> query<span class="token operator">:</span> StreamingQuery <span class="token operator">=</span> result<span class="token punctuation">.</span>writeStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;console&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span>OutputMode<span class="token punctuation">.</span>Complete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;numRows&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;truncate&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>trigger<span class="token punctuation">(</span>Trigger<span class="token punctuation">.</span>ProcessingTime<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//5-query.awaitTermination</span>
    query<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//6-query.stop</span>
    query<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><ul><li>方法2：使用DSL方式</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>iitcast<span class="token punctuation">.</span>structedstreaming<span class="token punctuation">.</span>iot</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>OutputMode<span class="token punctuation">,</span> StreamingQuery<span class="token punctuation">,</span> Trigger<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>DoubleType
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-首先准备生产者生产IOT的设备的数据，IOT可以开启topic的消费者查看是否成功消费
 * 2-使用StructuredStreaming读取Kafka的数据
 * 3-处理IOTTopic的数据--DSL&amp;SQL
 * 4-将数据结果写入控制台
 * 5-query.awaitTermination
 * 6-query.stop
 */</span>
<span class="token keyword">object</span> _02IOTStreamProcessDSL <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//1-首先准备生产者生产IOT的设备的数据，IOT可以开启topic的消费者查看是否成功消费</span>
    <span class="token comment">//2-使用StructuredStreaming读取Kafka的数据</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.shuffle.partitions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token keyword">val</span> streamDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>readStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;kafka&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;kafka.bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;subscribe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;iotTopic&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//3-处理IOTTopic的数据--DSL&amp;SQL</span>
    <span class="token keyword">val</span> parseJsonData<span class="token operator">:</span> DataFrame <span class="token operator">=</span> streamDF
      <span class="token punctuation">.</span>selectExpr<span class="token punctuation">(</span><span class="token string">&quot;cast (value as string)&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>
      <span class="token comment">//{&quot;device&quot;:&quot;device_10&quot;,&quot;deviceType&quot;:&quot;db&quot;,&quot;signal&quot;:74.0,&quot;time&quot;:1617612014757}</span>
      <span class="token punctuation">.</span>select<span class="token punctuation">(</span>
        get_json_object<span class="token punctuation">(</span>$<span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$.device&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;device&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        get_json_object<span class="token punctuation">(</span>$<span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$.deviceType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;deviceType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        get_json_object<span class="token punctuation">(</span>$<span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$.signal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cast<span class="token punctuation">(</span>DoubleType<span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;signal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        get_json_object<span class="token punctuation">(</span>$<span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;$.time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;time&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token comment">//SQL:signal &gt; 30 所有数据，按照设备类型 分组，统计数量、平均信号强度</span>
    parseJsonData<span class="token punctuation">.</span>createOrReplaceTempView<span class="token punctuation">(</span><span class="token string">&quot;table_view&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">/* val sql =
       &quot;&quot;&quot;
         |select round(avg(signal),2) as avg_signal,count(deviceType) as device_counts
         |from table_view
         |where signal &gt;30
         |group by deviceType
         |&quot;&quot;&quot;.stripMargin
     val result: DataFrame = spark.sql(sql)*/</span>
    <span class="token keyword">val</span> result<span class="token operator">:</span> DataFrame <span class="token operator">=</span> parseJsonData
      <span class="token comment">//.select(&quot;signal&quot;, &quot;deviceType&quot;)</span>
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span><span class="token symbol">'signal</span> <span class="token operator">&gt;</span> <span class="token number">30</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">&quot;deviceType&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>agg<span class="token punctuation">(</span>
        round<span class="token punctuation">(</span>avg<span class="token punctuation">(</span><span class="token string">&quot;signal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;avg_signal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        count<span class="token punctuation">(</span><span class="token string">&quot;deviceType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">&quot;device_counts&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>

    <span class="token comment">//4-将数据结果写入控制台</span>
    <span class="token keyword">val</span> query<span class="token operator">:</span> StreamingQuery <span class="token operator">=</span> result<span class="token punctuation">.</span>writeStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;console&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span>OutputMode<span class="token punctuation">.</span>Complete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;numRows&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;truncate&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>trigger<span class="token punctuation">(</span>Trigger<span class="token punctuation">.</span>ProcessingTime<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//5-query.awaitTermination</span>
    query<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//6-query.stop</span>
    query<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><ul><li><p>总结：</p></li> <li><p>解析Json的方式可以采用SparkSQL的getJsonObject的方式</p></li> <li><p>更复杂的Json格式解析</p></li></ul> <p><strong>对于重复数据去重操作</strong></p> <ul><li>对于指定的字段或多个字段进行去重操作</li> <li><img src="./assets/img/image-20210405173831039.8789ecba.png" alt="image-20210405173831039" style="zoom:150%;"></li> <li><img src="./assets/img/image-20210405174316849.d1b3f598.png" alt="image-20210405174316849"></li></ul> <h5 id="structureedstreaming的foreach及foreachbatch"><a href="#structureedstreaming的foreach及foreachbatch" class="header-anchor">#</a> StructureedStreaming的Foreach及ForeachBatch</h5> <ul><li>结构化流写入MySQL中</li> <li><img src="./assets/img/image-20210405145120162.2bbf7dcd.png" alt="image-20210405145120162"></li></ul> <p>Foreach</p> <ul><li><p>了解foreach</p></li> <li><p>1-驱动包导入</p></li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>  url=&quot;jdbc:mysql://localhost:3306/database_name&quot;
  驱动：com.mysql.jdbc.Driver
  驱动包Maven:
  <span class="token comment">&lt;!-- MySQL Client 5.1.38依赖 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.38<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>2-在MySQL中创建表</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t_word<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>word<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>word<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>word<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">26</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>2-JDBC的驱动类</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//注意这里不要加format(“console”)</span>
  <span class="token keyword">class</span> JDBCSink<span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> username<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
    <span class="token keyword">extends</span> ForeachWriter<span class="token punctuation">[</span>Row<span class="token punctuation">]</span> <span class="token keyword">with</span> Serializable <span class="token punctuation">{</span>
   <span class="token keyword">var</span> connection<span class="token operator">:</span> Connection <span class="token operator">=</span> _ <span class="token comment">//_表示占位符,后面会给变量赋值</span>
    <span class="token keyword">var</span> preparedStatement<span class="token operator">:</span> PreparedStatement <span class="token operator">=</span> _

    <span class="token comment">//开启连接</span>
    <span class="token keyword">override</span> <span class="token keyword">def</span> <span class="token keyword">open</span><span class="token punctuation">(</span>partitionId<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> version<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      connection <span class="token operator">=</span> DriverManager<span class="token punctuation">.</span>getConnection<span class="token punctuation">(</span>url<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
      <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    CREATE TABLE `t_word` (
        `id` int(11) NOT NULL AUTO_INCREMENT,
        `word` varchar(255) NOT NULL,
        `count` int(11) DEFAULT NULL,
        PRIMARY KEY (`id`),
        UNIQUE KEY `word` (`word`)
      ) ENGINE=InnoDB AUTO_INCREMENT=26 DEFAULT CHARSET=utf8;
     */</span>
    <span class="token comment">//replace INTO `bigdata`.`t_word` (`id`, `word`, `count`) VALUES (NULL, NULL, NULL);</span>
    <span class="token comment">//处理数据--存到MySQL</span>
    <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>row<span class="token operator">:</span> Row<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> word<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> row<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString
      <span class="token keyword">val</span> count<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> row<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString <span class="token comment">//这可能需要转换为int，row.getLong()</span>
      println<span class="token punctuation">(</span>word <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> count<span class="token punctuation">)</span>
      <span class="token comment">//REPLACE INTO:表示如果表中没有数据则插入,如果有数据则替换</span>
      <span class="token comment">//注意:REPLACE INTO要求表有主键或唯一索引</span>
      <span class="token keyword">val</span> sql <span class="token operator">=</span> <span class="token string">&quot;REPLACE INTO `t_word` (`id`, `word`, `count`) VALUES (NULL, ?, ?);&quot;</span>
      preparedStatement <span class="token operator">=</span> connection<span class="token punctuation">.</span>prepareStatement<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
      preparedStatement<span class="token punctuation">.</span>setString<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> word<span class="token punctuation">)</span>
      preparedStatement<span class="token punctuation">.</span>setInt<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>parseInt<span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>
      preparedStatement<span class="token punctuation">.</span>executeUpdate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//关闭资源</span>
    <span class="token keyword">override</span> <span class="token keyword">def</span> close<span class="token punctuation">(</span>errorOrNull<span class="token operator">:</span> Throwable<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>preparedStatement <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        preparedStatement<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><ul><li>演示如何使用这个工具</li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>iitcast<span class="token punctuation">.</span>structedstreaming<span class="token punctuation">.</span>toMySQL</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Connection<span class="token punctuation">,</span> DriverManager<span class="token punctuation">,</span> PreparedStatement<span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>OutputMode<span class="token punctuation">,</span> StreamingQuery<span class="token punctuation">,</span> Trigger<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>ForeachWriter<span class="token punctuation">,</span> Row<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * DESC:
 * 1-首先申请资源
 * 2-通过Spark读取Socket的数据，实现wordcount
 * 3-统计wordcountt
 * 4-将wordcount写入MySQL
 * 5-query.awaitTermination
 * 6-query.stop
 */</span>
<span class="token keyword">object</span> _01ForeachWayToMySQL <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1-首先申请资源</span>
    <span class="token comment">//1-首先准备sparksession，底层是sparksql的引擎</span>
    <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
      <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.shuffle.partitions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//spark.sparkContext.setLogLevel(&quot;WARN&quot;)</span>
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
    <span class="token comment">// 2-通过Spark读取Socket的数据，实现wordcount</span>
    <span class="token keyword">val</span> lines <span class="token operator">=</span> spark<span class="token punctuation">.</span>readStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;host&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node1&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
      
      
    <span class="token comment">// 3-统计wordcount</span>
    <span class="token comment">// Split the lines into words</span>
    <span class="token keyword">val</span> words <span class="token operator">=</span> lines
      <span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// Generate running word count</span>
    <span class="token keyword">val</span> wordCounts <span class="token operator">=</span> words
      <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> jDBCSink <span class="token operator">=</span> <span class="token keyword">new</span> JDBCSink<span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://localhost:3306/bigdata?characterEncoding=UTF-8&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 4-将wordcount写入MySQL</span>
    <span class="token keyword">val</span> query<span class="token operator">:</span> StreamingQuery <span class="token operator">=</span> wordCounts
      <span class="token punctuation">.</span>writeStream
      <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>jDBCSink<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span>OutputMode<span class="token punctuation">.</span>Complete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>trigger<span class="token punctuation">(</span>Trigger<span class="token punctuation">.</span>ProcessingTime<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 5-query.awaitTermination</span>
    query<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 6-query.stop</span>
    query<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//注意这里不要加format(“console”)</span>
  <span class="token keyword">class</span> JDBCSink<span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> username<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
    <span class="token keyword">extends</span> ForeachWriter<span class="token punctuation">[</span>Row<span class="token punctuation">]</span> <span class="token keyword">with</span> Serializable <span class="token punctuation">{</span>
    <span class="token keyword">var</span> connection<span class="token operator">:</span> Connection <span class="token operator">=</span> _ <span class="token comment">//_表示占位符,后面会给变量赋值</span>
    <span class="token keyword">var</span> preparedStatement<span class="token operator">:</span> PreparedStatement <span class="token operator">=</span> _

    <span class="token comment">//开启连接</span>
    <span class="token keyword">override</span> <span class="token keyword">def</span> <span class="token keyword">open</span><span class="token punctuation">(</span>partitionId<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> version<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      connection <span class="token operator">=</span> DriverManager<span class="token punctuation">.</span>getConnection<span class="token punctuation">(</span>url<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
      <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    CREATE TABLE `t_word` (
        `id` int(11) NOT NULL AUTO_INCREMENT,
        `word` varchar(255) NOT NULL,
        `count` int(11) DEFAULT NULL,
        PRIMARY KEY (`id`),
        UNIQUE KEY `word` (`word`)
      ) ENGINE=InnoDB AUTO_INCREMENT=26 DEFAULT CHARSET=utf8;
     */</span>
    <span class="token comment">//replace INTO `bigdata`.`t_word` (`id`, `word`, `count`) VALUES (NULL, NULL, NULL);</span>
    <span class="token comment">//处理数据--存到MySQL</span>
    <span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>row<span class="token operator">:</span> Row<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">val</span> word<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> row<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString
      <span class="token keyword">val</span> count<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> row<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString <span class="token comment">//这可能需要转换为int，row.getLong()</span>
      println<span class="token punctuation">(</span>word <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> count<span class="token punctuation">)</span>
      <span class="token comment">//REPLACE INTO:表示如果表中没有数据则插入,如果有数据则替换</span>
      <span class="token comment">//注意:REPLACE INTO要求表有主键或唯一索引</span>
      <span class="token keyword">val</span> sql <span class="token operator">=</span> <span class="token string">&quot;REPLACE INTO `t_word` (`id`, `word`, `count`) VALUES (NULL, ?, ?);&quot;</span>
      preparedStatement <span class="token operator">=</span> connection<span class="token punctuation">.</span>prepareStatement<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
      preparedStatement<span class="token punctuation">.</span>setString<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> word<span class="token punctuation">)</span>
      preparedStatement<span class="token punctuation">.</span>setInt<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>parseInt<span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>
      preparedStatement<span class="token punctuation">.</span>executeUpdate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//关闭资源</span>
    <span class="token keyword">override</span> <span class="token keyword">def</span> close<span class="token punctuation">(</span>errorOrNull<span class="token operator">:</span> Throwable<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>preparedStatement <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        preparedStatement<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div><ul><li>上述的方法就是集成ForeachWriter的类实现其中open，process和close方法，通过foreach传入对应参数即可</li></ul> <p>ForeachBatch</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>  <span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>iitcast<span class="token punctuation">.</span>structedstreaming<span class="token punctuation">.</span>toMySQL</span>
  
  <span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>Connection<span class="token punctuation">,</span> DriverManager<span class="token punctuation">,</span> PreparedStatement<span class="token punctuation">}</span>
  
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkConf
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>OutputMode<span class="token punctuation">,</span> StreamingQuery<span class="token punctuation">,</span> Trigger<span class="token punctuation">}</span>
  <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> ForeachWriter<span class="token punctuation">,</span> Row<span class="token punctuation">,</span> SaveMode<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>
  
  <span class="token comment">/**
   * DESC:
   * 1-首先申请资源
   * 2-通过Spark读取Socket的数据，实现wordcount
   * 3-统计wordcountt
   * 4-将wordcount写入MySQL
   * 5-query.awaitTermination
   * 6-query.stop
   */</span>
  <span class="token keyword">object</span> _02ForeeachBatchWayToMySQL <span class="token punctuation">{</span>
    <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1-首先申请资源</span>
      <span class="token comment">//1-首先准备sparksession，底层是sparksql的引擎</span>
      <span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession
        <span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.shuffle.partitions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">//spark.sparkContext.setLogLevel(&quot;WARN&quot;)</span>
      <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
      <span class="token comment">// 2-通过Spark读取Socket的数据，实现wordcount</span>
      <span class="token keyword">val</span> lines <span class="token operator">=</span> spark<span class="token punctuation">.</span>readStream
        <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;host&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node1&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        
      <span class="token comment">// 3-统计wordcount</span>
      <span class="token comment">// Split the lines into words</span>
      <span class="token keyword">val</span> words <span class="token operator">=</span> lines
        <span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>
        <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// Generate running word count</span>
      <span class="token keyword">val</span> wordCounts <span class="token operator">=</span> words
        <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 4-将结果写入到MySQL中</span>
      <span class="token keyword">val</span> query<span class="token operator">:</span> StreamingQuery <span class="token operator">=</span> wordCounts
        <span class="token punctuation">.</span>writeStream
        <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span>OutputMode<span class="token punctuation">.</span>Complete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>foreachBatch<span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token operator">:</span> DataFrame<span class="token punctuation">,</span> batchID<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
          println<span class="token punctuation">(</span><span class="token string">&quot;BatchId is:&quot;</span><span class="token punctuation">,</span> batchID<span class="token punctuation">)</span>
          data
            <span class="token punctuation">.</span>coalesce<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>write
            <span class="token punctuation">.</span>mode<span class="token punctuation">(</span>SaveMode<span class="token punctuation">.</span>Overwrite<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;jdbc&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;driver&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;com.mysql.jdbc.Driver&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;jdbc:mysql://localhost:3306/bigdata?characterEncoding=UTF-8&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;dbtable&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bigdata.tb_word_count2&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
  
      <span class="token comment">// 5-query.awaitTermination</span>
      query<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 6-query.stop</span>
      query<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><ul><li><p>需要注意的是foreach需要传入的是数据集本身，batchId</p></li> <li><p>默认情况下，foreachBatch仅提供至少一次写保证。 但是，可以使用提供给该函数的batchId作为重复数据删除输出并获得一次性保证的方法。</p> <p>foreachBatch不适用于连续处理模式，因为它从根本上依赖于流式查询的微批量执行。 如果以连续模式写入数据，请改用foreach。</p></li></ul> <h4 id="背压处理"><a href="#背压处理" class="header-anchor">#</a> 背压处理</h4> <p>在结构化流中自动实现反压机制，控制kafka数据接入</p> <p>spark.streaming积压</p> <p><img src="./assets/img/image-20210405184406571.1add97ac.png" alt="image-20210405184406571"></p> <p><img src="./assets/img/image-20210405184455933.fb139b6d.png" alt="image-20210405184455933"></p> <h3 id="事件时间-水印机制"><a href="#事件时间-水印机制" class="header-anchor">#</a> 事件时间--水印机制</h3> <ul><li><p><img src="./assets/img/image-20210405174638291.2878f004.png" alt="image-20210405174638291"></p></li> <li><p>SparkStreaming框架仅仅支持处理时间ProcessTime，</p> <p>StructuredStreaming支持事件时间和处理时间，</p> <p>Flink框架支持三种时间数据操作，</p></li> <li><p>基于事件时间处理</p></li> <li><img src="./assets/img/image-20210405175656065.0ad1bc62.png" alt="image-20210405175656065" style="zoom:150%;"></li> <li><img src="./assets/img/image-20210405180128446.8665c4e4.png" alt="image-20210405180128446" style="zoom:150%;"></li> <li><img src="./assets/img/image-20210405180409294.5451fd77.png" alt="image-20210405180409294" style="zoom:150%;"></li> <li><p>让Spark SQL引擎****自动追踪数据中当前事件时间EventTime，依据规则清除旧的状态数据****。</p></li> <li><p>图中的processing time是触发计算（多个未销毁的窗口）和水位线更新的时间，但不一定窗口会销毁，窗口销毁的时间是wartermark&gt;=窗口的结束时间。</p></li> <li><p><strong>加了水印之后就可以查到之前的数据，至于查多久，关注即将销毁的窗口数据（水位线在开始时间较小的那个窗口内，从这个窗口之后的聚合数据都还保存，只不过输出模式只输出有更新的key），销毁之后之前的窗口就不会再更新，意味着那个窗口的累计数据已经确定了。</strong></p></li> <li><img src="./assets/img/image-20210405180756809.e3ddd906.png" alt="image-20210405180756809" style="zoom:150%;"> <p><strong>获取上一个窗口水印--&gt;计算该事件时间分布在哪个窗口(滑动窗口会有两个)，判断该事件窗口是否还没被销毁，没被销毁就聚合更新--&gt;有更新的窗口数据，等待按照update模式触发时间拉取输出</strong></p></li> <li><p><img src="./assets/img/image-20210405181735338-1677680980955.8735619f.png" alt="image-20210405181735338"></p></li> <li><p><img src="./assets/img/image-20210405182046499.57a05553.png" alt="image-20210405182046499"></p></li> <li><p><img src="./assets/img/image-20210405182310907.9bb09c54.png" alt="image-20210405182310907"></p></li> <li><p><img src="./assets/img/image-20210405182404774.2013685f.png" alt="image-20210405182404774"></p> <p><img src="./assets/img/image-20230301223705309.aeef9946.png" alt="image-20230301223705309"></p> <p><img src="./assets/img/image-20230301224233613.72a08219.png" alt="image-20230301224233613"></p> <p><img src="./assets/img/image-20230301224330200.c09227e6.png" alt="image-20230301224330200"></p> <p><img src="./assets/img/image-20230301224841089.c960c957.png" alt="image-20230301224841089"></p></li> <li><p><img src="./assets/img/image-20230301225122318.e286c508.png" alt="image-20230301225122318"></p></li> <li><p>代码</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>iitcast<span class="token punctuation">.</span>structedstreaming<span class="token punctuation">.</span>kafka</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>Timestamp

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span>StringUtils
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkContext
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>OutputMode<span class="token punctuation">,</span> StreamingQuery<span class="token punctuation">,</span> Trigger<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * 基于Structured Streaming 读取TCP Socket读取数据，事件时间窗口统计词频，将结果打印到控制台
 * 每5秒钟统计最近10秒内的数据（词频：WordCount)，设置水位Watermark时间为10秒
 * 2019-10-10 12:00:07,dog
 * 2019-10-10 12:00:08,owl
 *
 * 2019-10-10 12:00:14,dog
 * 2019-10-10 12:00:09,cat
 *
 * 2019-10-10 12:00:15,cat
 * 2019-10-10 12:00:08,dog
 * 2019-10-10 12:00:13,owl
 * 2019-10-10 12:00:21,owl
 *
 * 2019-10-10 12:00:04,donkey  --丢失
 * 2019-10-10 12:00:17,owl     --不丢失
 */</span>
<span class="token keyword">object</span> StructuredWindow <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 构建SparkSession实例对象，传递sparkConf参数</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.shuffle.partitions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext
    sc<span class="token punctuation">.</span>setLogLevel<span class="token punctuation">(</span><span class="token string">&quot;WARN&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_

    <span class="token comment">// 2. 使用SparkSession从TCP Socket读取流式数据</span>
    <span class="token keyword">val</span> inputStreamDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>readStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;host&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node1&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 3. 针对获取流式DStream进行词频统计</span>
    <span class="token keyword">val</span> resultStreamDF <span class="token operator">=</span> inputStreamDF
      <span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span>isNotBlank<span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 将每行数据进行分割单词: 2019-10-12 09:00:02,cat dog</span>
      <span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>line <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> arr <span class="token operator">=</span> line<span class="token punctuation">.</span>trim<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> timestampStr<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> arr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> wordsStr<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> arr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        wordsStr
          <span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\\s+&quot;</span><span class="token punctuation">)</span>
          <span class="token comment">//(时间戳,单词)</span>
          <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>Timestamp<span class="token punctuation">.</span>valueOf<span class="token punctuation">(</span>timestampStr<span class="token punctuation">)</span><span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 设置列的名称</span>
      <span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;word&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">// TODO：设置水位Watermark</span>
      <span class="token punctuation">.</span>withWatermark<span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10 seconds&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">//依据事件时间生成窗口</span>
      <span class="token comment">// TODO：设置基于事件时间（event time）窗口 -&gt; time, 每5秒统计最近10秒内数据</span>
      <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>
          <span class="token comment">//structed streaming window 滑动步长不填默认窗口步长使用窗口长度，spark streaming 不填默认是使用 ssc 读取源文件每个batch 的步长，两者不一样。</span>
        window<span class="token punctuation">(</span>$<span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10 seconds&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;5 seconds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        $<span class="token string">&quot;word&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 按照窗口字段降序排序</span>
      <span class="token comment">//.orderBy($&quot;window&quot;)</span>

    <span class="token comment">/*
        root
         |-- window: struct (nullable = true)
         |    |-- start: timestamp (nullable = true)
         |    |-- end: timestamp (nullable = true)
         |-- word: string (nullable = true)
         |-- count: long (nullable = false)
     */</span>
    <span class="token comment">//resultStreamDF.printSchema()</span>

    <span class="token comment">// 4. 将计算的结果输出，打印到控制台</span>
    <span class="token keyword">val</span> query<span class="token operator">:</span> StreamingQuery <span class="token operator">=</span> resultStreamDF<span class="token punctuation">.</span>writeStream
      <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span>OutputMode<span class="token punctuation">.</span>Update<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;console&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;numRows&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;100&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;truncate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>trigger<span class="token punctuation">(</span>Trigger<span class="token punctuation">.</span>ProcessingTime<span class="token punctuation">(</span><span class="token string">&quot;5 seconds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    query<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    query<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br></div></div><p><img src="./assets/img/image-20210405183458836.250313ca.png" alt="image-20210405183458836"></p> <h3 id="structuredstreaming的continue的连续处理机制"><a href="#structuredstreaming的continue的连续处理机制" class="header-anchor">#</a> StructuredStreaming的Continue的连续处理机制</h3> <ul><li><p>连续处理（Continuous Processing）是Spark 2.3中引入的一种新的实验性流执行模式，可实现毫秒级端到端延迟(类似Storm、Flink)，但只能保证At-Least-Once 最少一次：即不会丢失数据，但可能会有重复结果。</p> <p>默认的微批处理（micro-batch processing）引擎，可以实现Exactly-Once 精确一次保证，但最多可实现100ms的延迟。</p></li> <li><p>结构化流提供了处于试验阶段的Continue的连续处理机制</p></li> <li><p>需要在writeStream.trigger(Trigger.ContinueTime())</p></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span>StringUtils
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span>SparkContext
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span></span><span class="token punctuation">{</span>OutputMode<span class="token punctuation">,</span> StreamingQuery<span class="token punctuation">,</span> Trigger<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{</span>DataFrame<span class="token punctuation">,</span> Dataset<span class="token punctuation">,</span> SparkSession<span class="token punctuation">}</span>

<span class="token comment">/**
 * 从Spark 2.3版本开始，StructuredStreaming结构化流中添加新流式数据处理方式：Continuous processing
 * 持续流数据处理：当数据一产生就立即处理，类似Storm、Flink框架，延迟性达到100ms以下，目前属于实验开发阶段
 */</span>
<span class="token keyword">object</span> StructuredContinuous <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 构建SparkSession会话实例对象，设置属性信息</span>
    <span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>getClass<span class="token punctuation">.</span>getSimpleName<span class="token punctuation">.</span>stripSuffix<span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>master<span class="token punctuation">(</span><span class="token string">&quot;local[*]&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">&quot;spark.sql.shuffle.partitions&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> sc<span class="token operator">:</span> SparkContext <span class="token operator">=</span> spark<span class="token punctuation">.</span>sparkContext
    sc<span class="token punctuation">.</span>setLogLevel<span class="token punctuation">(</span><span class="token string">&quot;WARN&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_
    <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_

    <span class="token comment">// 1. 从KAFKA读取数据</span>
    <span class="token keyword">val</span> kafkaStreamDF<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>readStream
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;kafka&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;kafka.bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;subscribe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;stationTopic&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 2. 对基站日志数据进行ETL操作</span>
    <span class="token comment">// station_0,18600004405,18900009049,success,1589711564033,9000</span>
    <span class="token keyword">val</span> etlStreamDF<span class="token operator">:</span> Dataset<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> kafkaStreamDF
      <span class="token comment">// 获取value字段的值，转换为String类型</span>
      <span class="token punctuation">.</span>selectExpr<span class="token punctuation">(</span><span class="token string">&quot;CAST(value AS STRING)&quot;</span><span class="token punctuation">)</span>
      <span class="token comment">// 转换为Dataset类型</span>
      <span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>
      <span class="token comment">// 过滤数据：通话状态为success</span>
      <span class="token punctuation">.</span>filter<span class="token punctuation">(</span>log <span class="token keyword">=&gt;</span> StringUtils<span class="token punctuation">.</span>isNotBlank<span class="token punctuation">(</span>log<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">.</span>equals<span class="token punctuation">(</span>log<span class="token punctuation">.</span>trim<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// 3. 针对流式应用来说，输出的是流</span>
    <span class="token keyword">val</span> query<span class="token operator">:</span> StreamingQuery <span class="token operator">=</span> etlStreamDF<span class="token punctuation">.</span>writeStream
      <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span>OutputMode<span class="token punctuation">.</span>Append<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">&quot;kafka&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;kafka.bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;node1:9092&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;etlTopic&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">&quot;checkpointLocation&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./ckp&quot;</span> <span class="token operator">+</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// TODO: 设置持续流处理 Continuous Processing, 指定CKPT时间间隔</span>
      <span class="token comment">//the continuous processing engine will records the progress of the query every second</span>
      <span class="token comment">//持续流处理引擎，将每1秒中记录当前查询Query进度状态</span>
      <span class="token punctuation">.</span>trigger<span class="token punctuation">(</span>Trigger<span class="token punctuation">.</span>Continuous<span class="token punctuation">(</span><span class="token string">&quot;1 second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    query<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
    query<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><ul><li>注意其中有很多限制，使用的时候需要注意</li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2023-6-24 2:06:37 ├F10: AM┤</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/./2019/09/08/spark/#spark入门" class="sidebar-link reco-side-spark入门" data-v-b57cc07c>Spark入门</a></li><li class="level-2" data-v-b57cc07c><a href="/./2019/09/08/spark/#spark的部署回顾" class="sidebar-link reco-side-spark的部署回顾" data-v-b57cc07c>Spark的部署回顾</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#local模式" class="sidebar-link reco-side-local模式" data-v-b57cc07c>local模式</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#standalone" class="sidebar-link reco-side-standalone" data-v-b57cc07c>Standalone</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#standaloneha" class="sidebar-link reco-side-standaloneha" data-v-b57cc07c>StandaloneHA</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparkonyarn" class="sidebar-link reco-side-sparkonyarn" data-v-b57cc07c>SparkOnYarn</a></li><li class="level-2" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparkcore-rdd" class="sidebar-link reco-side-sparkcore-rdd" data-v-b57cc07c>SparkCore--RDD</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#rdd是什么" class="sidebar-link reco-side-rdd是什么" data-v-b57cc07c>RDD是什么</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#rdd的五大属性" class="sidebar-link reco-side-rdd的五大属性" data-v-b57cc07c>RDD的五大属性</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#rdd的算子分类" class="sidebar-link reco-side-rdd的算子分类" data-v-b57cc07c>RDD的算子分类</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#实战案例" class="sidebar-link reco-side-实战案例" data-v-b57cc07c>实战案例</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#rdd依赖关系" class="sidebar-link reco-side-rdd依赖关系" data-v-b57cc07c>RDD依赖关系</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#rdd缓存" class="sidebar-link reco-side-rdd缓存" data-v-b57cc07c>RDD缓存</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#rdd的checkpoint" class="sidebar-link reco-side-rdd的checkpoint" data-v-b57cc07c>RDD的CheckPoint</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#rdd的dag" class="sidebar-link reco-side-rdd的dag" data-v-b57cc07c>RDD的DAG</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#共享变量" class="sidebar-link reco-side-共享变量" data-v-b57cc07c>共享变量</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#kyro序列化" class="sidebar-link reco-side-kyro序列化" data-v-b57cc07c>Kyro序列化</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#内存模型" class="sidebar-link reco-side-内存模型" data-v-b57cc07c>内存模型</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#spark的shuffle" class="sidebar-link reco-side-spark的shuffle" data-v-b57cc07c>Spark的shuffle</a></li><li class="level-2" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparksql引入" class="sidebar-link reco-side-sparksql引入" data-v-b57cc07c>SparkSQL引入</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#什么是sparksql" class="sidebar-link reco-side-什么是sparksql" data-v-b57cc07c>什么是sparksql</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparksql和hive的关系-发展历程" class="sidebar-link reco-side-sparksql和hive的关系-发展历程" data-v-b57cc07c>SparkSQL和Hive的关系(发展历程)</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparksql的数据结构" class="sidebar-link reco-side-sparksql的数据结构" data-v-b57cc07c>SparkSQL的数据结构</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#电影评分案例-掌握" class="sidebar-link reco-side-电影评分案例-掌握" data-v-b57cc07c>电影评分案例(掌握)</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#spark-sql整合hive" class="sidebar-link reco-side-spark-sql整合hive" data-v-b57cc07c>Spark SQL整合Hive</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparksql的udf函数-必须掌握" class="sidebar-link reco-side-sparksql的udf函数-必须掌握" data-v-b57cc07c>SparkSQL的UDF函数(必须掌握)</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparksql函数" class="sidebar-link reco-side-sparksql函数" data-v-b57cc07c>SparkSQL函数</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparksql底层如何执行解析成rdd" class="sidebar-link reco-side-sparksql底层如何执行解析成rdd" data-v-b57cc07c>SparkSQL底层如何执行解析成RDD</a></li><li class="level-2" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparkstreaming引入-rdd-dstream" class="sidebar-link reco-side-sparkstreaming引入-rdd-dstream" data-v-b57cc07c>SparkStreaming引入--RDD--DStream</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#流数据的处理模式" class="sidebar-link reco-side-流数据的处理模式" data-v-b57cc07c>流数据的处理模式</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparkstreaming数据结构" class="sidebar-link reco-side-sparkstreaming数据结构" data-v-b57cc07c>SparkStreaming数据结构</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#dstream两种算子" class="sidebar-link reco-side-dstream两种算子" data-v-b57cc07c>DStream两种算子</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparkstreaming初体验-无状态" class="sidebar-link reco-side-sparkstreaming初体验-无状态" data-v-b57cc07c>SparkStreaming初体验-无状态</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#状态计算" class="sidebar-link reco-side-状态计算" data-v-b57cc07c>状态计算</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparkstreaming和sparksql整合" class="sidebar-link reco-side-sparkstreaming和sparksql整合" data-v-b57cc07c>SparkStreaming和SparkSQL整合</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#sparkstreaming和kafka整合" class="sidebar-link reco-side-sparkstreaming和kafka整合" data-v-b57cc07c>SparkStreaming和Kafka整合</a></li><li class="level-2" data-v-b57cc07c><a href="/./2019/09/08/spark/#structuredstreamig引入" class="sidebar-link reco-side-structuredstreamig引入" data-v-b57cc07c>StructuredStreamig引入</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#structuredstreamig定义" class="sidebar-link reco-side-structuredstreamig定义" data-v-b57cc07c>StructuredStreamig定义</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#structuredstreaming与sparkstreaming区别" class="sidebar-link reco-side-structuredstreaming与sparkstreaming区别" data-v-b57cc07c>StructuredStreaming与sparkstreaming区别</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#结构化流编程模型" class="sidebar-link reco-side-结构化流编程模型" data-v-b57cc07c>结构化流编程模型</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#入门案例" class="sidebar-link reco-side-入门案例" data-v-b57cc07c>入门案例</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#structuredstreaming的kakfa整合" class="sidebar-link reco-side-structuredstreaming的kakfa整合" data-v-b57cc07c>StructuredStreaming的Kakfa整合</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#事件时间-水印机制" class="sidebar-link reco-side-事件时间-水印机制" data-v-b57cc07c>事件时间--水印机制</a></li><li class="level-3" data-v-b57cc07c><a href="/./2019/09/08/spark/#structuredstreaming的continue的连续处理机制" class="sidebar-link reco-side-structuredstreaming的continue的连续处理机制" data-v-b57cc07c>StructuredStreaming的Continue的连续处理机制</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----></div></div>
    <script src="./assets/js/app.764dede6.js" defer></script><script src="./assets/js/13.20e964b9.js" defer></script><script src="./assets/js/1.8757f81f.js" defer></script><script src="./assets/js/3.9efa3b27.js" defer></script><script src="./assets/js/34.ec572062.js" defer></script>
  </body>
</html>
