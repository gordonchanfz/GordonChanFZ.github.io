<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>布隆过滤器和布谷鸟过滤器 | 个人博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="./favicon.ico">
    <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?55943ae09e5901d7a9f5705133737eec";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
           </script>
    <script src="https://hm.baidu.com/hm.js?xxxxxxxxxxx"></script>
    <meta name="description" content="会思考的芦苇。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="robots" content="all">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="./assets/css/0.styles.f4f644f3.css" as="style"><link rel="preload" href="./assets/js/app.764dede6.js" as="script"><link rel="preload" href="./assets/js/13.20e964b9.js" as="script"><link rel="preload" href="./assets/js/1.8757f81f.js" as="script"><link rel="preload" href="./assets/js/15.7747d51d.js" as="script"><link rel="preload" href="./assets/js/34.ec572062.js" as="script"><link rel="prefetch" href="./assets/js/10.36ed4133.js"><link rel="prefetch" href="./assets/js/11.18e1c33d.js"><link rel="prefetch" href="./assets/js/12.b32071c5.js"><link rel="prefetch" href="./assets/js/14.d0932ff0.js"><link rel="prefetch" href="./assets/js/16.487f9c88.js"><link rel="prefetch" href="./assets/js/17.9ae2b89b.js"><link rel="prefetch" href="./assets/js/18.801c9b12.js"><link rel="prefetch" href="./assets/js/19.867ef46b.js"><link rel="prefetch" href="./assets/js/20.ec371d7f.js"><link rel="prefetch" href="./assets/js/21.73f810bc.js"><link rel="prefetch" href="./assets/js/22.8c016772.js"><link rel="prefetch" href="./assets/js/23.9aa3d5ef.js"><link rel="prefetch" href="./assets/js/24.a6dcda10.js"><link rel="prefetch" href="./assets/js/25.2fe13775.js"><link rel="prefetch" href="./assets/js/26.2296389e.js"><link rel="prefetch" href="./assets/js/27.21f2d66f.js"><link rel="prefetch" href="./assets/js/28.3209357f.js"><link rel="prefetch" href="./assets/js/29.c7065b7f.js"><link rel="prefetch" href="./assets/js/3.9efa3b27.js"><link rel="prefetch" href="./assets/js/30.92914cc9.js"><link rel="prefetch" href="./assets/js/31.13c12633.js"><link rel="prefetch" href="./assets/js/32.b016f60e.js"><link rel="prefetch" href="./assets/js/33.ed48a654.js"><link rel="prefetch" href="./assets/js/35.5b55607b.js"><link rel="prefetch" href="./assets/js/36.f50b6e38.js"><link rel="prefetch" href="./assets/js/37.34409ac4.js"><link rel="prefetch" href="./assets/js/38.c7073f77.js"><link rel="prefetch" href="./assets/js/39.12f063e9.js"><link rel="prefetch" href="./assets/js/4.95c562bd.js"><link rel="prefetch" href="./assets/js/40.1bbd5377.js"><link rel="prefetch" href="./assets/js/41.6331a8cf.js"><link rel="prefetch" href="./assets/js/42.28acd6f5.js"><link rel="prefetch" href="./assets/js/43.905d2114.js"><link rel="prefetch" href="./assets/js/44.041132c5.js"><link rel="prefetch" href="./assets/js/45.d1a66b92.js"><link rel="prefetch" href="./assets/js/46.1c9100fe.js"><link rel="prefetch" href="./assets/js/47.3e75f768.js"><link rel="prefetch" href="./assets/js/48.7d7248fb.js"><link rel="prefetch" href="./assets/js/49.8d465809.js"><link rel="prefetch" href="./assets/js/5.a1a0df33.js"><link rel="prefetch" href="./assets/js/50.4aa56564.js"><link rel="prefetch" href="./assets/js/51.59674bf5.js"><link rel="prefetch" href="./assets/js/52.f3990683.js"><link rel="prefetch" href="./assets/js/53.092fe0ad.js"><link rel="prefetch" href="./assets/js/54.ac62e2a7.js"><link rel="prefetch" href="./assets/js/55.3530fa5a.js"><link rel="prefetch" href="./assets/js/56.6e9bc6f3.js"><link rel="prefetch" href="./assets/js/6.e534639a.js"><link rel="prefetch" href="./assets/js/7.bc868936.js"><link rel="prefetch" href="./assets/js/8.ce0f4f25.js"><link rel="prefetch" href="./assets/js/9.a57a9cf0.js">
    <link rel="stylesheet" href="./assets/css/0.styles.f4f644f3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Gordon</h3> <p class="description" data-v-59e6cb88>会思考的芦苇。</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Gordon</span>
          
        <span data-v-59e6cb88>2018 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><img src="./logo.png" alt="个人博客" class="logo"> <span class="site-name">个人博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      计算引擎
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./计算引擎/flink.html" class="nav-link"><i class="undefined"></i>
  flink
</a></li><li class="dropdown-item"><!----> <a href="/./计算引擎/spark.html" class="nav-link"><i class="undefined"></i>
  spark
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      存储引擎
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./存储引擎/ElasticSearch.html" class="nav-link"><i class="undefined"></i>
  ElasticSearch
</a></li><li class="dropdown-item"><!----> <a href="/./存储引擎/hbase.html" class="nav-link"><i class="undefined"></i>
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/./存储引擎/redis.html" class="nav-link"><i class="undefined"></i>
  redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      云原生
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./云原生/Docker.html" class="nav-link"><i class="undefined"></i>
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      中间件
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./中间件/kafka.html" class="nav-link"><i class="undefined"></i>
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./中间件/Sqoop基本使用.html" class="nav-link"><i class="undefined"></i>
  Sqoop基本使用
</a></li></ul></div></div><div class="nav-item"><a href="/./tool/emoji/我的常用emoji.html" class="nav-link"><i class="undefined"></i>
  工具
</a></div><div class="nav-item"><a href="/./aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></div> <a href="https://github.com/GordonChanFZ/gordonchanfz.github.io/" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="./avatar.jpeg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Gordon
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>30</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>47</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41><li class="social-item" data-v-1fad0c41><i class="iconfont reco-github" style="color:#e15b64;" data-v-1fad0c41></i></li></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/./" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      计算引擎
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./计算引擎/flink.html" class="nav-link"><i class="undefined"></i>
  flink
</a></li><li class="dropdown-item"><!----> <a href="/./计算引擎/spark.html" class="nav-link"><i class="undefined"></i>
  spark
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      存储引擎
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./存储引擎/ElasticSearch.html" class="nav-link"><i class="undefined"></i>
  ElasticSearch
</a></li><li class="dropdown-item"><!----> <a href="/./存储引擎/hbase.html" class="nav-link"><i class="undefined"></i>
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/./存储引擎/redis.html" class="nav-link"><i class="undefined"></i>
  redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      云原生
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./云原生/Docker.html" class="nav-link"><i class="undefined"></i>
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      中间件
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./中间件/kafka.html" class="nav-link"><i class="undefined"></i>
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./中间件/Sqoop基本使用.html" class="nav-link"><i class="undefined"></i>
  Sqoop基本使用
</a></li></ul></div></div><div class="nav-item"><a href="/./tool/emoji/我的常用emoji.html" class="nav-link"><i class="undefined"></i>
  工具
</a></div><div class="nav-item"><a href="/./aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></div> <a href="https://github.com/GordonChanFZ/gordonchanfz.github.io/" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>布隆过滤器和布谷鸟过滤器</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Gordon</span>
          
        <span data-v-59e6cb88>2018 - </span>
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">布隆过滤器和布谷鸟过滤器</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Gordon</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2023-2-8</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>黑名单过滤</span><span class="tag-item" data-v-8a445198>缓存穿透优化</span></i></div></div> <div class="theme-reco-content content__default"><h3 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h3> <p>布隆过滤器 (Bloom Filter)是由Burton Howard Bloom于1970年提出，它是一种space efficient的概率型数据结构，用于<strong>判断一个元素是否在集合</strong>中。在垃圾邮件过滤的黑白名单方法、爬虫(Crawler)的网址判重模块中等等经常被用到。哈希表也能用于判断元素是否在集合中，但是布隆过滤器只需要哈希表的1/8或1/4的空间复杂度就能完成同样的问题。布隆过滤器可以插入元素，但不可以删除已有元素。其中的元素越多，false positive rate(误报率)越大，但是false negative (漏报)是不可能的。</p> <p><strong>传统HashMap数据结构的不足</strong></p> <p>一般来说，将网页 URL 存入数据库进行查找，或者建立一个哈希表进行查找就 OK 了。</p> <p>当数据量小的时候，这么思考是对的，确实可以将值映射到 HashMap 的 Key，然后可以在 O(1) 的时间复杂度内 返回结果，效率奇高。但是 HashMap 的实现也有缺点，例如存储容量占比高，考虑到负载因子的存在，通常空间是不能被用满的，举个例子如果一个 1000 万 HashMap，Key=String（长度不超过 16 字符，且重复性极小），Value=Integer，会占据多少空间呢？1.2 个 G。</p> <p>实际上用 bitmap，1000 万个 int 型，只需要 40M（ 10 000 000 * 4/1024/1024 =40M）左右空间，占比 3%，1000 万个 Integer，需要 161M 左右空间，占比 13.3%。</p> <p>可见一旦你的值很多例如上亿的时候，那 HashMap 占据的内存大小就可想而知了。</p> <p>但如果整个网页黑名单系统包含 100 亿个网页 URL，在数据库查找是很费时的，并且如果每个 URL 空间为 64B，那么需要内存为 640GB，一般的服务器很难达到这个需求。</p> <h3 id="bitmap数据结构"><a href="#bitmap数据结构" class="header-anchor">#</a> BitMap数据结构</h3> <p>现代计算机用二进制（bit，位）作为信息的基础单位，1 个字节等于 8 位。许多开发语言都提供了操作位的功能，合理地使用位能够有效地提高内存使用率和开发效率。</p> <p>Bit-map 的基本思想就是用一个 bit 位来标记某个元素对应的 value，而 key 即是该元素。由于采用了 bit 为单位来存储数据，因此在存储空间方面，可以大大节省。</p> <p>在 Java 中，int 占 4 字节，1 字节 = 8位（1 byte = 8 bit），如果我们用这个 32 个 bit 位的每一位的值来表示一个数的话是不是就可以表示 32 个数字，也就是说 <strong>32 个数字只需要一个 int 所占的空间大小就可以了，那就可以缩小空间 32 倍。</strong></p> <blockquote><p>1 Byte = 8 Bit，1 KB = 1024 Byte，1 MB = 1024 KB，1GB = 1024 MB</p></blockquote> <p>举个例子：假设网站有 1 亿用户，每天独立访问的用户有 5 千万，如果每天用集合类型和 BitMap 分别存储活跃用户：</p> <p>集合类型：假如用户 id 是 int 型，4 字节，32 位，则集合类型占据的空间为 50 000 000 * 4/1024/1024 = 200M；</p> <p>BitMap：.如果按位存储，5 千万个数就是 5 千万位，占据的空间为 50 000 000/8/1024/1024 = 6M。</p> <p>那么如何用 BitMap 来表示一个数呢？</p> <p>上面说了用 bit 位来标记某个元素对应的 value，而 key 即是该元素，我们可以把 BitMap 想象成一个以位为单位的<strong>数组</strong>，数组的每个单元只能存储 0 和 1（0 表示这个数不存在，1 表示存在），数组的下标在 BitMap 中叫做偏移量。</p> <p>比如我们需要表示<code>{1,3,5,7}</code>这四个数，如下：</p> <p><img src="data:image/png;base64,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" alt="image-20220311102113004"></p> <p>那如果还存在一个数 65 呢？只需要开<code>int[N/32+1]</code>个 int 数组就可以存储完这些数据（其中 N 表示这群数据中的最大值），即：</p> <p><code>int[0]</code>：可以表示 0~31</p> <p><code>int[1]</code>：可以表示 32~63</p> <p><code>int[2]</code>：可以表示 64~95</p> <p><img src="./assets/img/20220318143436143.3983024d.png" alt="image-20220311102821020"></p> <p>假设我们要判断任意整数是否在列表中，则 <code>M/32</code> 就得到下标，<code>M%32</code>就知道它在此下标的哪个位置，如：</p> <p><code>65/32 = 2</code>，<code>65%32=1</code>，即 65 在<code>int[2]</code> 中的第 1 位。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Java BitArray使用long类型来实现，long占8字节，64位，所以需要构建long[Math.ceil(n/64)]大小的long数组。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="布隆过滤器"><a href="#布隆过滤器" class="header-anchor">#</a> 布隆过滤器</h3> <h4 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h4> <p>本质上布隆过滤器是一种数据结构，比较巧妙的概率型数据结构，<strong>特点是高效地插入和查询</strong>，可以用来告诉你 “<strong>某 样东西一定不存在或者可能存在</strong>”。</p> <p>网页交互初探：<a href="https://www.jasondavies.com/bloomfilter/" target="_blank" rel="noopener noreferrer">Bloom Filters (jasondavies.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h4> <p>相比于传统的 List、Set、Map 等数据结构，它更高效、占用空间更少，但是缺点是其返回的结果是概率性的，而不是确切的。</p> <p>实际上，布隆过滤器广泛应用于<strong>网页黑名单系统</strong>、<strong>垃圾邮件过滤系统</strong>、<strong>爬虫网址判重系统</strong>等，Google 著名的分布式数据库 Bigtable 使用了布隆过滤器来查找不存在的行或列，以减少磁盘查找的 IO 次数，Google Chrome 浏览器使用了布隆过滤器加速安全浏览服务。</p> <p>在很多 Key-Value 系统中也使用了布隆过滤器来加快查询过程，如 Hbase，Redis。一般而言，Value 保存在磁盘中，访问磁盘需要花费大量时间，然而使用布隆过滤器可以快速判断某个 Key 对应的 Value 是否存在，因此可以避免很多不必要的磁盘 IO 操作。通过一个 Hash 函数将一个元素映射成一个位阵列（Bit Array）中的一个点。这样一来，我们只要看看这个点是不是 1 就知道可以集合中有没有它了。这就是布隆过滤器的基本思想。</p> <p><strong>当一个元素加入布隆过滤器中的时候，会进行如下操作：</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>使用布隆过滤器中的哈希函数对元素值进行计算，得到哈希值（有几个哈希函数得到几个哈希值）。
根据得到的哈希值，在位数组中把对应下标的值置为 1。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>当我们需要判断一个元素是否存在于布隆过滤器的时候，会进行如下操作：</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>对给定元素再次进行相同的哈希计算；
得到值之后判断位数组中的每个元素是否都为 1，如果值都为 1，那么说明这个值在布隆过滤器中(注意：由于hash冲突问题，所谓的存在只能是可能存在)，如果存在一个值不为 1，说明该元素不在布隆过滤器中。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>布隆过滤器不支持删除</strong></p> <p><strong>传统的布隆过滤器并不支持删除操作</strong>。因为hash碰撞的原因，你想要<strong>删除的元素有可能存储着其他元素的信息</strong>。但是名为 Counting Bloom filter 的变种可以用来测试元素计数个数是否绝对小于某个阈值，它支持元素删除。</p> <p>综上，我们可以得出：</p> <p><strong>1.布隆过滤器说某个元素存在，小概率会误判，不一定存在；</strong></p> <p><strong>2.布隆过滤器说某个元素不在，那么这个元素一定不在；</strong></p> <p><strong>3.布隆过滤器不支持删除。（不包含变种）</strong></p> <h4 id="运用场景"><a href="#运用场景" class="header-anchor">#</a> <strong>运用场景</strong></h4> <p>1、目前有 10 亿数量的自然数，乱序排列，需要对其排序。限制条件在 32 位机器上面完成，内存限制为 2G。如何完成？</p> <p>2、如何快速在亿级黑名单中快速定位 URL 地址是否在黑名单中？(每条 URL 平均 64 字节)</p> <p>3、需要进行用户登陆行为分析，来确定用户的活跃情况？</p> <p>4、网络爬虫-如何判断 URL 是否被爬过？</p> <p>5、快速定位用户属性（黑名单、白名单等）？</p> <p>6、数据存储在磁盘中，如何避免大量的无效 IO？</p> <p>7、判断一个元素在亿级数据中是否存在？</p> <p>8、缓存穿透。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>解决缓存穿透

缓存穿透是指查询一个根本不存在的数据，缓存层和存储层都不会命中，如果从存储层查不到数据则不写入缓存层。
缓存穿透将导致不存在的数据每次请求都要到存储层去查询，失去了缓存保护后端存储的意义，可能会使后端存储负载加大，数据库宕机。

因此我们可以用布隆过滤器来解决，在访问缓存层和存储层之前，将存在的 key 用布隆过滤器提前保存起来，做第一层拦截。

例如：一个推荐系统有 4 亿个用户 id，每个小时算法工程师会根据每个用户之前历史行为计算出推荐数据放到存储层中，但是最新的用户由于没有历史行为，就会发生缓存穿透的行为，为此可以将所有推荐数据的用户做成布隆过滤器。

如果布隆过滤器认为该用户 id 不存在，那么就不会访问存储层，在一定程度保护了存储层。

注：布隆过滤器可能会误判，放过部分请求，当不影响整体，所以目前该方案是处理此类问题最佳方案
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>9.短视频的曝光页面瀑布流式展示</p> <p><img src="./assets/img/image-20230624005823225.85dd3585.png" alt="image-20230624005823225"></p> <p>为了兼顾短视频质量和时效性，短视频排序采用了重力算法：</p> <p><img src="./assets/img/image-20230624005845050.945d5253.png" alt="image-20230624005845050"></p> <p>H为短视频的质量分，通过观看，点赞，评论，转发等数据加权求和计算，T为短视频发布时间戳，T0位基准时间，取发现页最早发布的短视频创建时间戳，单位均为秒。A为时间系数，根据发现页短视频的平均更新间隔，取36000(10小时)。该算法的效果是，发布时间接近，质量分高的短视频靠前，随着时间推移，短视频不断下沉，削弱头部曝光产生的马太效应。</p> <p>为了提高内容的新鲜感，我们希望用户在每次下拉刷新以及翻页的时候，都能看到新的短视频，同时在短视频列表头部加入新的短视频时，能得到优先展示，如下图所示：</p> <p><img src="./assets/img/image-20230624005900854.ad8a986e.png" alt="image-20230624005900854"></p> <p>左图为首屏显示的短视频，如在此时，短视频列表顺序发生了更新，C+和D+插在了看过的视频中间，我们希望在下次刷新的时候，把浏览过的其他视频去掉，相当于优先插入C+、D+。实现这个需求最简单的方法是保存用户最近观看过的全部短视频作为过滤器，每次返回列表的时候，从头部开始遍历，去掉用户看过的短视频。显然，过滤器的容量，决定了短视频列表的最大展示深度？？？？？（返回的列表一定，只是对列表进行过滤？？？）。根据产品需求，发现页需要展示最近一个月的短视频，大约4000个，平均每个短视频id的长度为50字节，这个过滤器如果用传统的redis set等手段实现，存储成本和过滤效率都比较低，针对这个问题，我们采用了一个简单而强大的数据结构---布隆过滤器。</p> <p>Bloom Filter(布隆过滤器)是一种空间效率很高的随机数据结构，它利用位数组很简洁地表示一个集合，并能判断一个元素是否属于这个集合。Bloom Filter的这种高效是有一定代价的：在判断一个元素是否属于某个集合时，有可能会把不属于这个集合的元素误认为属于这个集合（false positive）。因此，Bloom Filter不适合那些“零错误”的应用场合。而在能容忍低错误率的应用场合下，Bloom Filter通过极少的错误换取了存储空间的极大节省。</p> <p>我们使用MurmurHash和bitset实现了一个可以序列化成整形数组的布隆过滤器，可以利用redis支持的简单key-value数据结构进行存取，在本地实现高效的过滤运算，一个能保存4000个短视频id的布隆过滤器，只占用不到8KB的空间，get&amp;set的效率都比较高。</p> <p>因为布隆过滤器容量有限，且无法删除元素，<strong>需要配合重建策略使用</strong>。我们用redis维护了一个最近观看的100个短视频id，当布隆过滤器空间利用率超过百分之50的时候，清空并使用这100个id进行重建，避免了极端情况下的重复问题。</p> <p>注：常见的布隆过滤器：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1.RedisBloom
布隆过滤器可以使用 Redis 中的位图(bitmap)操作实现，直到 Redis4.0 版本提供了插件功能，Redis 官方提供的布隆过滤器才正式登场，布隆过滤器作为一个插件加载到 Redis Server 中，官网推荐了一个 RedisBloom 作为 Redis 布隆过滤器的 Module。
详细安装、指令操作参考：https://github.com/RedisBloom/RedisBloom
文档地址：https://oss.redislabs.com/redisbloom/
整合redis方案:
①.将算法和bitmap数据放在client
②.算法在client，bitmap数据在redis
③.讲算法和bitmap数据都放在redis


2.Guava 的 BloomFilter
Guava 项目发布版本11.0时，新添加的功能之一是BloomFilter类。
Guava 提供的布隆过滤器的实现还是很不错的（想要详细了解的可以看一下它的源码实现），但是它有一个重大的缺陷就是只能单机使用（另外，容量扩展也不容易），而现在互联网一般都是分布式的场景，还得是redis出马。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h4> <p>假设我们有个集合 A，A 中有 n 个元素。利用<strong>k个哈希散列</strong>函数，将A中的每个元素<strong>映射</strong>到一个长度为 a 位的数组 B中的不同位置上，这些位置上的二进制数均设置为 1。</p> <p>如果待检查的元素，经过这 k个哈希散列函数的映射后，发现其 k 个位置上的二进制数<strong>全部为 1</strong>，这个元素很可能属于集合A，反之，<strong>一定不属于集合A</strong>。</p> <p>比如我们有 3 个 URL <code>{URL1,URL2,URL3}</code>，通过一个hash 函数把它们映射到一个长度为 16 的数组上，如下：</p> <p><img src="data:image/png;base64,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EokoGo0qGo2m3if5+tq1a/s9bzQadd5/7dq1ikQi/f45OxsAWEBBBGBGskRFo9F+v58se2eXq387NunAgQNqbW1VSUmJioqKnO+1t7frs88+6zNz/Phx7dmzR5s2bdKpU6ck9ZbKTZs2ac+ePWpvb9eRI0ckSbNmzeoznzy2v/dvaGhIlc2NGzeqtLT0vPkBIAyFYQcAgM2bN2v58uXnPSYajaq2tjbj9961a5dKS0s1b9681GtFRUWaMWOGtm7dqpaWFnV2dmr06NGp75eXl2vhwoXq6OhIvdbR0SHf97Vw4UKNGTNGLS0tkuRkqq6u1jPPPKMTJ05oz549qq+v15EjRzRv3jxdccUVGWcHgLBQEAGEau3atWpqajrvMZ2dnXrjjTckSTU1Naqrq0vrvTs7O9XS0qLKykqdOnVK8+bNU3t7u3NMa2urZs+enfq6oaFB+/fv1+rVq53jli1bJknq6upSR0eHWltb1dDQkLrN3NzcrCeffFKS9M4776iyslKTJ09WY2Ojrr322rTyAoAVFEQAoZs2bZqWLVumpUuXqrW1tc/3t23bptbWVlVXV2vhwoVpv29ybvz48br22mv7vZ3cn+uuu04LFixwymuyDHZ3d2vFihWSpGPHjmnq1Kk6fvy4rrzySo0ZM0bff/+9tm7dKkmpfy5btky7du3Szp07+70KWllZmfZOABAEPoMIIFR1dXV69913nVu850p+3m/GjBlqbGxMff7w335AROr9QZPdu3c7r0Wj0X4/t3j2D6JIvVcJH3/8cTU3N+uhhx6S1HsrORKJ6LbbbksVvyNHjqi7u1vHjh3T+PHjVVRUpN27d6uhoUH19fWSem87T506NXUuPoMIIBcU+r6f0UCmxzPLLLPMpjN78uRJ9fT0SJL++OOP1MyJEyd09OhRSerzOcWmpiadPn2636tyP/30U6rInTlzRidPntT+/fslSevXr1d5ebkuuugi/fnnn9q5c6ck6auvvtJ1112n9evX66abblJtba22bNkiSVqzZo1isZhWr16tsWPHasyYMTp69Kj279+vX375Rffdd5/OnDmj2tpadXV16fXXX9fYsWP1yCOP6MyZMzp9+nSf3X7//Xf9/fffqXwXXXSR6b8jZplldvjMFnqel9GbZHI8s8wyy2y6sz09PbrgggskSZdccok8z5Pv+7rssss0cuRISb1X45YsWaKioqLUD7bs3btXPT09zhXI7u5uNTc3p74eOXKkLrvsMs2dO1dbtmzRDz/8IN/3VVxcrJ6eHv38888qLS3V/Pnz5Xmeamtr5XmeNm/erNWrV6u+vl533HGHJGnBggWKRqPatWuXWlpatHfvXo0YMUIzZsxIZY5Go/rxxx9VU1OjadOmSZIuvPBCZzdJuvTSSzVixIhUvjNnzpj+O2KWWWaHzyyfQQRgWlFRkUpKSiT13mJOPqpm/Pjx552prKzUxRdfrGPHjqVeHz16tG655RY1NTVp7969mjhxYuoxONXV1anbvQ0NDVq3bl1qbvny5amrl2f/kExTU1Of2cOHD6uxsTH1/aamJtXU1KTei88gAsgFfAYRgHnXXHONJGnTpk3q7OyU1Pv4Gkmpz/6dq6KiQvPnz+/zevK5hbt371Z3d3fqfc4un7W1taqpqVFpaak2btyoaDSa+kxhMsukSZNSVwfPfsbib7/9lvpJ6ZqaGkWjUeenrvkMIoBcwBVEAObdddddmjZtWp9H0kjS/Pnz+y2IkydP1iWXXNLn9bOLXfIxOKWlpbrppptSxxw+fFjNzc1qb29XXV2dnn76aTU2Nqq6ulpz586V1FsEk89JbGpq0qxZsxSJRHTzzTf/58O7AcA6riACMG/06NF6++23VV1dnXoteXUvEolk/F7vvvuuVq5cqba2NrW2tqqystK5kldeXq6NGzequrpa7e3tevHFF9Xe3p66ynjw4EHV1dVp7ty5qauAS5cudX5tX/InoyORiDZv3pz9vwQACBBXEAGYkCxu/6aoqEgrV67UypUrB/T+n376qV599dV+v7d169bUTzxXV1fr8ssv10cffSRJqq+v1wMPPJD6TS7JzyImn4so9T7su66uTp999plOnz6tdevWqb6+PnUl8eznKfb3GcTkLelnnnlmwB82B4DBREEEkLfOLZ0PP/xwWnO+7+vFF190Xjvf732eOHFi6iHcvu/rueeec75fV1eX1m9/yeZRFQAwmLjFDAAAAAcFEQAAAA4KIgAAABwURAAAADgoiAAAAHBQEAEAAOCgIAIAAMBREI/HE+ke7Pv+sHqIK/vmN/bNb+yb39g3v7Fv+AozCZTNAswyyyyzzDLLLLPM5sYst5gBAADgoCACAADAQUEEAACAg4IIAAAABwURAAAADgoiAAAAHBREAAAAOCiIAAAAcFAQAQAA4KAgAgAAwEFBBAAAgIOCCAAAAAcFEQAAAI6CeDyeSPdg3/fled5Q5jGFffMb++Y39s1v7Jvf2Dd8hZkEymYBZplllllmmWWWWWZzY5ZbzAAAAHBQEAEAAOCgIAIAAMBBQQQAAICDgggAAAAHBREAAAAOCiIAAAAcFEQAAAA4KIgAAABwUBABAADgoCACAADAQUEEAACAg4IIAAAAx/8BGw/mkroe4zUAAAAASUVORK5CYII=" alt="image-20220311114106069"></p> <p>若当前哈希函数为 <code>Hash1()</code>，通过哈希运算映射到数组中，假设<code>Hash1(URL1) = 3</code>，<code>Hash1(URL2) = 6</code>，<code>Hash1(URL3) = 6</code>，如下：</p> <p><img src="./assets/img/20220318143436145.6dc3d8d0.png" alt="image-20220311142934256"></p> <p>因此，如果我们需要判断<code>URL1</code>是否在这个集合中，则通过<code>Hash(1)</code>计算出其下标，并得到其值若为 1 则说明存在。</p> <p>由于 Hash 存在哈希冲突，如上面<code>URL2,URL3</code>都定位到一个位置上，假设 Hash 函数是良好的，如果我们的数组长度为 m 个点，那么如果我们想将冲突率降低到例如 <strong>1%</strong>， 这个散列表就只能容纳 <code>m/100</code> 个元素，显然空间利用率就变低了，也就是没法做到<strong>空间有效</strong>（space-efficient）。</p> <p>解决方法也简单，就是使用多个 Hash 算法，如果它们有一个说元素不在集合中，那肯定就不在，如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Hash1(URL1) = 3,Hash2(URL1) = 5,Hash3(URL1) = 6
Hash1(URL2) = 5,Hash2(URL2) = 8,Hash3(URL2) = 14
Hash1(URL3) = 4,Hash2(URL3) = 7,Hash3(URL3) = 10
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="./assets/img/20220318143436146.fe96974a.png" alt="image-20220311154805364"></p> <p>以上就是布隆过滤器做法，使用了<strong>k个哈希函数</strong>，每个字符串跟 k 个 bit 对应，从而降低了冲突的概率。</p> <p>误判现象</p> <p>上面的做法同样存在问题，因为随着增加的值越来越多，被置为 1 的 bit 位也会越来越多，这样某个值即使没有被存储过，但是万一哈希函数返回的三个 bit 位都被其他值置位了 1 ，那么程序还是会判断这个值存在。</p> <p>比如此时来一个不存在的 <code>URL1000</code>，经过哈希计算后，发现 bit 位为下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Hash1(URL1000) = 7,Hash2(URL1000) = 8,Hash3(URL1000) = 14
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/20220318143436147.477b80f0.png" alt="image-20220311155646991"></p> <p>但是上面这些 bit 位已经被<code>URL1,URL2,URL3</code>置为 1 了，此时程序就会判断 <code>URL1000</code> 值存在。</p> <p>这就是布隆过滤器的误判现象，所以，<strong>布隆过滤器判断存在的不一定存在，但是，判断不存在的一定不存在。</strong></p> <p>布隆过滤器可精确的代表一个集合，可精确判断某一元素是否在此集合中，精确程度由用户的具体设计决定，达到 100% 的正确是不可能的。</p> <p>但是布隆过滤器的优势在于，<strong>利用很少的空间可以达到较高的精确率</strong>。</p> <h4 id="bloom-filter公式推导"><a href="#bloom-filter公式推导" class="header-anchor">#</a> Bloom Filter公式推导</h4> <p><img src="./assets/img/image-20230224221925075.9632725b.png" alt="image-20230224221925075"></p> <p><img src="./assets/img/image-20230224222617820.07cd8c39.png" alt="image-20230224222617820"></p> <p><img src="./assets/img/image-20230224222649851.5971822b.png" alt="image-20230224222649851"></p> <h4 id="coding"><a href="#coding" class="header-anchor">#</a> Coding</h4> <p>1.spark中构建布隆过滤器，然后进行广播；</p> <p>2.整合redis布隆过滤</p> <p>3.Hbase也有布隆过滤器</p> <h3 id="布谷鸟过滤器"><a href="#布谷鸟过滤器" class="header-anchor">#</a> 布谷鸟过滤器</h3> <h4 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h4> <p>除了删除这个问题之外，布隆过滤器还有一个问题：查询性能不高。</p> <p>因为真实场景中过滤器中的数组长度是非常长的，经过多个不同 Hash 函数后，得到的数组下标在内存中的跨度可能会非常的大。跨度大，就是不连续。不连续，就会导致 CPU 缓存行命中率低。</p> <p>变种的Counting Bloom Filter，虽然实现了删除操作，但是用多占用3 到 4 倍倍的存储空间的代价，才给 Bloom Filter 增加了删除操作，不够优雅。</p> <p>因此出现新的解决方案，那就是布谷鸟过滤器。</p> <h4 id="特点-2"><a href="#特点-2" class="header-anchor">#</a> 特点</h4> <p>论文《Cuckoo Filter: Practically Better Than Bloom》提出了删除并不需要在空间或性能上提出更高的开销。</p> <p>布谷鸟过滤器是一个实用的数据结构，提供了四大优势：</p> <blockquote><ul><li>1.支持动态的新增和删除元素。</li> <li>2.提供了比传统布隆过滤器更高的查找性能，即使在接近满的情况下（比如空间利用率达到 95% 的时候）。</li> <li>3.比诸如商过滤器（quotient filter，另一种过滤器）之类的替代方案更容易实现。</li> <li>4.如果要求错误率小于3%，那么在许多实际应用中，它比布隆过滤器占用的空间更小。</li></ul></blockquote> <h4 id="实现原理-2"><a href="#实现原理-2" class="header-anchor">#</a> 实现原理</h4> <p>布谷鸟过滤器不同于布隆过滤器主要有两点改动：</p> <p>1.hash算法：<br>
在布谷鸟过滤器中，数组中存储的是每个元素的&quot;指纹信息&quot;，也就是hash运算之后的几个bit位。查询数据的时候，就是看看对应的位置上有没有对应的“指纹”信息，删除数据的时候，也只是抹掉该位置上的“指纹”而已。<br>
由于指纹是对元素进行 hash 计算得出的，那么必然会出现 hash 碰撞的问题，也就是“指纹”相同的情况，也就是会出现误判的情况，所以这点和布隆过滤器一样。<br>
布谷鸟过滤器的hash算法是基于布谷鸟哈希算法做了改进，计算公式如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>fp = fingerprint(x)
h1 = hash(x)
h2 = h1 ^ hash(fp)  // 异或
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在上列公式可以看出，h2的位置是根据h1的位置计算出来的，也就是说我们知道了其中一个位置，就可以直接获取到另外一个位置，不需要再做全量的hash运算。因为使用的异或运算，所以这两个位置具有对偶性。这也是提高查询效率的一个点。<br>
只要保证 hash(fp) !=0，那么就可以确保 h2!=h1，也就可以确保不会出现自己踢自己的死循环问题了。<br>
这里还有个注意点：就是hash运算的时候，并没有对值进行长度取模运算，那么他是如何保证计算出来hash坐标，一定是在数组长度范围内呢？这就说到布谷鸟过滤器的一个限制条件了，那就是强制数组的长度必须是 2 的指数倍。2 的指数倍的二进制一定是这样的：10000000...（n个0）。<br>
这个限制带来的好处就是，进行异或运算时，可以保证计算出来的下标一定是落在数组中的</p> <p>2.存储结构：</p> <p>布谷鸟过滤器的存储结构是每个坐标下的空位是多个，不同于布隆过滤器的一个空位。如下图所示：</p> <p><img src="./assets/img/625861032ff5480e9e3170253dfefd01.d1f3c6c4.png" alt="img-625861032ff5480e9e3170253dfefd01.png"></p> <p>布谷鸟过滤器会记录每个元素的两个hash位置，每个位置下都会有多个空位，空位内存储的就是元素的“指纹信息”。</p> <blockquote><p>布谷鸟过滤器添加元素的流程是这样的：<br>
布谷鸟过滤器会先计算出元素对应的指纹信息，然后对元素进行hash运算，计算出元素的第一个存储坐标，该坐标下存在四个空位，如果四个空位中有空闲的，就将该元素的指纹信息存进去；如果没有空位，就会根据指纹和第一个hash坐标进行异或运算，计算出第二个坐标，如果第二个坐标下有空位，就将该元素的指纹信息存进去；如果还没有空位，那么该元素就会随机将一个空位中的指纹信息挤出，然后自己存进去，被挤出的指纹信息会计算出自己的第二个坐标，然后判断是否有空位，重复上述操作，直到达到一个阀值，布谷鸟过滤器返回false或进行扩容处理。</p></blockquote> <p>数据Data(指纹11)想要存储到布谷鸟过滤器中，首先会计算出h1和h2两个存储坐标，结果发现两个坐标的空位都已经“满员”了，此时会随机挤掉一个元素的指纹信息，假设挤掉了h1坐标的指纹3，然后指纹3会找自己的第二个坐标，然后判断是否有空位，有空位就存到第二个坐标下，如下图：</p> <p><img src="./assets/img/7467220cf5a34202a5873dbf0c8cdf21.b3c50edb.png" alt="img-7467220cf5a34202a5873dbf0c8cdf21.png"></p> <p>扩容：如果数组过小，会发生循环挤兑的情况，就可以设置最大挤兑次数，如果超过该次数，进行扩容，重新计算每个指纹的位置。</p> <p>当 hash 函数固定为 2 个的时候，如果一个下标只能放一个元素的指纹信息，那么空间利用率是 50%。如果为 2，4，8 个元素的时候，空间利用率分别是 84%，95%，98%，可以发现空间利用率飙升。</p> <p>但是需要对重复数据进行限制：如果需要布谷鸟过滤器支持删除，它必须知道一个数据插入过多少次。不能让同一个数据插入 kb+1 次。其中 k 是 hash 函数的个数，b 是一个下标的位置能放几个元素。</p> <p>比如 2 个 hash 函数，一个二维数组，它的每个下标最多可以插入 4 个元素。那么对于同一个元素，最多支持插入 8 次。</p> <p>例如下面这种情况：</p> <p><img src="./assets/img/image-20230624031242087.e7aadb8c.png" alt="image-20230624031242087"></p> <p>why 已经插入了 8 次了，如果再次插入一个 why，则会出现循环踢出的问题，直到最大循环次数，然后返回一个 false。</p> <p>怎么避免这个问题呢？</p> <p>我们维护一个记录表，记录每个元素插入的次数就行了。</p> <p>虽然逻辑简单，但是架不住数据量大呀。你想想，这个表的存储空间又怎么算呢？</p> <h4 id="优缺点"><a href="#优缺点" class="header-anchor">#</a> 优缺点</h4> <p>优点</p> <p>1.<strong>支持删除元素</strong>。</p> <blockquote><p>布隆过滤器不支持删除元素</p></blockquote> <p>2.<strong>更节省空间</strong>。</p> <blockquote><p>布谷鸟哈希表更加紧凑<br>
布谷鸟过滤器在错误率小于3%的时候空间性能是优于布隆过滤器<br>
布谷鸟过滤器比布隆过滤器空间节省40%多</p></blockquote> <p>3.<strong>查询效率很高</strong></p> <blockquote><p>布隆过滤器要采用多种哈希函数进行多次哈希</p></blockquote> <p>缺点</p> <p><strong>1.插入性能较差</strong></p> <blockquote><p>布谷鸟过滤器在计算哈希后可能当前位置上已经存储了指纹，这时就要将已存储的项踢到候选桶，随着桶越来越满，产生冲突的可能性越来越大，插入耗时越来越高<br>
布隆过滤器插入时计算好哈希直接写入位即可</p></blockquote> <p>2.插入重复元素存在上限</p> <blockquote><p>布谷鸟过滤器对已存在的值会做踢出操作，因此重复元素的插入存在上限。<br>
布隆过滤器在插入重复元素时并没有影响，只是对已存在的位再置一遍。</p></blockquote> <p>3.空间大小</p> <blockquote><p>布谷鸟过滤器必须是2的指数。<br>
布隆过滤器不需要2的指数。</p></blockquote> <p><strong>4.删除问题</strong></p> <blockquote><p>有上述重复插入的限制，删除时也会出现相关的问题：<br>
1.删除仅在相同哈希值被插入一次时是完美的;<br>
2.如果元素没有插入便进行删除，<strong>可能会出现误删除</strong>，这和假阳性率的原因相同;<br>
3.如果元素插入了多次，那么每次删除仅会删除一个值，你需要知道元素插入了多少次才能删除干净，或者循环运行删除直到删除失败为止.</p></blockquote> <p>Redis布谷鸟过滤器：https://github.com/kristoff-it/redis-cuckoofilter</p> <p>Redis通过插件支持sql及布谷鸟过滤器：https://github.com/RedBeardLab/rediSQL</p> <h4 id="扩展布谷鸟-hash原理"><a href="#扩展布谷鸟-hash原理" class="header-anchor">#</a> 扩展布谷鸟 hash原理</h4> <p>首先，先了解下布谷鸟hash。</p> <p><img src="./assets/img/image-20230624031012608.2c1bf322.png" alt="image-20230624031012608"></p> <p>它的工作原理，总结起来是这样的：</p> <p>它有两个 hash 表，记为 T1，T2。</p> <p>两个 hash 函数，记为 h1，h2。</p> <p>当一个不存在的元素插入的时候，会先根据 h1 计算出其在 T1 表的位置，如果该位置为空则可以放进去。</p> <p>如果该位置不为空，则根据 h2 计算出其在 T2 表的位置，如果该位置为空则可以放进去。</p> <p>如果该位置不为空，就把当前位置上的元素踢出去，然后把当前元素放进去就行了。</p> <p>也可以随机踢出两个位置中的一个，总之会有一个元素被踢出去。</p> <p>被踢出去的元素怎么办呢？没事啊，它也有自己的另外一个位置。</p> <p><img src="./assets/img/image-20230624031051607.68c61712.png" alt="image-20230624031051607"></p> <p>上面的图说的是这样的一个事儿：</p> <p>我想要插入元素 x，经过两个 hash 函数计算后，它的两个位置分别为 T1 表的 2 号位置和 T2 表的 1 号位置。</p> <p>两个位置都被占了，那就随机把 T1 表 2 号位置上的 y 踢出去吧。</p> <p>而 y 的另一个位置被 z 元素占领了。</p> <p>于是 y 毫不留情把 z 也踢了出去。</p> <p>z 发现自己的备用位置还空着（虽然这个备用位置也是元素 v 的备用位置），赶紧就位。</p> <p>所以，当 x 插入之后，图就变成了这样：</p> <p><img src="./assets/img/image-20230624031126647.5fae8bf2.png" alt="image-20230624031126647"></p> <p>这种类似于套娃的解决方式看是可行，但是总是有出现循环踢出导致放不进 x 的问题。</p> <p>当遇到这种情况时候，说明布谷鸟 hash 已经到了极限情况，应该进行扩容，或者 hash 函数的优化。</p> <p>当踢来踢去了 （MaxLoop）次还没插入完成后，它会告诉你，需要 rehash 并对数组扩容了。</p> <p><strong>优化</strong></p> <p>上面的布谷鸟哈希算法的平均空间利用率并不高，大概只有 50%。到了这个百分比，就会很快出现连续挤兑次数超出阈值。这样的哈希算法价值并不明显，所以需要对它进行改良。</p> <p>改良的方案之一是<strong>增加 hash 函数</strong>，让<strong>每个元素不止有两个巢，而是三个巢、四个巢</strong>。这样可以大大降低碰撞的概率，将空间利用率提高到 95%左右。</p> <p>另一个改良方案是<strong>在数组的每个位置上挂上多个座位</strong>，这样即使两个元素被 hash 在了同一个位置，也不必立即「鸠占鹊巢」，因为这里有多个座位，你可以随意坐一个。除非这多个座位都被占了，才需要进行挤兑。很明显这也会显著降低挤兑次数。这种方案的空间利用率只有 85%左右，但是查询效率会很高，同一个位置上的多个座位在内存空间上是连续的，可以有效利用 CPU 高速缓存。</p> <p>所以更加高效的方案是将上面的两个改良方案融合起来，比如<strong>使用 4 个 hash 函数，每个位置上放 2 个座位</strong>。这样既可以得到时间效率，又可以得到空间效率。这样的组合甚至可以<strong>将空间利用率提到高 99%</strong>，这是非常了不起的空间效率。</p> <h4 id="coding-2"><a href="#coding-2" class="header-anchor">#</a> Coding</h4> <p>1.redis4.0支持module,将布谷鸟过滤器加载到module中.</p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2023-7-19 7:18:59 ├F10: PM┤</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-3" data-v-b57cc07c><a href="/./2023/02/08/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%92%8C%E5%B8%83%E8%B0%B7%E9%B8%9F%E8%BF%87%E6%BB%A4%E5%99%A8/#前言" class="sidebar-link reco-side-前言" data-v-b57cc07c>前言</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/02/08/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%92%8C%E5%B8%83%E8%B0%B7%E9%B8%9F%E8%BF%87%E6%BB%A4%E5%99%A8/#bitmap数据结构" class="sidebar-link reco-side-bitmap数据结构" data-v-b57cc07c>BitMap数据结构</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/02/08/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%92%8C%E5%B8%83%E8%B0%B7%E9%B8%9F%E8%BF%87%E6%BB%A4%E5%99%A8/#布隆过滤器" class="sidebar-link reco-side-布隆过滤器" data-v-b57cc07c>布隆过滤器</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/02/08/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%92%8C%E5%B8%83%E8%B0%B7%E9%B8%9F%E8%BF%87%E6%BB%A4%E5%99%A8/#布谷鸟过滤器" class="sidebar-link reco-side-布谷鸟过滤器" data-v-b57cc07c>布谷鸟过滤器</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----></div></div>
    <script src="./assets/js/app.764dede6.js" defer></script><script src="./assets/js/13.20e964b9.js" defer></script><script src="./assets/js/1.8757f81f.js" defer></script><script src="./assets/js/15.7747d51d.js" defer></script><script src="./assets/js/34.ec572062.js" defer></script>
  </body>
</html>
