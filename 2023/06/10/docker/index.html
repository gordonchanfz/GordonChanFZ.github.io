<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Docker | 个人博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="./favicon.ico">
    <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?55943ae09e5901d7a9f5705133737eec";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
            })();
           </script>
    <script src="https://hm.baidu.com/hm.js?xxxxxxxxxxx"></script>
    <meta name="description" content="会思考的芦苇。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="robots" content="all">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="./assets/css/0.styles.f4f644f3.css" as="style"><link rel="preload" href="./assets/js/app.764dede6.js" as="script"><link rel="preload" href="./assets/js/13.20e964b9.js" as="script"><link rel="preload" href="./assets/js/1.8757f81f.js" as="script"><link rel="preload" href="./assets/js/5.a1a0df33.js" as="script"><link rel="preload" href="./assets/js/34.ec572062.js" as="script"><link rel="prefetch" href="./assets/js/10.36ed4133.js"><link rel="prefetch" href="./assets/js/11.18e1c33d.js"><link rel="prefetch" href="./assets/js/12.b32071c5.js"><link rel="prefetch" href="./assets/js/14.d0932ff0.js"><link rel="prefetch" href="./assets/js/15.7747d51d.js"><link rel="prefetch" href="./assets/js/16.487f9c88.js"><link rel="prefetch" href="./assets/js/17.9ae2b89b.js"><link rel="prefetch" href="./assets/js/18.801c9b12.js"><link rel="prefetch" href="./assets/js/19.867ef46b.js"><link rel="prefetch" href="./assets/js/20.ec371d7f.js"><link rel="prefetch" href="./assets/js/21.73f810bc.js"><link rel="prefetch" href="./assets/js/22.8c016772.js"><link rel="prefetch" href="./assets/js/23.9aa3d5ef.js"><link rel="prefetch" href="./assets/js/24.a6dcda10.js"><link rel="prefetch" href="./assets/js/25.2fe13775.js"><link rel="prefetch" href="./assets/js/26.2296389e.js"><link rel="prefetch" href="./assets/js/27.21f2d66f.js"><link rel="prefetch" href="./assets/js/28.3209357f.js"><link rel="prefetch" href="./assets/js/29.c7065b7f.js"><link rel="prefetch" href="./assets/js/3.9efa3b27.js"><link rel="prefetch" href="./assets/js/30.92914cc9.js"><link rel="prefetch" href="./assets/js/31.13c12633.js"><link rel="prefetch" href="./assets/js/32.b016f60e.js"><link rel="prefetch" href="./assets/js/33.ed48a654.js"><link rel="prefetch" href="./assets/js/35.5b55607b.js"><link rel="prefetch" href="./assets/js/36.f50b6e38.js"><link rel="prefetch" href="./assets/js/37.34409ac4.js"><link rel="prefetch" href="./assets/js/38.c7073f77.js"><link rel="prefetch" href="./assets/js/39.12f063e9.js"><link rel="prefetch" href="./assets/js/4.95c562bd.js"><link rel="prefetch" href="./assets/js/40.1bbd5377.js"><link rel="prefetch" href="./assets/js/41.6331a8cf.js"><link rel="prefetch" href="./assets/js/42.28acd6f5.js"><link rel="prefetch" href="./assets/js/43.905d2114.js"><link rel="prefetch" href="./assets/js/44.041132c5.js"><link rel="prefetch" href="./assets/js/45.d1a66b92.js"><link rel="prefetch" href="./assets/js/46.1c9100fe.js"><link rel="prefetch" href="./assets/js/47.3e75f768.js"><link rel="prefetch" href="./assets/js/48.7d7248fb.js"><link rel="prefetch" href="./assets/js/49.8d465809.js"><link rel="prefetch" href="./assets/js/50.4aa56564.js"><link rel="prefetch" href="./assets/js/51.59674bf5.js"><link rel="prefetch" href="./assets/js/52.f3990683.js"><link rel="prefetch" href="./assets/js/53.092fe0ad.js"><link rel="prefetch" href="./assets/js/54.ac62e2a7.js"><link rel="prefetch" href="./assets/js/55.3530fa5a.js"><link rel="prefetch" href="./assets/js/56.6e9bc6f3.js"><link rel="prefetch" href="./assets/js/6.e534639a.js"><link rel="prefetch" href="./assets/js/7.bc868936.js"><link rel="prefetch" href="./assets/js/8.ce0f4f25.js"><link rel="prefetch" href="./assets/js/9.a57a9cf0.js">
    <link rel="stylesheet" href="./assets/css/0.styles.f4f644f3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Gordon</h3> <p class="description" data-v-59e6cb88>会思考的芦苇。</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Gordon</span>
          
        <span data-v-59e6cb88>2018 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><img src="./logo.png" alt="个人博客" class="logo"> <span class="site-name">个人博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      计算引擎
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./计算引擎/flink.html" class="nav-link"><i class="undefined"></i>
  flink
</a></li><li class="dropdown-item"><!----> <a href="/./计算引擎/spark.html" class="nav-link"><i class="undefined"></i>
  spark
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      存储引擎
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./存储引擎/ElasticSearch.html" class="nav-link"><i class="undefined"></i>
  ElasticSearch
</a></li><li class="dropdown-item"><!----> <a href="/./存储引擎/hbase.html" class="nav-link"><i class="undefined"></i>
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/./存储引擎/redis.html" class="nav-link"><i class="undefined"></i>
  redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      云原生
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./云原生/Docker.html" class="nav-link"><i class="undefined"></i>
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      中间件
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./中间件/kafka.html" class="nav-link"><i class="undefined"></i>
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./中间件/Sqoop基本使用.html" class="nav-link"><i class="undefined"></i>
  Sqoop基本使用
</a></li></ul></div></div><div class="nav-item"><a href="/./tool/emoji/我的常用emoji.html" class="nav-link"><i class="undefined"></i>
  工具
</a></div><div class="nav-item"><a href="/./aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></div> <a href="https://github.com/GordonChanFZ/gordonchanfz.github.io/" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="./avatar.jpeg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Gordon
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>30</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>47</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41><li class="social-item" data-v-1fad0c41><i class="iconfont reco-github" style="color:#e15b64;" data-v-1fad0c41></i></li></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/./" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      计算引擎
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./计算引擎/flink.html" class="nav-link"><i class="undefined"></i>
  flink
</a></li><li class="dropdown-item"><!----> <a href="/./计算引擎/spark.html" class="nav-link"><i class="undefined"></i>
  spark
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      存储引擎
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./存储引擎/ElasticSearch.html" class="nav-link"><i class="undefined"></i>
  ElasticSearch
</a></li><li class="dropdown-item"><!----> <a href="/./存储引擎/hbase.html" class="nav-link"><i class="undefined"></i>
  hbase
</a></li><li class="dropdown-item"><!----> <a href="/./存储引擎/redis.html" class="nav-link"><i class="undefined"></i>
  redis
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      云原生
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./云原生/Docker.html" class="nav-link"><i class="undefined"></i>
  Docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      中间件
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/./中间件/kafka.html" class="nav-link"><i class="undefined"></i>
  kafka
</a></li><li class="dropdown-item"><!----> <a href="/./中间件/Sqoop基本使用.html" class="nav-link"><i class="undefined"></i>
  Sqoop基本使用
</a></li></ul></div></div><div class="nav-item"><a href="/./tool/emoji/我的常用emoji.html" class="nav-link"><i class="undefined"></i>
  工具
</a></div><div class="nav-item"><a href="/./aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于我
</a></div> <a href="https://github.com/GordonChanFZ/gordonchanfz.github.io/" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Docker</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Gordon</span>
          
        <span data-v-59e6cb88>2018 - </span>
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">Docker</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Gordon</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2023-6-10</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>云原生</span><span class="tag-item" data-v-8a445198>容器技术</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="_1-docker-的介绍和安装"><a href="#_1-docker-的介绍和安装" class="header-anchor">#</a> 1. Docker 的介绍和安装</h2> <h3 id="容器技术的介绍"><a href="#容器技术的介绍" class="header-anchor">#</a> 容器技术的介绍</h3> <p>注意我们这里所说的容器container是指的一种技术，而Docker只是一个容器技术的实现，或者说让容器技术普及开来的最成功的实现</p> <p><strong>容器正在引领基础架构的一场新的革命</strong></p> <ul><li>90年代的PC</li> <li>00年代的虚拟化</li> <li>10年代的cloud</li> <li>11年代的container</li></ul> <p><strong>什么是container(容器）？</strong></p> <p>容器是一种快速的打包技术</p> <p>Package Software into Standardized Units for Development, Shipment and Deployment</p> <ul><li>标准化</li> <li>轻量级</li> <li>易移植</li></ul> <p><strong>为什么容器技术会出现？</strong></p> <p>容器技术出现之前</p> <p><img src="./assets/img/why_container_1.65fc9070.png" alt="why_container1"></p> <p>容器技术出现之后</p> <p><img src="./assets/img/why_container_2.b1fa06e9.png" alt="why_container2"></p> <p>容器 vs 虚拟机</p> <p><img src="./assets/img/container_vs_vm.b4b11921.png" alt="container_vs_vm"></p> <p>Linux Container容器技术的诞生于2008年（Docker诞生于2013年），解决了IT世界里“集装箱运输”的问题。Linux Container（简称LXC）它是一种内核轻量级的操作系统层虚拟化技术。Linux Container主要由Namespace 和Cgroups  两大机制来保证实现</p> <ul><li>Namespace命名空间主要用于资源的隔离（诞生于2002年）</li> <li>Cgroups(Control Groups)就负责资源管理控制作用，比如进程组使用CPU/MEM的限制，进程组的优先级控制，进程组的挂起和恢复等等。（由Google贡献，2008年合并到了Linux Kernel）</li></ul> <p><strong>容器的标准化</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker != container
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在2015年，由Google，Docker、红帽等厂商联合发起了OCI（Open Container Initiative）组织，致力于容器技术的标准化</p> <p><strong>容器运行时标准 （runtime spec）</strong></p> <p>简单来讲就是规定了容器的基本操作规范，比如如何下载镜像，创建容器，启动容器等。</p> <p><strong>容器镜像标准（image spec）</strong></p> <p>主要定义镜像的基本格式。</p> <p><strong>容器是关乎“速度”</strong></p> <ul><li>容器会加速你的软件开发</li> <li>容器会加速你的程序编译和构建</li> <li>容器会加速你的测试</li> <li>容器会速度你的部署</li> <li>容器会加速你的更新</li> <li>容器会速度你的故障恢复</li></ul> <p><strong>容器的快速发展和普及</strong></p> <p>到2020年，全球超过50%的公司将在生产环境中使用container —— Gartner</p> <p><img src="./assets/img/dockerhub-2020.8e6b6d35.png" alt="dockerhub2020"></p> <h3 id="在-linux-系统上安装-docker"><a href="#在-linux-系统上安装-docker" class="header-anchor">#</a> 在 Linux 系统上安装 Docker</h3> <p>使用脚本快速安装</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#下载安装脚本到get-dcoker.sh,version为可选</span>
<span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> get.docker.com <span class="token parameter variable">-o</span> get-docker.sh  
<span class="token function">sh</span> get-docker.sh <span class="token parameter variable">--version</span> <span class="token operator">&lt;</span>VERSION<span class="token operator">&gt;</span>
<span class="token comment">#确认是否安装成功</span>
<span class="token function">sudo</span> systemctl start <span class="token function">docker</span>
<span class="token function">sudo</span> <span class="token function">docker</span> version
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="./assets/img/image-20230613194139663.8dd3fbcc.png" alt="image-20230613194139663"></p> <h2 id="_2-容器的快速上手"><a href="#_2-容器的快速上手" class="header-anchor">#</a> 2.容器的快速上手</h2> <h3 id="docker命令行的认识"><a href="#docker命令行的认识" class="header-anchor">#</a> docker命令行的认识</h3> <p><strong>docker + 管理的对象（比如容器，镜像） + 具体操作（比如创建，启动，停止，删除）</strong></p> <p>例如</p> <ul><li><code>docker image pull nginx</code> 拉取一个叫nginx的docker image镜像</li> <li><code>docker container stop web</code> 停止一个叫web的docker container容器</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> version 或docker info <span class="token comment">#查看版本</span>
<span class="token function">docker</span> <span class="token builtin class-name">help</span> <span class="token comment">#查看docker的命令</span>
<span class="token function">docker</span> container <span class="token parameter variable">--help</span>
<span class="token function">docker</span> container <span class="token function">ps</span> <span class="token comment">#当前运行的容器</span>
<span class="token function">docker</span> container <span class="token function">ps</span> <span class="token parameter variable">-a</span> <span class="token comment">#当前所有的容器</span>
<span class="token function">docker</span> container <span class="token function">ls</span> <span class="token comment">#与ps效果一样，ps是老版的命令</span>
<span class="token function">docker</span> image <span class="token function">ls</span>
<span class="token function">docker</span> image <span class="token function">rm</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="理解image-vs-container-镜像-vs-容器"><a href="#理解image-vs-container-镜像-vs-容器" class="header-anchor">#</a> 理解Image vs Container 镜像 vs 容器</h3> <p><strong>image镜像</strong></p> <ul><li>Docker image是一个 <code>read-only</code> 文件</li> <li>这个文件包含文件系统，源码，库文件，依赖，工具等一些运行application所需要的文件</li> <li>可以理解成一个模板</li> <li>docker image具有分层的概念</li></ul> <p><strong>container容器</strong></p> <ul><li>“一个运行中的docker image”</li> <li>实质是复制image并在image最上层加上一层 <code>read-write</code> 的层 （称之为 <code>container layer</code> ,容器层）</li> <li>基于同一个image可以创建多个container</li></ul> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAf8AAAFSCAMAAADLrSa8AAAArlBMVEUCiccdsNMkqcsett0OsakGr48PmJkSkZ0Vg50YkK4SgaYLgcICd9ADh8gDkrcDo8kDnMUbp8oanb47pNAvnL5KsddOsM5fvdY+m7QTdY0QZnw3fZNbnbSMyduBqbk/aHkBLjsAEBQAAAAODg4mKStDRUZLV11wbG2CgoKBkZ6NjI2bm5usiovKqanOs7Pew8PSxMTY19i/v7+trKzQ0NC1xcmy4e3R5vXq9fn///9CCSmvAAAVxUlEQVR42u2dj2+qvNvGv+PkTc5Jlk0GhjwC6paMOd1iJgvq//+Pvf1JWyiic0qR68p5NoHe5Ymf9u7dFu797wUasv73MoKGK/AHfwj8IfCHwB8Cfwj8IfB3QtF2t9/vttFR5z1yruCXyUWvPJ/uNWnnR6MxsRAm+rnduLXOSK8zNYqL+xQB+J8p7ds0vszAfp4Vj07hn9bOEP7k1Li1zlb+pHQE/r+E34Q01s+PK+W3/vH8/S07FbX0f1udR/CvNizwP02MTkG+w2BrfMfs/JZ0/KCQbPQvP6qxsrhvhXpbHQAs/C11Rna8tDhrTn5Ra1jgf+LYX1L3t0VknhfIzC+Zs6JYjuRPzIvI9CFW/2+ps40/c1Ip+J+hosGDaudVdKY53/RY/gyWV+Vk6//1Otv578H/bPdftJ0v9AFAsCL0juPPT6XGGGLv//U62/jTMcv0K+B/evRXNJxPtdBOYWBXmNVx/At2A7O/2/q/rU49/quFIEIF4v8z+acn849osB8dxV/0VepP0oP8bXUewb/wwf/q/T+iOLfpMfzlmUrhuv+31dnKv3B+8teD8X/rnzr+R4zM7hj+hYYwOtj/LXUeHP8rE1bwv178H0murfybhmpL/7fUeTj+Y0sUEfj/0vx/VGwj35z/+w3z/0guD7byjxpWBW39v15nS/w/3vVh+a8v63+F0UPZebrwz9xsZfCNRvZV/TowNXSYSzVW/rU62+Z/KeL/X4kAT13/j6RdG38NuhlpWP1/rU7De1RDkFFfRgDH9/+C0/f/5FZdK/9Uazv654b+X62zjX8/RoAe7P/vT9v/LztfC3+jzxsDgL3/V+ts5c9ikxT8IfCHwB8Cfwj8IfCHwB8Cfwj8IfCHwB8Cfwj8oevyX0AD1XKVE/7L5ZIfQQORoE/wU/6r1YqdXUEDkcSd5xvCP4eGqg3lv4EGq2/C//tbfIYGIsX7i/D/EtpDA5FGnPDH9zFggT/4Q+APgT8E/hD4Q+APgT8E/hD4Q+APgT8E/hD4Q+APgT8E/hD4Q+APgT8E/hD4Q+APgT8E/hD4Q+APgT8E/hD4Q+APgT8E/hD4Q+APgT/kHv//g85Uz/kjRfZ5An/wB3/w7yf/b/A/l/8X+A+a/3eP+X9twP9c/psv8Af/M7R4fX3dnmiQCX6L8/h/g//5/L+74v+1kO2gh/z9yX311NPzy/P9abX8wOR2+L+99pf/ZP4C/j/kL9Vj/oQb+IP/b9TjGH8CZbEmP94o0g35wD8xrTJymK3kYU4PV1X+ZXSXiQ9rVkqrl5dYvXKxELByo674/5sTrs+Tx9LHv7zMJ+xz/Pwyf5iwq+SIXqDXaBhAzvGTEqZZlOiBFH+eM8yTl5cJuTS/r/BX1ZQtS146YH0h/m8MM//MJIhn4lDQFlff3kz+FHchfrPzK/Zbq7fOv3KjrvjPngVX2gB8AZkfUajixETnXxYy+auijBoVg0k+00vPjxX+WjVzXtloxu98yPpC/CWKheTNuajDhXlY8f8ZL7+ShqTgW7Vek3/lRl3xfxL4OQCJhB/F5TX69Zf8OaQJ56P4a0VpEYVworULjb9ezUwAnrNiB60vxn8rO/Lbdvclhmnuxvf5qzp8Xe12mxr/N8abV7Qo24Oqtxb/V27UGf8J88C03xMA9Isnjtan37mAKi6+3CsvPS8vmvxVUfqLsP3Hu/VE+hOTv16NP9cqO2x9Kf6rEtNut98J8CuOVVJbMfz7nfLzZZTACrDT8kOh11vjX7lRV/x93uNG8XzywN2wHAbmJWINtRb/PdX4q6Kx8PCGp7DHf6KaCbshL3/Y+lL8t9KPLyjg3Zvw+EbU/iag7faV8V8AJz8zdmGlYomtnX/Dja7N32AqGwPHoUA8Vfn7Exa6mfy1oqUDZ15lUunAJX+tGmr/WHX/VusL8c8q4d6r6Pn0C1+9qdjwbceoifh/UQ7nDCM5XLzJwN+c7Fn4127UNX91wMfjBv5lkHgU//sm/kY1bABQgcEB64vyX+vxXbbfq4hN8af4RXyv8WcjBblerOhhxqcDzfzrN3K0/z/W+DNuz6zrmvwfdf5avG7nb1bDCtFJRNn4mqyvyp8dv+Vfb2b/39X7Py1Jw8QtHQPy+mKvo/wl8qf53Dr+W/ib0YCVf2xECnb+laCCnpwY4UYX/NmwXAnrd3yQzrSgjZ0w+VNLPgnIWBDw1sB/oY3/Lqz/ififR/z1+N/CX3TP+AB/Np24l83Izt+sRkw9n2Xra7a+LP+F0RtpL2VRWqbF/3sRtVfWfxfmCsKqhf/iwDpwR/P/R21IlvP/Kn+6NvhMXca/+Usz/9oMvqH/q2qEyXxUfmyyviz/tViSXWWLjfDSGzZJb5n/S49eyIhh28yfXTNv5MD63/O9bf1Ph8q76PxRNZJJE3+5asPGlob4z6hGtK770ik1Wl+Wf7lk96oWcLTlvlXT+p+I6MtG8rZv4L/SJgxNC4AOrf8bUJljnjyydfv5A5+eN/AX9dw3j/8joxreusqw74D1hfkrLkstTMvF+v5+KZHV+S8k9qxEauG/Lmd8xo3w/E+5B9DN/p8ajNm2XLbgdJnrX2z35SrNhp9Y1/mv9D2Dook/r2BZu9Hg+U9+aXf5Ovv/HT7/eYv8RWj5CP7D5M/jzqs9FAL+DvKfT0bgj+e/wR/8wR/8wR/8wd/OHzpTfeb/tcnz5XIB/VDLZZ73+/3fTb5aQj/WKt/0mT8ZAPJ8Bf1YpPv3Of/D/uubeADox9psvnud/2X/TRoA9HN9u939j8j/+fUN/Vhud/498r8OXeAP/hD4N+gP1InAH/zBH/zBH/y73P8DiW70Df7g3zn/rw1IdKOrbRqCP/gf2P0FiY74f4M/+IM/+IM/+IM/+HfEHw/wn6te878Dv3N1dwf+w+Z/11v+uQ9+Z79v3l/+m/wJ/M7ON/KTBgD+N8Tf7yl/8vbfP/A7V/+ewB/8wR/8wb8u7+PjI3SwLvAHf/AHf/Dvj8C/t/3//eMjCJcfH0tv5CfkVMKXzuhHeTAK39lnWpQdkuIf756FvzKjZwL9kmZECiUJuyP4u8D/nUFbMkKCOT9FLtGDQHwW/BNxLajz18zehTEp/e6bRpQ9vaEP/k7wN7X0JbSEl/C0i4EiqXt8UZdulgjA76xFGUbiIIH/d4R/4vusQ3oSOe/pgQKecKzkkJYkkKmzeLeNJdKMlgvkFdOI1vTuY/x3xv8L/6yQqxKB4cnJYSA6fqIzNOI/r2w277KYaZRcKVoE/yP5izHZ18I2P3z/UB0+UVwTc6So8FdmlDkpUHX/9Fxyne4P/j/m77+rAV81iWWFv9nlQ9OMF/eMEV8Ygb/j/Fk08JGEDf2/HrirUb40484+MGoXAn/H+YsooHH8D+x1mWb091JMGU0j8HecvzhojP/pWpEl/jfNxNSS9XvTqEP+oSnwb+z/CV+xC06Y/5tmouT7aDSqz/874h9mhmbgb4//1KJQoq3/fZjrf8mBtaQyYJBuXzfqkP+rIfBviv/ZEk0oQbEunZQTgaRp/b9iRusuw77EWP8H//7t/3m2yO+g3vUYwYX9P29WiuKPwf8IiV1BNrkPTzUMnOKvtYQ4e81C8D8So9zX80/yFlfy8z+b/4Xw/8e78VrE3yq+GNRl9wf/X/MA4smAUzozm/J3ir+Fvwf+N65G/p5Hf8aI/4bI3/PCJAlD3gbAf2j8w2TG5/6JB/7D4x9mavUnBP+h8fcyffnPc5n/3/8m0Bn672+d/13Mlv3Ij5iOAk7Hf2gAZ9En+C3rvxmFTmZ+GVkKdnv+9/Tv79//oB/rL+3+Nf6UvPgZsp/u5v94Ih4A+rFI76/nf+kNf5L/iTYA6Oey4KfkXz3h/2OH/T/J/+b7pAVAPxf5Au9s4T8b/1/D2OX4j+b/u/Ohs2RJ/3fHOj3lnzU8/uFO/tc76EzZN314/6dNIHSaP9ZvzpWF7l2ceZx/Zl/+Q/7X25HVAxDqd7NZHIfI/3v7/O8aN3+R//f2ZUv/yjZ/vQPNAPlfb0a2BYCEBP5ZQj45vf8L/r/Dv/7+Fw/9vT932P8d4v6v2P4lCz/0F57/Hhp/OvGjW7/k6T/X93/B7zL8Q/rT4w1g0O//5Z+fgYN1XZo/jf2Y5wf/4fEnnT6gUWDM9wLBf2D8/9C3/sKQ/hi6/3e1LV2UP6OeZfy/gb//z5lNPz/HIfmYk/Qs5POnyP87Jac+c5n/l1+gRelhQK9NPQt/ZUbPjPVLmhGpZ5qwO3Y1/xMKwZ/CoGTIz4D/ngpE6iAQnwV/eW1c56+ZTYUxBe2bRuKWeQf5f1vTPwyRvymKhUOjlwJe8FPhS8qDoFqXbia4i3ZgGE21tnVt/iTpj1TsgT+HMfV91iE9iZz39IAD5yU4wvGIliRg6ZAxtY0l0sznAwC/YhqJCjuJ/z3kf6v7f+GfFXJVYmx4cnIYiI6f6A7ciP8MM17MNJp+XidaRP6/4/hPFc4ybPMDFsqJjjxVXBNzpKjwV2aUOWdtuH9xLu8w/yN5ATjE+78H+ftTNeCrJlHlb3b5wDTjxVVgoBl1yt9L4hnL/ReH4N/An0cD0yC39/86PDXKl2a85sCoXahL/vSxf7z/28JfRAGN4//YXpdpRn/nYspoGnXJf6bN/zIP/K38xUFz/O8pr6DVZZqJeR4jbRp1yJ89/0Ef/5xlQ9//ben/UzZbk/35qPm/aSZK8kZSnf93xV+99c0SQXjgb43/1KLQVFv/y831v+mBtaQyYJBuXzfqkL/W6UPwPxz/54EM29j+QFJOBBKxWFSrq2JmgNaMuuXvaXsBHvb/Tmsw45MspldY5D3Z/3vau+DgfxxFitE/edku+Ty1wVzj+Q+xBEwngnj+71iMtRW/o7zFlfz8Cfxp1peYrP2R10DokyBsKRD8j3AA1Yi/VX7+2XH3t/FP2PMfZPMvE7+JPPBv8wC8L5+0Z8em/MnIMf7m8x/yZRDwv0mBP/hX4/9MewBkBv8/NP4kAsT+/6D54/mPwfMn0z/Pff5I//r7+X/FIlBt0Ef+32Hk/1WbgKHr/JH/9wL5f/vCH/l/L5P/tzf8kf/3Ivl/+8Mf+X8vkf+3R/yR//cC+X/7xP9h9IB/Z/1rWvwJ4zj2nOeP9Ztzddf01x8PvP7jzvgPfufKPv6TPwDINoFCz+34H/wuwZ8lABVJAEOn5//gd65sE8BEewJgFoL/bfO3Pv9HnvvC+z8D3f+jb/3wbh/O7H8AFPxvmX+soNOmEIL/wJ7/0pjPBs3f26zXgYN1XZx/DP7D5u+pUBD8B8Y/pn/2zZPvf2UY/wfGn3b6LKb5n1gmAG/w/T9fr8ch+bgJyQue6/Wav6/rT8mp9SbiRUNSaB2xovQwoNfS0MJfmdEzY/2SZkRuM52yO3bw/GfMXvxi2X8dXv+5Kn9KhvwM+G/WAPI1V8p4i8+C/1RcG9f5a2a5MI5Izb5pNOW3vPwOh/X5P5X/KRt0/ifF3xTFwqFRZgEvuFb4ovIgqNalmwnutP5pxUi0hemoE/5/Yp4Cyum//3ld/iT9K+uQoUTOe3rAgbNRwecISfqnDQNLh4zUNpZIM58PAPyKaUQrTDvM/8j2/93++5/X9f/CPyvkqsTY8OTkMBAdP9IduBH/CbMpM+PFTKPp+krRIt7/OYp/qnCWYZs/Tjeqw08V18gcKSr8lRllTgpU3b/gf52nG8D/h/z9XA34qklU+ZtdPjDNeHEVGGhGXfJnqX+VMP+z8efRwHS8sff/Ojw1ypdmfAAIjNqFuuQfZ4Zi8LfwF1FA4/g/ttdlmtHfm5R/NI065W+mfgB/G39x0Bz/h+xXNf43zcTUkpE2jdzhj/7f2P+nbLYm+/NR83/TTJTkjaQ6/++Mf8j/8gt5/oc8AJRh/dce/6lFoam2/rcx1/+mB9aSyoBBun3dyJH4P8b6f2P8P2ULwjJsY/sDUTkRiMRiUa2uiplcWxhVjBzhTzYAZ9j/O63BnJbOL9djBDf2/6oOAPxbJXYF/ZOX7aL1qQ3m2v0f/I/EWFvxO8pbXMvP/2z9h+4Eg/9xbrwW8bfK36y77v7257+lhj7/P8UD8L58WvrXjXp+xCH+5vwfz//ftNr4D/r5n2HyL9d/4qYcAOB/y/yx/wv+4A/+PeCP9J+XyP/qVVR7CAT5X285/2s4qytG/tfB5H8NLX//Y4b8r4PJ/9oX/sj/epn8r3X/T9YBkP/1RhPA3p0e/juU//UBOkujhxb8JPp3mj8yuJ7xj/6o9H8j5yeBH89ih/kjAeTZMgYAT5/pUfhZNfRzbPwHv1/lH5a4PZoC1hL6Oxb/g9+5MmYAId/v9zwJn+aBBP/b5u8b/F/jIIgVfIfz/36T9T/w+9UNIJ76NTsIH/xveAMwlKmfm1J/gP9tbwCHM/naX+L833+4PH9vt9+NHazrkg8AhHFrExgS//3Ywbou+wCIF5fRP8kB5KH/D6r/15oAxv/h8efjAGsCGfp/sd9HwXa/35EELik5xd/YpB/38mAUFOwzLUoPx7R4EVj8vzKjZyK9aWhG6X6f0lsFnfGXTSDD+E+gbtktd2P+mzEvxP9HwXjv+GfBP+WXdlG9/2tmhTCOSP2+aUQ+s2bidfwAaBjH6P9F9dYUC4dGOY15Q5GK2DVRcFxtS7pZJAAXrEUZRqnWtpx7AHiI/Avfp32fOGSBnPf0MffhKSsxinaMPy1JIAc7HaA2lkgzWi6SV0wjUeEI/B3x/8I/K+SqRGR4cnI4Fq5e+HVL/OeVzaaQxUyjdH+laBH8j+r/BSdD3XUZtvlRsduXHT5VXCNzpKjM/5UZY+5V3T8zSvWmA/6d9/86f79QA75qEtsq/3GlLelmvLi4YBqBv+P9n0cDRbSz9/964M7bkmHGBwDiBLTahcDfcf4iCmga//eRvS7TjJ0UU0bTCPwd9//ioDH+p2tF23r8b5qJqSXr96YR+Peg/6dstib781Hzf9NMlOSNpDr/B3+n4z+1KJRq6387Y/1vnx5YSyoDBun2dSPwd33+x9bxt2M5x2f7A2k5EYhonLe1rP9XzGjdZdinGYF/L/f/PFvkd1DFNRZ5wf/CSrnbppP705bt0pMbDPg7yF9bvDnBbfOoceuDf+/9f2GJ+FvFFoO67f7g/1seYMsf6zgpASjd8nMvASj4D0jgD/7gD/7gD/7gD/794o/8j5dIANoX/j4SgF4iAWh/+CMB6CUSgPaIPxKAXiABaH/y/yEB6CUSgPaIPxKAnpv/s9f8iXzoDNFvsL/5X//8uYPO1J8/feYPdSHwB3/wB3/wB//u+JM/AJQvlwvoqlouV/nmyw3+m3y1hK6rFcHvBn8yAOT5Crqy8vxq7r+F/9c38QDQlbXZfH+5wZ81AOjauh7+Nv60BUBX1vXoH8EfummBP/hD4A+BPwT+EPhD4A+BPwT+EPhD4A+BP3ST/KEh6/8BfJJPiQLXST0AAAAASUVORK5CYII=" alt="docker-image-vs-container"></p> <p><strong>docker image的获取</strong></p> <ul><li>自己制作</li> <li>从registry拉取（比如docker hub）</li></ul> <p><strong>配置国内镜像仓库加速拉取，跟maven配置镜像源一个道理</strong></p> <ul><li><p>为docker配置国内镜像地址，用于在pull镜像下载加速</p> <ol><li>创建配置文件daemon.json</li></ol> <p>在目录/etc/docker/daemon.json下，如果没，则创建该文件</p> <ol start="2"><li>按如下格式化添加镜像地址</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;registry-mirrors&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;https://registry.docker-cn.com&quot;</span>,
    <span class="token string">&quot;http://hub-mirror.c.163.com&quot;</span>,
    <span class="token string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">#docker中国镜像地址：    &quot;https://registry.docker-cn.com&quot;,</span>
<span class="token comment">#网络docker镜像地址  &quot;http://hub-mirror.c.163.com&quot;,</span>
<span class="token comment">#ustc大学镜像地址 &quot;https://docker.mirrors.ustc.edu.cn&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="3"><li>添加完重启docker，并使用docker info 命令查看</li></ol> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart <span class="token function">docker</span>
<span class="token function">sudo</span> <span class="token function">docker</span> info
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>docker信息:</p></li></ul> <p><img src="./assets/img/image-20230613203418772.9e10e822.png" alt="image-20230613203418772"></p> <h3 id="容器的基本操作"><a href="#容器的基本操作" class="header-anchor">#</a> 容器的基本操作</h3> <p><img src="./assets/img/image-20230704213534149.55eeae2d.png" alt="image-20230704213534149"></p> <p><img src="./assets/img/image-20230613212427849.144f4240.png" alt="image-20230613212427849"></p> <p><img src="./assets/img/image-20230613212507558.4ea5cb0a.png" alt="image-20230613212507558"></p> <h3 id="docker-container-命令小技巧"><a href="#docker-container-命令小技巧" class="header-anchor">#</a> docker container 命令小技巧</h3> <ul><li><h2 id="批量停止"><a href="#批量停止" class="header-anchor">#</a> 批量停止</h2></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">docker</span> container <span class="token function">ps</span>
CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES
cd3a825fedeb   nginx     <span class="token string">&quot;/docker-entrypoint.…&quot;</span>   <span class="token number">7</span> seconds ago    Up <span class="token number">6</span> seconds    <span class="token number">80</span>/tcp    mystifying_leakey
269494fe89fa   nginx     <span class="token string">&quot;/docker-entrypoint.…&quot;</span>   <span class="token number">9</span> seconds ago    Up <span class="token number">8</span> seconds    <span class="token number">80</span>/tcp    funny_gauss
34b68af9deef   nginx     <span class="token string">&quot;/docker-entrypoint.…&quot;</span>   <span class="token number">12</span> seconds ago   Up <span class="token number">10</span> seconds   <span class="token number">80</span>/tcp    interesting_mahavira
7513949674fc   nginx     <span class="token string">&quot;/docker-entrypoint.…&quot;</span>   <span class="token number">13</span> seconds ago   Up <span class="token number">12</span> seconds   <span class="token number">80</span>/tcp    kind_nobel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>方法1</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">docker</span> container stop cd3 <span class="token number">269</span> 34b <span class="token number">751</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>方法2</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">docker</span> container stop <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> container <span class="token function">ps</span> <span class="token parameter variable">-aq</span><span class="token variable">)</span></span>
cd3a825fedeb
269494fe89fa
34b68af9deef
7513949674fc
$ <span class="token function">docker</span> container <span class="token function">ps</span> <span class="token parameter variable">-a</span>
CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS                     PORTS     NAMES
cd3a825fedeb   nginx     <span class="token string">&quot;/docker-entrypoint.…&quot;</span>   <span class="token number">30</span> seconds ago   Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token number">2</span> seconds ago             mystifying_leakey
269494fe89fa   nginx     <span class="token string">&quot;/docker-entrypoint.…&quot;</span>   <span class="token number">32</span> seconds ago   Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token number">2</span> seconds ago             funny_gauss
34b68af9deef   nginx     <span class="token string">&quot;/docker-entrypoint.…&quot;</span>   <span class="token number">35</span> seconds ago   Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token number">2</span> seconds ago             interesting_mahavira
7513949674fc   nginx     <span class="token string">&quot;/docker-entrypoint.…&quot;</span>   <span class="token number">36</span> seconds ago   Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token number">2</span> seconds ago             kind_nobel
$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li><h2 id="批量删除"><a href="#批量删除" class="header-anchor">#</a> 批量删除</h2></li></ul> <p>和批量停止类似，可以使用 <code>docker container rm $(docker container ps -aq)</code></p> <blockquote><p><code>docker system prune -a -f</code> 可以快速对系统进行清理，删除停止的容器，不用的image，等等</p></blockquote> <h3 id="container-mode-容器运行的各种模式"><a href="#container-mode-容器运行的各种模式" class="header-anchor">#</a> Container Mode 容器运行的各种模式</h3> <h4 id="attach-模式"><a href="#attach-模式" class="header-anchor">#</a> attach 模式</h4> <p>范例指令: docker container run -p 80:80 nginx</p> <ul><li>透过这种方式创建容器的话，容器在前台执行</li> <li>容器的输入输出结果会反映到本地端，本地端的输入输出也会反映到容器，例如能在终端机看到网页浏览器的 log，ctrl + c 会让容器停止执行</li> <li>一般情况不推荐使用</li></ul> <h4 id="detach-模式-一般生产中使用"><a href="#detach-模式-一般生产中使用" class="header-anchor">#</a> detach 模式(一般生产中使用)</h4> <p>范例指令:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> container run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><p>容器会在后台执行</p></li> <li><p>想进入查看log 可通过</p></li> <li><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#这种方式进入 ctl+c退出，容器也会stop</span>
<span class="token function">docker</span> container attach <span class="token function">id</span>
<span class="token comment">#故查看日志，推荐docker logs</span>
<span class="token function">docker</span> container logs <span class="token function">id</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ul> <p><img src="./assets/img/image-20230613221008147.7059a259.png" alt="image-20230613221008147"></p> <p><img src="./assets/img/image-20230613221825728.138cac40.png" alt="image-20230613221825728"></p> <h3 id="连接容器的-shell"><a href="#连接容器的-shell" class="header-anchor">#</a> 连接容器的 shell</h3> <p><strong>创建一个容器并进入交互式模式</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> container run <span class="token parameter variable">-it</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>~ <span class="token function">docker</span> container run <span class="token parameter variable">-it</span> busybox <span class="token function">sh</span>
/ <span class="token comment">#</span>
/ <span class="token comment">#</span>
/ <span class="token comment"># ls</span>
bin   dev   etc   home  proc  root  sys   tmp   usr   var
/ <span class="token comment"># ps</span>
PID   <span class="token environment constant">USER</span>     TIME  COMMAND
    <span class="token number">1</span> root      <span class="token number">0</span>:00 <span class="token function">sh</span>
    <span class="token number">8</span> root      <span class="token number">0</span>:00 <span class="token function">ps</span>
/ <span class="token comment"># exit</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>在一个已经运行的容器里执行一个额外的command</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> container <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>➜  ~ docker container run -d nginx
33d2ee50cfc46b5ee0b290f6ad75d724551be50217f691e68d15722328f11ef6
➜  ~
➜  ~ docker container exec -it 33d sh
#
#
# ls
bin  boot  dev  docker-entrypoint.d  docker-entrypoint.sh  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
#
# exit
➜  ~
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="容器和虚拟机-container-vs-vm"><a href="#容器和虚拟机-container-vs-vm" class="header-anchor">#</a> 容器和虚拟机 Container vs VM</h3> <p><img src="./assets/img/containers-vs-virtual-machines.959f9fcc.jpg" alt="docker-vs-vm"></p> <ul><li><p>容器不是Mini虚拟机</p></li> <li><p><strong>容器其实是进程Containers are just processes</strong></p></li> <li><p>容器中的进程被限制了对CPU内存等资源的访问</p></li> <li><p>当进程停止后，容器就退出了</p></li></ul> <p><img src="./assets/img/image-20230613232708883.b368bffc.png" alt="image-20230613232708883"></p> <h3 id="docker-container-run-背后发生了什么"><a href="#docker-container-run-背后发生了什么" class="header-anchor">#</a> docker container run 背后发生了什么？</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker container run -d --publish 80:80 --name webhost nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><ol><li>在本地查找是否有nginx这个image镜像，但是没有发现</li></ol></li> <li><ol><li>去远程的image registry查找nginx镜像（默认的registry是Docker Hub)</li></ol></li> <li><ol><li>下载最新版本的nginx镜像 （nginx:latest 默认)</li></ol></li> <li><ol><li>基于nginx镜像来创建一个新的容器，并且准备运行</li></ol></li> <li><ol><li>docker engine分配给这个容器一个虚拟IP地址</li></ol></li> <li><ol><li>在宿主机上打开80端口并把容器的80端口转发到宿主机上</li></ol></li> <li><ol><li>启动容器，运行指定的命令（这里是一个shell脚本去启动nginx）</li></ol></li></ul> <h2 id="_3-镜像的获取的三种方式"><a href="#_3-镜像的获取的三种方式" class="header-anchor">#</a> 3. 镜像的获取的三种方式</h2> <ul><li>pull from <code>registry</code> (online) 从registry拉取
<ul><li>public（公有）</li> <li>private（私有）</li></ul></li> <li>build from <code>Dockerfile</code> (online) 从Dockerfile构建</li> <li>load from <code>file</code> (offline) 文件导入 （离线）</li></ul> <p><img src="./assets/img/docker-stages.45f8e057.png" alt="docker-image"></p> <p><strong>镜像的命令查询</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">docker</span> image

Usage:  <span class="token function">docker</span> image COMMAND

Manage images

Commands:
build       Build an image from a Dockerfile
<span class="token function">history</span>     Show the <span class="token function">history</span> of an image
<span class="token function">import</span>      Import the contents from a tarball to create a filesystem image
inspect     Display detailed information on one or <span class="token function">more</span> images
load        Load an image from a <span class="token function">tar</span> archive or STDIN
<span class="token function">ls</span>          List images
prune       Remove unused images
pull        Pull an image or a repository from a registry
push        Push an image or a repository to a registry
<span class="token function">rm</span>          Remove one or <span class="token function">more</span> images
save        Save one or <span class="token function">more</span> images to a <span class="token function">tar</span> archive <span class="token punctuation">(</span>streamed to STDOUT by default<span class="token punctuation">)</span>
tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE

Run <span class="token string">'docker image COMMAND --help'</span> <span class="token keyword">for</span> <span class="token function">more</span> information on a command.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="从registry拉取pull"><a href="#从registry拉取pull" class="header-anchor">#</a> 从registry拉取pull</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> pull nginx <span class="token comment">#默认从Docker Hub拉取，如果不指定版本，会拉取最新版</span>
<span class="token function">docker</span> pull nginx:1.20.0 <span class="token comment"># 指定版本</span>
<span class="token function">docker</span> pull quay.io/bitnami/nginx <span class="token comment">#从指定仓库Quay上拉取镜像</span>
<span class="token function">docker</span> image <span class="token function">ls</span> <span class="token comment">#镜像的查看</span>
<span class="token function">docker</span> image <span class="token function">rm</span> <span class="token function">id</span> <span class="token comment">#镜像的删除</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="从离线导入load"><a href="#从离线导入load" class="header-anchor">#</a> 从离线导入load</h3> <p>模拟生成一个离线的镜像</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> image save nginx:1.20.0 <span class="token parameter variable">-o</span> nginx.myself
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230614002229573.73a7cca8.png" alt="image-20230614002229573"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> image load <span class="token parameter variable">-i</span> nginx.myself
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230614002610129.27df73a1.png" alt="image-20230614002610129"></p> <h3 id="从dockerfile-build"><a href="#从dockerfile-build" class="header-anchor">#</a> 从dockerfile build</h3> <h4 id="dockerfile-介绍"><a href="#dockerfile-介绍" class="header-anchor">#</a> Dockerfile 介绍</h4> <p>Docker can build images automatically by reading the instructions from a <code>Dockerfile</code>. A Dockerfile is a <code>text</code> document that contains all the commands a user could call on the command line to assemble an image. Using docker build users can create an automated build that executes several command-line instructions in succession.</p> <p>https://docs.docker.com/engine/reference/builder/</p> <ul><li><strong>Dockerfile是用于构建docker镜像的文件</strong></li> <li>Dockerfile里包含了构建镜像所需的“指令”</li> <li>Dockerfile有其特定的语法规则</li></ul> <h4 id="dockerfile的构建"><a href="#dockerfile的构建" class="header-anchor">#</a> Dockerfile的构建</h4> <p><strong>示例：使用centos 脚本打印&quot;hello docker !&quot;</strong></p> <p>hello.sh</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;hello docker !&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Dockerfile</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> centos:7</span>
<span class="token instruction"><span class="token keyword">ADD</span> hello.sh /</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;sh&quot;</span>, <span class="token string">&quot;/hello.sh&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="./assets/img/image-20230614065355333.999ff1ad.png" alt="image-20230614065355333"></p> <p><strong>示例：部署一个Hello Docker java项目</strong></p> <p>新建HelloWorld,并将项目打包</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloDocker</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Docker !&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>新建一个Dockerfile文件</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> openjdk:8-jdk-alpine</span>
<span class="token instruction"><span class="token keyword">ADD</span> *.jar app.jar</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;java&quot;</span>,<span class="token string">&quot;-Djava.security.egd=file:/dev/./urandom&quot;</span>,<span class="token string">&quot;-jar&quot;</span>,<span class="token string">&quot;/app.jar&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>将文件上传到linux服务器上</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAcMAAABXCAYAAAB4Bi4/AAAUE0lEQVR4nO3dzW/bZp4H8C8XA+wp6ySAIB2kJAZmD63pKAf60EnbQWChblN5bj3MSHOJjB6KGUiugoX9F1gopEjCFHso7FxW7hx6q9RMM5CQnc60e5CAjWomOWwBJxEXEGFsHE9Oe1nugaRESSQlyy9SzO8HKBCL4vNGlT8+Dx/yEebm5jR4iKZJWCmE0UxtoiEIky4OkSNNSqAQA7b5WyU6cT+bdAGIqEsLRrGeXkTACH47pSQDIdEpELzWMyQiIur3D5MuABER0aQxGBIRkecxGBIRkecxGBIRkecxGBIRkecxGBIRkecxGBIRkefZPnSvaUEsr6cRCXQf/N1qTO7B32B0DbcjAQBAu5pFpqJMrCxuzAem97ZTE22vUenl9aN6hDecmL8Vf/V466xJCRTj8/q/21XkNspQjvjwuZTIIz4/Hb9pIpouLj1DFdVsEqnUyZ/YNS2I6FoeCWnw+f9gdA1pUUY2mUQymYUspm2/dxplmSZmOQuFwtSXdRxCYwupVArJbBVq3za97glImoZgdA35hDRSmo2tVSSTWVTbZ6+9iOhopnqYVNMkLC3uYdvoFQiCgnKpBl94YdJFsyUoFWRWV0/h4kHCSiEOlHIePbEH4Pd3/1LV9uSKQkRnwqHfTSol8girNfgW9fcnatpO50XCdu9VNAOD0zbrECjiRRTigKa1Uctt4OG1CHy1EuoLK50hs51SCXu+AIKaBkUQeoa+RimL+aJuteZDpG/o1a0sFaU3r/76OQ3BueXn1i7ubd3A1mpDH6I85PHrz0/Tdhy39Q8l2rV1vS99sw077T1W/ZwvJqzHaL5YND69jbx4tKHU/nJO83A8ER2/sV7ULYpALpXqBKPwAlBvR7GeFiHnUsgo5klwHdH2BspYdtxWqWSQLNvddxIgLQHy/QBW0j5Us1kgHgfagNkpkBJ5xLCNVKrRLVwnEDqUpQUAIhb9+n76ygBLkMqbaLiUBdCH2cyc9DRXINX1k3djaxV18/7ZYIvZ5lfHAlbSflRTKT2AaxJWCka7KIJjWzcaAxmMRNMkrBj3NDOdQOW31MfhGBkXAnZtDUvHVErkEfPVkE1uQDHrc8z1UyoZJB9GsR4HShtlBFYKCDeNY3WEe4oLS912ISLvGSsYytXuFbgeIASEoiL8chUZ4yQnKBVU5UWEA0Ao4LwNLhffAd8e2ghAVGXcbwWw5N9Ds6UHw//TJIRFFbVcHWawMoWuueTXAgAZ25t1/eTZVqHahC871kkdQG+vyp1DfqEAfBARLxYR76TZ7rlHZtfWY1sIQ1RrsGky1zbTWs5tbZqPFyHulLCaaXSD0knVL+CHf6+JFkK45lNxHKOkbVVFPF5EPlzC6taYVxtE9Nqa6iWc/FDx0DzxhQLwqSraAMITKIumSViJ+VDNJlFRentVYwv44VdryA4M771+vZOdUgmIxZCQ6t0e9QnUL7qWN2Y5z6M7SlqEeMRhTaWSQapiXPAU4tB2GBSJvOTYJtC0HspQxQiiQX3cTAtGERH1q3a3bQAgCArae4AvEHLOIODX+1MLYYh7bfy3oEJV/VhcGpxMMyw/N45lCQXgs/y5sLQ4Yn/SRb0J2b8ImyqcjLYK1S/iWsh4JCLerYN7m7Ud27qrjs1cDb6YZXbrCdSvkllFttpGu5pFMlnCjraDUjJ5bPf3hMaWPoNVDEPSvDg5icibjq1nKCgVbGz7UbxdRAS9E08EOG8z1e/XEEmnUYgIne0q/AjUm5BjMRR8MmQsIh3Th+sEQUB5Iwesp1Eo6INwnQkYLmUZhV1ZKsawYdxIs12tQhaN+219z2Wak292Skls9s8wsbaZ0MBmLoD1dAGFuDExZYRn6vR7bzHMC4P5uc1kFZQKSjURt4067JRKkGPhzjbH4ycojm1d70t/Y9uPYryItUAWmcp49Rsm4Pdjr9kCQtc6owXDuB+jUO82cFFdIq+xXdxXP3HEgdLoAeQkSIl8d3IEeZIW7E6WOepD90RETqb6OcN6U4YYWUbQGK7SpMSZfMCciIgmy2WY1I9IZzhtMq+uEhpbyAXWcLsYAWAOzeF1nF9Ch9T/OjYiopNkO0xKRETkJcL/BH/OYEhEE/fuzD9OugjkYVN9z5CIiOg0MBgSEZHn9Uyg4TAFEZ2m7w7+d9JFIALAniERERGDIREREYMhERF53sSDoaZdxh9i72D5GF+KfBJp0utFu3AV5div8YcrZ+c3oGlBRNfyJ/IWJjPtQqGAQqGAtWiwuy0YxVp+MF8p0f3+WX8zlN4GiSO9vP0kj9/hyyIhccT6nDVTvYTTWaFpF5Befh+3zgt48Ldt/P7paK/Q0S5cReXmHGYFAdBe4u69b3Bnf/i+PfsBQOt7iH95Bu3KO3j0dgi7O3/CcnO/U65Z+ctOmfq/o5f/Mj6P/wI3LO8GtdbDNT/xAB+Vm3giCAP59e9npvlG+Ca+mj8/UC9rmaad3dqX26nN6X3598ISFlFDNjn6O2DdF7SeHuZL2nsX7CbqxWB4wvRAMofde9/i7vX3MXuY/W7O4en3X2K5EzjexX+VvkPZbUWLC1dRuRnEg3tfYtkucL58CYRCeOPhCzy22f9Xl8/h7t9k3BD17zzp5KVg/d/0vPU8PsSnB98gh7B7foeqn57mneY9iE2z7S7hz0PqbEfY/xHL2z9iku/us67QEYyuIV1YAaY0IIYCPmCvaRsIBaWCzGoFfA8inWW2wXD5l7/GRmiwF2CenHblc7hlXLlbr9ad9rNNV2thvfQdvjY3zr4L+e3QQJpOvYeRjJGmUx3eCN/EZ1DwVJzDjYNHuPtqDrdCw3t6gvAMv99+pveKRiu1UfZLuHHwCB/tAhCANy8FMSucx3uzQPnpYRLqp+CLVhCfzDbxu93eLZp2Ge+dU/Cvuy1AfAsfXGziiV1H7EULDw7mMDsD4GC8Urx5bQ43lB8gGm0n7P+IL5Q5fHzpIu7sj9f7s/bATaMcW3Pbey8f4Ypo9sT13+dhg7CTVrmEmphGZDmERkUxFodeRMBIv//9v1Iij/i80fO2WS4LAILRNdyOBDr7uqUpJfIIqzX4FvXtZprt5XXcjgSMFOMoFOI9vVhrOQ7zjuJh9RtHf28bANrGos5O+ZltpFdPX7Zr1CXd+tPUtJ2R63dax2/YhVV/mu3+RbAXVlAw2nRgm8fYBsPyX/6IsvFvs0eyvGsGriBunf8BYumZse0tfPpcH75z2q8sCPqJCPp+HYIAaHqaG5d/gFj6qz60dl3E8sPv8DWu4PObM/ii9KXeI9Eu4/O40XsY2guxpGkpZ+6Fe5pOdfgJwKw4gy9KPwDxX+BG61t89PItfDZzEcDxD929OXMOePUcT8y2O/cId1szuDEkP2H/R/yLHMRXH8Zw66XcGaK0+um5go+vXgF2/9678+wlXGnJeCLsAy3gM6fANCvi1swB7h6MkN95EV/9VuzZ/QGAn5+fwe7L3vx/enmA2fP/5Fo/N4KwjzuVP+IOuoHR2hN3+30CwI0Q8FHpy06bH/3Cw1o2fdFoEeYJSoScSyGjmCfBdUTb+glaSuQRwzZSqYY1AeP/FZ2UyCPmqyGb3IAiCPoal2k/qqkUGubfhW6aACCKQC6VgmIEufAC0KhkkKroJ+a0v4rVrUY3P4w3FDpKWQ5L0ySsxHyoZpOoKAI0KYFCREWp3IKGBef8Khkky3bDpEOCiCZhJb2Ive0UMp1AZaxfOk3HrwFXC0vdOgwSEQtvI5Xa0tsztgSpPJ0jF6fBNhia9426H7QsWxWs//tT/eBaewj7zvtp2mW8FzzA3XtPYf8jtKR5cIBdzOgfX5zBFQSx8dsYNjppvoTZoenPr/eekkM5cbg0e+quPMfXAN7DAR48fwFccm6z47q/1bmIqDzD8i/ncGOE/J4Yw4xvhG/qgcgIUp1h0RdNfIEPkb74H93yaxeQFoN4Kn8HQMDj5wpw3TqcammzvvuXrvlZAqRdgDpN7r9r4IHcDeR64DyZk0Lomgi/XEXGOMkJxsLR4QCgtSSERX0Ba6cT9ny8CHGnhNVMoxO0EArABxHxYhFx43ua1oZq2U+udu8HNrZW0TipYc8RyjIt+fX3Nju9o4UwRLUGu8PwOh2/tqoiHi8iHy51L3S6KWJ7s66Xoa1Cneo7vydvIBhq2mV8fv0c7n6zjTv75r2cmaEJjbufq5kZzB48sundGD/Cp3+FeNgrd5c0j1KHscri4vHBK2D+Oj7e+RNEY7LLP58Dnj57AUAYKb8nzXuYe6hPfvlktonfWbZ9/ewVHl0N4a75wcUQbswAs2/HIL9tfKa9xAcXm3j8ArDeMzRqfKj8+tn1Au16i8flRH6fh8o/CP22XAsIDP++m51SCYjFkJDq3Z5OwA+/WkN2YBHkCVzln0BZBKGBphxD3FhWTh/q3NTTP0J+QmMLqSG9q+N2msdPMXr+mpRAsRCHtmMXFAmwe7Ti4gyuWP781dU55yv5WRG3ZhT8eXfYfn/H7sEMbl29MpCEq93neDAzh0+O2pWwltMtzcPU/RhpV96BHP9N72MAu8/xQHup90CB3jocxsUZXMEBdvvv7e3KuHsu2OlpvnkpiFnlB4ilLzv/fSQDNy5dPJ78+jx+rmA3OIdPLxgLN1+4io+DB936DmHbZkPL1XVax9a0sJLGol9Gsw60HspQxQiiQaPuwSgiogq1DQBtqKofi0sLLqnVsZmrwRezPNJQb0L2L8J1t9NyAmXRglFEfDVkk0mkUimsrma6Q65D8jOHqH2BkP0X7LRVqH4R10LGbNT4YqffNI3HT5MSro+4CI0tJLNVqGKYj1M4GOgZmhMZNj6M4RaA3R0ZD4LWK+jB4bKyILjuJwj7yJW/BZbfhxy/rifTP4HGhiA8w+/uzaBy8zeQ3zZ++A73wQY5lBMuaQ6t++ENPJZg9LyskzfenDnnWvdblkcrhk3oGBgKhJ7XnX0BsFRFEPaRk1/h1tvn8RTAB6EZPJB7h7EfH7zC7HURy//5DE5GzW+gfvs/Ivr9DB4ZbX2YR0cA+zZzM/x3ffyEQKS7MHW7ilxKv+oXlAo2tv0o9vRy9HtDgqCgvJED1tMoFPQBM7sJGJ004kWsBbLIVBrYzAWwni6gEBe6eQ70NEZnPpIQCRj7GxNQdkpJbNZDjtu2GsdfFkGpoLqX77SnXj5zEsnw/Or3a4ik0yhEhJEm0AhKBaWaiNudBc5LkGPhzrZpO36hgG/gs4HjB/34NPruX5KuZz3DYS/qPspUd6LTZPcMJU0f64u63c4/+gQP9MyglBJ5RNScp2dA0vGZ+BtoiE7EuMPK9FrQNAlhEdhrt4Z/mWgEfOiezgy750c5gnFG1O+jFkn3zLZsV7MOjwwQHd6hhkmJiI7TqMOkRCeNPUPyhEKh4Lo9lUqdUkmIaBoxGJJnOAW8YYGSiM4+TqAhIiLPYzAkIiLPYzAkIiLPYzAkIiLPYzAkIiLPs1/Cqe+ddsexMOdRWBfonOYFKM2FNPe2UxNtr1GZa7RVj7D6uvlb6V0r7hjKZlla56jvtSQiGsalZ6iimtXfEH/SJ3ZNCyK6lrd943owuoa0KCObTCKZzEIW045vZj/pskwTs5xub6p/nQmNLaRSKf1N+33b9LonIGkagtE15BPSRMpIRGfHVA+TapqEpcU9bBu9AkFQUC7V4AtPwzo1gwSlgszq6ilcPEhYKcSBUg7V9tkLhMMF4LesQ6rqa+cQEY3t0A/dS4k8wmoNvsVFBATBsoyK0BkmDAiDw6tO26xDoOYyMOaSKA+vReCrlVBfWOkMme2UStjzBRDUNCiCACmRR3zeyGOEsuiBJAy15kOkb+jVrSwVpTev/vpZt/XU2yU/t3Zxb+sGtlYb+hDlIY9ff36atuO4rX943K6trcvSAN0h7U57j1U/54sJ6zGaLxaNT28jL3IolYjGN9YbaEQRyKVSnWAUXgDq7SjW0yLkXAoZxTwJriPa3kAZy47bKpUMkmW7+04CpCVAvh/AStqHajYLxONAG51FNqVEHjFsI2VdqroTCB3K0gIAEYt+fT99aZglSOVNNFzKAgCNrVWYOelprkCq6yfvxtYq6ub9s8EWs82vjgWspP2oplJ6ANckrBSMdjHWWrNr68aYC1VrmoQV455mphOo/Jb6OBwj40LArq2t66JJiTxivhqyyQ0oZn2OuX5KJYPkwyjW40Bpo4zASgHhpnGsGAiJaEw9L+omIpoUvqibJmmq7xkSERGdBgZDIiLyvJ/ZDU3oz47FgVL33o5JSuS792j697M+G2aZeDJsG9A7ecPcjvgK2htNhAsxiKoMGSJEv9rZt/95yJ4JNA75mRNamj0TbXqftbMrS/8Emna1ir1FP5qpTdQR6imHaaeUxGZ9wTW/gQktlmfqnNpar0MM88JgfsNmslonoOyUSkDMUja34+fQ1mbdzXusZhrmJKFx6tdT12D3/qA5Ocbcb7O9PLDNSaFQcF21gks4EXmbMDc3N3DP0C0YnqZRTpZ0ttkFw3EwGBKRm6keJq03ZYiRZQQ1PV5rUuJMPmBOREST5fJohR+R20VEMLnXsQmNLeQCa7hdjAAwh+ZgPulAZ1j/69iIiE6SbTAUBAWVzCoq3U9OrUD9lEoGqYrlAz5L5glCYwvWRxp53InoJI310D3R66hQKEy6CEQ0pWwn0BAREXnJVE+gISIiOg0MhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5HkMhkRE5Hn/D5PBFQVCYmafAAAAAElFTkSuQmCC" alt="image-20230614043947938"></p> <p>构建镜像</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> image build <span class="token parameter variable">-t</span> docker-demo-java <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230614044514049.60618fb3.png" alt="image-20230614044514049"></p> <p>重新打标签</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> image tag docker-demo-java docker-demo-java:2.0
<span class="token comment">#实际应按照远程仓库的规则打标签</span>
<span class="token function">docker</span> tag <span class="token punctuation">[</span>ImageId<span class="token punctuation">]</span> registry.cn-shenzhen.aliyuncs.com/gordonchan/quickstart:<span class="token punctuation">[</span>镜像版本号<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="./assets/img/image-20230614050147206.aac63548.png" alt="image-20230614050147206"></p> <h4 id="推送镜像到远程仓库进行共享"><a href="#推送镜像到远程仓库进行共享" class="header-anchor">#</a> 推送镜像到远程仓库进行共享</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> login <span class="token parameter variable">--username</span><span class="token operator">=</span>XXXXXXX registry.cn-shenzhen.aliyuncs.com
<span class="token function">docker</span> push registry.cn-shenzhen.aliyuncs.com/gordonchan/quickstart:<span class="token punctuation">[</span>镜像版本号<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="./assets/img/image-20230614054131643.f920c3bf.png" alt="image-20230614054131643"></p> <p><img src="./assets/img/image-20230614053824763.5a56a19b.png" alt="image-20230614053824763"></p> <p>拉取镜像并构建容器运行</p> <p><img src="./assets/img/image-20230614055202954.9e6704bb.png" alt="image-20230614055202954"></p> <p><img src="./assets/img/image-20230614055347798.3cfc4d77.png" alt="image-20230614055347798"></p> <p><strong>示例：执行一个Python程序</strong></p> <p>容器及进程，所以镜像就是一个运行这个进程所需要的环境。</p> <p>假如我们要在centos:7上运行下面这个hello.py的Python程序</p> <p>hello.py的文件内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>print(&quot;hello docker&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>第一步，<strong>准备Python环境</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yum install -y python3.9 python3-pip python3.9-dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>第二步，<strong>运行hello.py</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ python3 hello.py
hello docker
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><hr> <p><strong>把上面的程序构建成一个Dockerfile</strong></p> <p>Dockerfile</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">ARG</span> image=centos:7</span>
<span class="token instruction"><span class="token keyword">FROM</span> <span class="token variable">${image}</span></span>
<span class="token instruction"><span class="token keyword">RUN</span>  yum install -y python3.9 python3-pip python3.9-dev</span>
<span class="token instruction"><span class="token keyword">ADD</span> hello.py /</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;python3&quot;</span>, <span class="token string">&quot;/hello.py&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_4-dockerfile命令详解"><a href="#_4-dockerfile命令详解" class="header-anchor">#</a> 4.Dockerfile命令详解</h2> <h3 id="基础镜像的选择-from"><a href="#基础镜像的选择-from" class="header-anchor">#</a> 基础镜像的选择 (FROM)</h3> <p><strong>基本原则</strong></p> <ul><li>官方镜像优于非官方的镜像，如果没有官方镜像，则尽量选择Dockerfile开源的</li> <li>固定版本tag而不是每次都使用latest</li> <li>尽量选择体积小的镜像</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">docker</span> image <span class="token function">ls</span>
REPOSITORY      TAG             IMAGE ID       CREATED          SIZE
bitnami/nginx   <span class="token number">1.18</span>.0          dfe237636dde   <span class="token number">28</span> minutes ago   <span class="token number">89</span>.3MB
nginx           <span class="token number">1.21</span>.0-alpine   a6eb2a334a9f   <span class="token number">2</span> days ago       <span class="token number">22</span>.6MB
nginx           <span class="token number">1.21</span>.0          d1a364dc548d   <span class="token number">2</span> days ago       133MB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>Build一个Nginx镜像</strong></p> <p>假如我们有一个 <code>index.html</code> 文件</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Hello Docker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>准备一个Dockerfile</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> nginx:1.21.0-alpine</span>

<span class="token instruction"><span class="token keyword">ADD</span> ../其他/index.html /usr/share/nginx/html/index.html</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="在image里run-执行指令"><a href="#在image里run-执行指令" class="header-anchor">#</a> 在image里RUN 执行指令</h3> <p><code>RUN</code> 主要用于在build Image里执行指令，比如安装软件，下载文件等。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">apt-get</span> update
$ <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">wget</span>
$ <span class="token function">wget</span> https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz
$ <span class="token function">tar</span> zxf ipinfo_2.0.1_linux_amd64.tar.gz
$ <span class="token function">mv</span> ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo
$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> ipinfo_2.0.1_linux_amd64.tar.gz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>Dockerfile</strong></p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> ubuntu:20.04</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt-get update</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt-get install -y wget</span>
<span class="token instruction"><span class="token keyword">RUN</span> wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz</span>
<span class="token instruction"><span class="token keyword">RUN</span> tar zxf ipinfo_2.0.1_linux_amd64.tar.gz</span>
<span class="token instruction"><span class="token keyword">RUN</span> mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo</span>
<span class="token instruction"><span class="token keyword">RUN</span> rm -rf ipinfo_2.0.1_linux_amd64.tar.gz</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>镜像的大小和分层</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">docker</span> image <span class="token function">ls</span>
REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
ipinfo       latest    97bb429363fb   <span class="token number">4</span> minutes ago   138MB
ubuntu       <span class="token number">21.04</span>     478aa0080b60   <span class="token number">4</span> days ago      <span class="token number">74</span>.1MB
$ <span class="token function">docker</span> image <span class="token function">history</span> 97b
IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT
97bb429363fb   <span class="token number">4</span> minutes ago   RUN /bin/sh <span class="token parameter variable">-c</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> ipinfo_2.0.1_linux_amd…   0B        buildkit.dockerfile.v0
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> minutes ago   RUN /bin/sh <span class="token parameter variable">-c</span> <span class="token function">mv</span> ipinfo_2.0.1_linux_amd64 /…   <span class="token number">9</span>.36MB    buildkit.dockerfile.v0
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> minutes ago   RUN /bin/sh <span class="token parameter variable">-c</span> <span class="token function">tar</span> zxf ipinfo_2.0.1_linux_am…   <span class="token number">9</span>.36MB    buildkit.dockerfile.v0
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> minutes ago   RUN /bin/sh <span class="token parameter variable">-c</span> <span class="token function">wget</span> https://github.com/ipinf…   <span class="token number">4</span>.85MB    buildkit.dockerfile.v0
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> minutes ago   RUN /bin/sh <span class="token parameter variable">-c</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> <span class="token function">wget</span> <span class="token comment"># bui…   7.58MB    buildkit.dockerfile.v0</span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> minutes ago   RUN /bin/sh <span class="token parameter variable">-c</span> <span class="token function">apt-get</span> update <span class="token comment"># buildkit        33MB      buildkit.dockerfile.v0</span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> days ago      /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> days ago      /bin/sh <span class="token parameter variable">-c</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /run/systemd <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">'do…   7B
&lt;missing&gt;      4 days ago      /bin/sh -c [ -z &quot;$(apt-get indextargets)&quot; ]     0B
&lt;missing&gt;      4 days ago      /bin/sh -c set -xe   &amp;&amp; echo '</span><span class="token comment">#!/bin/sh' &gt; /…   811B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> days ago      /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop) ADD file:d6b6ba642344138dc…   74.1MB</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>每一行的RUN命令都会产生一层image layer, 导致镜像的臃肿。</p> <p><strong>改进版Dockerfile</strong></p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> ubuntu:20.04</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; <span class="token operator">\</span>
    apt-get install -y wget &amp;&amp; <span class="token operator">\</span>
    wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; <span class="token operator">\</span>
    tar zxf ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; <span class="token operator">\</span>
    mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo &amp;&amp; <span class="token operator">\</span>
    rm -rf ipinfo_2.0.1_linux_amd64.tar.gz</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">docker</span> image <span class="token function">ls</span>
REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
ipinfo-new   latest    fe551bc26b92   <span class="token number">5</span> seconds ago    124MB
ipinfo       latest    97bb429363fb   <span class="token number">16</span> minutes ago   138MB
ubuntu       <span class="token number">21.04</span>     478aa0080b60   <span class="token number">4</span> days ago       <span class="token number">74</span>.1MB
$ <span class="token function">docker</span> image <span class="token function">history</span> fe5
IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT
fe551bc26b92   <span class="token number">16</span> seconds ago   RUN /bin/sh <span class="token parameter variable">-c</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span>     apt-get…   <span class="token number">49</span>.9MB    buildkit.dockerfile.v0
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> days ago       /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  CMD [&quot;/bin/bash&quot;]            0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> days ago       /bin/sh <span class="token parameter variable">-c</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /run/systemd <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">echo</span> <span class="token string">'do…   7B
&lt;missing&gt;      4 days ago       /bin/sh -c [ -z &quot;$(apt-get indextargets)&quot; ]     0B
&lt;missing&gt;      4 days ago       /bin/sh -c set -xe   &amp;&amp; echo '</span><span class="token comment">#!/bin/sh' &gt; /…   811B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> days ago       /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop) ADD file:d6b6ba642344138dc…   74.1MB</span>
$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="文件复制-add-copy"><a href="#文件复制-add-copy" class="header-anchor">#</a> 文件复制 (ADD,COPY)</h3> <p>往镜像里复制文件有两种方式，<code>COPY</code> 和 <code>ADD</code> , 我们来看一下两者的不同。</p> <p><strong>复制普通文件</strong></p> <p><code>COPY</code> 和 <code>ADD</code> 都可以<strong>把local的一个文件复制到镜像里</strong>，如果目标目录不存在，则会自动创建</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> python:3.9.5-alpine3.13</span>
<span class="token instruction"><span class="token keyword">COPY</span> hello.py /app/hello.py</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>比如把本地的 hello.py 复制到 /app 目录下。 /app这个folder不存在，则会自动创建</p> <p><strong>复制压缩文件</strong></p> <p><code>ADD</code> 比 COPY高级一点的地方就是，如果复制的是一个gzip等压缩文件时，ADD会帮助我们自动去解压缩文件。</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> python:3.9.5-alpine3.13</span>
<span class="token instruction"><span class="token keyword">ADD</span> hello.tar.gz /app/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>如何选择</strong></p> <p>因此在 COPY 和 ADD 指令中选择的时候，可以遵循这样的原则，所有的文件复制均使用 COPY 指令，仅在需要自动解压缩的场合使用 ADD。</p> <h3 id="构建参数和环境变量-arg↑-vs-env"><a href="#构建参数和环境变量-arg↑-vs-env" class="header-anchor">#</a> 构建参数和环境变量 (ARG↑ vs ENV)</h3> <p><code>ARG</code> 和 <code>ENV</code> 是经常容易被混淆的两个Dockerfile的语法，都可以用来设置一个“变量”。 但实际上两者有很多的不同。</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> ubuntu:20.04</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; <span class="token operator">\</span>
    apt-get install -y wget &amp;&amp; <span class="token operator">\</span>
    wget https://github.com/ipinfo/cli/releases/download/ipinfo-2.0.1/ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; <span class="token operator">\</span>
    tar zxf ipinfo_2.0.1_linux_amd64.tar.gz &amp;&amp; <span class="token operator">\</span>
    mv ipinfo_2.0.1_linux_amd64 /usr/bin/ipinfo &amp;&amp; <span class="token operator">\</span>
    rm -rf ipinfo_2.0.1_linux_amd64.tar.gz</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>ENV</strong></p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> ubuntu:20.04</span>
<span class="token instruction"><span class="token keyword">ENV</span> VERSION=2.0.1</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; <span class="token operator">\</span>
    apt-get install -y wget &amp;&amp; <span class="token operator">\</span>
    wget https://github.com/ipinfo/cli/releases/download/ipinfo-<span class="token variable">${VERSION}</span>/ipinfo_<span class="token variable">${VERSION}</span>_linux_amd64.tar.gz &amp;&amp; <span class="token operator">\</span>
    tar zxf ipinfo_<span class="token variable">${VERSION}</span>_linux_amd64.tar.gz &amp;&amp; <span class="token operator">\</span>
    mv ipinfo_<span class="token variable">${VERSION}</span>_linux_amd64 /usr/bin/ipinfo &amp;&amp; <span class="token operator">\</span>
    rm -rf ipinfo_<span class="token variable">${VERSION}</span>_linux_amd64.tar.gz</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>ARG</strong></p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> ubuntu:20.04</span>
<span class="token instruction"><span class="token keyword">ARG</span> VERSION=2.0.1</span>
<span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; <span class="token operator">\</span>
    apt-get install -y wget &amp;&amp; <span class="token operator">\</span>
    wget https://github.com/ipinfo/cli/releases/download/ipinfo-<span class="token variable">${VERSION}</span>/ipinfo_<span class="token variable">${VERSION}</span>_linux_amd64.tar.gz &amp;&amp; <span class="token operator">\</span>
    tar zxf ipinfo_<span class="token variable">${VERSION}</span>_linux_amd64.tar.gz &amp;&amp; <span class="token operator">\</span>
    mv ipinfo_<span class="token variable">${VERSION}</span>_linux_amd64 /usr/bin/ipinfo &amp;&amp; <span class="token operator">\</span>
    rm -rf ipinfo_<span class="token variable">${VERSION}</span>_linux_amd64.tar.gz</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>区别</strong></p> <p><img src="./assets/img/docker_environment_build_args.a2d333ca.png" alt="docker-image"></p> <p>ARG 可以在镜像build的时候动态修改value, 通过 <code>--build-arg</code></p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code>$ docker image build -f .\Dockerfile-arg -t ipinfo-arg-2.0.0 --build-arg VERSION=2.0.0 .
$ docker image ls
REPOSITORY         TAG       IMAGE ID       CREATED          SIZE
ipinfo-arg-2.0.0   latest    0d9c964947e2   6 seconds ago    124MB
$ docker container run -it ipinfo-arg-2.0.0
root@b64285579756:/#
root@b64285579756:/# ipinfo version
2.0.0
root@b64285579756:/#
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>ENV 设置的变量可以在Image中保持，并在容器中的环境变量里</p> <h3 id="容器启动命令-cmd"><a href="#容器启动命令-cmd" class="header-anchor">#</a> 容器启动命令 CMD</h3> <p>CMD可以用来设置容器启动时默认会执行的命令。</p> <ul><li><strong>容器启动时默认执行的命令</strong></li> <li><strong>如果docker container run启动容器时指定了其它命令，则CMD命令会被忽略</strong></li> <li><strong>如果定义了多个CMD，只有最后一个会被执行。</strong></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM ubuntu:20.04
ENV VERSION=2.0.1
RUN apt-get update &amp;&amp; \
    apt-get install -y wget &amp;&amp; \
    wget https://github.com/ipinfo/cli/releases/download/ipinfo-${VERSION}/ipinfo_${VERSION}_linux_amd64.tar.gz &amp;&amp; \
    tar zxf ipinfo_${VERSION}_linux_amd64.tar.gz &amp;&amp; \
    mv ipinfo_${VERSION}_linux_amd64 /usr/bin/ipinfo &amp;&amp; \
    rm -rf ipinfo_${VERSION}_linux_amd64.tar.gz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker image build -t ipinfo .
$ docker container run -it ipinfo
root@8cea7e5e8da8:/#
root@8cea7e5e8da8:/#
root@8cea7e5e8da8:/#
root@8cea7e5e8da8:/# pwd
/
root@8cea7e5e8da8:/#
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>默认进入到shell是因为在ubuntu的基础镜像里有定义CMD</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$docker image history ipinfo
IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT
db75bff5e3ad   24 hours ago   RUN /bin/sh -c apt-get update &amp;&amp;     apt-get…   50MB      buildkit.dockerfile.v0
&lt;missing&gt;      24 hours ago   ENV VERSION=2.0.1                               0B        buildkit.dockerfile.v0
&lt;missing&gt;      7 days ago     /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B
&lt;missing&gt;      7 days ago     /bin/sh -c mkdir -p /run/systemd &amp;&amp; echo 'do…   7B
&lt;missing&gt;      7 days ago     /bin/sh -c [ -z &quot;$(apt-get indextargets)&quot; ]     0B
&lt;missing&gt;      7 days ago     /bin/sh -c set -xe   &amp;&amp; echo '#!/bin/sh' &gt; /…   811B
&lt;missing&gt;      7 days ago     /bin/sh -c #(nop) ADD file:d6b6ba642344138dc…   74.1MB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="容器启动命令-entrypoint"><a href="#容器启动命令-entrypoint" class="header-anchor">#</a> 容器启动命令 ENTRYPOINT</h3> <p>ENTRYPOINT 也可以设置容器启动时要执行的命令，但是和CMD是有区别的。</p> <ul><li><code>CMD</code> 设置的命令，可以在docker container run 时传入其它命令，覆盖掉 <code>CMD</code> 的命令，但是 <code>ENTRYPOINT</code> 所设置的命令是一定会被执行的。</li> <li><code>ENTRYPOINT</code> 和 <code>CMD</code> 可以联合使用，<code>ENTRYPOINT</code> 设置执行的命令，CMD传递参数</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM ubuntu:20.04
CMD [&quot;echo&quot;, &quot;hello docker&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>把上面的Dockerfile build成一个叫 <code>demo-cmd</code> 的镜象</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker image ls
REPOSITORY        TAG       IMAGE ID       CREATED      SIZE
demo-cmd          latest    5bb63bb9b365   8 days ago   74.1MB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>FROM ubuntu:20.04
ENTRYPOINT [&quot;echo&quot;, &quot;hello docker&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>build成一个叫 <code>demo-entrypoint</code> 的镜像</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker image ls
REPOSITORY        TAG       IMAGE ID       CREATED      SIZE
demo-entrypoint   latest    b1693a62d67a   8 days ago   74.1MB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>CMD的镜像，如果执行创建容器，不指定运行时的命令，则会默认执行CMD所定义的命令，打印出hello docker</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker container run -it --rm demo-cmd
hello docker
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>但是如果我们docker container run的时候指定命令，则该命令会覆盖掉CMD的命令，如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker container run -it --rm demo-cmd echo &quot;hello world&quot;
hello world
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>但是ENTRYPOINT的容器里ENTRYPOINT所定义的命令则无法覆盖，一定会执行</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker container run -it --rm demo-entrypoint
hello docker
$ docker container run -it --rm demo-entrypoint echo &quot;hello world&quot;
hello docker echo hello world
$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="shell-格式和-exec-格式"><a href="#shell-格式和-exec-格式" class="header-anchor">#</a> Shell 格式和 Exec 格式</h3> <p><strong>容器的启动命令中带有参数传递的处理方式</strong></p> <p>CMD和ENTRYPOINT同时支持shell格式和Exec格式。</p> <p><strong>Shell格式</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>CMD echo &quot;hello docker&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>ENTRYPOINT echo &quot;hello docker&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>Exec格式</strong></p> <p>以可执行命令的方式</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ENTRYPOINT [&quot;echo&quot;, &quot;hello docker&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>CMD [&quot;echo&quot;, &quot;hello docker&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意shell脚本的问题</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM ubuntu:20.04
ENV NAME=docker
CMD echo &quot;hello $NAME&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>假如我们要把上面的CMD改成Exec格式，下面这样改是不行的, 大家可以试试。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM ubuntu:20.04
ENV NAME=docker
CMD [&quot;echo&quot;, &quot;hello $NAME&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>它会打印出 <code>hello $NAME</code> , 而不是 <code>hello docker</code> ,那么需要怎么写呢？ 我们需要以shell脚本的方式去执行</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM ubuntu:20.04
ENV NAME=docker
CMD [&quot;sh&quot;, &quot;-c&quot;, &quot;echo hello $NAME&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="实战-构建一个-python-flask-镜像"><a href="#实战-构建一个-python-flask-镜像" class="header-anchor">#</a> 实战：构建一个 Python Flask 镜像</h3> <p>Python 程序</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'Hello, World!'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Dockerfile</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> python:3.9.5-slim</span>

<span class="token instruction"><span class="token keyword">COPY</span> app.py /src/app.py</span>

<span class="token instruction"><span class="token keyword">RUN</span> pip install flask</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /src</span>
<span class="token instruction"><span class="token keyword">ENV</span> FLASK_APP=app.py</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> 5000</span>

<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;flask&quot;</span>, <span class="token string">&quot;run&quot;</span>, <span class="token string">&quot;-h&quot;</span>, <span class="token string">&quot;0.0.0.0&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> image build <span class="token parameter variable">-t</span> flask <span class="token builtin class-name">.</span>
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">5000</span>:5000 flask
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAzsAAABFCAYAAABt7/gDAAAcnUlEQVR4nO2du2rjXPv2r+fjfwRPqwxkah2AcBFwepVqgsH9i1QKDD4Ag0ClzLRDQLhRqT6GFEEHoDoDyWqfU5iv0G7JlrzRxpLt6weGGcXLWhtp7e77vtY/v3///htFEX79+gXSP6rlY20oEIGJmRcPnR1yKVQL/tqAggjudIFw6PwQQu4QHc7WhgYgcqdYsCMihNwB/zd0Bu4KVcfcUABE2HChc6dosLdb2LuXRQBz5oFPBSGkPSosfw1DGTofhBAyPFzsXAwdztrGQxTAffW4s08IIYQQQkjP/EM3NkIIIYQQQsgt8v+GzgAhhBBCCCGE9MHpbmx5gHUNjDkgo6cIzgUYoDtujsccsP36ZPj6150tbA0ART36RXewtbXmY3jb9IQQ0jOM2bkYKnRrjpeJBiWfQAiI6AObVw8hRwhyCVQV+vMcL5MHfKxmuCudjGzDRp6UVV0j5G5QYb0k2z/Rpsnzf2b6c/sfVYc1f8LkQR43ASEifGxe4R0aOLNF2In0qZCq6g6WL1IZhED0scGrF16kzxn6/kVGLjz+HNukB05apLetv6HTk0aLHe6ynU3tC6dA0QzY2gSP5p1NPMnlUHVYz0+YGJr0DIoBM3QKMbzZFN7e9bJ17ix+/kjK//2nGCCqrhHU1v+ZE0gycvR5Yr0TAV6bDOqnpG/a/xx41hRFg2FrmDy5mI3avKtCd9bYK4aiQDNsaJPHnjdZhr4/rnT8yWhbf0OnJxm07PSN3GGLCO7qFWGcPpqqCmu+hKEpMJYW3vjQ9kyIxXTMA2O3ZGc6kQT9Kd2Bfg8PXiPkPujXqtNN/yMgog1WryGyYROqDmdpQ1MARbPhW5+jPbOumKgKRO4Ki9QSpeoOlrYGRTGwdv5g2tOCbcj738L407b+hk5PCihQcBIqLH+L7XaLrW9BPTmdDidd6IjAxHS2KBY6ABDH8BYrBAKAMsHz6T98ZTStP9KGnz+UxNwdBHBdE+Z0CjO4lh21rlHx+AAAAl+fh66R26Nt/3Oj/VfPVp3W/U/4CnM6w2whLXQAIA6xmLmI0v8qk+fqNgkXmE6nhz9u9is9nH2nWnjJ9jmDYqKaFGGBWXZvzYajd3vrMdx/XONPBLfuGajbZG5bf0OnJyW42OkR3UndbSK3vPOk6nCywXO7xAQAoODHz0GySW6UcDHFdDbDwvMQhvGdWw1/4kfir4Y/+Q7xMyYKAPGBt/uuHHJ39B+r077/OZQmxHux2mm4USiVwe3eNV+fZ67rNQup8BXZ3F976X4RPfT9r338aVt/Q6cnZbjY6Yt8VR7BlU2MqgV/bePhw4U5nWI6XWHznTyxD498XAnpBf0p3Xh4LyY1jNch90pmlUGERh6cbdN3wOdXOyuBai3bWbYOouMpl/18r1lIxfjznf6zc8+Ooe9/7bStv6HTk10uELMjBRRHbupbqEJ3lnjRlFLAWhSssKhawao6rPkLJjvfP1nJrEn6uuBIxcB6a1QkEAgkkQH1eZLcq/SgqrCWBpTIxdTLrsb4/AKORlxLKiaKLEsDASG+8f3xXq/M0bD+9qVfKxTlRAR3tdj/jZb1J2Ueqv6M+dMEDw/KjiKPwPembN6V0x2Wzj0utNGq/Lu50S3MXybQpAKcpCjUxftzl9S0v2Zju7Xrr+V13HV2zn1/pfzXqgVVPRunfOdan58L9j8d9F+V/cdOvYsoOFGNc1eYo51QUBarJoLXRr/RNn0X/PyR1aJkrT0ZHfPk5UKw6iFWVn3EQ/pPccBHNnyPYGsacs+OrjIy9P07p9vn/yht62/o9GSPywsUHFAme6j8el2QW6ZkZuDlgGRk2/RNyTriUuBzuhsWbc57RVXLwbKkZCKjQFEUKIYG/An3zr3orvw1k0dFg732e1KTO7xgURQFir2G/9ifZOjRvBwtvwrLSUQodmmkKHTm+3O/ZG5r53FoYGlKm/e3h8xc6fMzRP/TIaoOZ72vIjiIGqfkddAoTqVt+k6Qdr7FF859awsX800/9Z5ZjQF8n7gSSzw7OsrM0Pe/dtrW39DpyR4XXuw8wVlrUFJlidfMj7NuF013ion6jpKZqlqYL41EkcVYw0fFhLdN+nCBQrjrlF1WmSzwuWziT3bD9s3+Pw/MysqLlZ16SwoC9ecznp8m+LGbuG39STw5a2gKIAIXq3QHusibgsmzCi/uqv7KiCjAx/sb3krlLiYPijGH7u3u8lRL5xa7redxdvnz+61h5EGGRVqoOqylDSNVFHL0Uya6Z74/d42svJftCsq7gem1ns/XafX+ds71Pj8X73867L8ADfZaA0SEQLLkyvm/pBpnFgvQ2KrTMn0XqNZLcTj0uTFH+WJNIOjefy25xWO+L39Y/OTzCwLJRojS4db80PcfHxrs7RY2Co+KtwNxRG3rb+j0ZJ/LxuxoWjLhMGdYHA1YK5TMgAjujpJZHHtlRRZjDr3T9G2o2lWWdqJOug5AtbDMJ0o19RbHiEMP3mK2M1nusvwaNC05MX0mudrE3ua4Ik4rkgXLbOHB2yt3iNdc2eUB/YY7NSy/7uQLq+TAOslNKQ7hSfWvPZ3w9J31/pCcqnid7Fqf8Tqt3t8euNrnZ6j+p0NEAHO2KLmsxt4MbtEBY34JRaVbsOrI71Xknv3e5IHffVl1yKhJPCrWWG99WKPuNEiXXNiyIxCYFf7VpV20lGwygkM7SCFegxdohgJAw5MOhGFH6bugyry+e03K5y553A9StZhzOuaOyy8Cs2JQ+cSXACo8tC5C/OcbOHw2cmecX/5C6ad+YhDiPbKhaQC0J+gIj+yUnvH+kJxsl0x2Uau61vl927y/vXC9z88Y+5/TieDWWG0Kn/tjbijdnBF29VYdVYeTuWGKAObZKx2niKPi2SRXRMPnP/Ywmxb+Haqq43n+krqVKzDWPjB2F1jSCZe17JyxkyKb8T4O6MLGbx/5Wbzy7njb9J2g/MBhNWl5Qrz/t+dJsSt8ruJNt+Uf0jcbSEQKLDi+n8p1p5+Lud40Kb9k3atVU5E5wTp1ZTuRqm7B94v28n0Hll5VyOwcE6dD62pB5iZa+D5n79bhd6Md7d7fXriy56dg6P6nRz6/8v5X6fvsAcl9q9Fz3zZ9a6S4p0buhNJ4e1KfTG6NOA7hLWaYmkH63iUupDTw3D6XFyg4kUNxLJdI344DO47pAijxlZ/DUASiCNAObU82CMActvwdojvw7brg7hEjqalUKoDdOrqD9c5iNBNkMGyBKNjg9S05LFDNDyc8/zmvufmOck+CZm9RbgYFxnqLTFtL9CBUkvxwV+UipDmFQmizRW/b9O3Q4fhtFjqQ5LL7i9XJKLwOjqhkSYHoXVqZh77/6Ik9bCIjsfIpEzyrXung2rb1N3R6sg/P2emFTP88cQ1LyA5BS6+pFnxbA8QH3r8GyubYSQOnk/FJIApcmGbV6ddkXMiH9ZlJW5km3CDKd9M0w8Z6nVh8skVRs8MNq27/2EhZ7FTVG0KuD0lqudFEv236NqiwfDvZPGwsKCLFsF5isSZZ7E49P6/T/mfo+18BYXEq7f6B7m3rb+j0ZI/RWnY+Wzpjt03fluz+mhQIk/lna/YWWwCZxv/n8wRAooq2NSr042Vr0Jn3v17KMS/urEdN/T6I/yCPKOrr7JbRkrrwiQCvWYBIHCOMFwi9xG96vnwpzhwSAsFmBa+rKpL8tDPFK9lqU3WtVxq8v+T+6DV+LFMva2rVaZm+Dfnhnwdin47/hqTedgmfUqn/P6SSpRf62YdVt67t/tdO2/obOj3ZY7SWnbg4GhaTA0fDloKApU6sbfq25LEw2kuh+BEuYGYKYiKqOUQz/wW8feTRNHg5UzZk6PK359yYl7GRuDICAB4e78wnOMRiOsW0ZmISxyEWs1lhoZvNjhys2pz6eJ2+d8Lavb+l07FrkCdw5DqR+9/+nscrtupIxydEbtMNryz/SDdgusrcITJPDqTiM1VkR1QAEB/oNgxq6PuPn8MLhbb1N3R6sstoFzsI30+QRZY6sd0g4LbpS0gTj6OiA1kSD6tAIIkLcJDFZcdeOsmbLfKFTn5tOsVUsurI4gGKsTxPJrHT8relQf2dQCHCUGGGHhxpsqsYWFLjcgAyWXf52c4W0f2LBrR6f2Wq3hn5DC1yhLb9T9v0D6jWfjmn/9XhyOIsZ4h5XK9VR3I9a7FIkTcFxMdbQwvr+fUfvmZB8DWbHXkM0SkuvNd3/27p+P652AZqFwpt62/o9KTMeBc7CLHIYzI02L4DXS0aXFWtImARVVKYbdOX+fySdmkdC+rus6eqe9dib4XEkJOc8u1YemmHX1V1WI4P36l5bfMFE5DJJDqWvnMfNfkdy4FTeiG6LX9bzq8/yTKi2XB0Oe86HN8vTfZO9Wu9JEX7pwe3OlapDQAk5U6V5uoeA9KQLHZHFgioutYXrd7fnXcm7ztU6FYi2oEoAqPWTqNJ/91degWavYXvSP2/qidxKOl/m1stjnG9Vp1WB4cWvyKpIl44riH2sElfUMVYlsewVHgHQKOzgq7i/iNA1Z29PlfVLfiZfDkOPFtt62/o9KTEaGN2ACRuX4/ppFZJTqGu0rSq9b1vm14i9jaIjGRwUjQDa83Y+44ITMxkSQ/E8GYm4K9hKElQtmZU5ODAjCX2ZjDhYGloUHDgN5AsWEp0WP62nF9/MbxVgEnaKWn2ekdJSyByXXy92DCULN7pMmU5Hbn9k3LbmlHZBsDBx6ARurNFvTp3WYksz4M7vZmOM3MRkndzq671SZv3t/TOGDbWcjoRwFz8wXxLR7ZTaNZ/d5U+QhQ9QNNsrCtUGUWPk5V8wdDQzaVN+nb9T3mRsq+kWEq1H+eaIx/wfXkJ+HBhAs4atqZUjGFodlbQldx/FOPP48OBPlcgclcH79e2/oZOTwpGbNlJiL0ZpqaLIBK5S0iCgIgCuOb04OS2bfqCEItpqigl9v8qhMD3n8ocwJtNYboBop2EQkQIXPNo8HrsLTDL7717cwEhIkSBi1XFaNRd+dvSoP5iD7M079I3ISIXpjnDIgzhzVwUf65rgyFJ2z9rg73mS9ohcKsOTSRt2I/Xqb7WN83f3xAL093pN1JVwoaB2vdL0/67m/TvixlMdydt2v/PenvxiwVDM8tI2/QjQFZmHEQCPka4mFa0vUDkmhd4j4e+/7DEbx+I9sZdeQ5xrPRt62/o9CTn9+/ff//3v//9BXD4o1p//e3273br/NWPfZcffvjhp5eP/tfZbv9ut9u/jj50Xvjhp/6jO8lzOtiYqTvJ/X3rrzpEen744YefkXxGb9khhBBCyDlIZ101tOq0S08IIeOhQcyOBnu73Y87aHzYFyGE7KLCSmOdCCFnkik1NVUxa5ueEEJGBC07hBBCyM1Aqw4hhMj88/v3779RFOHXr19D54UQQgi5CQo1qkNqYYQQQvpm3NLThBBCyBUSLqZc4BBCyAgY8WLnuM/+YU32tunJsFym/S62+6qWDzLbgzFvZPTocLbyQZjsP8fL9Y5///33X6v0//77b0c5IYTcCozZIeRUdAfb7Rbb7RaOPnRm7g0VuuXA97d5G2y3PnzHgl57cj0hHaNmz6EP696eO9WCv91i61tQD10jhJCRMWLLTnIYo7d7WXewrT+Wt8P0ZFhutf3ov382tVYxBYpmwNYmeDRnuMjZuOT+UHVYz0+YGJr0DFacLDoqavrPHevcWfz8kZT/+09hga66RgghI2PEix1CyN0jL25FBHf1ijBOp1WqCmu+hKEpMJYW3ugG2DMhFtP7Waarlo81tc9z9KdUoe09PHiNEELGRr0bW2ae3m7hH7DXq5afu5TcnVl/pOjO8XarSJS0I/2zSOeosDL3s7PcXXQ46UJHBCams0Wx0AGAOIa3WCEQAJQJnm+2/2laf6QNP38ogBCIggCua8KcTmEGY7fo9IWKxwcAEPj6PHSNEELGBy07N8jnlwA0BcqPn8CZe92CoxYZCbqTuttELmayj5qqw1na0BQAEBACABQ0eNwJqaVKTe1+F5o/8SPxV8Of7B1TnzFRAIgPvPG9I4SMGAoU3CDxn+/kHw+PJw/OarJFh+8/HLXICFAtvGQqebJklGrBX9t4+HBhTqeYTlfYfCe77Q+P9zsVJaRX9Kd04+G9WAAyXocQciVczLKj6hbmLxNoihTiKSJ8bF7hhSPvKlUd1vwFE00pBaiK6AObVw+jy/7nFwQ0KMoPnLrZ/fOHglp3hFbllwJiIxfTRQhAhe4s8bLze1GwwqKPKPO9/AuIaIPVubqrWb1e1G2jg/pr+/w2SV8nJKEYWG+NigQCgSQyoD5PknvJkyuosJYGlMjF1Muuxvj8Ao5GXKsq9Oc5XiYPUBQ5DkNAiG98f7zj1Qur35WG9bcva65Ct+Z4mWjIsyAiuKvF/m+0rD8p81D1Z8yfJnh4UCAXXQiB780Ki8oCHJMuPi600ar8u7lpPH6MoP+5SmraX7Ox3dr11/I6JoSQ8XCBxY4Ky0mCiHdRFA2GrWHy5GI20g6yPkg1U4Iy8BKYZTebsSJNoEQpz5nvteSikP2l6/IfUNZ6OLUc51B5PwWKZmPtPyH67uOmPXJm/bVtv6Ge/2TxvRP4rM9hKEC0Oa+vUC0Hy5KSlowCRVGgGBrwJ9w7d6S78tdMHhUN9trvSU3u8IJFURQo9hr+4yX6r6bl73j8uHT/c7VkbmvnQTdoQsgY6X2xoztrGJmYUuBile2eqjqspQ1DARTNhqPvTzQGR3eKic6OEpSqWpgvDWgKoBhr+BjRgif+g28kw/ejity0k7mqAdiJ50kHNvGF0lDVefmf4KwTy0jkrvAaxkkOepOT1uHkExuBwF3lu8Cq7mBpa6iYQ42YM+uvbfu1SR8uUAh3SRPdkw5PzRbfEUprnSdt7xpQLIwqf6m0WNmpt6QgUH8+4/lpgh+7iTt8/p+cNTSl3AcWeVMweVbhxV3VXxkRBfh4f8Nbqdw6nHVi8VCMOXRv10pTLV1cWGvO4+zy5/frcvy4dP9zzcjKe5l1TLbmpdd4GDIh5AroN2ZHd/KBMbEkSG4icQhv5iJK/6s9jU0FrFCCAiK4O0pQcexhIeVfMeYYTwk+8SUHbaeUJoVyPI/6mOxqlnyveyi/piUDpjnDQp549UQe4J65+EjuLnG4wGxq4qrElc6qv7btN+TzX7WrrOOpcj5adx2AamGZL3Rq6i2OEYcevMVsZ7LcZfk1aFpyYr3cB8bepkg/ee4h+D1ZsMwWHry9cod4zR/+dFOkNxqWv+vx48L9z81QFa+TXWO8DiHkCjhpsaMYa+nU8vKn/hwCFdZLMVnYVO56hngvRqsRLRZQdOYARPBa45suTxg0jGe9FqPQKMimENmkUCTH4clSvWmgackFoZfyCwRmhX9+uMB0Ou3YMiZNgmvVgop6ug7OqL+27TeG53/X0lh1TcrnLnncD4DIPR4XUqLj8ovArLA8ZJsSwxBf8OE/v/x9jB+X7H9uh8wjQB4fqq4RQshY6dGyI+3OloKM6+h7d/E8CpcvgY8Duprx20d+lvaYrFOf6SxCyUw7mfUm2mATAbLVp0qJrZfyR5vLnXKflReA+HjrZvcxdQ+sim26CGfUX9v2G8Xznwps1CNPiPf/9jwprDrnnnnYbfnrJuuXQoWqW3B8v7xZdTHXrSbl72H8uGT/0wGqbsH3i/byfQeWXlXI7Bwmp5cNw8wjoBgfsnfr8LtBCCFj4aSYHdEkgFmabFYquIycQ3EA10Cya6vk7mqxZL35RHIOj/akA2FYqcR27eXPZVFxn3Labdtv2PZPdvwr46lkhUF9DkMRiCJAOxR8VWUhOsLVP/8ZugPfrhNnGDFXPn60Rnew3lmMZoIMhi0QBRu8voWIY0BNhTuaPOc1Ny8U7CQ0e4tyMygw1ltk2oCH5gmEEDIkPGfnVvn8St3VkslhEtyd7MSVz+GpV2IjZBgy90LZNSxzWUqvqRZ8WwPEB96/Bsrm2EkD75OzVwWiwIVpTjGdph83OvYLZBAKi2XkmklbmSbcIEqtiAo0w8Z6nbqSp4uiaNORUIC80DyDe9xUIoRcB/2pseWKYLhK7f3P2q3lK0Gu/90FTfyOyNagyW5CO7uCV19+iQdZkq4VskLRuGnbfkO3f3b/zPoIAOF7BFvTkh1mAIBAsPLw+TwBkMYWGhXnv5xx3tTu/a+XcsyLOzt8Js7ouPLxox2ZOmaA1yzAKI4RxguEHqCqOubLl+LMISEQbFbwuqqi2MNsmujwZZ4bstWm6hohhIyZHi07UvCprPx1JRTBu4ksah2lIOhzAwMuwgMe1XTwzH3fs7bR8KSnf9tR1bn68meWLUhxS3dE2/Ybuv3zWBjtBVZ2+3ABMxMEEFHNIZr5L+DtoxAPeLHO64GGLn97zo15GRvXPX60I8RiOsW0RtI5jkMsZrPCQjeb9XYwd328Di05hJDrocfFjjTZUAwsz5xsDE74foKsrI65JG17eK6jwykp2fUTTFogyU/PE2WpQjmnaJuHpyc8oEJVp/PyX5j4DcVct1qpSbX8RmeGXAVt26/T9pdU746KDmRJPKwCgSQuwEEWlx176SRvtsgXOvm16RRTyaojiwcoxhJndUGjev4b1N8JFCIMZYn6cXDl48dNkClays92togeWX9PCCEH6DVmJ/ZW+TkmirGG71jQ1Z1BSy2UgpzxiJkBCLHIfdo12L5TyruqWnB8+wR52qEoJkialuRS3onLdq4VLfHp39+lu/7yyzv7tqNL5wrpsJwaYY0D6I60WB3Xw1pB2/brtv0/vyQri2NhtxuAqu5dK/oPDfbah2PppR1+NW1Hv64t8gUTkCya0t8o3UdNfsdy4JQm1ON6/s+vP8kyotlwdDnvOhy//Pw/jEkKM+W6x48bIIvdkV2cq64RQsjI6S9mB0ByqJ0JpKd/K5oBWzNQp6szunDZcAHzMZ0UKBrstVaZ97H6LpfjDnZ24j6/IHBEpenKyx97KwST9OR5zcZ6R9Epck28P61v2LrTsv06bP/Y2yAyksWBohlYa8bed0RgYhaXnCml/iMJytaMihwc6DhibwYTDpaGBgUHfgPJgqXEiJ7/8+svhrcKMFkbSB7/9Y6SlkDkuvh6sZO+2Vhja4ztXR52/NCd7YG+oaxElufBnVacJ3SdZC6asnR/1TVCCBk7F1BjS07xNk0XQSQgdg+REwIiChC4VYfODU/szTDN8l76S5Jv1xzvYXSlQwN3d+JkN68d2enS1664/NlkqVAxShAigmtOsejJz31MtG2/7to/xGKatkXFQZJCCHz/qcxB0n+4AaKdhEJECFzzaPB67C0wy++91wFBiAhR4GJVcWbIeJ7/BvUXe5ileZe+CRG5MM0ZFmEIb+YikvqB6jYYkuseP66Z/Xid6muEEDJ2/vn9+/ffKIrw69evofNyH6RysBABzJoAVHKDqBb8tQEFFWphhBByEYozdMZqhfrvv/9apf/33387ygkh5FbgOTsXJgsKphsAIYQQQggh/dJzzA4poWbqTRE2o3X9Iv2iwd5u9+MOaOkjhHSGCiuNdSKEkHuHi52LocNZ23iIArivHt2YCCGEEEII6RnG7BBCCCFkFDBmhxDSNYzZIYQQQgghhNwkdGMjhBBCyCigZYYQ0jW07BBCCCGEEEJuEi52CCGEEEIIITcJFzuEEEIIIYSQm4SLHUIIIYQQQshNwsUOIYQQQggh5CbhYocQQgghhBByk3CxQwghhBBCCLlJuNghhBBCCCGE3CRc7BBCCCGEEEJukv8PLQoCt6xoJJAAAAAASUVORK5CYII=" alt="image-20230614183643911"></p> <p><img src="data:image/png;base64,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" alt="image-20230614183813272"></p> <h4 id="dockerfile-技巧-合理使用缓存"><a href="#dockerfile-技巧-合理使用缓存" class="header-anchor">#</a> Dockerfile 技巧——合理使用缓存</h4> <p>如果按照上述Dockerfile，修改app.py后，之后的操作比如install flask都不会使用cache，这样影响构建效率，因此，把经常改变的内容放在后面，尽可能的使用缓存，提高构建速度。</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> python:3.9.5-slim</span>
<span class="token instruction"><span class="token keyword">RUN</span> pip install flask</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /src</span>
<span class="token instruction"><span class="token keyword">ENV</span> FLASK_APP=app.py</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 5000</span>
<span class="token instruction"><span class="token keyword">COPY</span> app.py /src/app.py</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;flask&quot;</span>, <span class="token string">&quot;run&quot;</span>, <span class="token string">&quot;-h&quot;</span>, <span class="token string">&quot;0.0.0.0&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="./assets/img/image-20230614185305649.185f7cbf.png" alt="image-20230614185305649"></p> <p><img src="./assets/img/image-20230614185826404.dfd52840.png" alt="image-20230614185826404"></p> <h4 id="dockerfile-技巧-合理使用-dockerignore"><a href="#dockerfile-技巧-合理使用-dockerignore" class="header-anchor">#</a> Dockerfile 技巧——合理使用 .dockerignore</h4> <p><strong>什么是Docker build context</strong></p> <p>Docker是client-server架构，理论上Client和Server可以不在一台机器上。</p> <p>在构建docker镜像的时候，需要把所需要的文件由CLI（client）发给Server，这些文件实际上就是build context</p> <p>加入文件夹下有些文件不是必须的，可以过滤掉。</p> <p>Dockerfile</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> python:3.9.5-slim</span>
<span class="token instruction"><span class="token keyword">RUN</span> pip install flask</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /src</span>
<span class="token instruction"><span class="token keyword">ENV</span> FLASK_APP=app.py</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 5000</span>
<span class="token instruction"><span class="token keyword">COPY</span> ./ /src/</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;flask&quot;</span>, <span class="token string">&quot;run&quot;</span>, <span class="token string">&quot;-h&quot;</span>, <span class="token string">&quot;0.0.0.0&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="./assets/img/image-20230614204910784.efe29cfd.png" alt="image-20230614204910784"></p> <p><img src="./assets/img/image-20230614205051618.aafc5ecb.png" alt="image-20230614205051618"></p> <p>增加vim .dockerignore</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>./hello.image
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>有了.dockerignore文件后，我们再build, build context就小了很多</p> <p><img src="./assets/img/image-20230614205127406.29636486.png" alt="image-20230614205127406"></p> <p><img src="./assets/img/image-20230614205156437.43213ab4.png" alt="image-20230614205156437"></p> <h3 id="dockerfile-技巧-镜像的多阶段构建"><a href="#dockerfile-技巧-镜像的多阶段构建" class="header-anchor">#</a> Dockerfile 技巧——镜像的多阶段构建</h3> <p>这一节来聊聊多阶段构建，以及为什么要使用它。</p> <ul><li><strong>C语言例子</strong></li></ul> <p>假如有一个C的程序，我们想用Docker去做编译，然后执行可执行文件。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#include &lt;stdio.h&gt;

void main(int argc, char *argv[])
{
    printf(&quot;hello %s\n&quot;, argv[argc - 1]);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>本地测试（如果你本地有C环境）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ gcc --static -o hello hello.c
$ ls
hello  hello.c
$ ./hello docker
hello docker
$ ./hello world
hello world
$ ./hello friends
hello friends
$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>构建一个Docker镜像，因为要有C的环境，所以我们选择gcc这个image</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM gcc:9.4

COPY hello.c /src/hello.c

WORKDIR /src

RUN gcc --static -o hello hello.c

ENTRYPOINT [ &quot;/src/hello&quot; ]

CMD []
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>build和测试</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker build -t hello .
Sending build context to Docker daemon   5.12kB
Step 1/6 : FROM gcc:9.4
---&gt; be1d0d9ce039
Step 2/6 : COPY hello.c /src/hello.c
---&gt; Using cache
---&gt; 70a624e3749b
Step 3/6 : WORKDIR /src
---&gt; Using cache
---&gt; 24e248c6b27c
Step 4/6 : RUN gcc --static -o hello hello.c
---&gt; Using cache
---&gt; db8ae7b42aff
Step 5/6 : ENTRYPOINT [ &quot;/src/hello&quot; ]
---&gt; Using cache
---&gt; 7f307354ee45
Step 6/6 : CMD []
---&gt; Using cache
---&gt; 7cfa0cbe4e2a
Successfully built 7cfa0cbe4e2a
Successfully tagged hello:latest
$ docker image ls
REPOSITORY     TAG          IMAGE ID       CREATED       SIZE
hello          latest       7cfa0cbe4e2a   2 hours ago   1.14GB
gcc            9.4          be1d0d9ce039   9 days ago    1.14GB
$ docker run --rm -it hello docker
hello docker
$ docker run --rm -it hello world
hello world
$ docker run --rm -it hello friends
hello friends
$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>可以看到镜像非常的大，1.14GB</p> <p>实际上当我们把hello.c编译完以后，并不需要这样一个大的GCC环境，一个小的alpine镜像就可以了。</p> <p>这时候我们就可以使用多阶段构建了。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM gcc:9.4 AS builder

COPY hello.c /src/hello.c

WORKDIR /src

RUN gcc --static -o hello hello.c



FROM alpine:3.13.5

COPY --from=builder /src/hello /src/hello

ENTRYPOINT [ &quot;/src/hello&quot; ]

CMD []
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>测试</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker build -t hello-apline -f Dockerfile-new .
Sending build context to Docker daemon   5.12kB
Step 1/8 : FROM gcc:9.4 AS builder
---&gt; be1d0d9ce039
Step 2/8 : COPY hello.c /src/hello.c
---&gt; Using cache
---&gt; 70a624e3749b
Step 3/8 : WORKDIR /src
---&gt; Using cache
---&gt; 24e248c6b27c
Step 4/8 : RUN gcc --static -o hello hello.c
---&gt; Using cache
---&gt; db8ae7b42aff
Step 5/8 : FROM alpine:3.13.5
---&gt; 6dbb9cc54074
Step 6/8 : COPY --from=builder /src/hello /src/hello
---&gt; Using cache
---&gt; 18c2bce629fb
Step 7/8 : ENTRYPOINT [ &quot;/src/hello&quot; ]
---&gt; Using cache
---&gt; 8dfb9d9d6010
Step 8/8 : CMD []
---&gt; Using cache
---&gt; 446baf852214
Successfully built 446baf852214
Successfully tagged hello-apline:latest
$ docker image ls
REPOSITORY     TAG          IMAGE ID       CREATED       SIZE
hello-alpine   latest       446baf852214   2 hours ago   6.55MB
hello          latest       7cfa0cbe4e2a   2 hours ago   1.14GB
demo           latest       079bae887a47   2 hours ago   125MB
gcc            9.4          be1d0d9ce039   9 days ago    1.14GB
$ docker run --rm -it hello-alpine docker
hello docker
$ docker run --rm -it hello-alpine world
hello world
$ docker run --rm -it hello-alpine friends
hello friends
$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>可以看到这个镜像非常小，只有6.55MB</p> <ul><li><strong>Java 语言例子</strong></li></ul> <p>使用的openjdk:8-jdk-alpine就是瘦身过的镜像，不过要注意时区问题，要自己设置。</p> <h3 id="dockerfile-技巧-尽量使用非root用户"><a href="#dockerfile-技巧-尽量使用非root用户" class="header-anchor">#</a> Dockerfile 技巧——尽量使用非root用户</h3> <p><strong>Root的危险性</strong></p> <p>docker的root权限一直是其遭受诟病的地方，docker的root权限有那么危险么？我们举个例子。</p> <p>假如我们有一个用户，叫demo，它本身不具有sudo的权限，所以就有很多文件无法进行读写操作，比如/root目录它是无法查看的。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[demo@docker-host ~]$ sudo ls /root
[sudo] password for demo:
demo is not in the sudoers file.  This incident will be reported.
[demo@docker-host ~]$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但是这个用户有执行docker的权限，也就是它在docker这个group里。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[demo@docker-host ~]$ groups
demo docker
[demo@docker-host ~]$ docker image ls
REPOSITORY   TAG       IMAGE ID       CREATED      SIZE
busybox      latest    a9d583973f65   2 days ago   1.23MB
[demo@docker-host ~]$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这时，我们就可以通过Docker做很多越权的事情了，比如，我们可以把这个无法查看的/root目录映射到docker container里，你就可以自由进行查看了。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[demo@docker-host vagrant]$ docker run -it -v /root/:/root/tmp busybox sh
/ # cd /root/tmp
~/tmp # ls
anaconda-ks.cfg  original-ks.cfg
~/tmp # ls -l
total 16
-rw-------    1 root     root          5570 Apr 30  2020 anaconda-ks.cfg
-rw-------    1 root     root          5300 Apr 30  2020 original-ks.cfg
~/tmp #
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>更甚至我们可以给我们自己加sudo权限。我们现在没有sudo权限</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[demo@docker-host ~]$ sudo vim /etc/sudoers
[sudo] password for demo:
demo is not in the sudoers file.  This incident will be reported.
[demo@docker-host ~]$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但是我可以给自己添加。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[demo@docker-host ~]$ docker run -it -v /etc/sudoers:/root/sudoers busybox sh
/ # echo &quot;demo    ALL=(ALL)       ALL&quot; &gt;&gt; /root/sudoers
/ # more /root/sudoers | grep demo
demo    ALL=(ALL)       ALL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后退出container，bingo，我们有sudo权限了。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[demo@docker-host ~]$ sudo more /etc/sudoers | grep demo
demo    ALL=(ALL)       ALL
[demo@docker-host ~]$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>如何使用非root用户</strong></p> <p>我们准备两个Dockerfile，第一个Dockerfile如下，</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM python:3.9.5-slim

RUN pip install flask

COPY app.py /src/app.py

WORKDIR /src
ENV FLASK_APP=app.py

EXPOSE 5000

CMD [&quot;flask&quot;, &quot;run&quot;, &quot;-h&quot;, &quot;0.0.0.0&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>假设构建的镜像名字为 <code>flask-demo</code></p> <p>第二个Dockerfile，使用非root用户来构建这个镜像，名字叫 <code>flask-no-root</code> Dockerfile如下：</p> <ul><li>通过groupadd和useradd创建一个flask的组和用户</li> <li>通过USER指定后面的命令要以flask这个用户的身份运行</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM python:3.9.5-slim

RUN pip install flask &amp;&amp; \
    groupadd -r flask &amp;&amp; useradd -r -g flask flask &amp;&amp; \
    mkdir /src &amp;&amp; \
    chown -R flask:flask /src

USER flask

COPY app.py /src/app.py

WORKDIR /src
ENV FLASK_APP=app.py

EXPOSE 5000

CMD [&quot;flask&quot;, &quot;run&quot;, &quot;-h&quot;, &quot;0.0.0.0&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker image ls
REPOSITORY      TAG          IMAGE ID       CREATED          SIZE
flask-no-root   latest       80996843356e   41 minutes ago   126MB
flask-demo      latest       2696c68b51ce   49 minutes ago   125MB
python          3.9.5-slim   609da079b03a   2 weeks ago      115MB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>分别使用这两个镜像创建两个容器</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker run -d --name flask-root flask-demo
b31588bae216951e7981ce14290d74d377eef477f71e1506b17ee505d7994774
$ docker run -d --name flask-no-root flask-no-root
83aaa4a116608ec98afff2a142392119b7efe53617db213e8c7276ab0ae0aaa0
$ docker container ps
CONTAINER ID   IMAGE           COMMAND                  CREATED          STATUS          PORTS      NAMES
83aaa4a11660   flask-no-root   &quot;flask run -h 0.0.0.0&quot;   4 seconds ago    Up 3 seconds    5000/tcp   flask-no-root
b31588bae216   flask-demo      &quot;flask run -h 0.0.0.0&quot;   16 seconds ago   Up 15 seconds   5000/tcp   f
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_5-docker的存储"><a href="#_5-docker的存储" class="header-anchor">#</a> 5.Docker的存储</h2> <h3 id="data-volume"><a href="#data-volume" class="header-anchor">#</a> Data Volume</h3> <p><strong>示例：保存数据了解数据是如何持久化？</strong></p> <p>环境准备</p> <p>准备一个Dockerfile 和一个 my-cron的文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ ls
Dockerfile  my-cron
$ more Dockerfile
FROM alpine:latest
RUN apk update
RUN apk --no-cache add curl
ENV SUPERCRONIC_URL=https://github.com/aptible/supercronic/releases/download/v0.1.12/supercronic-linux-amd64 \
    SUPERCRONIC=supercronic-linux-amd64 \
    SUPERCRONIC_SHA1SUM=048b95b48b708983effb2e5c935a1ef8483d9e3e
RUN curl -fsSLO &quot;$SUPERCRONIC_URL&quot; \
    &amp;&amp; echo &quot;${SUPERCRONIC_SHA1SUM}  ${SUPERCRONIC}&quot; | sha1sum -c - \
    &amp;&amp; chmod +x &quot;$SUPERCRONIC&quot; \
    &amp;&amp; mv &quot;$SUPERCRONIC&quot; &quot;/usr/local/bin/${SUPERCRONIC}&quot; \
    &amp;&amp; ln -s &quot;/usr/local/bin/${SUPERCRONIC}&quot; /usr/local/bin/supercronic
COPY my-cron /app/my-cron
WORKDIR /app

VOLUME [&quot;/app&quot;]

# RUN cron job
CMD [&quot;/usr/local/bin/supercronic&quot;, &quot;/app/my-cron&quot;]
$
$ more my-cron
*/1 * * * * date &gt;&gt; /app/test.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>工具supercronic：https://github.com/aptible/supercronic/ 这个专为容器而生的计划任务工具。</p> <p>my-cron的意思是使用的my-cron就是一个crontab格式的计划任务，比如, 每隔一分钟输出时间到一个文件里</p> <p>构建镜像</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">docker</span> image build <span class="token parameter variable">-t</span> my-cron <span class="token builtin class-name">.</span>
$ <span class="token function">docker</span> image <span class="token function">ls</span>
REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
my-cron      latest    e9fbd9a562c9   <span class="token number">4</span> seconds ago   <span class="token number">24</span>.7MB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>创建容器(不指定-v参数)，在这个Volume的mountpoint可以发现容器创建的文件。此时Docker会自动创建一个随机名字的volume，去存储我们在Dockerfile定义的volume <code>VOLUME [&quot;/app&quot;]</code></strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">docker</span> run <span class="token parameter variable">-d</span> my-cron
9a8fa93f03c42427a498b21ac520660752122e20bcdbf939661646f71d277f8f
$ <span class="token function">docker</span> volume <span class="token function">ls</span>
DRIVER    VOLUME NAME
<span class="token builtin class-name">local</span>     043a196c21202c484c69f2098b6b9ec22b9a9e4e4bb8d4f55a4c3dce13c15264
$ <span class="token function">docker</span> volume inspect 043a196c21202c484c69f2098b6b9ec22b9a9e4e4bb8d4f55a4c3dce13c15264
<span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;CreatedAt&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-06-22T23:06:13+02:00&quot;</span>,
        <span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;local&quot;</span>,
        <span class="token string">&quot;Labels&quot;</span><span class="token builtin class-name">:</span> null,
        <span class="token string">&quot;Mountpoint&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/var/lib/docker/volumes/043a196c21202c484c69f2098b6b9ec22b9a9e4e4bb8d4f55a4c3dce13c15264/_data&quot;</span>,
        <span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;043a196c21202c484c69f2098b6b9ec22b9a9e4e4bb8d4f55a4c3dce13c15264&quot;</span>,
        <span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span> null,
        <span class="token string">&quot;Scope&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;local&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>创建容器(指定-v参数)</strong></p> <p>在创建容器的时候通过 <code>-v</code> 参数我们可以手动的指定需要创建Volume的名字，以及对应于容器内的路径，这个路径是可以任意的，不必需要在Dockerfile里通过VOLUME定义</p> <p>比如我们把上面的Dockerfile里的VOLUME删除</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM alpine:latest
RUN apk update
RUN apk --no-cache add curl
ENV SUPERCRONIC_URL=https://github.com/aptible/supercronic/releases/download/v0.1.12/supercronic-linux-amd64 \
    SUPERCRONIC=supercronic-linux-amd64 \
    SUPERCRONIC_SHA1SUM=048b95b48b708983effb2e5c935a1ef8483d9e3e
RUN curl -fsSLO &quot;$SUPERCRONIC_URL&quot; \
    &amp;&amp; echo &quot;${SUPERCRONIC_SHA1SUM}  ${SUPERCRONIC}&quot; | sha1sum -c - \
    &amp;&amp; chmod +x &quot;$SUPERCRONIC&quot; \
    &amp;&amp; mv &quot;$SUPERCRONIC&quot; &quot;/usr/local/bin/${SUPERCRONIC}&quot; \
    &amp;&amp; ln -s &quot;/usr/local/bin/${SUPERCRONIC}&quot; /usr/local/bin/supercronic
COPY my-cron /app/my-cron
WORKDIR /app

# RUN cron job
CMD [&quot;/usr/local/bin/supercronic&quot;, &quot;/app/my-cron&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>重新build镜像，然后创建容器，加-v参数 容器外路径:容器内路径</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> image build <span class="token parameter variable">-t</span> my-cron <span class="token builtin class-name">.</span>
<span class="token function">docker</span> container run <span class="token parameter variable">-d</span> <span class="token parameter variable">-v</span> cron-data:/app my-cron
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>43c6d0357b0893861092a752c61ab01bdfa62ea766d01d2fcb8b3ecb6c88b3de
$ docker volume ls
DRIVER    VOLUME NAME
local     cron-data
$ docker volume inspect cron-data
[
    {
        &quot;CreatedAt&quot;: &quot;2021-06-22T23:25:02+02:00&quot;,
        &quot;Driver&quot;: &quot;local&quot;,
        &quot;Labels&quot;: null,
        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/cron-data/_data&quot;,
        &quot;Name&quot;: &quot;cron-data&quot;,
        &quot;Options&quot;: null,
        &quot;Scope&quot;: &quot;local&quot;
    }
]
$ ls /var/lib/docker/volumes/cron-data/_data
my-cron
$ ls /var/lib/docker/volumes/cron-data/_data
my-cron  test.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>环境清理</p> <p>强制删除所有容器，系统清理和volume清理</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> container <span class="token function">ps</span> <span class="token parameter variable">-aq</span><span class="token variable">)</span></span> <span class="token comment">#强制删除所有容器</span>
$ <span class="token function">docker</span> system prune <span class="token parameter variable">-f</span> <span class="token comment">#删除不在运行的contianer cache</span>
$ <span class="token function">docker</span> volume prune <span class="token parameter variable">-f</span> <span class="token comment">#Remove all unused local volumes</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="data-volume-练习-mysql"><a href="#data-volume-练习-mysql" class="header-anchor">#</a> Data Volume 练习 MySQL</h3> <p>使用MySQL官方镜像，tag版本5.7</p> <p>Dockerfile可以在这里查看 https://github.com/docker-library/mysql/tree/master/5.7</p> <p><strong>准备镜像</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> pull mysql:5.7
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>创建容器</strong></p> <p>关于MySQL的镜像使用，可以参考dockerhub https://hub.docker.com/_/mysql?tab=description&amp;page=1&amp;ordering=last_updated</p> <p>关于Dockerfile Volume的定义，可以参考 https://github.com/docker-library/mysql/tree/master/5.7</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#--name 容器名docker-mysql  -e 编辑密码 -v磁盘映射到docker下的mysql-data目录下</span>
<span class="token function">docker</span> container run <span class="token parameter variable">--name</span> docker-mysql <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-v</span> mysql-data:/var/lib/mysql mysql:5.7
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>
$ docker volume ls
DRIVER    VOLUME NAME
local     mysql-data
$ docker volume inspect mysql-data
[
    {
        &quot;CreatedAt&quot;: &quot;2021-06-21T23:55:23+02:00&quot;,
        &quot;Driver&quot;: &quot;local&quot;,
        &quot;Labels&quot;: null,
        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/mysql-data/_data&quot;,
        &quot;Name&quot;: &quot;mysql-data&quot;,
        &quot;Options&quot;: null,
        &quot;Scope&quot;: &quot;local&quot;
    }
]
$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>数据库写入数据</strong></p> <p>进入MySQL的shell</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> container <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> 022 <span class="token function">sh</span>
mysql <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.34 MySQL Community Server (GPL)

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.00 sec)

mysql&gt; create database demo;
Query OK, 1 row affected (0.00 sec)

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| demo               |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.00 sec)

mysql&gt; exit
Bye
# exit
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>创建了一个叫 demo的数据库</p> <p>查看data volume</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">docker</span> volume inspect mysql-data
<span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;CreatedAt&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-06-22T00:01:34+02:00&quot;</span>,
        <span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;local&quot;</span>,
        <span class="token string">&quot;Labels&quot;</span><span class="token builtin class-name">:</span> null,
        <span class="token string">&quot;Mountpoint&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/var/lib/docker/volumes/mysql-data/_data&quot;</span>,
        <span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;mysql-data&quot;</span>,
        <span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span> null,
        <span class="token string">&quot;Scope&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;local&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
$ <span class="token function">ls</span>  /var/lib/docker/volumes/mysql-data/_data
auto.cnf    client-cert.pem  ib_buffer_pool  ibdata1  performance_schema  server-cert.pem
ca-key.pem  client-key.pem   ib_logfile0     ibtmp1   private_key.pem     server-key.pem
ca.pem      demo             ib_logfile1     mysql    public_key.pem      sys
$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="多个机器之间的容器共享数据"><a href="#多个机器之间的容器共享数据" class="header-anchor">#</a> 多个机器之间的容器共享数据</h3> <p><img src="./assets/img/volumes-shared-storage.89cc77d3.png" alt="multi-host-volume"></p> <p>官方参考链接 https://docs.docker.com/storage/volumes/#share-data-among-machines</p> <p>Docker的volume支持多种driver。默认创建的volume driver都是local</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker volume inspect vscode
[
    {
        &quot;CreatedAt&quot;: &quot;2021-06-23T21:33:57Z&quot;,
        &quot;Driver&quot;: &quot;local&quot;,
        &quot;Labels&quot;: null,
        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/vscode/_data&quot;,
        &quot;Name&quot;: &quot;vscode&quot;,
        &quot;Options&quot;: null,
        &quot;Scope&quot;: &quot;local&quot;
    }
]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这一节我们看看一个叫sshfs的driver，如何让docker使用不在同一台机器上的文件系统做volume</p> <p><strong>环境准备</strong></p> <p>准备三台Linux机器，之间可以通过SSH相互通信。</p> <table><thead><tr><th>hostname</th> <th>ip</th> <th>ssh username</th> <th>ssh password</th></tr></thead> <tbody><tr><td>docker-host1</td> <td>192.168.200.10</td> <td>vagrant</td> <td>vagrant</td></tr> <tr><td>docker-host2</td> <td>192.168.200.11</td> <td>vagrant</td> <td>vagrant</td></tr> <tr><td>docker-host3</td> <td>192.168.200.12</td> <td>vagrant</td> <td>vagrant</td></tr></tbody></table> <p><strong>安装plugin</strong></p> <p>在其中两台机器上安装一个plugin <code>vieux/sshfs</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[vagrant@docker-host1 ~]$ docker plugin install --grant-all-permissions vieux/sshfs
latest: Pulling from vieux/sshfs
Digest: sha256:1d3c3e42c12138da5ef7873b97f7f32cf99fb6edde75fa4f0bcf9ed277855811
52d435ada6a4: Complete
Installed plugin vieux/sshfs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>[vagrant@docker-host2 ~]$ docker plugin install --grant-all-permissions vieux/sshfs
latest: Pulling from vieux/sshfs
Digest: sha256:1d3c3e42c12138da5ef7873b97f7f32cf99fb6edde75fa4f0bcf9ed277855811
52d435ada6a4: Complete
Installed plugin vieux/sshfs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>创建volume</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[vagrant@docker-host1 ~]$ docker volume create --driver vieux/sshfs \
                          -o sshcmd=vagrant@192.168.200.12:/home/vagrant \
                          -o password=vagrant \
                          sshvolume
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>查看</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[vagrant@docker-host1 ~]$ docker volume ls
DRIVER               VOLUME NAME
vieux/sshfs:latest   sshvolume
[vagrant@docker-host1 ~]$ docker volume inspect sshvolume
[
    {
        &quot;CreatedAt&quot;: &quot;0001-01-01T00:00:00Z&quot;,
        &quot;Driver&quot;: &quot;vieux/sshfs:latest&quot;,
        &quot;Labels&quot;: {},
        &quot;Mountpoint&quot;: &quot;/mnt/volumes/f59e848643f73d73a21b881486d55b33&quot;,
        &quot;Name&quot;: &quot;sshvolume&quot;,
        &quot;Options&quot;: {
            &quot;password&quot;: &quot;vagrant&quot;,
            &quot;sshcmd&quot;: &quot;vagrant@192.168.200.12:/home/vagrant&quot;
        },
        &quot;Scope&quot;: &quot;local&quot;
    }
]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>创建容器挂载Volume</strong></p> <p>创建容器，挂载sshvolume到/app目录，然后进入容器的shell，在/app目录创建一个test.txt文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[vagrant@docker-host1 ~]$ docker run -it -v sshvolume:/app busybox sh
Unable to find image 'busybox:latest' locally
latest: Pulling from library/busybox
b71f96345d44: Pull complete
Digest: sha256:930490f97e5b921535c153e0e7110d251134cc4b72bbb8133c6a5065cc68580d
Status: Downloaded newer image for busybox:latest
/ #
/ # ls
app   bin   dev   etc   home  proc  root  sys   tmp   usr   var
/ # cd /app
/app # ls
/app # echo &quot;this is ssh volume&quot;&gt; test.txt
/app # ls
test.txt
/app # more test.txt
this is ssh volume
/app #
/app #
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这个文件我们可以在docker-host3上看到</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[vagrant@docker-host3 ~]$ pwd
/home/vagrant
[vagrant@docker-host3 ~]$ ls
test.txt
[vagrant@docker-host3 ~]$ more test.txt
this is ssh volume
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>如何给已创建的容器额外挂载共享文件夹</strong></p> <p><strong>一、背景</strong></p> <p>在使用docker过程中，有时候创建容器时候没有设置挂载本地数据卷进行文件夹共享，但已经在容器中配置完了环境，此时再重新创建一个容器非常麻烦，因此需要对已有的容器挂载数据卷。</p> <p><strong>二、挂载原理</strong></p> <p>Docker中所有的容器的配置，如挂载点、运行方式等都是以json文件进行配置，修改对应的json文件参数即可挂载指定文件夹。</p> <p>配置容器的json文件<br> <code>/var/lib/docker/containers/&lt;容器ID&gt;/config.v2.json</code><br> <code>/var/lib/docker/containers/&lt;容器ID&gt;/hostconfig.json</code></p> <p><strong>三、打开文件</strong></p> <ol><li><p>使用 <code>docker ps -a</code>拿到需要更改的container的12位ID，然后<code>docker inspect id</code>，拿到64位ID(终端最上面的那个ID)</p></li> <li><p>停止所有container 并使用<code>service docker stop</code>关闭docker服务（<strong>必须关闭Docker服务，否则无法修改成功</strong>）</p></li> <li><p>到目录<code>/var/lib/docker/containers/&lt;64位容器ID&gt;/</code>中复制 <code>config.v2.json</code>和 <code>hostconfig.json</code>两个文件到任意不用root权限的目录下，同时对原文件进行备份。</p> <p>4.在<code>~/</code>下新建两个同名文件(避免权限问题)<br> <code>cd ~/</code><br> <code>touch config.v2.json hostconfig.json</code></p></li></ol> <p>5.新开一个终端，进入到容器目录下，打开文件<br> <code>sudo -i</code> ，提升权限<br> <code>cd /var/lib/docker/containers/&lt;64位容器ID&gt;/</code></p> <p>修改前一定要先备份下，否则改错了就GG！<br> <code>cp config.v2.json config.v2.json.back</code><br> <code>cp hostconfig.json hostconfig.back</code></p> <p><strong>四、添加共享文件夹挂载信息</strong></p> <p>打开**<code>~/</code>目录**下的这两个文件</p> <p>1.修改<code>config.v2.json</code>文件</p> <p><img src="./assets/img/image-20230624001942212.e00fb2ef.png" alt="image-20230624001942212"></p> <p>在<code>MountPoints</code>参数下按照相应的格式进行添加相应的字段，<strong>注意，必须是绝对路径，且不能是/root，必须是/root/的二级子目录</strong>。</p> <p>2.修改<code>hostconfig.json</code>文件</p> <p>在<code>hostconfig.json</code>文件中的<code>Binds</code>参数添加宿主机和容器共享文件夹目录（<strong>注意，必须是绝对路径，且不能是/root，必须是/root/dataset这样的二级子目录</strong>）</p> <p><img src="./assets/img/20587097-181ef0aea6cb0724-1687536491371.9aa9cebe.png" alt="img"></p> <p><strong>五、修改容器配置</strong></p> <p><strong>把</strong><code>～/</code>目录下的<code>config.v2.json</code>和<code>hostconfig.json</code>两个文件内容，对应复制到以下文件中。<br> <code>/var/lib/docker/containers/&lt;容器ID&gt;/config.v2.json</code><br> <code>/var/lib/docker/containers/&lt;容器ID&gt;/hostconfig.json</code></p> <p><strong>六、启动docker 服务</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>service docker start
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_6-docker网络"><a href="#_6-docker网络" class="header-anchor">#</a> 6.Docker网络</h2> <p><strong>Bridge 网络</strong></p> <p><img src="./assets/img/two-container-network.70b9aa93.png" alt="docker-volume"></p> <h3 id="容器间通信"><a href="#容器间通信" class="header-anchor">#</a> <strong>容器间通信</strong></h3> <p><strong>两个容器都连接到了一个叫 docker0 的Linux bridge上</strong></p> <p>创建两个容器</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> container run <span class="token parameter variable">-d</span>  <span class="token parameter variable">--name</span> box1 busybox /bin/sh <span class="token parameter variable">-c</span> <span class="token string">&quot;while true; do sleep 3600; done&quot;</span>

<span class="token function">docker</span> container run <span class="token parameter variable">-d</span>  <span class="token parameter variable">--name</span> box2 busybox /bin/sh <span class="token parameter variable">-c</span> <span class="token string">&quot;while true; do sleep 3600; done&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> network <span class="token function">ls</span>
<span class="token function">docker</span> network inspect bridge
<span class="token comment">#查看网络</span>
brctl show
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>NETWORK ID     NAME      DRIVER    SCOPE
1847e179a316   bridge    bridge    <span class="token builtin class-name">local</span>
a647a4ad0b4f   <span class="token function">host</span>      <span class="token function">host</span>      <span class="token builtin class-name">local</span>
fbd81b56c009   none      null      <span class="token builtin class-name">local</span>
$ <span class="token function">docker</span> network inspect bridge
<span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bridge&quot;</span>,
        <span class="token string">&quot;Id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1847e179a316ee5219c951c2c21cf2c787d431d1ffb3ef621b8f0d1edd197b24&quot;</span>,
        <span class="token string">&quot;Created&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2021-07-01T15:28:09.265408946Z&quot;</span>,
        <span class="token string">&quot;Scope&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;local&quot;</span>,
        <span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bridge&quot;</span>,
        <span class="token string">&quot;EnableIPv6&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;IPAM&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;default&quot;</span>,
            <span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span> null,
            <span class="token string">&quot;Config&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">&quot;Subnet&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.17.0.0/16&quot;</span>,
                    <span class="token string">&quot;Gateway&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.17.0.1&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;Internal&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;Attachable&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;Ingress&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;ConfigFrom&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;Network&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;ConfigOnly&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;Containers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;03494b034694982fa085cc4052b6c7b8b9c046f9d5f85f30e3a9e716fad20741&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;box1&quot;</span>,
                <span class="token string">&quot;EndpointID&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;072160448becebb7c9c333dce9bbdf7601a92b1d3e7a5820b8b35976cf4fd6ff&quot;</span>,
                <span class="token string">&quot;MacAddress&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;02:42:ac:11:00:02&quot;</span>,
                <span class="token string">&quot;IPv4Address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.17.0.2/16&quot;</span>,
                <span class="token string">&quot;IPv6Address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>
            <span class="token punctuation">}</span>,
            <span class="token string">&quot;4f3303c84e5391ea37db664fd08683b01decdadae636aaa1bfd7bb9669cbd8de&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;box2&quot;</span>,
                <span class="token string">&quot;EndpointID&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;4cf0f635d4273066acd3075ec775e6fa405034f94b88c1bcacdaae847612f2c5&quot;</span>,
                <span class="token string">&quot;MacAddress&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;02:42:ac:11:00:03&quot;</span>,
                <span class="token string">&quot;IPv4Address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.17.0.3/16&quot;</span>,
                <span class="token string">&quot;IPv6Address&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;com.docker.network.bridge.default_bridge&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>,
            <span class="token string">&quot;com.docker.network.bridge.enable_icc&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>,
            <span class="token string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>,
            <span class="token string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0.0.0.0&quot;</span>,
            <span class="token string">&quot;com.docker.network.bridge.name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;docker0&quot;</span>,
            <span class="token string">&quot;com.docker.network.driver.mtu&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1500&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;Labels&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>brctl` 使用前需要安装, 对于CentOS, 可以通过 `sudo yum install -y bridge-utils` 安装. 对于Ubuntu, 可以通过 `sudo apt-get install -y bridge-utils
$ brctl show
bridge name     bridge id               STP enabled     interfaces
docker0         8000.0242759468cf       no              veth8c9bb82
                                                        vethd8f9afb
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>查看路由</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ ip route
default via 10.0.2.2 dev eth0 proto dhcp metric 100
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100
172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1
192.168.200.0/24 dev eth1 proto kernel scope link src 192.168.200.10 metric 101
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="外部访问容器-端口转发"><a href="#外部访问容器-端口转发" class="header-anchor">#</a> <strong>外部访问容器：端口转发</strong></h3> <p>不同host主机之间的容器通信</p> <p>创建容器</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> container run <span class="token parameter variable">-d</span> <span class="token parameter variable">--rm</span> <span class="token parameter variable">--name</span> web <span class="token parameter variable">-p</span> <span class="token number">8080</span>:80 nginx:1.20.0
<span class="token comment">#暴露端口，外部访问容器</span>
firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --add-port<span class="token operator">=</span><span class="token number">80</span>/tcp <span class="token parameter variable">--permanent</span>
<span class="token comment">#重启防火墙</span>
systemctl restart firewalld
<span class="token comment">#查看已经对外暴露的端口，确认端口是否已经暴露</span>
firewall-cmd <span class="token parameter variable">--zone</span><span class="token operator">=</span>public --list-ports
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="./assets/img/image-20230615014550650.ffee685c.png" alt="image-20230615014550650"></p> <p>测试容器间是否通信,让box1去请求web，通信返回一个index文件。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> container <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> box1 <span class="token function">wget</span> http://172.17.0.5
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230615014905449.37e64e8a.png" alt="image-20230615014905449"></p> <p>测试外部网络是否能访问容器，访问web暴露出来的8080端口</p> <p><img src="./assets/img/image-20230615015046323.90508b82.png" alt="image-20230615015046323"></p> <p><img src="./assets/img/image-20230615014928149.243d5bd7.png" alt="image-20230615014928149"></p> <p>同一host暴露出来的端口需唯一，不然后起的服务报错，端口被占用 。这样就保证外部所访问的容器是唯一的。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> container run <span class="token parameter variable">-d</span> <span class="token parameter variable">--rm</span> <span class="token parameter variable">--name</span> web2 <span class="token parameter variable">-p</span> <span class="token number">8080</span>:80 nginx:1.20.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230615031010565.37faaa85.png" alt="image-20230615031010565"></p> <p>如果network采用host模式，暴露出来是默认的80端口</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> container run <span class="token parameter variable">-d</span> <span class="token parameter variable">--rm</span> <span class="token parameter variable">--name</span> web1 <span class="token parameter variable">--network</span> <span class="token function">host</span> nginx:1.20.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230615031050706.e48defe9.png" alt="image-20230615031050706"></p> <h3 id="同一host中的不同bridge通信"><a href="#同一host中的不同bridge通信" class="header-anchor">#</a> 同一host中的不同bridge通信</h3> <p>创建和使用 bridge</p> <p>在上面的启动的容器中，断开web的连接</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> network disconnect bridge web
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230615020041753.4a9ab809.png" alt="image-20230615020041753"></p> <p>创建一个自己的mybridge</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> network create mybridge
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230615020459251.cfd4c129.png" alt="image-20230615020459251"></p> <p>web连接mybridge，要实现box1能通信web，box1也得连接mybridge,而box2是ping不同web。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> network connect mybridge web
<span class="token function">docker</span> container <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> box1 <span class="token function">ping</span> web
<span class="token function">docker</span> network connect mybridge box1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="./assets/img/image-20230615022050502.af823d32.png" alt="image-20230615022050502"></p> <p><img src="./assets/img/image-20230615022408022.ba7869da.png" alt="image-20230615022408022"></p> <p>创建时可指定路由和ip范围</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> network create <span class="token parameter variable">-d</span> bridge <span class="token parameter variable">--gateway</span> <span class="token number">172.200</span>.0.1 <span class="token parameter variable">--subnet</span> <span class="token number">172.200</span>.0.0/16 detailbridge
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230615022856154.a69f79cf.png" alt="image-20230615022856154"></p> <h3 id="容器通信的底层原理"><a href="#容器通信的底层原理" class="header-anchor">#</a> 容器通信的底层原理：</h3> <p><strong>-----------------------------------------网络命名空间和虚拟网络设备对</strong></p> <p>Linux的Namespace（命名空间）技术是一种隔离技术，常用的Namespace有 user namespace, process namespace, network namespace等</p> <p>网络命名空间 是 Linux 内核用来隔离不同容器间的网络资源（每个 Docker 容器都拥有一个独立的网络命名空间），网络命名空间主要隔离的资源包括：</p> <p>1.iptables规则表</p> <p>2.路由规则表</p> <p>3.网络设备列表</p> <p>如下图所示，当系统中拥有 3 个网络命名空间：</p> <p><img src="./assets/img/image-20230624000916878.275a97c2.png" alt="image-20230624000916878"></p> <p>由于不同的网络命名空间之间是相互隔离的，所以不同的网络命名空间之间并不能直接通信。比如在 网络命名空间A 配置了一个 IP 地址为 172.17.42.1 的设备，但在 网络命名空间B 里却不能访问，如下图所示：</p> <p><img src="./assets/img/image-20230624000945278.862776b8.png" alt="image-20230624000945278"></p> <p>就好比两台电脑，如果没有任何网线连接，它们之间是不能通信的。所以，Linux 内核提供了 虚拟网络设备对（veth） 这个功能，用于解决不同网络命名空间之间的通信。</p> <p>Docker 就是使用 虚拟网络设备对 来实现不同容器之间的通信，其原理如下图：</p> <p><img src="./assets/img/image-20230624001011324.8d516a1e.png" alt="image-20230624001011324"></p> <p><img src="./assets/img/image-20230615194209960.b5b39b95.png" alt="image-20230615194209960"></p> <p>以下模拟的是容器的通信原理，即不同命名空间的通信</p> <p>新建增加网络命名空间脚本</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> add-ns-to-br.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>

<span class="token assign-left variable">bridge</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">namespace</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token assign-left variable">addr</span><span class="token operator">=</span><span class="token variable">$3</span>

<span class="token comment">#虚拟网络设备对</span>
<span class="token comment">#在docker0上</span>
<span class="token assign-left variable">vethA</span><span class="token operator">=</span>veth-<span class="token variable">$namespace</span>
<span class="token comment">#在容器内</span>
<span class="token assign-left variable">vethB</span><span class="token operator">=</span>eth00-<span class="token variable">$namespace</span>
<span class="token comment">#新建命名空间</span>
<span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token function">add</span> <span class="token variable">$namespace</span>
<span class="token comment">#创建一个veth pair</span>
<span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> <span class="token variable">$vethA</span> <span class="token builtin class-name">type</span> veth peer name <span class="token variable">$vethB</span>
<span class="token comment">#设置虚拟网络设备所属命名空间</span>
<span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> <span class="token variable">$vethB</span> netns <span class="token variable">$namespace</span>
<span class="token comment">#给虚拟网络设备添加ip</span>
<span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token variable">$namespace</span> <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token variable">$addr</span> dev <span class="token variable">$vethB</span>
<span class="token comment">#开启网络命令空间 namespace vethB 端口</span>
<span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> <span class="token variable">$namespace</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> <span class="token variable">$vethB</span> up

<span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> <span class="token variable">$vethA</span> up

<span class="token function">sudo</span> brctl addif <span class="token variable">$bridge</span> <span class="token variable">$vethA</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>brctl --help查看使用命令 

Usage: brctl <span class="token punctuation">[</span>commands<span class="token punctuation">]</span>
commands:
   addbr           <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span>                <span class="token function">add</span> bridge
   delbr           <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span>                delete bridge
   addif           <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>device<span class="token operator">&gt;</span>       <span class="token function">add</span> interface to bridge
   delif           <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>device<span class="token operator">&gt;</span>       delete interface from bridge
   hairpin         <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>port<span class="token operator">&gt;</span> <span class="token punctuation">{</span>on<span class="token operator">|</span>off<span class="token punctuation">}</span>        turn hairpin on/off
   setageing       <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>time<span class="token operator">&gt;</span>         <span class="token builtin class-name">set</span> ageing <span class="token function">time</span>
   setbridgeprio   <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>prio<span class="token operator">&gt;</span>         <span class="token builtin class-name">set</span> bridge priority
   setfd           <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>time<span class="token operator">&gt;</span>         <span class="token builtin class-name">set</span> bridge forward delay
   sethello        <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>time<span class="token operator">&gt;</span>         <span class="token builtin class-name">set</span> hello <span class="token function">time</span>
   setmaxage       <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>time<span class="token operator">&gt;</span>         <span class="token builtin class-name">set</span> max message age
   setpathcost     <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>port<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>cost<span class="token operator">&gt;</span>  <span class="token builtin class-name">set</span> path cost
   setportprio     <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>port<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>prio<span class="token operator">&gt;</span>  <span class="token builtin class-name">set</span> port priority
   show            <span class="token punctuation">[</span> <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span> <span class="token punctuation">]</span>            show a list of bridges
   showmacs        <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span>                show a list of mac addrs
   showstp         <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span>                show bridge stp info
   stp             <span class="token operator">&lt;</span>bridge<span class="token operator">&gt;</span> <span class="token punctuation">{</span>on<span class="token operator">|</span>off<span class="token punctuation">}</span>       turn stp on/off

<span class="token punctuation">[</span>root@container1 docker<span class="token punctuation">]</span><span class="token comment"># ip netns help</span>
Usage: <span class="token function">ip</span> netns list
  <span class="token function">ip</span> netns <span class="token function">add</span> NAME
  <span class="token function">ip</span> netns <span class="token builtin class-name">set</span> NAME NETNSID
  <span class="token function">ip</span> <span class="token punctuation">[</span>-all<span class="token punctuation">]</span> netns delete <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span>
  <span class="token function">ip</span> netns identify <span class="token punctuation">[</span>PID<span class="token punctuation">]</span>
  <span class="token function">ip</span> netns pids NAME
  <span class="token function">ip</span> <span class="token punctuation">[</span>-all<span class="token punctuation">]</span> netns <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span> cmd <span class="token punctuation">..</span>.
  <span class="token function">ip</span> netns monitor
  <span class="token function">ip</span> netns list-id
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>启动两个容器</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> container run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> box3 <span class="token parameter variable">--network</span> mybridge  busybox /bin/sh <span class="token parameter variable">-c</span> <span class="token string">&quot;while true; do sleep 3600; done&quot;</span>
<span class="token function">docker</span> container run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> box4 <span class="token parameter variable">--network</span> mybridge  busybox /bin/sh <span class="token parameter variable">-c</span> <span class="token string">&quot;while true; do sleep 3600; done&quot;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="./assets/img/image-20230615164951809.90dba8c7.png" alt="image-20230615164951809"></p> <p><img src="./assets/img/image-20230615165300217.40145d8e.png" alt="image-20230615165300217"></p> <p>获取bridge name</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>brctl show
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230615165442594.fc58d3ad.png" alt="image-20230615165442594"></p> <p>设置命名空间</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sh</span> add-ns-to-br.sh br-1379584d9670 ns1 <span class="token number">172.19</span>.0.2/16
<span class="token function">sh</span> add-ns-to-br.sh br-1379584d9670 ns2 <span class="token number">172.19</span>.0.3/16
<span class="token comment">#查看网络命名空间list</span>
<span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token function">ls</span>
<span class="token comment">#进入命令空间查看ip信息</span>
<span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns2 
<span class="token function">ip</span> a
<span class="token function">ping</span> <span class="token number">172.19</span>.0.2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="./assets/img/image-20230615191429985.a8034735.png" alt="image-20230615191429985"></p> <p>以上就是模拟实现了不同网络命名空间之间的通信。</p> <p>断开虚拟网络设备，不同的网络命名空间就ping不同，实现隔离。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth-ns1 down
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230615204622919.391d4875.png" alt="image-20230615204622919"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#重启网卡</span>
<span class="token function">service</span> network restart
<span class="token comment">#查看配置信息</span>
<span class="token function">ifconfig</span>
<span class="token comment">#错误日志查看</span>
<span class="token function">cat</span> /var/log/messages <span class="token operator">|</span> <span class="token function">grep</span> network
<span class="token comment">#查看docker的情况</span>
systemctl status docker.service
<span class="token comment">#关掉网桥</span>
<span class="token function">ifconfig</span> docker0 down
<span class="token comment">#删除网桥</span>
brctl delbr docker0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_7-docker-compose"><a href="#_7-docker-compose" class="header-anchor">#</a> 7.Docker Compose</h2> <h3 id="docker-compose-介绍"><a href="#docker-compose-介绍" class="header-anchor">#</a> docker compose 介绍</h3> <p>要启动一些容器需进行一系列操作，一般我们使用shell脚本进行一键式操作。而基于这个需求，docker compose就是专门用于解决这种组合的操作。通过配置yml文件来实现。</p> <p><img src="./assets/img/docker-compose-intro.5a569317.png" alt="docker-compose-intro"></p> <h3 id="docker-compose-的安装"><a href="#docker-compose-的安装" class="header-anchor">#</a> docker compose 的安装</h3> <p>Windows和Mac在默认安装了docker desktop以后，docker-compose随之自动安装</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>PS C:\Users\Peng Xiao\docker.tips&gt; docker-compose --version
docker-compose version 1.29.2, build 5becea4c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Linux用户需要自行安装</p> <p>最新版本号可以在这里查询 https://github.com/docker/compose/releases</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose
$ sudo chmod +x /usr/local/bin/docker-compose
$ docker-compose --version
docker-compose version 1.29.2, build 5becea4c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>熟悉python的朋友，可以使用pip去安装docker-Compose</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#快速安装对应版本pip</span>
<span class="token function">wget</span> https://bootstrap.pypa.io/pip/3.6/get-pip.py
python3 get-pip.py
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>pip install docker<span class="token operator">-</span>compose
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="docker-compose基本使用"><a href="#docker-compose基本使用" class="header-anchor">#</a> docker-compose基本使用</h3> <p><strong>compose 文件的结构和版本</strong></p> <p>docker compose文件的语法说明 https://docs.docker.com/compose/compose-file/</p> <p><strong>基本语法结构</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>version: &quot;3.8&quot;

services: # 容器
  servicename: # 服务名字，这个名字也是内部 bridge网络可以使用的 DNS name
    image: # 镜像的名字
    command: # 可选，如果设置，则会覆盖默认镜像里的 CMD命令
    environment: # 可选，相当于 docker run里的 --env
    volumes: # 可选，相当于docker run里的 -v
    networks: # 可选，相当于 docker run里的 --network
    ports: # 可选，相当于 docker run里的 -p
  servicename2:

volumes: # 可选，相当于 docker volume create

networks: # 可选，相当于 docker network create
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>以 Python Flask + Redis练习：为例子，改造成一个docker-compose文件</p> <p>自定义的flask-demo</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> redis <span class="token keyword">import</span> Redis
<span class="token keyword">import</span> os
<span class="token keyword">import</span> socket

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
redis <span class="token operator">=</span> Redis<span class="token punctuation">(</span>host<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'REDIS_HOST'</span><span class="token punctuation">,</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    redis<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">'hits'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f&quot;Hello Container World! I have been seen </span><span class="token interpolation"><span class="token punctuation">{</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'hits'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> times and my hostname is </span><span class="token interpolation"><span class="token punctuation">{</span>socket<span class="token punctuation">.</span>gethostname<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.\n&quot;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>Dockerfile</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> python:3.9.5-slim</span>

<span class="token instruction"><span class="token keyword">RUN</span> python -m pip install --upgrade pip &amp;&amp; <span class="token operator">\</span>
    pip install flask redis &amp;&amp; <span class="token operator">\</span>
    groupadd -r flask &amp;&amp; useradd -r -g flask flask &amp;&amp; <span class="token operator">\</span>
    mkdir /src &amp;&amp; <span class="token operator">\</span>
    chown -R flask:flask /src</span>

<span class="token instruction"><span class="token keyword">USER</span> flask</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /src</span>

<span class="token instruction"><span class="token keyword">ENV</span> FLASK_APP=app.py REDIS_HOST=redis</span>

<span class="token instruction"><span class="token keyword">COPY</span> app.py /src/app.py</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 5000</span>

<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;flask&quot;</span>, <span class="token string">&quot;run&quot;</span>, <span class="token string">&quot;-h&quot;</span>, <span class="token string">&quot;0.0.0.0&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>未使用docker-compose之前的操作</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker image pull redis
docker image build -t flask-demo .

# create network
docker network create -d bridge demo-network

# create container
docker container run -d --name redis-server --network demo-network redis
docker container run -d --network demo-network --name flask-demo --env REDIS_HOST=redis-server -p 5000:5000 flask-demo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>只构建flask-demo镜像，后面可以直接拉取</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> image build <span class="token parameter variable">-t</span> flask-demo <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>docker-compose.yml 文件如下</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.8&quot;</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">flask-demo</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>latest
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> REDIS_HOST=redis<span class="token punctuation">-</span>server
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> demo<span class="token punctuation">-</span>network
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8080<span class="token punctuation">:</span><span class="token number">5000</span>

  <span class="token key atrule">redis-server</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>latest
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> demo<span class="token punctuation">-</span>network

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">demo-network</span><span class="token punctuation">:</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>基本操作</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>Usage:
<span class="token function">docker-compose</span> <span class="token punctuation">[</span>-f <span class="token operator">&lt;</span>arg<span class="token operator">&gt;</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>--profile <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>--<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> <span class="token punctuation">[</span>ARGS<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
<span class="token function">docker-compose</span> -h<span class="token operator">|</span>--help

Commands:
build              Build or rebuild services
config             Validate and view the Compose <span class="token function">file</span>
create             Create services
down               Stop and remove resources
events             Receive real <span class="token function">time</span> events from containers
<span class="token builtin class-name">exec</span>               Execute a <span class="token builtin class-name">command</span> <span class="token keyword">in</span> a running container
<span class="token builtin class-name">help</span>               Get <span class="token builtin class-name">help</span> on a <span class="token builtin class-name">command</span>
images             List images
<span class="token function">kill</span>               Kill containers
logs               View output from containers
pause              Pause services
port               Print the public port <span class="token keyword">for</span> a port binding
<span class="token function">ps</span>                 List containers
pull               Pull <span class="token function">service</span> images
push               Push <span class="token function">service</span> images
restart            Restart services
<span class="token function">rm</span>                 Remove stopped containers
run                Run a one-off <span class="token builtin class-name">command</span>
scale              Set number of containers <span class="token keyword">for</span> a <span class="token function">service</span>
start              Start services
stop               Stop services
<span class="token function">top</span>                Display the running processes
unpause            Unpause services
up                 Create and start containers
version            Show version information and quit
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#确认配置</span>
<span class="token function">docker-compose</span> config
<span class="token comment"># 从配置build的Dockerfile构建镜像，并不会启动容器，可以用于构建镜像或者更新镜像，没配置直接拉取镜像</span>
<span class="token function">docker-compose</span> build 
<span class="token comment">#获取镜像启动服务，镜像不存在，按情况从仓库拉取或build</span>
<span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="./assets/img/image-20230616003716859.520d3457.png" alt="image-20230616003716859"></p> <p><img src="./assets/img/image-20230615233815833.b5ed1b07.png" alt="image-20230615233815833"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#查看compose中的相关镜像，只显示该compose服务包含的镜像</span>
<span class="token function">docker-compose</span> images
<span class="token comment">#查看容器的运行情况</span>
<span class="token function">docker-compose</span> <span class="token function">ps</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="./assets/img/image-20230616003533812.bf2a35b4.png" alt="image-20230616003533812"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#对容器的操作就是docker的操作</span>
<span class="token function">docker</span> <span class="token function">ps</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> 0b <span class="token function">sh</span>
<span class="token comment">#对redis进行读写数据</span>
<span class="token builtin class-name">set</span> k1 v1
get k1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="./assets/img/image-20230616005138911.45d8822e.png" alt="image-20230616005138911"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#停止服务</span>
<span class="token function">docker-compose</span> stop
<span class="token comment">#移除停止container</span>
<span class="token function">docker-compose</span> <span class="token function">rm</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="./assets/img/image-20230616005633040.5e288364.png" alt="image-20230616005633040"></p> <h3 id="docker-compose-服务的构建、拉取与更新"><a href="#docker-compose-服务的构建、拉取与更新" class="header-anchor">#</a> docker-compose 服务的构建、拉取与更新</h3> <p>带有build的yml，会视情况构建镜像</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.8&quot;</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">flask-demo</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>latest
    <span class="token key atrule">build</span><span class="token punctuation">:</span>
      <span class="token key atrule">context</span><span class="token punctuation">:</span> .
      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> REDIS_HOST=redis<span class="token punctuation">-</span>server
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> demo<span class="token punctuation">-</span>network
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8080<span class="token punctuation">:</span><span class="token number">5000</span>

  <span class="token key atrule">redis-server</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>latest
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> demo<span class="token punctuation">-</span>network

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">demo-network</span><span class="token punctuation">:</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><img src="./assets/img/image-20230616010445855.9d224d4b.png" alt="image-20230616010445855"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#根据Dockerfile重新下载需要的镜像并构建容器,并启动</span>
<span class="token function">docker-compose</span> up <span class="token parameter variable">--build</span> <span class="token parameter variable">-d</span>
<span class="token comment">#重新启动单个容器</span>
<span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> <span class="token parameter variable">--build</span> flask
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>根据Dockerfile重新下载需要的镜像并构建容器，也就是说这句相当于是 docker-compose build --no-cache 和 docker-compose up -d 的集合体，<br>
意味着构建镜像的时候是根据Dockerfile的最新内容来的，而不会使用缓存，这样就避免了构建镜像时由于缓存造成的影响。</p></blockquote> <h3 id="docker-compose-网络"><a href="#docker-compose-网络" class="header-anchor">#</a> docker-compose 网络</h3> <p>如果配置没指定网络，则创建默认的网络docker-compose_default（文件目录_default）</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.8&quot;</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">box1</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="./assets/img/image-20230616030540760.17f766f3.png" alt="image-20230616030540760"></p> <p>多网络的配置</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.8&quot;</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">box1</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">command</span><span class="token punctuation">:</span> /bin/sh <span class="token punctuation">-</span>c &quot;while true; do sleep 3600; done&quot;
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> demo<span class="token punctuation">-</span>network1

  <span class="token key atrule">box2</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">command</span><span class="token punctuation">:</span> /bin/sh <span class="token punctuation">-</span>c &quot;while true; do sleep 3600; done&quot;
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> demo<span class="token punctuation">-</span>network2
  <span class="token key atrule">box3</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">command</span><span class="token punctuation">:</span> /bin/sh <span class="token punctuation">-</span>c &quot;while true; do sleep 3600; done&quot;
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> demo<span class="token punctuation">-</span>network1
      <span class="token punctuation">-</span> demo<span class="token punctuation">-</span>network2

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">demo-network1</span><span class="token punctuation">:</span>
    <span class="token key atrule">ipam</span><span class="token punctuation">:</span>
      <span class="token key atrule">driver</span><span class="token punctuation">:</span> defaule
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">subnet</span><span class="token punctuation">:</span> 172.28.0.0/16
  <span class="token key atrule">demo-network2</span><span class="token punctuation">:</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><img src="./assets/img/image-20230616024620573.48c40f63.png" alt="image-20230616024620573"></p> <p>按照配置，box1和box2 ping不通，都能和box3通信</p> <p><img src="./assets/img/image-20230616032013489.49724318.png" alt="image-20230616032013489"></p> <h3 id="水平扩展-scale"><a href="#水平扩展-scale" class="header-anchor">#</a> 水平扩展 scale</h3> <p>去掉端口指定，不然端口占用，启动失败</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>version: <span class="token string">&quot;3.8&quot;</span>

services:
  flask:
    build:
      context: <span class="token punctuation">..</span>/flask
      dockerfile: Dockerfile
    image: flask-demo:latest
    environment:
      - <span class="token assign-left variable">REDIS_HOST</span><span class="token operator">=</span>redis-server
    networks:
      - demo-network

  redis-server:
    image: redis:latest
    networks:
      - demo-network
  client:
    image: busybox
    command: /bin/sh <span class="token parameter variable">-c</span> <span class="token string">&quot;while true; do sleep 3600; done&quot;</span>
    networks:
      - demo-network

networks:
  demo-network:
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> <span class="token parameter variable">--build</span> <span class="token parameter variable">--scale</span> <span class="token assign-left variable">flask</span><span class="token operator">=</span><span class="token number">3</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230616034818237.defc8dce.png" alt="image-20230616034818237"></p> <p>与服务器通信</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">ping</span> flask
<span class="token comment">#busybox没有curl命令使用wget</span>
<span class="token function">wget</span> -O- flask:5000
<span class="token comment">#也可以用封装好的image</span>
xiaopeng163/net-box:latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p><code>wget -O-</code>以'-'作为file参数，那么数据将会被打印到标准输出，通常为控制台。</p></blockquote> <p><img src="./assets/img/image-20230616035043531.a86469fe.png" alt="image-20230616035043531"></p> <p><img src="./assets/img/image-20230616143909418.8be8a45f.png" alt="image-20230616143909418"></p> <p>外部如何访问，flask端口不能写死暴露？</p> <p>通过nginx反向代理</p> <p>nginx.conf 配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
  listen  80 default_server;
  location / {
    proxy_pass http://flask:5000;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>yml配置</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.8&quot;</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">flask</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span>
      <span class="token key atrule">context</span><span class="token punctuation">:</span> ../flask
      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile
    <span class="token key atrule">image</span><span class="token punctuation">:</span> flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>latest
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> REDIS_HOST=redis<span class="token punctuation">-</span>server
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> redis<span class="token punctuation">-</span>server
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> frontend
      <span class="token punctuation">-</span> backend

  <span class="token key atrule">redis-server</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>latest
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> backend
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>stable<span class="token punctuation">-</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8000<span class="token punctuation">:</span><span class="token number">80</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> flask
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ../nginx/nginx.conf<span class="token punctuation">:</span>/etc/nginx/conf.d/default.conf<span class="token punctuation">:</span>ro
      <span class="token punctuation">-</span> ../log/nginx<span class="token punctuation">:</span>/var/log/nginx
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> frontend

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
    <span class="token key atrule">backend</span><span class="token punctuation">:</span>
    <span class="token key atrule">frontend</span><span class="token punctuation">:</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><blockquote><p>服务的依赖：nginx依赖flask，flask依赖redis，通过depend_on配置来定义程序启动顺序</p> <p><strong>和</strong><code>ports</code><strong>的区别是，</strong><code>expose</code><strong>不会将端口暴露给主机，主机无法访问</strong><code>expose</code><strong>的端口。</strong></p></blockquote> <p>.dockerignore</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>.env
.dockerignore
Dockerfile
docker-compose.yaml
nginx.conf
var
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker-compose</span> config
<span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> <span class="token parameter variable">--build</span> <span class="token parameter variable">--scale</span> <span class="token assign-left variable">flask</span><span class="token operator">=</span><span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="./assets/img/image-20230616155516681.c2a2badb.png" alt="image-20230616155516681"></p> <p><img src="data:image/png;base64,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AAAGARIAAAAAGARIAAAAAGAQIAEAAACAQYAEAAAAAAYBEgAAAAAYBEgAAAAAYBAgAQAAAIBBgAQAAAAABgESAAAAABgESAAAAABgECABAAAAgEGABAAAAAAGARIAAAAAGARIAAAAAGAQIAEAAACAQYAEAAAAAAYBEgAAAAAYBEgAAAAAYKA88/gAAAGySURBVBAgAQAAAIBBgAQAAAAABgESAAAAABgESAAAAABgECABAAAAgEGABAAAAAAGARIAAAAAGARIAAAAAGAQIAEAAACAQYAEAAAAAAYBEgAAAAAYBEgAAAAAYBAgAQAAAIBBgAQAAAAABgESAAAAABgESAAAAABgECABAAAAgEGABAAAAAAGARIAAAAAGARIAAAAAGAQIAEAAACAQYAEAAAAAAYBEgAAAAAYBEgAAAAAYBAgAQAAAIBBgAQAAAAABgESAAAAABgESAAAAABgECABAAAAgEGABAAAAAAGARIAAAAAGARIAAAAAGAQIAEAAACAQYAEAAAAAAYBEgAAAAAYBEgAAAAAYBAgAQAAAIBBgAQAAAAABgESAAAAABgESAAAAABgECABAAAAgEGABAAAAAAGARIAAAAAGARIAAAAAGAQIAEAAACAQYAEAAAAAAYBEgAAAAAYBEgAAAAAYBAgAQAAAIBBgAQAAAAABgESAAAAABgESAAAAABgECABAAAAgEGABAAAAAAGARIAAAAAGARIAAAAAGAQIAEAAACAQYAEAAAAAAYBEgAAAAAY/w8Q+5K6uyOzjAAAAABJRU5ErkJggg==" alt="image-20230616155244344"></p> <h3 id="docker-compose-环境变量"><a href="#docker-compose-环境变量" class="header-anchor">#</a> docker compose 环境变量</h3> <p>上述涉及的redis若添加密码，无论写到代码里还是配置里都是不安全的，故可以写到.env里面，.env文件.dockerignore文件不上传。</p> <p>.env</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">REDIS_PASSWORD</span><span class="token operator">=</span>ABC123
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>yml文件</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.8&quot;</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">flask</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span>
      <span class="token key atrule">context</span><span class="token punctuation">:</span> ../flask
      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile
    <span class="token key atrule">image</span><span class="token punctuation">:</span> flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>latest
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> REDIS_HOST=redis<span class="token punctuation">-</span>server
      <span class="token punctuation">-</span> REDIS_PASS=$<span class="token punctuation">{</span>REDIS_PASSWORD<span class="token punctuation">}</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> frontend
      <span class="token punctuation">-</span> backend

  <span class="token key atrule">redis-server</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>latest
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>requirepass $<span class="token punctuation">{</span>REDIS_PASSWORD<span class="token punctuation">}</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> backend
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>stable<span class="token punctuation">-</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8000<span class="token punctuation">:</span><span class="token number">80</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> flask
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ../nginx/nginx.conf<span class="token punctuation">:</span>/etc/nginx/conf.d/default.conf<span class="token punctuation">:</span>ro
      <span class="token punctuation">-</span> ../log/nginx<span class="token punctuation">:</span>/var/log/nginx
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> frontend

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
    <span class="token key atrule">backend</span><span class="token punctuation">:</span>
    <span class="token key atrule">frontend</span><span class="token punctuation">:</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>app.py增加获取该变量</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> redis <span class="token keyword">import</span> StrictRedis
<span class="token keyword">import</span> os
<span class="token keyword">import</span> socket

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
redis <span class="token operator">=</span> StrictRedis<span class="token punctuation">(</span>host<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'REDIS_HOST'</span><span class="token punctuation">,</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> password<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'REDIS_PASS'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    redis<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">'hits'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f&quot;Hello Container World! I have been seen </span><span class="token interpolation"><span class="token punctuation">{</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'hits'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> times and my hostname is </span><span class="token interpolation"><span class="token punctuation">{</span>socket<span class="token punctuation">.</span>gethostname<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.\n&quot;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><img src="./assets/img/image-20230616161615653.62d54285.png" alt="image-20230616161615653"></p> <h3 id="docker-compose-健康检查"><a href="#docker-compose-健康检查" class="header-anchor">#</a> docker compose 健康检查</h3> <p>Dockerfile healthcheck https://docs.docker.com/engine/reference/builder/#healthcheck</p> <p>docker compose https://docs.docker.com/compose/compose-file/compose-file-v3/#healthcheck</p> <p>健康检查是容器运行状态的高级检查，主要是检查容器所运行的进程是否能正常的对外提供“服务”，比如一个数据库容器，我们不光 需要这个容器是up的状态，我们还要求这个容器的数据库进程能够正常对外提供服务，这就是所谓的健康检查。</p> <p><strong>容器的健康检查</strong></p> <p>容器本身有一个健康检查的功能，但是需要在Dockerfile里定义，或者在执行docker container run 的时候，通过下面的一些参数指定</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>--health-cmd string              Command to run to check health
--health-interval duration       Time between running the check
                                (ms|s|m|h) (default 0s)
--health-retries int             Consecutive failures needed to
                                report unhealthy
--health-start-period duration   Start period for the container to
                                initialize before starting
                                health-retries countdown
                                (ms|s|m|h) (default 0s)
--health-timeout duration        Maximum time to allow one check to
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>Dockerfile healthcheck示例源码</strong></p> <p>我们以下面的这个flask容器为例，Dockerfile如下</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> python:3.9.5-slim</span>

<span class="token instruction"><span class="token keyword">RUN</span> pip install flask redis &amp;&amp; <span class="token operator">\</span>
    apt-get update &amp;&amp; <span class="token operator">\</span>
    apt-get install -y curl &amp;&amp; <span class="token operator">\</span>
    groupadd -r flask &amp;&amp; useradd -r -g flask flask &amp;&amp; <span class="token operator">\</span>
    mkdir /src &amp;&amp; <span class="token operator">\</span>
    chown -R flask:flask /src</span>

<span class="token instruction"><span class="token keyword">USER</span> flask</span>

<span class="token instruction"><span class="token keyword">COPY</span> app.py /src/app.py</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /src</span>

<span class="token instruction"><span class="token keyword">ENV</span> FLASK_APP=app.py REDIS_HOST=redis</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> 5000</span>

<span class="token instruction"><span class="token keyword">HEALTHCHECK</span> <span class="token options"><span class="token property">--interval</span><span class="token punctuation">=</span><span class="token string">30s</span> <span class="token property">--timeout</span><span class="token punctuation">=</span><span class="token string">3s</span></span> <span class="token operator">\</span>
    <span class="token keyword">CMD</span> curl -f http://localhost:5000/ || exit 1</span>

<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;flask&quot;</span>, <span class="token string">&quot;run&quot;</span>, <span class="token string">&quot;-h&quot;</span>, <span class="token string">&quot;0.0.0.0&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>上面Dockerfili里的HEALTHCHECK 就是定义了一个健康检查。 会每隔30秒检查一次，如果失败就会退出，退出代码是1</p> <p>查看容器状态</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ docker container ls
CONTAINER ID   IMAGE        COMMAND                  CREATED       STATUS                            PORTS      NAMES
059c12486019   flask-demo   &quot;flask run -h 0.0.0.0&quot;   4 hours ago   Up 8 seconds (health: starting)   5000/tcp   dazzling_tereshkova
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>也可以通过docker container inspect 059 查看详情， 其中有有关health的</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;Health&quot;: {
&quot;Status&quot;: &quot;starting&quot;,
&quot;FailingStreak&quot;: 1,
&quot;Log&quot;: [
    {
        &quot;Start&quot;: &quot;2021-07-14T19:04:46.4054004Z&quot;,
        &quot;End&quot;: &quot;2021-07-14T19:04:49.4055393Z&quot;,
        &quot;ExitCode&quot;: -1,
        &quot;Output&quot;: &quot;Health check exceeded timeout (3s)&quot;
    }
]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>模拟实现故障，把redis停掉之后，经过3次检查，一直是不通的，然后health的状态会从starting变为 unhealthy</p> <p><img src="./assets/img/image-20230616165246979.68325347.png" alt="image-20230616165246979"></p> <p>重启redis，经过几秒钟，我们的flask 变成了healthy</p> <p><img src="./assets/img/image-20230616165405507.a8027444.png" alt="image-20230616165405507"></p> <p><strong>docker compose health示例</strong></p> <p>除了在Dockerfile中配置，还可以在docker-compose.yml文件中配置</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3.8&quot;</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">flask</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span>
      <span class="token key atrule">context</span><span class="token punctuation">:</span> ../flask
      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile
    <span class="token key atrule">image</span><span class="token punctuation">:</span> flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>latest
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> REDIS_HOST=redis<span class="token punctuation">-</span>server
    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>
      <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;CMD&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;curl&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-f&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://localhost:5000&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30s
      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 3s
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token key atrule">start_period</span><span class="token punctuation">:</span> 40s
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token key atrule">redis-server</span><span class="token punctuation">:</span>
        <span class="token key atrule">condition</span><span class="token punctuation">:</span> service_healthy
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> frontend
      <span class="token punctuation">-</span> backend

  <span class="token key atrule">redis-server</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>latest
    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>
      <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;CMD&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;redis-cli&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ping&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1s
      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 3s
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> backend
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>stable<span class="token punctuation">-</span>alpine
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8000<span class="token punctuation">:</span><span class="token number">80</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token key atrule">flask</span><span class="token punctuation">:</span>
        <span class="token key atrule">condition</span><span class="token punctuation">:</span> service_healthy
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ../nginx/nginx.conf<span class="token punctuation">:</span>/etc/nginx/conf.d/default.conf<span class="token punctuation">:</span>ro
      <span class="token punctuation">-</span> ../log/nginx<span class="token punctuation">:</span>/var/log/nginx
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> frontend

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
    <span class="token key atrule">backend</span><span class="token punctuation">:</span>
    <span class="token key atrule">frontend</span><span class="token punctuation">:</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p><img src="./assets/img/image-20230616172342028.431c63da.png" alt="image-20230616172342028"></p> <h3 id="一站式hadoop集群便于测试开发"><a href="#一站式hadoop集群便于测试开发" class="header-anchor">#</a> 一站式hadoop集群便于测试开发</h3> <p><a href="https://www.cnblogs.com/liugp/p/17279520.html" target="_blank" rel="noopener noreferrer">通过 docker-compose 快速部署 Hadoop 集群详细教程 - 大数据老司机 - 博客园 (cnblogs.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>包含了zookeeper 3.8.0，mysql5.7，hadoop3.3.5，hive3.1.3，spark 3.3.2，Flink1.17.0</p> <h4 id="_1、下载"><a href="#_1、下载" class="header-anchor">#</a> 1、下载</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>git clone https://gitee.com/hadoop-bigdata/docker-compose-hadoop.git
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_2、创建网络"><a href="#_2、创建网络" class="header-anchor">#</a> 2、创建网络</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code># 创建，注意不能使用hadoop_network，要不然启动hs2服务的时候会有问题！！！
docker network create hadoop-network

# 查看
docker network ls
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_3、部署-mysql5-7"><a href="#_3、部署-mysql5-7" class="header-anchor">#</a> 3、部署 mysql5.7</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd docker-compose-hadoop/mysql

docker-compose -f mysql-compose.yaml up -d

docker-compose -f mysql-compose.yaml ps

#root 密码：123456，以下是登录命令，注意一般在公司不能直接在命令行明文输入密码，要不然容易被安全抓，切记，切记！！！
docker exec -it mysql mysql -uroot -p123456
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="_4、部署-hadoop-hive"><a href="#_4、部署-hadoop-hive" class="header-anchor">#</a> 4、部署 Hadoop Hive</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>cd docker-compose-hadoop/hadoop_hive

docker-compose -f docker-compose.yaml up -d

# 查看
docker-compose -f docker-compose.yaml ps
# 查看指定列
docker ps --format &quot;table {{.ID}}\t{{.Names}}\t{{.Ports}}&quot;

# hive
docker exec -it hive-hiveserver2 hive -e &quot;show databases&quot;;

# hiveserver2
docker exec -it hive-hiveserver2 beeline -u jdbc:hive2://hive-hiveserver2:10000  -n hadoop -e &quot;show databases;&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>5.测试访问hdfs UI 和 yarn UI ，该项目设置的是http: //ip:30070 和http: //ip:30889</p> <p>6.yarn ui地址在镜像中写死了，如果没有进行转发处理，宿主机无法访问，可以进入hadoop-yarn-nm进行修改，写自己的域名，docker-compose.yaml中的暴露端口与之对应，然后重启。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.web-proxy.address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>container1:9111<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="./assets/img/image-20230618005439820.6df6da9e.png" alt="image-20230618005439820"></p> <p><img src="./assets/img/image-20230618010027391.b90d2853.png" alt="image-20230618010027391"></p> <h2 id="_8-docker-swarm"><a href="#_8-docker-swarm" class="header-anchor">#</a> 8.Docker Swarm</h2> <h3 id="docker-swarm-介绍"><a href="#docker-swarm-介绍" class="header-anchor">#</a> docker swarm 介绍</h3> <p>为什么不建议在生产环境中使用docker-compose</p> <ul><li>多机器如何管理？</li> <li>如果跨机器做scale横向扩展？</li> <li>容器失败退出时如何新建容器确保服务正常运行？</li> <li>如何确保零宕机时间？</li> <li>如何管理密码，Key等敏感数据？</li> <li>其它</li></ul> <p><strong>容器编排 swarm</strong></p> <p><img src="./assets/img/docker-compose_swarm.6e5c983a.png" alt="docker-swarm-intro"></p> <p>Swarm的基本架构</p> <p><img src="./assets/img/swarm_arch.33196797.png" alt="docker-swarm-arch"></p> <h3 id="swarm-单节点快速上手"><a href="#swarm-单节点快速上手" class="header-anchor">#</a> Swarm 单节点快速上手</h3> <p><strong>初始化</strong></p> <p>这个命令可以查看我们的docker engine有没有激活swarm模式， 默认是没有的，我们会看到</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker</span> info
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230616195332575.4147faf1.png" alt="image-20230616195332575"></p> <p>激活swarm，有两个方法：</p> <ul><li>初始化一个swarm集群，自己成为manager</li> <li>加入一个已经存在的swarm集群</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>Swarm Commands:
config      Manage Swarm configs
<span class="token function">node</span>        Manage Swarm nodes
secret      Manage Swarm secrets
<span class="token function">service</span>     Manage Swarm services
stack       Manage Swarm stacks
swarm       Manage Swarm



Usage:  <span class="token function">docker</span> swarm COMMAND

Manage Swarm

Commands:
ca          Display and rotate the root CA
init        Initialize a swarm
<span class="token function">join</span>        Join a swarm as a <span class="token function">node</span> and/or manager
join-token  Manage <span class="token function">join</span> tokens
leave       Leave the swarm
unlock      Unlock swarm
unlock-key  Manage the unlock key
update      Update the swarm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><img src="./assets/img/image-20230616201111290.2e06ac57.png" alt="image-20230616201111290"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#初始化一个集群</span>
<span class="token function">docker</span> swarm init
<span class="token comment">#查看集群节点</span>
<span class="token function">docker</span> <span class="token function">node</span> <span class="token function">ls</span>
<span class="token comment">#查看node的信息</span>
<span class="token function">docker</span> <span class="token function">node</span> inspect <span class="token operator">&lt;</span>node id<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><img src="./assets/img/image-20230616201211209.494d6cf9.png" alt="image-20230616201211209"></p> <p><strong>docker swarm init 背后发生了什么</strong></p> <p>主要是PKI和安全相关的自动化</p> <ul><li>创建swarm集群的根证书</li> <li>manager节点的证书</li> <li>其它节点加入集群需要的tokens</li></ul> <p>创建Raft数据库用于存储证书，配置，密码等数据</p> <p>RAFT相关资料</p> <ul><li>http://thesecretlivesofdata.com/raft/</li> <li>https://raft.github.io/</li> <li>https://docs.docker.com/engine/swarm/raft/</li></ul> <p>看动画学会 Raft 算法</p> <p>https://mp.weixin.qq.com/s/p8qBcIhM04REuQ-uG4gnbw</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>swarm join-token ：可以查看或更换join token。
<span class="token function">docker</span> swarm join-token worker：查看加入woker的命令。
<span class="token function">docker</span> swarm join-token manager：查看加入manager的命令
<span class="token function">docker</span> swarm join-token <span class="token parameter variable">--rotate</span> worker：重置woker的Token。
<span class="token function">docker</span> swarm join-token <span class="token parameter variable">-q</span> worker：仅打印Token。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#打开另外的虚拟机作为worker 加入，执行以下命令</span>
<span class="token function">docker</span> swarm <span class="token function">join</span> <span class="token parameter variable">--token</span> SWMTKN-1-3hocsrayh278lv0lz17g0ty5bxedekofilq3pbiaj9xskqcjmh-331n58myelyc6bej36wosd69v <span class="token number">192.168</span>.8.10:2377
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="./assets/img/image-20230617134719031.214ce232.png" alt="image-20230617134719031"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#打开manager所在的虚拟机，查看node情况</span>
<span class="token function">docker</span> <span class="token function">node</span> <span class="token function">ls</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="./assets/img/image-20230617134833434.96ce4028.png" alt="image-20230617134833434"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#创建服务</span>
<span class="token function">docker</span> <span class="token function">service</span> create <span class="token parameter variable">--name</span> nginx <span class="token parameter variable">-d</span> <span class="token parameter variable">--replicas</span> <span class="token number">3</span> nginx:stable-alpine
<span class="token function">docker</span> <span class="token function">service</span> <span class="token function">ps</span> nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>调节service的副本数在docker swarm中可以在创建service时，通过设置--replicas 来设置副本数，但是当服务运行起来后应该如何处理呢？docker 提供了scale命令来实现这个功能</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#scale 动态扩缩容</span>
<span class="token function">docker</span> <span class="token function">service</span> scale <span class="token assign-left variable">nginx</span><span class="token operator">=</span><span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="./assets/img/image-20230617143823599.049a1bfd.png" alt="image-20230617143823599"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#动态更新服务</span>
<span class="token function">docker</span> <span class="token function">service</span> update <span class="token parameter variable">--image</span> nginx:latest nginx
<span class="token comment">#动态回滚服务</span>
<span class="token function">docker</span> <span class="token function">service</span> update  <span class="token parameter variable">--rollback</span> nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="./assets/img/image-20230617144531651.738b9e8b.png" alt="image-20230617144531651"></p> <p><img src="./assets/img/image-20230617144619636.58a012bc.png" alt="image-20230617144619636"></p> <h3 id="docker-stack"><a href="#docker-stack" class="header-anchor">#</a> Docker Stack</h3> <p>docker 与docker-compose的区别是后者可以部署多个容器；</p> <p>docker swarm与docker stack的区别是stack可以部署多个服务；</p> <p>docker stack与docker-compose的区别，stack是集群式，compose是单机模式，多用于开发测试。</p> <p>stack获取不到.env，找到githup上的一种方法：</p> <p><a href="https://github.com/moby/moby/issues/29133" target="_blank" rel="noopener noreferrer"><code>docker stack deploy</code> in 1.13 doesn't load <code>.env</code> file as <code>docker-compose up</code> does · Issue #29133 · moby/moby (github.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">env</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> .env <span class="token operator">|</span> <span class="token function">grep</span> ^<span class="token punctuation">[</span>A-Z<span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token function">xargs</span><span class="token variable">)</span></span> <span class="token function">docker</span> stack deploy <span class="token parameter variable">-c</span> stack.yaml STACK
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>任务的编排可以进阶学习k8s。</p> <h2 id="_9-docker整合gitlab-cicd"><a href="#_9-docker整合gitlab-cicd" class="header-anchor">#</a> 9.Docker整合gitlab CICD</h2> <h3 id="单模块下部署"><a href="#单模块下部署" class="header-anchor">#</a> 单模块下部署</h3> <p><strong>Dockerfile配置</strong></p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> openjdk:8-jre-alpine</span>
<span class="token instruction"><span class="token keyword">VOLUME</span> /tmp</span>
<span class="token comment">###复制文件到容器app-springboot</span>
<span class="token instruction"><span class="token keyword">COPY</span> ./target/cicd-0.0.1-SNAPSHOT.jar app.jar</span>

<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;java&quot;</span>,<span class="token string">&quot;-Djava.security.egd=file:/dev/./urandom&quot;</span>,<span class="token string">&quot;-jar&quot;</span>,<span class="token string">&quot;/app.jar&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>.gitlab-ci.yml配置</strong></p> <p>单环境</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#1：需要用到的镜像</span>
<span class="token comment">#2：必须配置的一些环境变量。如果本地可不配置 DOCKER_HOST。</span>
<span class="token comment">#3：配置缓存，配置后，maven 下载的依赖可以被缓存起来，下次不需要重复去下载了。</span>
<span class="token comment">#4：配置需要用到的额外的服务。docker:dind，这个貌似是用于在 docker 中运行 docker 的一种东西，在项目的构建中需要。</span>
  <span class="token comment">#有时需要在容器内执行 docker 命令，比如：在 jenkins 容器内运行 docker 命令执行构建镜像</span>
  <span class="token comment">#直接在 docker 容器内嵌套安装 docker 未免太过臃肿</span>
  <span class="token comment">#更好的办法是：容器内仅部署 docker 命令行工具（作为客户端），实际执行交由宿主机内的 docker-engine（服务器）</span>
  <span class="token comment">#先启动一个docker:dind容器A，再启动一个docker容器B，容器B指定host为A容器内的docker daemon。</span>

<span class="token comment">#5：stages，这是 Gitlab CI 中的概念，Stages 表示构建阶段，就是一些按序执行的流程，具体执行是依赖于 Jobs 的。</span>
<span class="token comment">#6 ：定义的 Jobs 之一，用于构建 jar 包。内部又引入 maven 镜像来处理，负责执行 package 这一流程。script 为具体执行的脚本。</span>
<span class="token comment">#7：定义的 Jobs 之一，用于构建 Docker 镜像。负责执行 deploy 这一流程。具体执行 build 和 run。only 节点表示只监控 master 分支。</span>

<span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>latest  <span class="token comment">#1</span>
<span class="token key atrule">variables</span><span class="token punctuation">:</span>  <span class="token comment">#2</span>
  <span class="token key atrule">DOCKER_DRIVER</span><span class="token punctuation">:</span> overlay2
  <span class="token key atrule">DOCKER_HOST</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//192.168.8.10<span class="token punctuation">:</span><span class="token number">2375</span>  <span class="token comment"># docker host，本地可不写</span>
  <span class="token key atrule">DOCKER_TLS_CERTDIR</span><span class="token punctuation">:</span> <span class="token string">''</span>
  <span class="token key atrule">TAG</span><span class="token punctuation">:</span> root/hello<span class="token punctuation">-</span>spring<span class="token punctuation">:</span>v0.1  <span class="token comment"># 镜像名称</span>
<span class="token key atrule">cache</span><span class="token punctuation">:</span>  <span class="token comment">#3</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span> m2<span class="token punctuation">-</span>repo
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> .m2/repository
<span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token comment">#4</span>
  <span class="token punctuation">-</span> docker<span class="token punctuation">:</span>dind
<span class="token key atrule">stages</span><span class="token punctuation">:</span>  <span class="token comment">#5</span>
  <span class="token punctuation">-</span> package
  <span class="token punctuation">-</span> deploy
<span class="token key atrule">maven-package</span><span class="token punctuation">:</span>  <span class="token comment">#6</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> maven<span class="token punctuation">:</span>3.5.0<span class="token punctuation">-</span>jdk<span class="token punctuation">-</span><span class="token number">8</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> maven
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> package
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> mvn clean package <span class="token punctuation">-</span>Dmaven.test.skip=true
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> target/<span class="token important">*.jar</span>
<span class="token key atrule">build-master</span><span class="token punctuation">:</span>  <span class="token comment">#7</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>t $TAG .
    <span class="token punctuation">-</span> docker rm <span class="token punctuation">-</span>f test <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name test <span class="token punctuation">-</span>p 8888<span class="token punctuation">:</span>8888 $TAG
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> master
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>多环境</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#1：需要用到的镜像</span>
<span class="token comment">#2：必须配置的一些环境变量。如果本地可不配置 DOCKER_HOST。</span>
<span class="token comment">#3：配置缓存，配置后，maven 下载的依赖可以被缓存起来，下次不需要重复去下载了。</span>
<span class="token comment">#4：配置需要用到的额外的服务。docker:dind，这个貌似是用于在 docker 中运行 docker 的一种东西，在项目的构建中需要。</span>
  <span class="token comment">#有时需要在容器内执行 docker 命令，比如：在 jenkins 容器内运行 docker 命令执行构建镜像</span>
  <span class="token comment">#直接在 docker 容器内嵌套安装 docker 未免太过臃肿</span>
  <span class="token comment">#更好的办法是：容器内仅部署 docker 命令行工具（作为客户端），实际执行交由宿主机内的 docker-engine（服务器）</span>
  <span class="token comment">#先启动一个docker:dind容器A，再启动一个docker容器B，容器B指定host为A容器内的docker daemon。</span>

<span class="token comment">#5：stages，这是 Gitlab CI 中的概念，Stages 表示构建阶段，就是一些按序执行的流程，具体执行是依赖于 Jobs 的。</span>
<span class="token comment">#6 ：定义的 Jobs 之一，用于构建 jar 包。内部又引入 maven 镜像来处理，负责执行 package 这一流程。script 为具体执行的脚本。</span>
<span class="token comment">#7：定义的 Jobs 之一，用于构建 Docker 镜像。负责执行 deploy 这一流程。具体执行 build 和 run。only 节点表示只监控 master 分支。</span>

image: docker:latest  <span class="token comment">#1</span>
variables:  <span class="token comment">#2</span>
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://192.168.8.10:2375  <span class="token comment"># docker host，本地可不写</span>
  DOCKER_TLS_CERTDIR: <span class="token string">''</span>
  USERSERVICE_TAG: <span class="token string">':1.0'</span>  <span class="token comment"># 镜像版本号</span>
  USERSERVICE_NAME: cicd <span class="token comment">#镜像名称</span>
  USERSERVICE_RPORT: <span class="token number">8888</span> <span class="token comment">#镜像端口 容器内的端口与其不一致</span>
  USERSERVICE_DIRECTORY: cicd <span class="token comment">#模块目录</span>
  PROFILE_ACTIVE: prd
cache:  <span class="token comment">#3</span>
  key: m2-repo
  paths:
    - .m2/repository
services:  <span class="token comment">#4</span>
  - docker:dind
stages:  <span class="token comment">#5</span>
  - package
  - deploy-dev
  - deploy-prd
maven-package:  <span class="token comment">#6</span>
  image: maven:3.5.0-jdk-8
  tags:
    - maven
  stage: package
  script:
    - mvn clean package <span class="token parameter variable">-P</span> <span class="token variable">$PROFILE_ACTIVE</span> <span class="token parameter variable">-Dmaven.test.skip</span><span class="token operator">=</span>true
  artifacts:
    paths:
      - target/*.jar
build-dev:
  tags:
    - <span class="token function">docker</span>
  stage: deploy-dev
  script:
    - <span class="token function">docker</span> login <span class="token variable">$CI_REGISTRY</span> <span class="token parameter variable">-u</span> <span class="token variable">$CI_REGISTRY_USER</span> <span class="token parameter variable">-p</span> <span class="token variable">$CI_REGISTRY_PASSWORD</span>
    - <span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token variable">$USERSERVICE_NAME</span> <span class="token operator">||</span> <span class="token boolean">true</span>
    - <span class="token function">docker</span> rmi <span class="token parameter variable">-f</span> <span class="token variable">$CI_REGISTRY_IMAGE</span>/<span class="token variable">$USERSERVICE_NAME</span>-<span class="token variable">$PROFILE_ACTIVE</span><span class="token variable">$USERSERVICE_TAG</span> <span class="token operator">||</span> <span class="token boolean">true</span>
    - <span class="token function">docker</span> build <span class="token parameter variable">-f</span> Dockerfile <span class="token parameter variable">-t</span> <span class="token variable">$CI_REGISTRY_IMAGE</span>/<span class="token variable">$USERSERVICE_NAME</span>-<span class="token variable">$PROFILE_ACTIVE</span><span class="token variable">$USERSERVICE_TAG</span> <span class="token builtin class-name">.</span>
    - <span class="token function">docker</span> push <span class="token variable">$CI_REGISTRY_IMAGE</span>/<span class="token variable">$USERSERVICE_NAME</span>-<span class="token variable">$PROFILE_ACTIVE</span><span class="token variable">$USERSERVICE_TAG</span>
    - <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> <span class="token variable">$USERSERVICE_NAME</span> <span class="token parameter variable">-v</span> <span class="token variable">$USERSERVICE_NAME</span>:/apps <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token parameter variable">-p</span> <span class="token variable">$USERSERVICE_RPORT</span><span class="token builtin class-name">:</span><span class="token variable">$USERSERVICE_RPORT</span> <span class="token variable">$CI_REGISTRY_IMAGE</span>/<span class="token variable">$USERSERVICE_NAME</span>-<span class="token variable">$PROFILE_ACTIVE</span><span class="token variable">$USERSERVICE_TAG</span>
    - <span class="token function">docker</span> image prune <span class="token parameter variable">-f</span>
  only: <span class="token comment">#限制作业在什么时候创建，定义了哪些分支或标签(branches and tags)的作业会运行</span>
    refs: <span class="token comment">#分支</span>
      - dev
    <span class="token comment">#changes: # 下面的文件中任一文件发生改变</span>
    <span class="token comment">#  - .gitlab-ci.yml</span>
build-prd:  <span class="token comment">#7</span>
  tags:
    - <span class="token function">docker</span>
  stage: deploy-prd
  before_script:
    - <span class="token function">docker</span> login <span class="token variable">$CI_REGISTRY</span> <span class="token parameter variable">-u</span> <span class="token variable">$CI_REGISTRY_USER</span> <span class="token parameter variable">-p</span> <span class="token variable">$CI_REGISTRY_PASSWORD</span>
    - <span class="token function">docker</span> rmi <span class="token parameter variable">-f</span> <span class="token variable">$CI_REGISTRY_IMAGE</span>/<span class="token variable">$USERSERVICE_NAME</span>-<span class="token variable">$PROFILE_ACTIVE</span><span class="token variable">$USERSERVICE_TAG</span> <span class="token operator">||</span> <span class="token boolean">true</span>
    - <span class="token function">docker</span> build <span class="token parameter variable">-f</span> Dockerfile <span class="token parameter variable">-t</span> <span class="token variable">$CI_REGISTRY_IMAGE</span>/<span class="token variable">$USERSERVICE_NAME</span>-<span class="token variable">$PROFILE_ACTIVE</span><span class="token variable">$USERSERVICE_TAG</span> <span class="token builtin class-name">.</span>
    - <span class="token function">docker</span> push <span class="token variable">$CI_REGISTRY_IMAGE</span>/<span class="token variable">$USERSERVICE_NAME</span>-<span class="token variable">$PROFILE_ACTIVE</span><span class="token variable">$USERSERVICE_TAG</span>
    - <span class="token function">docker</span> image prune <span class="token parameter variable">-f</span>
    - <span class="token string">'which  ssh-agent || ( yum update -y  &amp;&amp; yum install openssh-client git -y )'</span>
    - <span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span>ssh-agent <span class="token parameter variable">-s</span><span class="token variable">)</span></span>
    - <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$SSH_PRIVATE_KEY</span>&quot;</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">'\r'</span> <span class="token operator">|</span> ssh-add -
    - <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ~/.ssh
    - <span class="token function">chmod</span> <span class="token number">700</span> ~/.ssh
    - ssh-keyscan <span class="token number">192.168</span>.8.103 <span class="token operator">&gt;&gt;</span> ~/.ssh/known_hosts <span class="token comment">#ssh-keyscan 从服务器收集 SSH公钥。 ssh-keyscan 是一个收集多个主机的 SSH 公共密钥的实用工具。它被设计用来帮助构建和验证 ssh_known_hosts 文件</span>
    - <span class="token function">chmod</span> <span class="token number">644</span> ~/.ssh/known_hosts
  script:
    <span class="token comment"># -tq 打印台静默不打印</span>
    - <span class="token function">ssh</span> <span class="token parameter variable">-tq</span> <span class="token number">192.168</span>.8.103 <span class="token operator">&lt;&lt;</span> EOF
    - <span class="token function">docker</span> login <span class="token variable">$CI_REGISTRY</span> <span class="token parameter variable">-u</span> <span class="token variable">$CI_REGISTRY_USER</span> <span class="token parameter variable">-p</span> <span class="token variable">$CI_REGISTRY_PASSWORD</span>
    - <span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token variable">$USERSERVICE_NAME</span> <span class="token operator">||</span> <span class="token boolean">true</span>
    - <span class="token function">docker</span> rmi <span class="token parameter variable">-f</span> <span class="token variable">$CI_REGISTRY_IMAGE</span>/<span class="token variable">$USERSERVICE_NAME</span>-<span class="token variable">$PROFILE_ACTIVE</span><span class="token variable">$USERSERVICE_TAG</span> <span class="token operator">||</span> <span class="token boolean">true</span>
    - <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> <span class="token variable">$USERSERVICE_NAME</span> <span class="token parameter variable">-v</span> <span class="token variable">$USERSERVICE_NAME</span>:/apps <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token parameter variable">-p</span> <span class="token variable">$USERSERVICE_RPORT</span><span class="token builtin class-name">:</span><span class="token variable">$USERSERVICE_RPORT</span> <span class="token variable">$CI_REGISTRY_IMAGE</span>/<span class="token variable">$USERSERVICE_NAME</span>-<span class="token variable">$PROFILE_ACTIVE</span><span class="token variable">$USERSERVICE_TAG</span>
    - <span class="token function">docker</span> image prune <span class="token parameter variable">-f</span>
    - <span class="token builtin class-name">exit</span>
    - EOF
  only:
    variables: <span class="token punctuation">[</span> <span class="token variable">$PROFILE_ACTIVE</span> <span class="token operator">==</span> <span class="token string">&quot;prd&quot;</span> <span class="token punctuation">]</span>
    refs:
      - master
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><h3 id="多模块合并部署"><a href="#多模块合并部署" class="header-anchor">#</a> 多模块合并部署</h3> <p><strong>根目录.gitlab-ci.yml配置</strong></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#stages:</span>
<span class="token comment">#  - triggers</span>
<span class="token comment">#  - triggers1</span>
<span class="token comment">#trigger_a:</span>
<span class="token comment">#  stage: triggers</span>
<span class="token comment">#  trigger:</span>
<span class="token comment">#    include: szbxl-service/szbxl-user-service/.gitlab-ci.yml</span>
<span class="token comment">#  rules:</span>
<span class="token comment">#    - changes:</span>
<span class="token comment">#        - szbxl-service/szbxl-user-service/*</span>
<span class="token comment">#trigger_b:</span>
<span class="token comment">#  stage: triggers1</span>
<span class="token comment">#  trigger:</span>
<span class="token comment">#    include: szbxl-getway/.gitlab-ci.yml</span>
<span class="token comment">#  rules:</span>
<span class="token comment">#    - changes:</span>
<span class="token comment">#        - szbxl-getway/*</span>

<span class="token key atrule">variables</span><span class="token punctuation">:</span> <span class="token comment">#2</span>
  <span class="token key atrule">DOCKER_DRIVER</span><span class="token punctuation">:</span> overlay2
  <span class="token key atrule">DOCKER_HOST</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//192.168.8.10<span class="token punctuation">:</span><span class="token number">2375</span>  <span class="token comment"># docker host，本地可不写</span>
  <span class="token key atrule">DOCKER_TLS_CERTDIR</span><span class="token punctuation">:</span> <span class="token string">''</span>
  <span class="token key atrule">PROFILE_ACTIVE</span><span class="token punctuation">:</span> prd <span class="token comment">#激活属性,dev/prod,从Gitlab的变量设置，这样定时部署可以动态指定</span>
  <span class="token key atrule">GIT_STRATEGY</span><span class="token punctuation">:</span> clone <span class="token comment">#Initialized empty Git repository as it did in the first run of the first job, it now says Reinitialized existing Git repository.</span>
  <span class="token comment">#https://stackoverflow.com/questions/57779750/does-gitlab-runner-or-docker-cache-the-builds-directory-by-default</span>

<span class="token comment"># 多模块.gitlab-ci.yml</span>
<span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> service_first<span class="token punctuation">-</span>package
  <span class="token punctuation">-</span> service_first<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>deploy
  <span class="token punctuation">-</span> service_first<span class="token punctuation">-</span>prd<span class="token punctuation">-</span>deploy
  <span class="token punctuation">-</span> service_second<span class="token punctuation">-</span>package
  <span class="token punctuation">-</span> service_second<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>deploy
  <span class="token punctuation">-</span> service_second<span class="token punctuation">-</span>prd<span class="token punctuation">-</span>deploy
<span class="token key atrule">include</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">local</span><span class="token punctuation">:</span> service_first/.gitlab<span class="token punctuation">-</span>ci.yml
  <span class="token punctuation">-</span> <span class="token key atrule">local</span><span class="token punctuation">:</span> service_second/.gitlab<span class="token punctuation">-</span>ci.yml

<span class="token comment">#include</span>
  <span class="token comment">#全局关键字。可以在本地的gitlab-ci.yml文件中引入其他地方的gitlab-ci.yml的配置文件。</span>
  <span class="token comment">#</span>
  <span class="token comment">#include:local</span>
  <span class="token comment">#可以使用include:local来引入同一个仓库同一个分支中的其他配置文件（其他配置文件必须是.yml 或者.ymal扩展名）</span>
  <span class="token comment">#include:project</span>
      <span class="token comment">#可以通过include:project 来引入同一个gitlab 服务中其他项目中的gitlab-ci.yml配置</span>
      <span class="token comment">#主要有下面几部分构成，</span>
      <span class="token comment">#</span>
      <span class="token comment">#project：表在该gitlab服务器中的项目地址</span>
      <span class="token comment">#file：一个数组，表引入该项目中的哪些文件</span>
      <span class="token comment">#ref：非必须，表该项目中的那个分支。没有就是master(main)</span>
  <span class="token comment">#include:remote</span>
    <span class="token comment">#使用include:remote 可以通过一个完整的URL地址加载远端的gitlab-ci.yml的配置文件。</span>
    <span class="token comment">#远端的配置文件使用HTTP/GTTPS 的GET请求可以获取的到</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>子模块一目录<strong>Dockerfile配置</strong></p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token comment"># 基础镜像</span>
<span class="token comment"># 不能使用openjdk:8-jre-alpine，原因如下：</span>
<span class="token comment"># 1、会导致easy-captcha验证码生成失败。</span>
<span class="token comment"># 2、 Docker启动会报错：ERROR: failed to launch: exec.d: failed to execute exec.d file at path '/layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/memory-calculator': exit status 1</span>
<span class="token instruction"><span class="token keyword">FROM</span> openjdk:8-jre-alpine</span>

<span class="token comment"># 镜像作者</span>
<span class="token instruction"><span class="token keyword">LABEL</span> author=<span class="token string">&quot;gordon&quot;</span></span>

<span class="token comment"># 指定容器内的时区</span>
<span class="token instruction"><span class="token keyword">RUN</span> echo <span class="token string">&quot;Asia/Shanghai&quot;</span> &gt; /etc/timezone</span>

<span class="token comment"># 环境变量</span>
<span class="token instruction"><span class="token keyword">ENV</span> MYPATH /apps/service_first/</span>

<span class="token comment"># 创建项目存放路径</span>
<span class="token instruction"><span class="token keyword">RUN</span> mkdir -p <span class="token variable">${MYPATH}</span></span>

<span class="token comment"># 指定工作目录</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> <span class="token variable">${MYPATH}</span></span>

<span class="token comment"># 尽量采用指定路径挂载,不然会生成很多临时挂载垃圾文件</span>
<span class="token comment"># 匿名挂载目录(宿主机位置：/var/lib/docker/volumes/xxxxxxxxxxxxxxxx)</span>
<span class="token comment"># 查看挂载目录：docker inspect szbxl-user-service</span>
<span class="token comment"># 查看所有挂载卷：docker volume ls</span>
<span class="token comment">#VOLUME ${MYPATH}</span>

<span class="token comment"># Tomcat 默认使用/tmp作为工作目录。这个命令的效果是：在宿主机的/var/lib/docker目录下创建一个临时文件并把它链接到容器中的/tmp目录</span>
<span class="token comment">#VOLUME /tmp</span>
<span class="token comment">#VOLUME /log</span>

<span class="token comment"># 添加jar包到指定路径,当前目录是WORKDIR</span>
<span class="token instruction"><span class="token keyword">COPY</span> service_first/target/*.jar app.jar</span>

<span class="token comment"># 暴露端口</span>
<span class="token comment">#EXPOSE 802</span>

<span class="token comment"># 启动容器执行命令</span>
<span class="token comment">#ENTRYPOINT [&quot;java&quot;,&quot;-Djava.security.egd=file:/dev/./urandom&quot;,&quot;-jar&quot;,&quot;app.jar&quot;]</span>
<span class="token comment">#ENTRYPOINT [&quot;sh&quot;, &quot;-c&quot;, &quot;java --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.lang.reflect=ALL-UNNAMED -Djava.security.egd=file:/dev/./urandom -jar app.jar&quot;]</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;java&quot;</span>,<span class="token string">&quot;-Djava.security.egd=file:/dev/./urandom&quot;</span>,<span class="token string">&quot;-jar&quot;</span>,<span class="token string">&quot;app.jar&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>子模块一目录.gitlab-ci.yml配置</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#1：需要用到的镜像</span>
<span class="token comment">#2：必须配置的一些环境变量。如果本地可不配置 DOCKER_HOST。</span>
<span class="token comment">#3：配置缓存，配置后，maven 下载的依赖可以被缓存起来，下次不需要重复去下载了。</span>
<span class="token comment">#4：配置需要用到的额外的服务。docker:dind，这个貌似是用于在 docker 中运行 docker 的一种东西，在项目的构建中需要。</span>
  <span class="token comment">#有时需要在容器内执行 docker 命令，比如：在 jenkins 容器内运行 docker 命令执行构建镜像</span>
  <span class="token comment">#直接在 docker 容器内嵌套安装 docker 未免太过臃肿</span>
  <span class="token comment">#更好的办法是：容器内仅部署 docker 命令行工具（作为客户端），实际执行交由宿主机内的 docker-engine（服务器）</span>
  <span class="token comment">#先启动一个docker:dind容器A，再启动一个docker容器B，容器B指定host为A容器内的docker daemon。</span>

<span class="token comment">#5：stages，这是 Gitlab CI 中的概念，Stages 表示构建阶段，就是一些按序执行的流程，具体执行是依赖于 Jobs 的。</span>
<span class="token comment">#6 ：定义的 Jobs 之一，用于构建 jar 包。内部又引入 maven 镜像来处理，负责执行 package 这一流程。script 为具体执行的脚本。</span>
<span class="token comment">#7：定义的 Jobs 之一，用于构建 Docker 镜像。负责执行 deploy 这一流程。具体执行 build 和 run。only 节点表示只监控 master 分支。</span>

<span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>latest  <span class="token comment">#1</span>
<span class="token key atrule">variables</span><span class="token punctuation">:</span>  <span class="token comment">#2</span>
  <span class="token comment">#根目录已提供</span>
  <span class="token comment">#DOCKER_DRIVER: overlay2</span>
  <span class="token comment">#DOCKER_HOST: tcp://192.168.8.10:2375  # docker host，本地可不写</span>
  <span class="token comment">#DOCKER_TLS_CERTDIR: ''</span>
  <span class="token comment">#PROFILE_ACTIVE: prd</span>
  <span class="token key atrule">FIRST_TAG</span><span class="token punctuation">:</span> <span class="token string">':1.0'</span>  <span class="token comment"># 镜像版本号</span>
  <span class="token key atrule">FIRST_NAME</span><span class="token punctuation">:</span> service_first <span class="token comment">#镜像名称</span>
  <span class="token key atrule">FIRST_RPORT</span><span class="token punctuation">:</span> <span class="token number">8888</span> <span class="token comment">#镜像端口 容器内的端口与其不一致</span>
  <span class="token key atrule">FIRST_DIRECTORY</span><span class="token punctuation">:</span> service_first <span class="token comment">#模块目录</span>

<span class="token key atrule">cache</span><span class="token punctuation">:</span>  <span class="token comment">#3</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span> m2<span class="token punctuation">-</span>repo
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> .m2/repository
<span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token comment">#4</span>
  <span class="token punctuation">-</span> docker<span class="token punctuation">:</span>dind
<span class="token key atrule">stages</span><span class="token punctuation">:</span>  <span class="token comment">#5</span>
  <span class="token punctuation">-</span> service_first<span class="token punctuation">-</span>package
  <span class="token punctuation">-</span> service_first<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>deploy
  <span class="token punctuation">-</span> service_first<span class="token punctuation">-</span>prd<span class="token punctuation">-</span>deploy
<span class="token key atrule">maven-package:service_first</span><span class="token punctuation">:</span>  <span class="token comment">#6</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> maven<span class="token punctuation">:</span>3.5.0<span class="token punctuation">-</span>jdk<span class="token punctuation">-</span><span class="token number">8</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> maven
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> service_first<span class="token punctuation">-</span>package
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token comment">#mvn clean package -pl service_first -am -Dmaven.test.skip=true -pl --projects &lt;arg&gt; 构建制定的模块，模块间用逗号分隔；-am --also-make 同时构建所列模块的依赖模块；</span>
    <span class="token punctuation">-</span> mvn clean package <span class="token punctuation">-</span>P $PROFILE_ACTIVE <span class="token punctuation">-</span>Dmaven.test.skip=true <span class="token punctuation">-</span>pl $FIRST_DIRECTORY <span class="token punctuation">-</span>am
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> $FIRST_DIRECTORY/target/<span class="token important">*.jar</span>
<span class="token key atrule">build-dev:service_first</span><span class="token punctuation">:</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> service_first<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>deploy
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker login $CI_REGISTRY <span class="token punctuation">-</span>u $CI_REGISTRY_USER <span class="token punctuation">-</span>p $CI_REGISTRY_PASSWORD
    <span class="token punctuation">-</span> docker rm <span class="token punctuation">-</span>f $FIRST_NAME <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker rmi <span class="token punctuation">-</span>f $CI_REGISTRY_IMAGE/$FIRST_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$FIRST_TAG <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>f $FIRST_DIRECTORY/Dockerfile <span class="token punctuation">-</span>t $CI_REGISTRY_IMAGE/$FIRST_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$FIRST_TAG .
    <span class="token punctuation">-</span> docker push $CI_REGISTRY_IMAGE/$FIRST_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$FIRST_TAG
    <span class="token punctuation">-</span> docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name $FIRST_NAME <span class="token punctuation">-</span>v /apps/$FIRST_DIRECTORY<span class="token punctuation">:</span>/apps/$FIRST_DIRECTORY/log <span class="token punctuation">-</span><span class="token punctuation">-</span>privileged=true <span class="token punctuation">-</span>p $FIRST_RPORT<span class="token punctuation">:</span>$FIRST_RPORT $CI_REGISTRY_IMAGE/$FIRST_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$FIRST_TAG
    <span class="token punctuation">-</span> docker image prune <span class="token punctuation">-</span>f
  <span class="token key atrule">only</span><span class="token punctuation">:</span> <span class="token comment">#限制作业在什么时候创建，定义了哪些分支或标签(branches and tags)的作业会运行</span>
    <span class="token key atrule">refs</span><span class="token punctuation">:</span> <span class="token comment">#分支</span>
      <span class="token punctuation">-</span> dev
    <span class="token comment">#changes: # 下面的文件中任一文件发生改变</span>
    <span class="token comment">#  - .gitlab-ci.yml</span>
<span class="token key atrule">build-prd:service_first</span><span class="token punctuation">:</span> <span class="token comment">#7</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> service_first<span class="token punctuation">-</span>prd<span class="token punctuation">-</span>deploy
  <span class="token key atrule">before_script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker login $CI_REGISTRY <span class="token punctuation">-</span>u $CI_REGISTRY_USER <span class="token punctuation">-</span>p $CI_REGISTRY_PASSWORD
    <span class="token punctuation">-</span> docker rmi <span class="token punctuation">-</span>f $CI_REGISTRY_IMAGE/$FIRST_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$FIRST_TAG <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>f $FIRST_DIRECTORY/Dockerfile <span class="token punctuation">-</span>t $CI_REGISTRY_IMAGE/$FIRST_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$FIRST_TAG .
    <span class="token punctuation">-</span> docker push $CI_REGISTRY_IMAGE/$FIRST_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$FIRST_TAG
    <span class="token punctuation">-</span> docker image prune <span class="token punctuation">-</span>f
    <span class="token punctuation">-</span> <span class="token string">'which  ssh-agent || ( yum update -y  &amp;&amp; yum install openssh-client git -y )'</span>
    <span class="token punctuation">-</span> eval $(ssh<span class="token punctuation">-</span>agent <span class="token punctuation">-</span>s)
    <span class="token punctuation">-</span> echo &quot;$SSH_PRIVATE_KEY&quot; <span class="token punctuation">|</span> tr <span class="token punctuation">-</span>d '\r' <span class="token punctuation">|</span> ssh<span class="token punctuation">-</span>add <span class="token punctuation">-</span>
    <span class="token punctuation">-</span> mkdir <span class="token punctuation">-</span>p ~/.ssh
    <span class="token punctuation">-</span> chmod 700 ~/.ssh
    <span class="token punctuation">-</span> ssh<span class="token punctuation">-</span>keyscan 192.168.8.103 <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> ~/.ssh/known_hosts <span class="token comment">#ssh-keyscan 从服务器收集 SSH公钥。 ssh-keyscan 是一个收集多个主机的 SSH 公共密钥的实用工具。它被设计用来帮助构建和验证 ssh_known_hosts 文件</span>
    <span class="token punctuation">-</span> chmod 644 ~/.ssh/known_hosts
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token comment"># -tq 打印台静默不打印</span>
    <span class="token punctuation">-</span> ssh <span class="token punctuation">-</span>tq 192.168.8.103 &lt;&lt; EOF
    <span class="token punctuation">-</span> docker login $CI_REGISTRY <span class="token punctuation">-</span>u $CI_REGISTRY_USER <span class="token punctuation">-</span>p $CI_REGISTRY_PASSWORD
    <span class="token punctuation">-</span> docker rm <span class="token punctuation">-</span>f $FIRST_NAME <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker rmi <span class="token punctuation">-</span>f $CI_REGISTRY_IMAGE/$FIRST_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$FIRST_TAG <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name $FIRST_NAME <span class="token punctuation">-</span>v /apps/$FIRST_DIRECTORY<span class="token punctuation">:</span>/apps/$FIRST_DIRECTORY/log <span class="token punctuation">-</span><span class="token punctuation">-</span>privileged=true <span class="token punctuation">-</span>p $FIRST_RPORT<span class="token punctuation">:</span>$FIRST_RPORT $CI_REGISTRY_IMAGE/$FIRST_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$FIRST_TAG
    <span class="token punctuation">-</span> docker image prune <span class="token punctuation">-</span>f
    <span class="token punctuation">-</span> exit
    <span class="token punctuation">-</span> EOF
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token key atrule">variables</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> $PROFILE_ACTIVE == &quot;prd&quot; <span class="token punctuation">]</span>
    <span class="token key atrule">refs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> main
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br></div></div><p>子模块二目录<strong>Dockerfile配置</strong></p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token comment"># 基础镜像</span>
<span class="token comment"># 不能使用openjdk:8-jre-alpine，原因如下：</span>
<span class="token comment"># 1、会导致easy-captcha验证码生成失败。</span>
<span class="token comment"># 2、 Docker启动会报错：ERROR: failed to launch: exec.d: failed to execute exec.d file at path '/layers/paketo-buildpacks_bellsoft-liberica/helper/exec.d/memory-calculator': exit status 1</span>
<span class="token instruction"><span class="token keyword">FROM</span> openjdk:8-jre-alpine</span>

<span class="token comment"># 镜像作者</span>
<span class="token instruction"><span class="token keyword">LABEL</span> author=<span class="token string">&quot;gordon&quot;</span></span>

<span class="token comment"># 指定容器内的时区</span>
<span class="token instruction"><span class="token keyword">RUN</span> echo <span class="token string">&quot;Asia/Shanghai&quot;</span> &gt; /etc/timezone</span>

<span class="token comment"># 环境变量</span>
<span class="token instruction"><span class="token keyword">ENV</span> MYPATH /apps/service_second/</span>

<span class="token comment"># 创建项目存放路径</span>
<span class="token instruction"><span class="token keyword">RUN</span> mkdir -p <span class="token variable">${MYPATH}</span></span>

<span class="token comment"># 指定工作目录</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> <span class="token variable">${MYPATH}</span></span>

<span class="token comment"># 尽量采用指定路径挂载,不然会生成很多临时挂载垃圾文件</span>
<span class="token comment"># 匿名挂载目录(宿主机位置：/var/lib/docker/volumes/xxxxxxxxxxxxxxxx)</span>
<span class="token comment"># 查看挂载目录：docker inspect szbxl-user-service</span>
<span class="token comment"># 查看所有挂载卷：docker volume ls</span>
<span class="token comment">#VOLUME ${MYPATH}</span>

<span class="token comment"># Tomcat 默认使用/tmp作为工作目录。这个命令的效果是：在宿主机的/var/lib/docker目录下创建一个临时文件并把它链接到容器中的/tmp目录</span>
<span class="token comment">#VOLUME /tmp</span>
<span class="token comment">#VOLUME /log</span>

<span class="token comment"># 添加jar包到指定路径</span>
<span class="token instruction"><span class="token keyword">COPY</span> service_second/target/*.jar app.jar</span>

<span class="token comment"># 暴露端口</span>
<span class="token comment">#EXPOSE 802</span>

<span class="token comment"># 启动容器执行命令</span>
<span class="token comment">#ENTRYPOINT [&quot;java&quot;,&quot;-Djava.security.egd=file:/dev/./urandom&quot;,&quot;-jar&quot;,&quot;app.jar&quot;]</span>
<span class="token comment">#ENTRYPOINT [&quot;sh&quot;, &quot;-c&quot;, &quot;java --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.lang.reflect=ALL-UNNAMED -Djava.security.egd=file:/dev/./urandom -jar app.jar&quot;]</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;java&quot;</span>,<span class="token string">&quot;-Djava.security.egd=file:/dev/./urandom&quot;</span>,<span class="token string">&quot;-jar&quot;</span>,<span class="token string">&quot;app.jar&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>子模块一目录.gitlab-ci.yml配置</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#1：需要用到的镜像</span>
<span class="token comment">#2：必须配置的一些环境变量。如果本地可不配置 DOCKER_HOST。</span>
<span class="token comment">#3：配置缓存，配置后，maven 下载的依赖可以被缓存起来，下次不需要重复去下载了。</span>
<span class="token comment">#4：配置需要用到的额外的服务。docker:dind，这个貌似是用于在 docker 中运行 docker 的一种东西，在项目的构建中需要。</span>
  <span class="token comment">#有时需要在容器内执行 docker 命令，比如：在 jenkins 容器内运行 docker 命令执行构建镜像</span>
  <span class="token comment">#直接在 docker 容器内嵌套安装 docker 未免太过臃肿</span>
  <span class="token comment">#更好的办法是：容器内仅部署 docker 命令行工具（作为客户端），实际执行交由宿主机内的 docker-engine（服务器）</span>
  <span class="token comment">#先启动一个docker:dind容器A，再启动一个docker容器B，容器B指定host为A容器内的docker daemon。</span>

<span class="token comment">#5：stages，这是 Gitlab CI 中的概念，Stages 表示构建阶段，就是一些按序执行的流程，具体执行是依赖于 Jobs 的。</span>
<span class="token comment">#6 ：定义的 Jobs 之一，用于构建 jar 包。内部又引入 maven 镜像来处理，负责执行 package 这一流程。script 为具体执行的脚本。</span>
<span class="token comment">#7：定义的 Jobs 之一，用于构建 Docker 镜像。负责执行 deploy 这一流程。具体执行 build 和 run。only 节点表示只监控 master 分支。</span>

<span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>latest  <span class="token comment">#1</span>
<span class="token key atrule">variables</span><span class="token punctuation">:</span>  <span class="token comment">#2</span>
  <span class="token comment">#根目录已提供</span>
  <span class="token comment">#DOCKER_DRIVER: overlay2</span>
  <span class="token comment">#DOCKER_HOST: tcp://192.168.8.10:2375  # docker host，本地可不写</span>
  <span class="token comment">#DOCKER_TLS_CERTDIR: ''</span>
  <span class="token comment">#PROFILE_ACTIVE: prd</span>
  <span class="token key atrule">SECOND_TAG</span><span class="token punctuation">:</span> <span class="token string">':1.0'</span>  <span class="token comment"># 镜像版本号</span>
  <span class="token key atrule">SECOND_NAME</span><span class="token punctuation">:</span> service_second <span class="token comment">#镜像名称</span>
  <span class="token key atrule">SECOND_RPORT</span><span class="token punctuation">:</span> <span class="token number">9999</span> <span class="token comment">#镜像端口 容器内的端口与其不一致</span>
  <span class="token key atrule">SECOND_DIRECTORY</span><span class="token punctuation">:</span> service_second <span class="token comment">#模块目录</span>

<span class="token key atrule">cache</span><span class="token punctuation">:</span>  <span class="token comment">#3</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span> m2<span class="token punctuation">-</span>repo
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> .m2/repository
<span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token comment">#4</span>
  <span class="token punctuation">-</span> docker<span class="token punctuation">:</span>dind
<span class="token key atrule">stages</span><span class="token punctuation">:</span>  <span class="token comment">#5</span>
  <span class="token punctuation">-</span> service_second<span class="token punctuation">-</span>package
  <span class="token punctuation">-</span> service_second<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>deploy
  <span class="token punctuation">-</span> service_second<span class="token punctuation">-</span>prd<span class="token punctuation">-</span>deploy
<span class="token key atrule">maven-package:service_second</span><span class="token punctuation">:</span>  <span class="token comment">#6</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> maven<span class="token punctuation">:</span>3.5.0<span class="token punctuation">-</span>jdk<span class="token punctuation">-</span><span class="token number">8</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> maven
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> service_second<span class="token punctuation">-</span>package
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token comment">#mvn clean package -pl service_first -am -Dmaven.test.skip=true -pl --projects &lt;arg&gt; 构建制定的模块，模块间用逗号分隔；-am --also-make 同时构建所列模块的依赖模块；</span>
    <span class="token punctuation">-</span> mvn clean package <span class="token punctuation">-</span>P $PROFILE_ACTIVE <span class="token punctuation">-</span>Dmaven.test.skip=true <span class="token punctuation">-</span>pl $SECOND_DIRECTORY <span class="token punctuation">-</span>am
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> $SECOND_DIRECTORY/target/<span class="token important">*.jar</span>
<span class="token key atrule">build-dev:service_second</span><span class="token punctuation">:</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> service_second<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>deploy
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker login $CI_REGISTRY <span class="token punctuation">-</span>u $CI_REGISTRY_USER <span class="token punctuation">-</span>p $CI_REGISTRY_PASSWORD
    <span class="token punctuation">-</span> docker rm <span class="token punctuation">-</span>f $SECOND_NAME <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker rmi <span class="token punctuation">-</span>f $CI_REGISTRY_IMAGE/$SECOND_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$SECOND_TAG <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>f $SECOND_DIRECTORY/Dockerfile <span class="token punctuation">-</span>t $CI_REGISTRY_IMAGE/$SECOND_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$SECOND_TAG .
    <span class="token punctuation">-</span> docker push $CI_REGISTRY_IMAGE/$SECOND_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$SECOND_TAG
    <span class="token punctuation">-</span> docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name $SECOND_NAME <span class="token punctuation">-</span>v /apps/$SECOND_DIRECTORY<span class="token punctuation">:</span>/apps/$SECOND_DIRECTORY/log <span class="token punctuation">-</span><span class="token punctuation">-</span>privileged=true <span class="token punctuation">-</span>p $SECOND_RPORT<span class="token punctuation">:</span>$SECOND_RPORT $CI_REGISTRY_IMAGE/$SECOND_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$SECOND_TAG
    <span class="token punctuation">-</span> docker image prune <span class="token punctuation">-</span>f
  <span class="token key atrule">only</span><span class="token punctuation">:</span> <span class="token comment">#限制作业在什么时候创建，定义了哪些分支或标签(branches and tags)的作业会运行</span>
    <span class="token key atrule">refs</span><span class="token punctuation">:</span> <span class="token comment">#分支</span>
      <span class="token punctuation">-</span> dev
    <span class="token comment">#changes: # 下面的文件中任一文件发生改变</span>
    <span class="token comment">#  - .gitlab-ci.yml</span>
<span class="token key atrule">build-prd:service_second</span><span class="token punctuation">:</span> <span class="token comment">#7</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> service_second<span class="token punctuation">-</span>prd<span class="token punctuation">-</span>deploy
  <span class="token key atrule">before_script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker login $CI_REGISTRY <span class="token punctuation">-</span>u $CI_REGISTRY_USER <span class="token punctuation">-</span>p $CI_REGISTRY_PASSWORD
    <span class="token punctuation">-</span> docker rmi <span class="token punctuation">-</span>f $CI_REGISTRY_IMAGE/$SECOND_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$SECOND_TAG <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>f $SECOND_DIRECTORY/Dockerfile <span class="token punctuation">-</span>t $CI_REGISTRY_IMAGE/$SECOND_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$SECOND_TAG .
    <span class="token punctuation">-</span> docker push $CI_REGISTRY_IMAGE/$SECOND_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$SECOND_TAG
    <span class="token punctuation">-</span> docker image prune <span class="token punctuation">-</span>f
    <span class="token punctuation">-</span> <span class="token string">'which  ssh-agent || ( yum update -y  &amp;&amp; yum install openssh-client git -y )'</span>
    <span class="token punctuation">-</span> eval $(ssh<span class="token punctuation">-</span>agent <span class="token punctuation">-</span>s)
    <span class="token punctuation">-</span> echo &quot;$SSH_PRIVATE_KEY&quot; <span class="token punctuation">|</span> tr <span class="token punctuation">-</span>d '\r' <span class="token punctuation">|</span> ssh<span class="token punctuation">-</span>add <span class="token punctuation">-</span>
    <span class="token punctuation">-</span> mkdir <span class="token punctuation">-</span>p ~/.ssh
    <span class="token punctuation">-</span> chmod 700 ~/.ssh
    <span class="token punctuation">-</span> ssh<span class="token punctuation">-</span>keyscan 192.168.8.103 <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> ~/.ssh/known_hosts <span class="token comment">#ssh-keyscan 从服务器收集 SSH公钥。 ssh-keyscan 是一个收集多个主机的 SSH 公共密钥的实用工具。它被设计用来帮助构建和验证 ssh_known_hosts 文件</span>
    <span class="token punctuation">-</span> chmod 644 ~/.ssh/known_hosts
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token comment"># -tq 打印台静默不打印</span>
    <span class="token punctuation">-</span> ssh <span class="token punctuation">-</span>tq 192.168.8.103 &lt;&lt; EOF
    <span class="token punctuation">-</span> docker login $CI_REGISTRY <span class="token punctuation">-</span>u $CI_REGISTRY_USER <span class="token punctuation">-</span>p $CI_REGISTRY_PASSWORD
    <span class="token punctuation">-</span> docker rm <span class="token punctuation">-</span>f $SECOND_NAME <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker rmi <span class="token punctuation">-</span>f $CI_REGISTRY_IMAGE/$SECOND_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$SECOND_TAG <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name $SECOND_NAME <span class="token punctuation">-</span>v /apps/$SECOND_DIRECTORY<span class="token punctuation">:</span>/apps/$SECOND_DIRECTORY/log <span class="token punctuation">-</span><span class="token punctuation">-</span>privileged=true <span class="token punctuation">-</span>p $SECOND_RPORT<span class="token punctuation">:</span>$SECOND_RPORT $CI_REGISTRY_IMAGE/$SECOND_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$SECOND_TAG
    <span class="token punctuation">-</span> docker image prune <span class="token punctuation">-</span>f
    <span class="token punctuation">-</span> exit
    <span class="token punctuation">-</span> EOF
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token key atrule">variables</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> $PROFILE_ACTIVE == &quot;prd&quot; <span class="token punctuation">]</span>
    <span class="token key atrule">refs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> main
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br></div></div><p>多模块</p> <h3 id="部署过程中遇到的问题"><a href="#部署过程中遇到的问题" class="header-anchor">#</a> 部署过程中遇到的问题</h3> <p><img src="./assets/img/image-20230618211704013.7893e850.png" alt="image-20230618211704013"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#重新加载daemon</span>
systemctl daemon-reload
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>下载的镜像重复拉取</p> <p>The image pull policy: never, if-not-present or always (default).</p> <p>never是从不从远端拉镜像，只用本地。if-not-present 是优先本地，然后是从网络拉取镜像。always 是从远端拉取镜像。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>解决办法：配置先从本地拉取。
<span class="token function">vi</span> /etc/gitlab-runner/config.toml 添加：    
pull_policy <span class="token operator">=</span> <span class="token string">&quot;if-not-present&quot;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="./assets/img/image-20230618215738518.4f20a89c.png" alt="image-20230618215738518"></p> <p><img src="./assets/img/image-20230618220336436.95ccad1b.png" alt="image-20230618220336436"></p> <p>maven下载慢</p> <p>maven安装到宿主机，在runner里面进行挂载，这样可以重复使用，也可以使用国内的镜像源</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>
<span class="token punctuation">[</span><span class="token punctuation">[</span>runners<span class="token punctuation">]</span><span class="token punctuation">]</span>
  name <span class="token operator">=</span> <span class="token string">&quot;Docker Maven Runner&quot;</span>
  url <span class="token operator">=</span> <span class="token string">&quot;http://192.168.8.10:2280&quot;</span>
  token <span class="token operator">=</span> <span class="token string">&quot;mPciztaPrpZsYSsWuRAX&quot;</span>
  executor <span class="token operator">=</span> <span class="token string">&quot;docker&quot;</span>
  <span class="token punctuation">[</span>runners.custom_build_dir<span class="token punctuation">]</span>
  <span class="token punctuation">[</span>runners.cache<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>runners.cache.s3<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>runners.cache.gcs<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>runners.cache.azure<span class="token punctuation">]</span>
  <span class="token punctuation">[</span>runners.docker<span class="token punctuation">]</span>
    tls_verify <span class="token operator">=</span> <span class="token boolean">false</span>
    image <span class="token operator">=</span> <span class="token string">&quot;maven:3.5.0-jdk-8&quot;</span>
    privileged <span class="token operator">=</span> <span class="token boolean">true</span>
    pull_policy <span class="token operator">=</span> <span class="token string">&quot;if-not-present&quot;</span>
    disable_entrypoint_overwrite <span class="token operator">=</span> <span class="token boolean">false</span>
    oom_kill_disable <span class="token operator">=</span> <span class="token boolean">false</span>
    disable_cache <span class="token operator">=</span> <span class="token boolean">false</span>
    volumes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;/cache&quot;</span>, <span class="token string">&quot;/export/server/bigdata-stack/maven/apache-maven-3.9.2:/root/.m2&quot;</span><span class="token punctuation">]</span>
    shm_size <span class="token operator">=</span> <span class="token number">0</span>

<span class="token punctuation">[</span><span class="token punctuation">[</span>runners<span class="token punctuation">]</span><span class="token punctuation">]</span>
  name <span class="token operator">=</span> <span class="token string">&quot;Docker Build Runner&quot;</span>
  url <span class="token operator">=</span> <span class="token string">&quot;http://192.168.8.10:2280&quot;</span>
  token <span class="token operator">=</span> <span class="token string">&quot;pRuA3NL6tsJsBgq-Ps65&quot;</span>
  executor <span class="token operator">=</span> <span class="token string">&quot;docker&quot;</span>
  <span class="token punctuation">[</span>runners.custom_build_dir<span class="token punctuation">]</span>
  <span class="token punctuation">[</span>runners.cache<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>runners.cache.s3<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>runners.cache.gcs<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>runners.cache.azure<span class="token punctuation">]</span>
  <span class="token punctuation">[</span>runners.docker<span class="token punctuation">]</span>
    tls_verify <span class="token operator">=</span> <span class="token boolean">false</span>
    image <span class="token operator">=</span> <span class="token string">&quot;docker:latest&quot;</span>
    privileged <span class="token operator">=</span> <span class="token boolean">true</span>
    pull_policy <span class="token operator">=</span> <span class="token string">&quot;if-not-present&quot;</span>
    disable_entrypoint_overwrite <span class="token operator">=</span> <span class="token boolean">false</span>
    oom_kill_disable <span class="token operator">=</span> <span class="token boolean">false</span>
    disable_cache <span class="token operator">=</span> <span class="token boolean">false</span>
    volumes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;/cache&quot;</span>, <span class="token string">&quot;/export/server/bigdata-stack/maven/apache-maven-3.9.2:/root/.m2&quot;</span><span class="token punctuation">]</span>
    shm_size <span class="token operator">=</span> <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p><img src="./assets/img/image-20230618220813431.8b7f4c53.png" alt="image-20230618220813431"></p> <h2 id="_10-docker-整合sonar进行代码质量检查-统计单元测试覆盖率"><a href="#_10-docker-整合sonar进行代码质量检查-统计单元测试覆盖率" class="header-anchor">#</a> 10.Docker 整合Sonar进行代码质量检查,统计单元测试覆盖率</h2> <p>单模块的.yml配置修改如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#1：需要用到的镜像</span>
<span class="token comment">#2：必须配置的一些环境变量。如果本地可不配置 DOCKER_HOST。</span>
<span class="token comment">#3：配置缓存，配置后，maven 下载的依赖可以被缓存起来，下次不需要重复去下载了。</span>
<span class="token comment">#4：配置需要用到的额外的服务。docker:dind，这个貌似是用于在 docker 中运行 docker 的一种东西，在项目的构建中需要。</span>
<span class="token comment">#有时需要在容器内执行 docker 命令，比如：在 jenkins 容器内运行 docker 命令执行构建镜像</span>
<span class="token comment">#直接在 docker 容器内嵌套安装 docker 未免太过臃肿</span>
<span class="token comment">#更好的办法是：容器内仅部署 docker 命令行工具（作为客户端），实际执行交由宿主机内的 docker-engine（服务器）</span>
<span class="token comment">#先启动一个docker:dind容器A，再启动一个docker容器B，容器B指定host为A容器内的docker daemon。</span>

<span class="token comment">#5：stages，这是 Gitlab CI 中的概念，Stages 表示构建阶段，就是一些按序执行的流程，具体执行是依赖于 Jobs 的。</span>
<span class="token comment">#6 ：定义的 Jobs 之一，用于构建 jar 包。内部又引入 maven 镜像来处理，负责执行 package 这一流程。script 为具体执行的脚本。</span>
<span class="token comment">#7：定义的 Jobs 之一，用于构建 Docker 镜像。负责执行 deploy 这一流程。具体执行 build 和 run。only 节点表示只监控 master 分支。</span>

<span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>latest  <span class="token comment">#1</span>
<span class="token key atrule">variables</span><span class="token punctuation">:</span>  <span class="token comment">#2</span>
  <span class="token key atrule">DOCKER_DRIVER</span><span class="token punctuation">:</span> overlay2
  <span class="token key atrule">DOCKER_HOST</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//192.168.8.10<span class="token punctuation">:</span><span class="token number">2375</span>  <span class="token comment"># docker host，本地可不写</span>
  <span class="token key atrule">DOCKER_TLS_CERTDIR</span><span class="token punctuation">:</span> <span class="token string">''</span>
  <span class="token key atrule">USERSERVICE_TAG</span><span class="token punctuation">:</span> <span class="token string">':1.0'</span>  <span class="token comment"># 镜像版本号</span>
  <span class="token key atrule">USERSERVICE_NAME</span><span class="token punctuation">:</span> cicd <span class="token comment">#镜像名称</span>
  <span class="token key atrule">USERSERVICE_RPORT</span><span class="token punctuation">:</span> <span class="token number">6666</span> <span class="token comment">#镜像端口 容器内的端口与其不一致</span>
  <span class="token key atrule">USERSERVICE_DIRECTORY</span><span class="token punctuation">:</span> cicd <span class="token comment">#模块目录</span>
  <span class="token key atrule">PROFILE_ACTIVE</span><span class="token punctuation">:</span> prd

  <span class="token comment"># sonner scanner 安装目录</span>
  <span class="token key atrule">SCANNER_HOME</span><span class="token punctuation">:</span> <span class="token string">&quot;/export/server/sonar-scanner&quot;</span>
  <span class="token comment"># 扫描代码路径</span>
  <span class="token key atrule">SCAN_DIR</span><span class="token punctuation">:</span> <span class="token string">&quot;src&quot;</span>
<span class="token key atrule">cache</span><span class="token punctuation">:</span>  <span class="token comment">#3</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span> m2<span class="token punctuation">-</span>repo
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> .m2/repository
<span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token comment">#4</span>
  <span class="token punctuation">-</span> docker<span class="token punctuation">:</span>dind
<span class="token key atrule">stages</span><span class="token punctuation">:</span>  <span class="token comment">#5</span>
  <span class="token punctuation">-</span> package
  <span class="token punctuation">-</span> sonarqube<span class="token punctuation">-</span>check
  <span class="token punctuation">-</span> deploy<span class="token punctuation">-</span>dev
  <span class="token punctuation">-</span> deploy<span class="token punctuation">-</span>prd
<span class="token key atrule">maven-package</span><span class="token punctuation">:</span>  <span class="token comment">#6</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> maven<span class="token punctuation">:</span>3.5.0<span class="token punctuation">-</span>jdk<span class="token punctuation">-</span><span class="token number">8</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> maven
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> package
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> mvn clean org.jacoco<span class="token punctuation">:</span>jacoco<span class="token punctuation">-</span>maven<span class="token punctuation">-</span>plugin<span class="token punctuation">:</span>prepare<span class="token punctuation">-</span>agent install dependency<span class="token punctuation">:</span>copy<span class="token punctuation">-</span>dependencies
      <span class="token punctuation">-</span>Dmaven.test.failure.ignore=true package <span class="token punctuation">-</span>P $PROFILE_ACTIVE
  <span class="token comment"># Maven编译，所以会有Jar包产物，这里定义产物的过期时间</span>
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">expire_in</span><span class="token punctuation">:</span> 1 days
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> target/
<span class="token key atrule">sonarqube-check</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> sonarsource/sonar<span class="token punctuation">-</span>scanner<span class="token punctuation">-</span>cli<span class="token punctuation">:</span>latest
    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> sonar
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> sonarqube<span class="token punctuation">-</span>check
  <span class="token key atrule">needs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>maven<span class="token punctuation">-</span>package<span class="token punctuation">]</span>
  <span class="token key atrule">dependencies</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> maven<span class="token punctuation">-</span>package
  <span class="token key atrule">variables</span><span class="token punctuation">:</span>
    <span class="token key atrule">SONAR_USER_HOME</span><span class="token punctuation">:</span> <span class="token string">&quot;${CI_PROJECT_DIR}/.sonar&quot;</span>  <span class="token comment"># Defines the location of the analysis task cache</span>
    <span class="token key atrule">GIT_DEPTH</span><span class="token punctuation">:</span> <span class="token string">&quot;0&quot;</span>  <span class="token comment"># Tells git to fetch all the branches of the project, required by the analysis task</span>
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">&quot;${CI_JOB_NAME}&quot;</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .sonar/cache
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> sonar<span class="token punctuation">-</span>scanner
      <span class="token punctuation">-</span>Dsonar.projectKey=sonarqube<span class="token punctuation">-</span>check
      <span class="token punctuation">-</span>Dsonar.sources=src/main/
      <span class="token punctuation">-</span>Dsonar.tests=src/test/
      <span class="token punctuation">-</span>Dsonar.coverage.exclusions=src/main/java/com/gordon/cicd/CicdApplication.java
      <span class="token punctuation">-</span>Dsonar.scm.disabled=true
      <span class="token punctuation">-</span>Dsonar.language=java
      <span class="token punctuation">-</span>Dsonar.sourceEncoding=UTF<span class="token punctuation">-</span><span class="token number">8</span>
      <span class="token punctuation">-</span>Dsonar.host.url=http<span class="token punctuation">:</span>//192.168.8.10<span class="token punctuation">:</span><span class="token number">9000</span>
      <span class="token punctuation">-</span>Dsonar.login=b95cb41cb57230c28a79a177a9f0fc3bddf02a79
      <span class="token punctuation">-</span>Dsonar.java.binaries=target/classes
      <span class="token punctuation">-</span>Dsonar.java.test.binaries=target/test<span class="token punctuation">-</span>classes
      <span class="token punctuation">-</span>Dsonar.java.libraries=target/dependency
      <span class="token punctuation">-</span>Dsonar.java.test.libraries=target/dependency
      <span class="token punctuation">-</span>Dsonar.java.surefire.report=target/surefire<span class="token punctuation">-</span>reports
      <span class="token punctuation">-</span>Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
    <span class="token comment">#统计结果输出</span>
    <span class="token punctuation">-</span> awk <span class="token punctuation">-</span>F&quot;<span class="token punctuation">,</span>&quot; '<span class="token punctuation">{</span> instructions += $4 + $5; covered += $5 <span class="token punctuation">}</span> END <span class="token punctuation">{</span> print 100 <span class="token important">*covered/instructions</span><span class="token punctuation">,</span> <span class="token string">&quot;% covered&quot;</span> <span class="token punctuation">}</span>' target/site/jacoco/jacoco.csv

  <span class="token key atrule">allow_failure</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> merge_requests
    <span class="token punctuation">-</span> master <span class="token comment"># or the name of your main branch</span>
    <span class="token punctuation">-</span> develop
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> target/

<span class="token key atrule">build-dev</span><span class="token punctuation">:</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>dev
  <span class="token key atrule">needs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>sonarqube<span class="token punctuation">-</span>check<span class="token punctuation">]</span>
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker login $CI_REGISTRY <span class="token punctuation">-</span>u $CI_REGISTRY_USER <span class="token punctuation">-</span>p $CI_REGISTRY_PASSWORD
    <span class="token punctuation">-</span> docker rm <span class="token punctuation">-</span>f $USERSERVICE_NAME <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker rmi <span class="token punctuation">-</span>f $CI_REGISTRY_IMAGE/$USERSERVICE_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$USERSERVICE_TAG <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>f Dockerfile <span class="token punctuation">-</span>t $CI_REGISTRY_IMAGE/$USERSERVICE_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$USERSERVICE_TAG .
    <span class="token punctuation">-</span> docker push $CI_REGISTRY_IMAGE/$USERSERVICE_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$USERSERVICE_TAG
    <span class="token punctuation">-</span> docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name $USERSERVICE_NAME <span class="token punctuation">-</span>v $USERSERVICE_NAME<span class="token punctuation">:</span>/apps <span class="token punctuation">-</span><span class="token punctuation">-</span>privileged=true <span class="token punctuation">-</span>p $USERSERVICE_RPORT<span class="token punctuation">:</span>$USERSERVICE_RPORT $CI_REGISTRY_IMAGE/$USERSERVICE_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$USERSERVICE_TAG
    <span class="token punctuation">-</span> docker image prune <span class="token punctuation">-</span>f
  <span class="token key atrule">only</span><span class="token punctuation">:</span> <span class="token comment">#限制作业在什么时候创建，定义了哪些分支或标签(branches and tags)的作业会运行</span>
    <span class="token key atrule">refs</span><span class="token punctuation">:</span> <span class="token comment">#分支</span>
      <span class="token punctuation">-</span> dev
    <span class="token comment">#changes: # 下面的文件中任一文件发生改变</span>
    <span class="token comment">#  - .gitlab-ci.yml</span>
<span class="token key atrule">build-prd</span><span class="token punctuation">:</span>  <span class="token comment">#7</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>prd
  <span class="token key atrule">needs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>sonarqube<span class="token punctuation">-</span>check<span class="token punctuation">]</span>
  <span class="token key atrule">before_script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> docker login $CI_REGISTRY <span class="token punctuation">-</span>u $CI_REGISTRY_USER <span class="token punctuation">-</span>p $CI_REGISTRY_PASSWORD
    <span class="token punctuation">-</span> docker rmi <span class="token punctuation">-</span>f $CI_REGISTRY_IMAGE/$USERSERVICE_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$USERSERVICE_TAG <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>f Dockerfile <span class="token punctuation">-</span>t $CI_REGISTRY_IMAGE/$USERSERVICE_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$USERSERVICE_TAG .
    <span class="token punctuation">-</span> docker push $CI_REGISTRY_IMAGE/$USERSERVICE_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$USERSERVICE_TAG
    <span class="token punctuation">-</span> docker image prune <span class="token punctuation">-</span>f
    <span class="token punctuation">-</span> <span class="token string">'which  ssh-agent || ( yum update -y  &amp;&amp; yum install openssh-client git -y )'</span>
    <span class="token punctuation">-</span> eval $(ssh<span class="token punctuation">-</span>agent <span class="token punctuation">-</span>s)
    <span class="token punctuation">-</span> echo &quot;$SSH_PRIVATE_KEY&quot; <span class="token punctuation">|</span> tr <span class="token punctuation">-</span>d '\r' <span class="token punctuation">|</span> ssh<span class="token punctuation">-</span>add <span class="token punctuation">-</span>
    <span class="token punctuation">-</span> mkdir <span class="token punctuation">-</span>p ~/.ssh
    <span class="token punctuation">-</span> chmod 700 ~/.ssh
    <span class="token punctuation">-</span> ssh<span class="token punctuation">-</span>keyscan 192.168.8.103 <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> ~/.ssh/known_hosts <span class="token comment">#ssh-keyscan 从服务器收集 SSH公钥。 ssh-keyscan 是一个收集多个主机的 SSH 公共密钥的实用工具。它被设计用来帮助构建和验证 ssh_known_hosts 文件</span>
    <span class="token punctuation">-</span> chmod 644 ~/.ssh/known_hosts
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token comment"># -tq 打印台静默不打印</span>
    <span class="token punctuation">-</span> ssh <span class="token punctuation">-</span>tq 192.168.8.103 &lt;&lt; EOF
    <span class="token punctuation">-</span> docker login $CI_REGISTRY <span class="token punctuation">-</span>u $CI_REGISTRY_USER <span class="token punctuation">-</span>p $CI_REGISTRY_PASSWORD
    <span class="token punctuation">-</span> docker rm <span class="token punctuation">-</span>f $USERSERVICE_NAME <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker rmi <span class="token punctuation">-</span>f $CI_REGISTRY_IMAGE/$USERSERVICE_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$USERSERVICE_TAG <span class="token punctuation">|</span><span class="token punctuation">|</span> true
    <span class="token punctuation">-</span> docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name $USERSERVICE_NAME <span class="token punctuation">-</span>v $USERSERVICE_NAME<span class="token punctuation">:</span>/apps <span class="token punctuation">-</span><span class="token punctuation">-</span>privileged=true <span class="token punctuation">-</span>p $USERSERVICE_RPORT<span class="token punctuation">:</span>$USERSERVICE_RPORT $CI_REGISTRY_IMAGE/$USERSERVICE_NAME<span class="token punctuation">-</span>$PROFILE_ACTIVE$USERSERVICE_TAG
    <span class="token punctuation">-</span> docker image prune <span class="token punctuation">-</span>f
    <span class="token punctuation">-</span> exit
    <span class="token punctuation">-</span> EOF
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token key atrule">variables</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> $PROFILE_ACTIVE == &quot;prd&quot; <span class="token punctuation">]</span>
    <span class="token key atrule">refs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> master
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br></div></div><p><img src="./assets/img/image-20230621061204614.674c069c.png" alt="image-20230621061204614"></p> <p><img src="./assets/img/image-20230621061339592.f094441b.png" alt="image-20230621061339592"></p> <p>为了readme能查看结果，pom中jacoco做了exclude</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.1.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.gordon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>cicd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">&gt;</span></span>jar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>cicd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Demo project for Spring Boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>


    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginManagement</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.sonarsource.scanner.maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sonar-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.7.0.1746<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginManagement</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">&gt;</span></span>${java.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">&gt;</span></span>${java.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token comment">&lt;!--覆盖率测试--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-surefire-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.21.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>testFailureIgnore</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>testFailureIgnore</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argLine</span><span class="token punctuation">&gt;</span></span>@{argLine} -Dfile.encoding=utf-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>argLine</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.jacoco<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jacoco-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.8.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>**/CicdApplication.class<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>prepare-agent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>prepare-agent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>report<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>report<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>


        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br></div></div><p>覆盖率展示格式化</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">\</span>d+.<span class="token punctuation">\</span>d+ <span class="token punctuation">\</span>% covered
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="./assets/img/image-20230621132854431.c844f15e.png" alt="image-20230621132854431"></p> <p><img src="./assets/img/image-20230621132548570.dd61fcc8.png" alt="image-20230621132548570"></p> <p>多模块的子模块配置更新如下：</p> <p>这里提供一种思路，新建一个模块把其他模块作为依赖引入，然后计算总的覆盖率。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token operator">|</span>   .gitlab-ci.yml
<span class="token operator">|</span>   pom.xml
<span class="token operator">|</span>   README.md
+---report-aggregate
<span class="token operator">|</span>       .gitlab-ci.yml
<span class="token operator">|</span>       pom.xml
<span class="token operator">|</span>
+---service_first
<span class="token operator">|</span>   <span class="token operator">|</span>   .gitlab-ci.yml
<span class="token operator">|</span>   <span class="token operator">|</span>   Dockerfile
<span class="token operator">|</span>   <span class="token operator">|</span>   pom.xml
<span class="token operator">|</span>   <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token punctuation">\</span>---src
<span class="token operator">|</span>       +---main
<span class="token operator">|</span>       <span class="token operator">|</span>   +---java
<span class="token operator">|</span>       <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token punctuation">\</span>---com
<span class="token operator">|</span>       <span class="token operator">|</span>   <span class="token operator">|</span>       <span class="token punctuation">\</span>---gordon
<span class="token operator">|</span>       <span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>   FirstApplication.java
<span class="token operator">|</span>       <span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>
<span class="token operator">|</span>       <span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token punctuation">\</span>---controller
<span class="token operator">|</span>       <span class="token operator">|</span>   <span class="token operator">|</span>                   TestController.java
<span class="token operator">|</span>       <span class="token operator">|</span>   <span class="token operator">|</span>
<span class="token operator">|</span>       <span class="token operator">|</span>   <span class="token punctuation">\</span>---resources
<span class="token operator">|</span>       <span class="token operator">|</span>           application.properties
<span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span>       <span class="token punctuation">\</span>---test
<span class="token operator">|</span>           <span class="token punctuation">\</span>---java
<span class="token operator">|</span>               <span class="token punctuation">\</span>---com
<span class="token operator">|</span>                   <span class="token punctuation">\</span>---gordon
<span class="token operator">|</span>                       <span class="token punctuation">\</span>---controller
<span class="token operator">|</span>                               TestControllerTest.java
<span class="token operator">|</span>
<span class="token punctuation">\</span>---service_second
    <span class="token operator">|</span>   .gitlab-ci.yml
    <span class="token operator">|</span>   Dockerfile
    <span class="token operator">|</span>   pom.xml
    <span class="token operator">|</span>
    <span class="token punctuation">\</span>---src
        +---main
        <span class="token operator">|</span>   +---java
        <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token punctuation">\</span>---com
        <span class="token operator">|</span>   <span class="token operator">|</span>       <span class="token punctuation">\</span>---gordon
        <span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>   SecondApplication.java
        <span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token operator">|</span>
        <span class="token operator">|</span>   <span class="token operator">|</span>           <span class="token punctuation">\</span>---controller
        <span class="token operator">|</span>   <span class="token operator">|</span>                   TestController.java
        <span class="token operator">|</span>   <span class="token operator">|</span>
        <span class="token operator">|</span>   <span class="token punctuation">\</span>---resources
        <span class="token operator">|</span>           application.properties
        <span class="token operator">|</span>
        <span class="token punctuation">\</span>---test
            <span class="token punctuation">\</span>---java
                <span class="token punctuation">\</span>---com
                    <span class="token punctuation">\</span>---gordon
                        <span class="token punctuation">\</span>---controller
                                TestControllerTest.java
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>创建第三模块</p> <p>pom</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>cicd_muil<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.gordon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>report-aggregate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.gordon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>service_first<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.gordon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>service_second<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.jacoco<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jacoco-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.8.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>**/FirstApplication.class<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">&gt;</span></span>**/SecondApplication.class<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>jacoco-report-aggregate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                        <span class="token comment">&lt;!-- 触发的maven 命令 --&gt;</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>install<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>report-aggregate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>.gitlab-ci.yml</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>latest  <span class="token comment">#1</span>
<span class="token key atrule">variables</span><span class="token punctuation">:</span>  <span class="token comment">#2</span>
  <span class="token comment">#根目录已提供</span>
  <span class="token comment">#DOCKER_DRIVER: overlay2</span>
  <span class="token comment">#DOCKER_HOST: tcp://192.168.8.10:2375  # docker host，本地可不写</span>
  <span class="token comment">#DOCKER_TLS_CERTDIR: ''</span>
  <span class="token comment">#PROFILE_ACTIVE: prd</span>
  <span class="token key atrule">REPORT_NAME</span><span class="token punctuation">:</span> report<span class="token punctuation">-</span>aggregate <span class="token comment">#镜像名称</span>
  <span class="token key atrule">REPORT_DIRECTORY</span><span class="token punctuation">:</span> report<span class="token punctuation">-</span>aggregate <span class="token comment">#模块目录</span>

<span class="token key atrule">cache</span><span class="token punctuation">:</span>  <span class="token comment">#3</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span> m2<span class="token punctuation">-</span>repo
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> .m2/repository
<span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token comment">#4</span>
  <span class="token punctuation">-</span> docker<span class="token punctuation">:</span>dind
<span class="token key atrule">stages</span><span class="token punctuation">:</span>  <span class="token comment">#5</span>
  <span class="token punctuation">-</span> report<span class="token punctuation">-</span>aggregate

<span class="token key atrule">maven-package:report-aggregate</span><span class="token punctuation">:</span>  <span class="token comment">#6</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> maven<span class="token punctuation">:</span>3.5.0<span class="token punctuation">-</span>jdk<span class="token punctuation">-</span><span class="token number">8</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> maven
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> report<span class="token punctuation">-</span>aggregate
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token comment">#mvn clean package -pl service_first -am -Dmaven.test.skip=true -pl --projects &lt;arg&gt; 构建制定的模块，模块间用逗号分隔；-am --also-make 同时构建所列模块的依赖模块；</span>
    <span class="token punctuation">-</span> mvn clean install dependency<span class="token punctuation">:</span>copy<span class="token punctuation">-</span>dependencies <span class="token punctuation">-</span>Dmaven.test.failure.ignore=true <span class="token punctuation">-</span>pl $REPORT_DIRECTORY  <span class="token punctuation">-</span>am
    <span class="token punctuation">-</span> awk <span class="token punctuation">-</span>F&quot;<span class="token punctuation">,</span>&quot; '<span class="token punctuation">{</span> instructions += $4 + $5; covered += $5 <span class="token punctuation">}</span> END <span class="token punctuation">{</span> print 100 <span class="token important">*covered/instructions</span><span class="token punctuation">,</span> <span class="token string">&quot;% covered&quot;</span> <span class="token punctuation">}</span>' $REPORT_DIRECTORY/target/site/jacoco<span class="token punctuation">-</span>aggregate/jacoco.csv
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> $REPORT_DIRECTORY/target/

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p><strong>查看pipeline运行情况以及扫描结果</strong></p> <p><img src="./assets/img/image-20230620154235530.f5816d17.png" alt="image-20230620154235530"></p> <p>test<br> <img src="./assets/img/image-20230621154703183.1908cae8.png" alt="image-20230621154703183"></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2023-7-19 7:18:59 ├F10: PM┤</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/./2023/06/10/docker/#_1-docker-的介绍和安装" class="sidebar-link reco-side-_1-docker-的介绍和安装" data-v-b57cc07c>1. Docker 的介绍和安装</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#容器技术的介绍" class="sidebar-link reco-side-容器技术的介绍" data-v-b57cc07c>容器技术的介绍</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#在-linux-系统上安装-docker" class="sidebar-link reco-side-在-linux-系统上安装-docker" data-v-b57cc07c>在 Linux 系统上安装 Docker</a></li><li class="level-2" data-v-b57cc07c><a href="/./2023/06/10/docker/#_2-容器的快速上手" class="sidebar-link reco-side-_2-容器的快速上手" data-v-b57cc07c>2.容器的快速上手</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#docker命令行的认识" class="sidebar-link reco-side-docker命令行的认识" data-v-b57cc07c>docker命令行的认识</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#理解image-vs-container-镜像-vs-容器" class="sidebar-link reco-side-理解image-vs-container-镜像-vs-容器" data-v-b57cc07c>理解Image vs Container 镜像 vs 容器</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#容器的基本操作" class="sidebar-link reco-side-容器的基本操作" data-v-b57cc07c>容器的基本操作</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#docker-container-命令小技巧" class="sidebar-link reco-side-docker-container-命令小技巧" data-v-b57cc07c>docker container 命令小技巧</a></li><li class="level-2" data-v-b57cc07c><a href="/./2023/06/10/docker/#批量停止" class="sidebar-link reco-side-批量停止" data-v-b57cc07c>批量停止</a></li><li class="level-2" data-v-b57cc07c><a href="/./2023/06/10/docker/#批量删除" class="sidebar-link reco-side-批量删除" data-v-b57cc07c>批量删除</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#container-mode-容器运行的各种模式" class="sidebar-link reco-side-container-mode-容器运行的各种模式" data-v-b57cc07c>Container Mode 容器运行的各种模式</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#连接容器的-shell" class="sidebar-link reco-side-连接容器的-shell" data-v-b57cc07c>连接容器的 shell</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#容器和虚拟机-container-vs-vm" class="sidebar-link reco-side-容器和虚拟机-container-vs-vm" data-v-b57cc07c>容器和虚拟机 Container vs VM</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#docker-container-run-背后发生了什么" class="sidebar-link reco-side-docker-container-run-背后发生了什么" data-v-b57cc07c>docker container run 背后发生了什么？</a></li><li class="level-2" data-v-b57cc07c><a href="/./2023/06/10/docker/#_3-镜像的获取的三种方式" class="sidebar-link reco-side-_3-镜像的获取的三种方式" data-v-b57cc07c>3. 镜像的获取的三种方式</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#从registry拉取pull" class="sidebar-link reco-side-从registry拉取pull" data-v-b57cc07c>从registry拉取pull</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#从离线导入load" class="sidebar-link reco-side-从离线导入load" data-v-b57cc07c>从离线导入load</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#从dockerfile-build" class="sidebar-link reco-side-从dockerfile-build" data-v-b57cc07c>从dockerfile build</a></li><li class="level-2" data-v-b57cc07c><a href="/./2023/06/10/docker/#_4-dockerfile命令详解" class="sidebar-link reco-side-_4-dockerfile命令详解" data-v-b57cc07c>4.Dockerfile命令详解</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#基础镜像的选择-from" class="sidebar-link reco-side-基础镜像的选择-from" data-v-b57cc07c>基础镜像的选择 (FROM)</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#在image里run-执行指令" class="sidebar-link reco-side-在image里run-执行指令" data-v-b57cc07c>在image里RUN 执行指令</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#文件复制-add-copy" class="sidebar-link reco-side-文件复制-add-copy" data-v-b57cc07c>文件复制 (ADD,COPY)</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#构建参数和环境变量-arg↑-vs-env" class="sidebar-link reco-side-构建参数和环境变量-arg↑-vs-env" data-v-b57cc07c>构建参数和环境变量 (ARG↑ vs ENV)</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#容器启动命令-cmd" class="sidebar-link reco-side-容器启动命令-cmd" data-v-b57cc07c>容器启动命令 CMD</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#容器启动命令-entrypoint" class="sidebar-link reco-side-容器启动命令-entrypoint" data-v-b57cc07c>容器启动命令 ENTRYPOINT</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#shell-格式和-exec-格式" class="sidebar-link reco-side-shell-格式和-exec-格式" data-v-b57cc07c>Shell 格式和 Exec 格式</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#实战-构建一个-python-flask-镜像" class="sidebar-link reco-side-实战-构建一个-python-flask-镜像" data-v-b57cc07c>实战：构建一个 Python Flask 镜像</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#dockerfile-技巧-镜像的多阶段构建" class="sidebar-link reco-side-dockerfile-技巧-镜像的多阶段构建" data-v-b57cc07c>Dockerfile 技巧——镜像的多阶段构建</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#dockerfile-技巧-尽量使用非root用户" class="sidebar-link reco-side-dockerfile-技巧-尽量使用非root用户" data-v-b57cc07c>Dockerfile 技巧——尽量使用非root用户</a></li><li class="level-2" data-v-b57cc07c><a href="/./2023/06/10/docker/#_5-docker的存储" class="sidebar-link reco-side-_5-docker的存储" data-v-b57cc07c>5.Docker的存储</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#data-volume" class="sidebar-link reco-side-data-volume" data-v-b57cc07c>Data Volume</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#data-volume-练习-mysql" class="sidebar-link reco-side-data-volume-练习-mysql" data-v-b57cc07c>Data Volume 练习 MySQL</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#多个机器之间的容器共享数据" class="sidebar-link reco-side-多个机器之间的容器共享数据" data-v-b57cc07c>多个机器之间的容器共享数据</a></li><li class="level-2" data-v-b57cc07c><a href="/./2023/06/10/docker/#_6-docker网络" class="sidebar-link reco-side-_6-docker网络" data-v-b57cc07c>6.Docker网络</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#容器间通信" class="sidebar-link reco-side-容器间通信" data-v-b57cc07c>容器间通信</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#外部访问容器-端口转发" class="sidebar-link reco-side-外部访问容器-端口转发" data-v-b57cc07c>外部访问容器：端口转发</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#同一host中的不同bridge通信" class="sidebar-link reco-side-同一host中的不同bridge通信" data-v-b57cc07c>同一host中的不同bridge通信</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#容器通信的底层原理" class="sidebar-link reco-side-容器通信的底层原理" data-v-b57cc07c>容器通信的底层原理：</a></li><li class="level-2" data-v-b57cc07c><a href="/./2023/06/10/docker/#_7-docker-compose" class="sidebar-link reco-side-_7-docker-compose" data-v-b57cc07c>7.Docker Compose</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#docker-compose-介绍" class="sidebar-link reco-side-docker-compose-介绍" data-v-b57cc07c>docker compose 介绍</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#docker-compose-的安装" class="sidebar-link reco-side-docker-compose-的安装" data-v-b57cc07c>docker compose 的安装</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#docker-compose基本使用" class="sidebar-link reco-side-docker-compose基本使用" data-v-b57cc07c>docker-compose基本使用</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#docker-compose-服务的构建、拉取与更新" class="sidebar-link reco-side-docker-compose-服务的构建、拉取与更新" data-v-b57cc07c>docker-compose 服务的构建、拉取与更新</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#docker-compose-网络" class="sidebar-link reco-side-docker-compose-网络" data-v-b57cc07c>docker-compose 网络</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#水平扩展-scale" class="sidebar-link reco-side-水平扩展-scale" data-v-b57cc07c>水平扩展 scale</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#docker-compose-环境变量" class="sidebar-link reco-side-docker-compose-环境变量" data-v-b57cc07c>docker compose 环境变量</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#docker-compose-健康检查" class="sidebar-link reco-side-docker-compose-健康检查" data-v-b57cc07c>docker compose 健康检查</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#一站式hadoop集群便于测试开发" class="sidebar-link reco-side-一站式hadoop集群便于测试开发" data-v-b57cc07c>一站式hadoop集群便于测试开发</a></li><li class="level-2" data-v-b57cc07c><a href="/./2023/06/10/docker/#_8-docker-swarm" class="sidebar-link reco-side-_8-docker-swarm" data-v-b57cc07c>8.Docker Swarm</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#docker-swarm-介绍" class="sidebar-link reco-side-docker-swarm-介绍" data-v-b57cc07c>docker swarm 介绍</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#swarm-单节点快速上手" class="sidebar-link reco-side-swarm-单节点快速上手" data-v-b57cc07c>Swarm 单节点快速上手</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#docker-stack" class="sidebar-link reco-side-docker-stack" data-v-b57cc07c>Docker Stack</a></li><li class="level-2" data-v-b57cc07c><a href="/./2023/06/10/docker/#_9-docker整合gitlab-cicd" class="sidebar-link reco-side-_9-docker整合gitlab-cicd" data-v-b57cc07c>9.Docker整合gitlab CICD</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#单模块下部署" class="sidebar-link reco-side-单模块下部署" data-v-b57cc07c>单模块下部署</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#多模块合并部署" class="sidebar-link reco-side-多模块合并部署" data-v-b57cc07c>多模块合并部署</a></li><li class="level-3" data-v-b57cc07c><a href="/./2023/06/10/docker/#部署过程中遇到的问题" class="sidebar-link reco-side-部署过程中遇到的问题" data-v-b57cc07c>部署过程中遇到的问题</a></li><li class="level-2" data-v-b57cc07c><a href="/./2023/06/10/docker/#_10-docker-整合sonar进行代码质量检查-统计单元测试覆盖率" class="sidebar-link reco-side-_10-docker-整合sonar进行代码质量检查-统计单元测试覆盖率" data-v-b57cc07c>10.Docker 整合Sonar进行代码质量检查,统计单元测试覆盖率</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----></div></div>
    <script src="./assets/js/app.764dede6.js" defer></script><script src="./assets/js/13.20e964b9.js" defer></script><script src="./assets/js/1.8757f81f.js" defer></script><script src="./assets/js/5.a1a0df33.js" defer></script><script src="./assets/js/34.ec572062.js" defer></script>
  </body>
</html>
